<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å›¾ç‰‡å‹ç¼©å·¥å…· - é«˜æ•ˆå‹ç¼©ï¼Œæœ¬åœ°å¤„ç†</title>

  <!-- è®¾è®¡ç³»ç»Ÿ -->
  <link rel="stylesheet" href="design-system-modern.css" />
  <link rel="stylesheet" href="tool-pages-interactions.css" />

  <!-- JSZip ç”¨äºä¸‹è½½ -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    /* ===== é¡µé¢ç‰¹å®šæ ·å¼ ===== */
    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #f0f4f8 100%);
      min-height: 100vh;
    }

    /* ===== å¯¼èˆªæ  ===== */
    .navbar {
      position: sticky;
      top: 0;
      background: var(--color-bg-primary);
      border-bottom: 1px solid var(--color-border-light);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      z-index: 100;
      padding: var(--space-lg) var(--space-2xl);
    }

    .navbar-container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .navbar-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .navbar-icon {
      font-size: 28px;
    }

    .navbar-badges {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }

    .badge {
      background: var(--color-primary-bg);
      color: var(--color-primary);
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-weight-semibold);
      border: 1px solid var(--color-primary-light);
    }

    /* ===== è¿”å›æŒ‰é’® ===== */
    .navbar-home {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-lg);
      background: var(--color-bg-secondary);
      color: var(--color-text-primary);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      text-decoration: none;
      transition: all var(--transition-base);
      border: 1px solid var(--color-border-light);
    }

    .navbar-home:hover {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* ===== ä¸»å®¹å™¨ ===== */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--space-3xl) var(--space-lg);
    }

    /* ===== é¡¶éƒ¨å¡ç‰‡ ===== */
    .intro-card {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: white;
      padding: var(--space-3xl);
      border-radius: var(--radius-xl);
      margin-bottom: var(--space-3xl);
      box-shadow: 0 12px 32px rgba(59, 130, 246, 0.2);
    }

    .intro-title {
      font-size: var(--text-3xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-md);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .intro-desc {
      font-size: var(--text-lg);
      opacity: 0.95;
      line-height: 1.6;
    }

    /* ===== å†…å®¹ç½‘æ ¼ ===== */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-2xl);
    }

    /* ===== å¡ç‰‡ ===== */
    .card {
      background: var(--color-bg-primary);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-2xl);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      transition: all var(--transition-base);
    }

    .card:hover {
      border-color: var(--color-primary);
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.12);
    }

    .card-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-2xl);
      color: var(--color-text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .card-icon {
      font-size: 28px;
    }

    /* ===== æ§åˆ¶é¢æ¿ ===== */
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-2xl);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .form-label {
      font-size: var(--text-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .form-label-value {
      color: var(--color-primary);
      font-weight: var(--font-weight-bold);
      font-size: var(--text-md);
    }

    .form-input,
    .form-select {
      padding: var(--space-md);
      border: 1px solid var(--color-border-medium);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      background: var(--color-bg-secondary);
      color: var(--color-text-primary);
      transition: all var(--transition-base);
      font-family: inherit;
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--color-primary);
      background: var(--color-bg-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-input[type="range"] {
      padding: 0;
      height: 6px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    /* ===== æ‹–æ‹½åŒº ===== */
    .dropzone {
      border: 2px dashed var(--color-border-medium);
      border-radius: var(--radius-lg);
      padding: var(--space-3xl);
      text-align: center;
      cursor: pointer;
      transition: all var(--transition-base);
      background: var(--color-bg-secondary);
      position: relative;
    }

    .dropzone:hover {
      border-color: var(--color-primary);
      background: var(--color-primary-bg);
    }

    .dropzone.active {
      border-color: var(--color-primary);
      background: var(--color-primary-bg);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .dropzone-icon {
      font-size: 48px;
      margin-bottom: var(--space-md);
      opacity: 0.6;
    }

    .dropzone-text {
      font-size: var(--text-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
      margin-bottom: var(--space-sm);
    }

    .dropzone-hint {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    /* ===== éšè—æ–‡ä»¶è¾“å…¥ ===== */
    .file-input {
      display: none;
    }

    /* ===== æŒ‰é’®ç»„ ===== */
    .button-group {
      display: flex;
      gap: var(--space-md);
      flex-wrap: wrap;
      margin-top: var(--space-2xl);
    }

    .btn {
      padding: var(--space-md) var(--space-2xl);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all var(--transition-base);
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: white;
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--color-bg-primary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border-light);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .btn-secondary:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.12);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* ===== çŠ¶æ€æ¶ˆæ¯ ===== */
    .status {
      padding: var(--space-md) var(--space-lg);
      border-radius: var(--radius-md);
      margin: var(--space-lg) 0 0;
      font-size: var(--text-sm);
      animation: slideInUp var(--transition-base);
    }

    .status-info {
      background: var(--color-info-bg);
      color: var(--color-info);
      border: 1px solid rgba(6, 182, 212, 0.2);
    }

    .status-success {
      background: var(--color-success-light);
      color: var(--color-success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .status-error {
      background: var(--color-error-bg);
      color: var(--color-error);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* ===== è¡¨æ ¼ ===== */
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border-light);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      background: var(--color-bg-primary);
    }

    .table th {
      background: var(--color-bg-secondary);
      border-bottom: 2px solid var(--color-border-light);
      padding: var(--space-md) var(--space-lg);
      text-align: left;
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
      font-size: var(--text-sm);
      white-space: nowrap;
    }

    .table td {
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--color-border-light);
      color: var(--color-text-primary);
      font-size: var(--text-sm);
    }

    .table tbody tr {
      transition: background var(--transition-fast);
    }

    .table tbody tr:hover {
      background: var(--color-bg-secondary);
    }

    .table tbody tr:last-child td {
      border-bottom: none;
    }

    /* ===== å‹ç¼©ç‡æŒ‡ç¤ºå™¨ ===== */
    .ratio-good {
      color: var(--color-success);
      font-weight: var(--font-weight-semibold);
    }

    .ratio-warning {
      color: var(--color-warning);
      font-weight: var(--font-weight-semibold);
    }

    .ratio-bad {
      color: var(--color-error);
      font-weight: var(--font-weight-semibold);
    }

    /* ===== ç©ºçŠ¶æ€ ===== */
    .empty-state {
      text-align: center;
      padding: var(--space-3xl);
      color: var(--color-text-secondary);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: var(--space-md);
      opacity: 0.4;
    }

    .empty-text {
      font-size: var(--text-lg);
      color: var(--color-text-secondary);
    }

    /* ===== å“åº”å¼ ===== */
    @media (max-width: 768px) {
      .navbar-container {
        flex-direction: column;
        gap: var(--space-lg);
        align-items: flex-start;
      }

      .navbar-title {
        font-size: var(--text-xl);
      }

      .intro-card {
        padding: var(--space-2xl);
      }

      .intro-title {
        font-size: var(--text-2xl);
      }

      .controls {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .table {
        font-size: 12px;
      }

      .table th,
      .table td {
        padding: var(--space-sm) var(--space-md);
      }
    }

    /* ===== åŠ è½½åŠ¨ç”» ===== */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(59, 130, 246, 0.2);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ===== æˆæƒå±‚æ ·å¼ ===== */
    #auth-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.92);
      z-index: 9999;
      backdrop-filter: blur(8px);
    }
    .auth-card {
      width: 360px;
      max-width: 90vw;
      padding: 24px;
      border-radius: 16px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 16px 48px rgba(15, 23, 42, 0.12);
    }
    .auth-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #0f172a;
    }
    .auth-subtitle {
      font-size: 12px;
      color: #475569;
      margin-bottom: 16px;
    }
    .auth-label {
      font-size: 12px;
      color: #475569;
      margin-bottom: 6px;
      display: block;
      font-weight: 600;
    }
    .auth-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #f8fafc;
      color: #0f172a;
      outline: none;
      font-size: 13px;
      margin-bottom: 14px;
      box-sizing: border-box;
      transition: border-color 0.18s, box-shadow 0.18s, transform 0.12s ease;
    }
    .auth-input:focus {
      border-color: #bfdbfe;
      box-shadow: 0 0 0 3px rgba(191, 219, 254, 0.55);
      transform: translateY(-1px);
    }
    .auth-btn {
      width: 100%;
      border: none;
      border-radius: 10px;
      padding: 11px 16px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
      transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
    }
    .auth-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 36px rgba(37, 99, 235, 0.32);
      filter: brightness(1.02);
    }
    .auth-error {
      margin-top: 10px;
      font-size: 11px;
      color: #dc2626;
      min-height: 16px;
    }
    .auth-card.shake {
      animation: shake 0.3s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      50% { transform: translateX(6px); }
      75% { transform: translateX(-3px); }
    }
    #app { display: none; }
  </style>
</head>
<body>
  <!-- æˆæƒå±‚ -->
  <div id="auth-screen">
    <div class="auth-card" id="auth-card">
      <div class="auth-title">ğŸ” è®¿é—®æˆæƒ</div>
      <div class="auth-subtitle">è¯·è¾“å…¥å¯†ç è®¿é—®æœ¬å·¥å…·</div>

      <label class="auth-label" for="auth-code">å¯†ç </label>
      <input
        id="auth-code"
        class="auth-input"
        type="password"
        placeholder="è¯·è¾“å…¥å¯†ç "
        autocomplete="off"
      />

      <button class="auth-btn" id="auth-btn">ç¡®è®¤è¿›å…¥</button>

      <div class="auth-error" id="auth-error"></div>
    </div>
  </div>

  <!-- çœŸæ­£çš„åº”ç”¨ -->
  <div id="app">
  <!-- å¯¼èˆªæ  -->
  <nav class="navbar">
    <div class="navbar-container">
      <div class="navbar-title">
        <span class="navbar-icon">ğŸ–¼ï¸</span>
        <span>å›¾ç‰‡å‹ç¼©å·¥å…·</span>
      </div>
      <div style="display: flex; align-items: center; gap: var(--space-lg);">
        <div class="navbar-badges">
          <div class="badge">âœ“ æœ¬åœ°å¤„ç†</div>
          <div class="badge">âœ“ æ— éœ€ä¸Šä¼ </div>
          <div class="badge">JPG / PNG / WebP</div>
        </div>
        <a href="index.html" class="navbar-home">â† è¿”å›é¦–é¡µ</a>
      </div>
    </div>
  </nav>

  <!-- ä¸»å®¹å™¨ -->
  <div class="main-container">
    <!-- ä»‹ç»å¡ç‰‡ -->
    <div class="intro-card">
      <div class="intro-title">ğŸš€ å¿«é€Ÿå‹ç¼©æ‚¨çš„å›¾ç‰‡</div>
      <div class="intro-desc">
        åœ¨æµè§ˆå™¨ä¸­å®Œå…¨å¤„ç†ï¼Œæ— éœ€ä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚æ”¯æŒ JPGã€PNG å’Œ WebP æ ¼å¼ï¼Œå¯æ‰¹é‡å‹ç¼©å’Œä¸‹è½½ã€‚
      </div>
    </div>

    <!-- å†…å®¹ç½‘æ ¼ -->
    <div class="content-grid">
      <!-- å‚æ•°è®¾ç½®å¡ç‰‡ -->
      <div class="card">
        <div class="card-title">
          <span class="card-icon">âš™ï¸</span>
          <span>é€‰æ‹©å›¾ç‰‡ & å‚æ•°è®¾ç½®</span>
        </div>

        <!-- æ–‡ä»¶è¾“å…¥ -->
        <input type="file" id="fileInput" class="file-input" accept="image/*" multiple />

        <!-- æ‹–æ‹½åŒº -->
        <div class="dropzone" id="dropzone">
          <div class="dropzone-icon">ğŸ“</div>
          <div class="dropzone-text">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
          <div class="dropzone-hint">æˆ–ç‚¹å‡»é€‰æ‹©å¤šä¸ªæ–‡ä»¶</div>
        </div>

        <!-- æ§åˆ¶å‚æ•° -->
        <div class="controls">
          <div class="form-group">
            <label class="form-label">
              <span>è¾“å‡ºæ ¼å¼</span>
            </label>
            <select id="format" class="form-select">
              <option value="auto">ä¿æŒåŸæ ¼å¼</option>
              <option value="image/jpeg">JPEG</option>
              <option value="image/webp">WebP</option>
              <option value="image/png">PNG</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span>è´¨é‡</span>
              <span class="form-label-value"><span id="qVal">0.8</span></span>
            </label>
            <input type="range" id="quality" class="form-input" min="0.1" max="1" step="0.05" value="0.8" />
          </div>

          <div class="form-group">
            <label class="form-label">æœ€å¤§å®½åº¦ (px)</label>
            <input type="number" id="maxW" class="form-input" value="1920" min="100" />
          </div>

          <div class="form-group">
            <label class="form-label">æœ€å¤§é«˜åº¦ (px)</label>
            <input type="number" id="maxH" class="form-input" value="1080" min="100" />
          </div>
        </div>

        <!-- æŒ‰é’®ç»„ -->
        <div class="button-group">
          <button class="btn btn-primary" id="btnCompress">
            <span>âš¡</span>
            <span>å‹ç¼©æ‰€æœ‰</span>
          </button>
          <button class="btn btn-secondary" id="btnDownloadAll">
            <span>ğŸ“¦</span>
            <span>ä¸‹è½½ ZIP</span>
          </button>
          <button class="btn btn-secondary" id="btnClear">
            <span>ğŸ—‘ï¸</span>
            <span>æ¸…ç©º</span>
          </button>
        </div>

        <!-- çŠ¶æ€æ¶ˆæ¯ -->
        <div id="status"></div>
      </div>

      <!-- æ–‡ä»¶åˆ—è¡¨å¡ç‰‡ -->
      <div class="card">
        <div class="card-title">
          <span class="card-icon">ğŸ“‹</span>
          <span>æ–‡ä»¶åˆ—è¡¨</span>
        </div>

        <div class="table-container">
          <table class="table" id="table">
            <thead>
              <tr>
                <th>æ–‡ä»¶å</th>
                <th>åŸå°ºå¯¸</th>
                <th>åŸå¤§å°</th>
                <th>å‹åå°ºå¯¸</th>
                <th>å‹åå¤§å°</th>
                <th>å‹ç¼©ç‡</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr>
                <td colspan="7">
                  <div class="empty-state">
                    <div class="empty-icon">ğŸ“¸</div>
                    <div class="empty-text">æœªé€‰æ‹©æ–‡ä»¶</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const tbody = document.getElementById("tbody");
    const statusEl = document.getElementById("status");
    const qualityEl = document.getElementById("quality");
    const qVal = document.getElementById("qVal");
    const formatEl = document.getElementById("format");
    const maxWEl = document.getElementById("maxW");
    const maxHEl = document.getElementById("maxH");
    const dropzone = document.getElementById("dropzone");
    const btnCompress = document.getElementById("btnCompress");
    const btnDownloadAll = document.getElementById("btnDownloadAll");
    const btnClear = document.getElementById("btnClear");

    let files = [];
    let results = {};

    // è´¨é‡æ˜¾ç¤ºæ›´æ–°
    qVal.textContent = qualityEl.value;
    qualityEl.addEventListener("input", () => qVal.textContent = qualityEl.value);

    // æ ¼å¼åŒ–å­—èŠ‚
    function fmtBytes(bytes) {
      if (bytes === 0) return "0 B";
      const k = 1024;
      const sizes = ["B", "KB", "MB", "GB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return (bytes / Math.pow(k, i)).toFixed(2) + " " + sizes[i];
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(message, type = "info") {
      statusEl.innerHTML = `<div class="status status-${type}">${message}</div>`;
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
      if (!files.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="empty-icon">ğŸ“¸</div>
                <div class="empty-text">æœªé€‰æ‹©æ–‡ä»¶</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = "";
      files.forEach((f) => {
        const r = results[f.name];
        const ratioPercent = r ? (r.size / f.size * 100).toFixed(1) : "-";
        let ratioClass = "";

        if (r) {
          if (r.size <= f.size * 0.5) ratioClass = "ratio-good";
          else if (r.size <= f.size * 0.8) ratioClass = "ratio-warning";
          else ratioClass = "ratio-bad";
        }

        const origDim = r?.origW ? `${r.origW} Ã— ${r.origH}` : "-";
        const compDim = r?.w ? `${r.w} Ã— ${r.h}` : "-";

        tbody.innerHTML += `
          <tr>
            <td><strong>${f.name}</strong></td>
            <td>${origDim}</td>
            <td>${fmtBytes(f.size)}</td>
            <td>${compDim}</td>
            <td>${r ? fmtBytes(r.size) : "-"}</td>
            <td class="${ratioClass}">${r ? ratioPercent + "%" : "-"}</td>
            <td>
              ${r ? `<button class="btn btn-secondary" data-name="${f.name}" data-dl style="font-size: 12px; padding: 6px 12px;">ä¸‹è½½</button>` : '<span style="color: var(--color-text-tertiary);">æœªå‹ç¼©</span>'}
            </td>
          </tr>
        `;
      });

      tbody.querySelectorAll("button[data-dl]").forEach(btn => {
        btn.addEventListener("click", () => {
          const name = btn.getAttribute("data-name");
          const r = results[name];
          if (r?.blob) {
            const url = URL.createObjectURL(r.blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = r.outputName;
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 1000);
          }
        });
      });
    }

    // å‹ç¼©å•ä¸ªæ–‡ä»¶
    async function compressOne(file) {
      const format = formatEl.value;
      const quality = parseFloat(qualityEl.value);
      const maxW = parseInt(maxWEl.value, 10) || 1920;
      const maxH = parseInt(maxHEl.value, 10) || 1080;

      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.onload = () => resolve(i);
        i.onerror = reject;
        i.src = dataUrl;
      });

      let { width, height } = img;
      const origW = width, origH = height;
      const ratio = Math.min(1, maxW / width, maxH / height);

      if (ratio < 1) {
        width = Math.round(width * ratio);
        height = Math.round(height * ratio);
      }

      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);

      const outType = format === "auto" ? (file.type || "image/jpeg") : format;
      const blob = await new Promise(resolve => canvas.toBlob(resolve, outType, quality));
      if (!blob) throw new Error("å‹ç¼©å¤±è´¥");

      const ext = outType === "image/png" ? ".png" : outType === "image/webp" ? ".webp" : ".jpg";
      const outputName = file.name.replace(/\.[^.]+$/, "") + ext;

      results[file.name] = {
        blob,
        size: blob.size,
        w: width,
        h: height,
        origW,
        origH,
        outputName
      };
    }

    // å‹ç¼©æ‰€æœ‰
    async function compressAll() {
      if (!files.length) {
        showStatus("è¯·å…ˆé€‰æ‹©å›¾ç‰‡", "error");
        return;
      }

      btnCompress.disabled = true;
      showStatus('<span class="loading"></span> å‹ç¼©ä¸­...', "info");
      results = {};

      try {
        for (const f of files) {
          await compressOne(f);
        }
        showStatus(`âœ“ å‹ç¼©å®Œæˆï¼Œå…± ${files.length} ä¸ªæ–‡ä»¶`, "success");
        renderTable();
      } catch (e) {
        console.error(e);
        showStatus(`âœ— å‹ç¼©å¤±è´¥: ${e.message}`, "error");
      } finally {
        btnCompress.disabled = false;
      }
    }

    // ä¸‹è½½å…¨éƒ¨
    async function downloadAll() {
      if (!Object.keys(results).length) {
        showStatus("å…ˆå‹ç¼©åå†ä¸‹è½½", "error");
        return;
      }

      btnDownloadAll.disabled = true;
      showStatus('<span class="loading"></span> æ‰“åŒ…ä¸­...', "info");

      try {
        const zip = new JSZip();
        Object.entries(results).forEach(([name, r]) => {
          zip.file(r.outputName, r.blob);
        });
        const blob = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "compressed-images.zip";
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        showStatus("âœ“ å·²ä¸‹è½½ ZIP æ–‡ä»¶", "success");
      } catch (e) {
        showStatus("âœ— ä¸‹è½½å¤±è´¥", "error");
      } finally {
        btnDownloadAll.disabled = false;
      }
    }

    // æ¸…ç©º
    function clearAll() {
      files = [];
      results = {};
      fileInput.value = "";
      statusEl.innerHTML = "";
      renderTable();
    }

    // äº‹ä»¶ç›‘å¬ï¼šæ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener("change", (e) => {
      files = Array.from(e.target.files || []);
      renderTable();
      if (files.length) {
        showStatus(`å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶`, "info");
      }
    });

    // æ‹–æ‹½åŒºäº‹ä»¶
    dropzone.addEventListener("click", () => fileInput.click());

    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("active");
    });

    dropzone.addEventListener("dragleave", () => {
      dropzone.classList.remove("active");
    });

    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("active");
      const dropped = Array.from(e.dataTransfer.files || []).filter(f => f.type.startsWith("image/"));
      if (dropped.length) {
        files = files.concat(dropped);
        renderTable();
        showStatus(`å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶`, "info");
      }
    });

    // æŒ‰é’®äº‹ä»¶
    btnCompress.addEventListener("click", compressAll);
    btnDownloadAll.addEventListener("click", downloadAll);
    btnClear.addEventListener("click", clearAll);
  </script>

  <script>
    const DEFAULT_PASSWORD = 'dcone2025';
    const authScreen = document.getElementById('auth-screen');
    const appRoot = document.getElementById('app');
    const input = document.getElementById('auth-code');
    const btn = document.getElementById('auth-btn');
    const errElAuth = document.getElementById('auth-error');
    const cardEl = document.getElementById('auth-card');

    function shakeCard() {
      cardEl.classList.remove('shake');
      void cardEl.offsetWidth;
      cardEl.classList.add('shake');
    }

    function handleAuth() {
      const code = (input.value || '').trim();
      if (!code) {
        errElAuth.textContent = 'è¯·è¾“å…¥å¯†ç ã€‚';
        shakeCard();
        return;
      }
      if (code !== DEFAULT_PASSWORD) {
        errElAuth.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚';
        shakeCard();
        return;
      }
      authScreen.style.display = 'none';
      appRoot.style.display = 'block !important';
    }

    btn.addEventListener('click', handleAuth);
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') handleAuth();
    });

    window.addEventListener('load', function() {
      setTimeout(() => input.focus(), 80);
    });
  </script>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é¡µé¢è®¿é—®æ•°æ®åˆ†æ Dashboard</title>
  <link rel="stylesheet" href="ui.css" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

  <style>
    #app {
      display: none;
    }

    .chart {
      width: 100%;
      height: 320px;
    }

    /* Custom Metric Card Style */
    .metric-card {
      padding: 16px;
      border-radius: 16px;
      background: #FFFFFF;
      border: 1px solid #E0E3E7;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: all 0.2s;
    }

    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .metric-label {
      font-size: 13px;
      color: var(--color-text-secondary);
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--color-text);
    }

    .metric-desc {
      font-size: 12px;
      color: var(--color-text-tertiary);
      margin-top: 4px;
    }

    .preview-box {
      max-height: 400px;
      overflow: auto;
      border: 1px solid #E0E3E7;
      border-radius: 12px;
      padding: 12px;
      background: #F8FAFC;
      font-size: 12px;
      font-family: monospace;
    }

    .debug-box {
      padding: 12px;
      background: #ECF9FF;
      border: 1px solid #CFFAFE;
      color: #006064;
      border-radius: 12px;
      font-size: 12px;
      margin-bottom: 24px;
    }
  </style>
</head>

<body>
  <!-- æˆæƒå±‚ -->
  <div id="auth-screen">
    <div class="auth-card fade-in" id="auth-card">
      <h2 class="text-center">ğŸ” å‹ç›Ÿå¤šè¡¨æµé‡å·¥å…·</h2>
      <p class="text-center text-muted">è¯·è¾“å…¥å¯†ç è®¿é—®æœ¬å·¥å…·</p>

      <div class="form-group">
        <label class="form-label">å¯†ç </label>
        <input id="auth-code" class="input" type="password" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="off" />
      </div>

      <button class="btn btn-primary w-full" id="auth-btn">ç¡®è®¤è¿›å…¥</button>
      <div class="auth-error text-center" id="auth-error"></div>
    </div>
  </div>

  <!-- çœŸæ­£çš„åº”ç”¨ -->
  <div id="app" class="fade-in">
    <div id="nav-container"></div>

    <div class="container">

      <div style="margin-bottom: 24px;">
        <div class="debug-box">
          <div><strong>ğŸ” åŒ¹é…è§„åˆ™è‡ªæ£€ï¼š</strong> <span id="selfTest"></span></div>
        </div>

        <!-- çŠ¶æ€æç¤ºï¼ˆJSç”¨äºæ˜¾ç¤ºè§£æè¿›åº¦ï¼‰ -->
        <div id="status" style="margin-top: 12px; font-size: 13px;"></div>
        <div id="summary" style="font-size: 12px; color: var(--color-text-tertiary); margin-top: 4px;"></div>


      </div>

      <!-- ä¸€ã€æ•´ä½“æ¦‚å†µ -->
      <div class="section" id="section-overview" style="display:none; margin-bottom: 32px;">
        <h2 style="margin-bottom: 16px;">ä¸€ã€æ•´ä½“è®¿é—®æ¦‚å†µ</h2>
        <div class="grid grid-2" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
          <div class="metric-card">
            <div class="metric-label">æ€»æµè§ˆæ¬¡æ•°ï¼ˆPVï¼‰</div>
            <div class="metric-value" id="pvTotal">-</div>
            <div class="metric-desc">æ‰€æœ‰é¡µé¢æµè§ˆæ¬¡æ•°ä¹‹å’Œ</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">æ€»ç‹¬ç«‹è®¿å®¢ï¼ˆUVï¼‰</div>
            <div class="metric-value" id="uvTotal">-</div>
            <div class="metric-desc">ç‹¬ç«‹è®¿å®¢æ€»é‡</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">å¹³å‡åœç•™æ—¶é—´</div>
            <div class="metric-value" id="avgDuration">-</div>
            <div class="metric-desc">å¹³å‡å•æ¬¡è®¿é—®åœç•™</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">å¹³å‡æµè§ˆé¡µæ•°</div>
            <div class="metric-value" id="avgPagesPerVisit">-</div>
            <div class="metric-desc">äººå‡æµè§ˆé¡µæ•°</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">è®°å½•æ¡æ•°</div>
            <div class="metric-value" id="rowCount">-</div>
            <div class="metric-desc">åˆå¹¶åçš„åŸå§‹è¡Œæ•°</div>
          </div>
        </div>
      </div>

      <!-- äºŒã€ç±»å‹åˆ†å¸ƒ -->
      <div class="section" id="section-type" style="display:none; margin-bottom: 32px;">
        <h2 style="margin-bottom: 16px;">äºŒã€æŒ‰é¡µé¢ç±»å‹åˆ†å¸ƒ</h2>
        <div class="card">
          <h3 style="margin-bottom: 16px;">é¡µé¢ç±»å‹ PV / UV åˆ†å¸ƒ</h3>
          <div id="typeChart" class="chart"></div>
          <div style="margin-top: 24px; overflow-x: auto;">
            <div id="typeTable"></div>
          </div>
        </div>
      </div>

      <!-- ä¸‰ã€TOP æ¦œ -->
      <div class="section" id="section-top" style="display:none; margin-bottom: 32px;">
        <h2 style="margin-bottom: 16px;">ä¸‰ã€çƒ­é—¨é¡µé¢ Top æ¦œ</h2>

        <div class="card" style="margin-bottom: 24px;">
          <div class="flex justify-between items-center mb-4" style="margin-bottom: 16px;">
            <h3>çƒ­é—¨é¡µé¢ TOP 20ï¼ˆæŒ‰ PVï¼‰</h3>
            <div class="flex gap-2">
              <button class="btn btn-secondary" id="btnExportTopPV"
                style="font-size: 12px; padding: 6px 12px;">å¯¼å‡º TOP500</button>
              <button class="btn btn-secondary" id="btnExportAllAgg"
                style="font-size: 12px; padding: 6px 12px;">å¯¼å‡ºå…¨éƒ¨æ•°æ®</button>
            </div>
          </div>
          <div id="topPvTable" style="overflow-x: auto;"></div>
        </div>

        <div class="card">
          <div class="flex justify-between items-center mb-4" style="margin-bottom: 16px;">
            <h3>é«˜ç²˜æ€§é¡µé¢ TOP 20ï¼ˆæŒ‰åœç•™æ—¶é—´ï¼‰</h3>
            <button class="btn btn-secondary" id="btnExportTopDur"
              style="font-size: 12px; padding: 6px 12px;">å¯¼å‡º TOP500</button>
          </div>
          <div id="topDurationTable" style="overflow-x: auto;"></div>
        </div>
      </div>

      <!-- å››ã€æŒ‰ Sheet å¯¹æ¯” -->
      <div class="section" id="section-sheet" style="display:none; margin-bottom: 32px;">
        <h2 style="margin-bottom: 16px;">å››ã€æŒ‰ Sheetï¼ˆå­£åº¦ï¼‰å¯¹æ¯”</h2>
        <div class="card">
          <h3 style="margin-bottom: 16px;">å„ Sheet è®¿é—®è¡¨ç°</h3>
          <div id="sheetTable" style="margin-bottom: 24px; overflow-x: auto;"></div>
          <div id="sheetChart" class="chart"></div>
        </div>
      </div>

      <!-- äº”ã€é¢„è§ˆ & è°ƒè¯• -->
      <div class="section" id="section-preview" style="display:none; margin-bottom: 64px;">
        <h2 style="margin-bottom: 16px;">äº”ã€è§£ææ•°æ®é¢„è§ˆ <span
            style="font-size: 14px; opacity: 0.6; font-weight: normal;">ï¼ˆè°ƒè¯•ç”¨ï¼‰</span></h2>

        <div class="card" style="margin-bottom: 24px;">
          <h3 style="margin-bottom: 12px;">å‰ 50 è¡Œé¢„è§ˆ</h3>
          <div class="preview-box">
            <div id="preview"></div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-bottom: 12px;">URL ç±»å‹è°ƒè¯•</h3>
          <div id="urlTypeDebug" style="font-size: 12px;"></div>
        </div>
      </div>

    </div>


    <script>
      /** å±•ç¤º/å¯¼å‡ºæ•°é‡ */
      const DISPLAY_TOP_N = 20;   // é¡µé¢å±•ç¤º
      const EXPORT_TOP_N = 500;  // å¯¼å‡º TOP500

      // ----------- å·¥å…·å‡½æ•° -----------
      function num(v) {
        if (v === null || v === undefined || v === "") return 0;
        const n = Number(String(v).replace(/,/g, ""));
        return isNaN(n) ? 0 : n;
      }

      // å¼ºåˆ¶ä»ä»»ä½•å•å…ƒæ ¼å½¢æ€é‡Œæå– URL
      function normalizeUrl(val) {
        if (val == null) return "";

        const cleanUrl = (u) => (u || "")
          .replace(/[\u200B-\u200D\uFEFF]/g, "") // é›¶å®½å­—ç¬¦
          .trim()
          .replace(/[#?].*$/, "");              // å» query/hash

        if (typeof val === "string") {
          const m = val.match(/https?:\/\/[^\s"']+/i);
          return cleanUrl(m ? m[0] : val);
        }

        if (typeof val === "object") {
          const candidates = [];
          const keys = ["Target", "target", "Hyperlink", "hyperlink", "text", "Text", "url", "URL", "h", "t", "v", "w"];
          for (const k of keys) {
            if (val[k]) candidates.push(String(val[k]));
          }
          if (val.l && (val.l.Target || val.l.target)) candidates.push(String(val.l.Target || val.l.target));
          try { candidates.push(JSON.stringify(val)); } catch (e) { candidates.push(String(val)); }

          for (const c of candidates) {
            const m = String(c).match(/https?:\/\/[^\s"']+/i);
            if (m) return cleanUrl(m[0]);
          }
          return cleanUrl(candidates[0] || "");
        }

        return cleanUrl(String(val));
      }

      // å»æ‰è¡¨å¤´ç©ºæ ¼ä¾¿äºåŒ¹é…
      function normalizeRowsKey(rows) {
        return rows.map(r => {
          const o = {};
          Object.keys(r).forEach(k => {
            const nk = String(k).replace(/\s+/g, "").trim();
            o[nk] = r[k];
          });
          return o;
        });
      }

      // åœç•™æ—¶é—´ç»Ÿä¸€è½¬ç§’ï¼ˆå…¼å®¹ï¼šxxç§’ / xåˆ†yç§’ / 00:01:23 / 83sï¼‰
      function parseDuration(str) {
        if (!str) return 0;
        str = String(str).trim();
        if (!str) return 0;

        if (/^\d{1,2}:\d{2}:\d{2}$/.test(str)) {
          const [h, m, s] = str.split(":").map(x => parseInt(x, 10) || 0);
          return h * 3600 + m * 60 + s;
        }
        if (/^\d{1,2}:\d{2}$/.test(str)) {
          const [m, s] = str.split(":").map(x => parseInt(x, 10) || 0);
          return m * 60 + s;
        }
        if (/^\d+(\.\d+)?\s*[sS]$/.test(str)) {
          return parseFloat(str) || 0;
        }
        if (str.endsWith("ç§’")) return parseFloat(str) || 0;
        if (str.includes("åˆ†")) {
          const [m, s] = str.split("åˆ†");
          return (parseFloat(m) || 0) * 60 + (parseFloat(String(s).replace("ç§’", "")) || 0);
        }
        return 0;
      }

      // é¡µé¢ ID æå–
      function extractPageId(url) {
        const u = (url || "").toString().toLowerCase();
        if (!u) return "";
        let m;
        m = u.match(/postdetail\/(\d+)/); if (m) return m[1];
        m = u.match(/post\/(\d+)/); if (m) return m[1];
        m = u.match(/news\/(\d+)/); if (m) return m[1];
        m = u.match(/specialactivity\/(\d+)/); if (m) return m[1];
        m = u.match(/product\/(\d+)/); if (m) return m[1];
        m = u.match(/video\/(\d+)/); if (m) return m[1];
        return "";
      }

      /** âœ… ä½ æœ€æ–°çš„ç»†åŒ–è§„åˆ™ï¼šå®Œæ•´ detectPageTypeï¼ˆæœ€ç»ˆç‰ˆï¼‰ */
      function detectPageType(url) {
        const u = (url || "").toString().toLowerCase();
        if (!u) return "å…¶ä»–";

        // åŠå¯¼çºµæ¨ªé¦–é¡µï¼ˆæ ¹åŸŸåé¦–é¡µï¼šä¸å¸¦è·¯å¾„ï¼‰
        // https://www.icviews.cn/
        if (/^https?:\/\/(www\.)?icviews\.cn\/?$/.test(u)) return "åŠå¯¼çºµæ¨ª-é¦–é¡µ";

        // ---------------- åŠå¯¼åœˆï¼ˆsemiCommunityï¼‰ç»†åˆ†è§„åˆ™ ----------------
        // åŠå¯¼åœˆé¦–é¡µ
        if (u.includes("/semicommunity/latest")) return "åŠå¯¼åœˆ-é¦–é¡µ";

        // åŠå¯¼åœˆåˆ›ä½œå‘å¸ƒé¡µ
        if (u.includes("/semicommunity/writepost")) return "åŠå¯¼åœˆ-åˆ›ä½œå‘å¸ƒé¡µ";

        // åŠå¯¼åœˆä¸“æ é›†åˆé¡µ
        if (u.includes("/semicommunity/column")) return "åŠå¯¼åœˆ-ä¸“æ é›†åˆé¡µ";

        // åŠå¯¼åœˆä¸“æ å†…å®¹é¡µï¼ˆå¸¦ IDï¼‰
        if (/\/semicommunity\/postdetail\/\d+/.test(u)) return "åŠå¯¼åœˆ-ä¸“æ å†…å®¹é¡µ";

        // åŠå¯¼åœˆå…¶ä»–é¡µé¢ï¼ˆå…œåº•ï¼‰
        if (u.includes("/semicommunity/")) return "åŠå¯¼åœˆ-å…¶ä»–";

        // ---------------- èµ„è®¯ï¼ˆnewsï¼‰ç»†åˆ†è§„åˆ™ ----------------
        // äº§ä¸šæ”¿ç­–
        if (u.includes("/news/industpolicy")) return "äº§ä¸šæ”¿ç­–";

        // äº§ç ”å‰çº¿
        if (u.includes("/news/prodfront")) return "äº§ç ”å‰çº¿";

        // äº§ä¸šåŠ¨æ€ï¼ˆå…¼å®¹ industDynamic / industryDynamicï¼‰
        if (u.includes("/news/industrydynamic") || u.includes("/news/industdynamic")) return "äº§ä¸šåŠ¨æ€";

        // èµ„è®¯æ¨èé¡µ
        if (u.includes("/news/recommend")) return "èµ„è®¯æ¨èé¡µ";

        // èµ„è®¯æ± æ–‡ç« ï¼ˆæ•°å­— IDï¼‰
        if (u.includes("/news/") && /\/news\/\d+/.test(u)) return "èµ„è®¯æ± æ–‡ç« ";

        // ---------------- ä¼šè®® / æ´»åŠ¨ ----------------
        if (u.includes("conference.icviews.cn") || u.includes("/conference/")) return "ä¼šè®®æ´»åŠ¨";
        if (u.includes("/specialactivity/")) return "æ´»åŠ¨é¡µé¢";

        // ---------------- äº§å“ / è§†é¢‘ / ä½œè€… ----------------
        if (u.includes("/products")) return "äº§å“æ±‡";
        if (u.includes("/product/")) return "äº§å“æ±‡";
        if (u.includes("/video/")) return "è§†é¢‘å†…å®¹";
        if (u.includes("/usercenter/")) return "ä½œè€…ä¸»é¡µ";

        // ---------------- ç«™å†…å…œåº• ----------------
        if (u.includes("icviews.cn")) return "ç«™å†…å…¶ä»–";
        return "å…¶ä»–";
      }

      // CSV å¯¼å‡º
      function downloadCsv(filename, rows) {
        if (!rows || !rows.length) {
          alert("æ— æ•°æ®å¯å¯¼å‡º");
          return;
        }
        const cols = Object.keys(rows[0]);
        const esc = (v) => {
          const s = (v === null || v === undefined) ? "" : String(v);
          const needs = /[,"\n\r]/.test(s);
          const t = s.replace(/"/g, '""');
          return needs ? `"${t}"` : t;
        };
        const csv = [cols.join(",")]
          .concat(rows.map(r => cols.map(c => esc(r[c])).join(",")))
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // æŒ‰ URL è·¨ Sheet èšåˆï¼ˆç”¨äº TOP å±•ç¤º & å¯¼å‡ºï¼‰
      function aggregateByUrl(data) {
        const m = new Map();

        data.forEach(r => {
          const url = (r.é¡µé¢URL || "").trim();
          if (!url) return;

          if (!m.has(url)) {
            m.set(url, {
              é¡µé¢URL: url,
              é¡µé¢ç±»å‹: r.é¡µé¢ç±»å‹ || detectPageType(url),
              é¡µé¢ID: r.é¡µé¢ID || extractPageId(url),

              PV: 0,
              UV: 0,
              IP: 0,
              è¾“å‡ºPV: 0,

              äººå‡æµè§ˆé¡µæ•°_sum: 0,
              äººå‡æµè§ˆé¡µæ•°_cnt: 0,

              åœç•™ç§’_sum: 0,
              åœç•™ç§’_cnt: 0,

              è¦†ç›–Sheet_set: new Set()
            });
          }

          const a = m.get(url);
          a.PV += num(r.æµè§ˆæ¬¡æ•°);
          a.UV += num(r.ç‹¬ç«‹è®¿å®¢);
          a.IP += num(r.IP);
          a.è¾“å‡ºPV += num(r.è¾“å‡ºPV);

          const p = num(r.äººå‡æµè§ˆé¡µæ•°);
          if (p > 0) {
            a.äººå‡æµè§ˆé¡µæ•°_sum += p;
            a.äººå‡æµè§ˆé¡µæ•°_cnt += 1;
          }

          const d = num(r.åœç•™æ—¶é—´_ç§’);
          if (d > 0) {
            a.åœç•™ç§’_sum += d;
            a.åœç•™ç§’_cnt += 1;
          }

          if (r.æ¥æºSheet) a.è¦†ç›–Sheet_set.add(r.æ¥æºSheet);
        });

        return Array.from(m.values()).map(a => ({
          é¡µé¢URL: a.é¡µé¢URL,
          é¡µé¢ç±»å‹: a.é¡µé¢ç±»å‹,
          é¡µé¢ID: a.é¡µé¢ID,

          PV: a.PV,
          UV: a.UV,
          IP: a.IP,
          è¾“å‡ºPV: a.è¾“å‡ºPV,

          å¹³å‡åœç•™ç§’: a.åœç•™ç§’_cnt ? (a.åœç•™ç§’_sum / a.åœç•™ç§’_cnt) : 0,
          å¹³å‡äººå‡æµè§ˆé¡µæ•°: a.äººå‡æµè§ˆé¡µæ•°_cnt ? (a.äººå‡æµè§ˆé¡µæ•°_sum / a.äººå‡æµè§ˆé¡µæ•°_cnt) : 0,

          è¦†ç›–Sheetæ•°: a.è¦†ç›–Sheet_set.size,
          è¦†ç›–Sheet: Array.from(a.è¦†ç›–Sheet_set).join("ã€")
        }));
      }

      // é¢„è§ˆè¡¨ï¼ˆå‰ 50 è¡Œï¼‰
      function renderPreview(data) {
        const el = document.getElementById("preview");
        if (!data.length) {
          el.innerHTML = "<div class='small'>æ— æ•°æ®å¯é¢„è§ˆ</div>";
          return;
        }
        const cols = Object.keys(data[0]);
        let html = "<table class='table'><thead><tr>";
        cols.forEach(c => html += `<th class="${c.includes("URL") ? "url" : ""}">${c}</th>`);
        html += "</tr></thead><tbody>";
        data.slice(0, 50).forEach(row => {
          html += "<tr>";
          cols.forEach(c => {
            const v = (row[c] ?? "");
            const cls = (c.includes("URL") ? "url" : "");
            html += `<td class="${cls}">${String(v).replace(/</g, "&lt;").replace(/>/g, "&gt;")}</td>`;
          });
          html += "</tr>";
        });
        html += "</tbody></table>";
        el.innerHTML = `<div class="table-wrap">${html}</div>`;
      }

      // URL + ç±»å‹è°ƒè¯•ï¼ˆå‰ 20 æ¡ï¼‰
      function renderUrlTypeDebug(data) {
        const el = document.getElementById("urlTypeDebug");
        if (!data.length) {
          el.innerHTML = "<div class='small'>æ— æ•°æ®</div>";
          return;
        }
        let html = "<table class='table'><thead><tr>"
          + "<th>#</th><th class='url'>é¡µé¢URL</th><th>é¡µé¢ç±»å‹</th><th>é¡µé¢ID</th>"
          + "</tr></thead><tbody>";
        data.slice(0, 20).forEach((r, i) => {
          html += "<tr>"
            + `<td>${i + 1}</td>`
            + `<td class="url"><a href="${r.é¡µé¢URL}" target="_blank" rel="noopener">${r.é¡µé¢URL}</a></td>`
            + `<td>${r.é¡µé¢ç±»å‹}</td>`
            + `<td>${r.é¡µé¢ID}</td>`
            + "</tr>";
        });
        html += "</tbody></table>";
        el.innerHTML = `<div class="table-wrap">${html}</div>`;
      }

      // ---------- å…¨å±€å˜é‡ ----------
      let mergedData = [];
      let perSheetData = {};
      let aggAll = [];
      let pvSorted = [];
      let durSorted = [];

      const statusEl = document.getElementById("status");
      const summaryEl = document.getElementById("summary");

      // è‡ªæ£€
      function runSelfTest() {
        const samples = [
          "https://www.icviews.cn/",
          "https://www.icviews.cn/semiCommunity/latest",
          "https://www.icviews.cn/semiCommunity/postDetail/5846",
          "https://www.icviews.cn/semiCommunity/column",
          "https://www.icviews.cn/semiCommunity/writePost",
          "https://www.icviews.cn/news/industPolicy",
          "https://www.icviews.cn/news/prodFront",
          "https://www.icviews.cn/news/industDynamic",
          "https://www.icviews.cn/news/recommend",
          "https://conference.icviews.cn/ADA"
        ];
        document.getElementById("selfTest").textContent =
          samples.map(u => `${u.replace(/[#?].*$/, "")} â†’ ${detectPageType(u)}`).join("  |  ");
      }
      runSelfTest();

      // æ–‡ä»¶ä¸Šä¼ 
      document.getElementById("fileInput").addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        mergedData = [];
        perSheetData = {};
        aggAll = [];
        pvSorted = [];
        durSorted = [];

        statusEl.textContent = "æ­£åœ¨è§£ææ–‡ä»¶â€¦";
        statusEl.className = "";
        summaryEl.textContent = "";

        ["section-overview", "section-type", "section-top", "section-sheet", "section-preview"]
          .forEach(id => document.getElementById(id).style.display = "none");

        const reader = new FileReader();
        reader.onload = function (evt) {
          try {
            const wb = XLSX.read(evt.target.result, { type: "binary" });
            let totalSheets = 0, totalRows = 0, skipped = [];

            wb.SheetNames.forEach(sheetName => {
              const sheet = wb.Sheets[sheetName];
              const raw = XLSX.utils.sheet_to_json(sheet, { defval: "", raw: true });
              const rows = normalizeRowsKey(raw);
              if (!rows.length) return;

              const cols = Object.keys(rows[0]);

              // â‘  ä¼˜å…ˆâ€œå—è®¿é¡µé¢â€/URL/é“¾æ¥å…³é”®è¯
              const urlColCandidates = cols.filter(c => {
                const ck = String(c).toLowerCase();
                return ck.includes("å—è®¿") || ck.includes("url") || ck.includes("é“¾æ¥");
              });

              // â‘¡ å†æ‰¾åŒ…å« http çš„åˆ—
              if (urlColCandidates.length === 0) {
                const colWithHttp = cols.find(c => rows.some(r => {
                  const v = normalizeUrl(r[c]);
                  return v && v.toLowerCase().startsWith("http");
                }));
                if (colWithHttp) urlColCandidates.push(colWithHttp);
              }

              if (urlColCandidates.length === 0) {
                skipped.push(sheetName);
                return;
              }

              const urlCol = urlColCandidates[0];

              totalSheets++;
              const parsed = rows.map(r => {
                const url = normalizeUrl(r[urlCol]);
                const durStr = r["å¹³å‡é¡µé¢åœç•™æ—¶é—´"] || r["å¹³å‡åœç•™æ—¶é—´"] || "";
                return {
                  æ¥æºSheet: sheetName,
                  é¡µé¢URL: url,
                  é¡µé¢ç±»å‹: detectPageType(url),
                  é¡µé¢ID: extractPageId(url),
                  æµè§ˆæ¬¡æ•°: num(r["æµè§ˆæ¬¡æ•°"]),
                  ç‹¬ç«‹è®¿å®¢: num(r["ç‹¬ç«‹è®¿å®¢"]),
                  IP: num(r["IP"] || r["ip"]),
                  äººå‡æµè§ˆé¡µæ•°: num(r["äººå‡æµè§ˆé¡µæ•°"]),
                  è¾“å‡ºPV: num(r["è¾“å‡ºPV"] || r["è¾“å‡ºPv"] || r["è¾“å‡ºpv"]),
                  å¹³å‡é¡µé¢åœç•™æ—¶é—´: durStr,
                  åœç•™æ—¶é—´_ç§’: parseDuration(durStr)
                };
              });

              perSheetData[sheetName] = parsed;
              mergedData.push(...parsed);
              totalRows += parsed.length;
            });

            if (!mergedData.length) {
              statusEl.textContent = "è§£æå¤±è´¥ï¼šæœªæ‰¾åˆ° URL åˆ—";
              statusEl.className = "error";
              return;
            }

            statusEl.textContent = "è§£ææˆåŠŸ";
            statusEl.className = "ok";
            let msg = `å…±è§£æ ${totalSheets} ä¸ª Sheetï¼Œ${totalRows} è¡Œè®°å½•ã€‚`;
            if (skipped.length) {
              msg += ` è·³è¿‡æœªæ£€æµ‹åˆ° URL çš„ Sheetï¼š${skipped.join("ã€")}`;
            }
            summaryEl.textContent = msg;

            // èšåˆ + æ’åº
            aggAll = aggregateByUrl(mergedData);

            const totalPvAll = aggAll.reduce((s, r) => s + num(r.PV), 0) || 0;
            const totalUvAll = aggAll.reduce((s, r) => s + num(r.UV), 0) || 0;

            aggAll = aggAll.map(r => ({
              ...r,
              PVå æ¯”: totalPvAll ? (num(r.PV) / totalPvAll) : 0,
              UVå æ¯”: totalUvAll ? (num(r.UV) / totalUvAll) : 0
            }));

            pvSorted = aggAll.slice().sort((a, b) => num(b.PV) - num(a.PV));
            durSorted = aggAll.filter(r => num(r.å¹³å‡åœç•™ç§’) > 0)
              .slice()
              .sort((a, b) => num(b.å¹³å‡åœç•™ç§’) - num(a.å¹³å‡åœç•™ç§’));

            // æ¸²æŸ“
            renderOverview(mergedData);
            renderTypeAnalysis(mergedData);
            renderTopAnalysis();
            renderSheetComparison(perSheetData);
            renderPreview(mergedData);
            renderUrlTypeDebug(mergedData);

            ["section-overview", "section-type", "section-top", "section-sheet", "section-preview"]
              .forEach(id => document.getElementById(id).style.display = "block");

          } catch (e) {
            console.error(e);
            statusEl.textContent = "è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼";
            statusEl.className = "error";
          }
        };
        reader.readAsBinaryString(file);
      });

      // ---------- ä¸€ã€æ•´ä½“æ¦‚å†µ ----------
      function renderOverview(data) {
        const pv = data.reduce((s, r) => s + num(r.æµè§ˆæ¬¡æ•°), 0);
        const uv = data.reduce((s, r) => s + num(r.ç‹¬ç«‹è®¿å®¢), 0);

        const durSum = data.reduce((s, r) => s + num(r.åœç•™æ—¶é—´_ç§’), 0);
        const durCnt = data.filter(r => num(r.åœç•™æ—¶é—´_ç§’) > 0).length;
        const avgDur = durCnt ? durSum / durCnt : 0;

        const pagesArr = data.map(r => num(r.äººå‡æµè§ˆé¡µæ•°)).filter(v => v > 0);
        const avgPages = pagesArr.length ? pagesArr.reduce((a, b) => a + b) / pagesArr.length : 0;

        document.getElementById("pvTotal").textContent = pv.toLocaleString();
        document.getElementById("uvTotal").textContent = uv.toLocaleString();
        document.getElementById("rowCount").textContent = data.length;
        document.getElementById("avgDuration").textContent = avgDur.toFixed(2) + " ç§’";
        document.getElementById("avgPagesPerVisit").textContent = avgPages.toFixed(2);
      }

      // ---------- äºŒã€ç±»å‹åˆ†æ ----------
      function renderTypeAnalysis(data) {
        const agg = {};
        data.forEach(r => {
          const t = r.é¡µé¢ç±»å‹ || "å…¶ä»–";
          if (!agg[t]) agg[t] = { pv: 0, uv: 0, count: 0, durSum: 0, durCnt: 0 };
          agg[t].pv += num(r.æµè§ˆæ¬¡æ•°);
          agg[t].uv += num(r.ç‹¬ç«‹è®¿å®¢);
          agg[t].count++;
          if (num(r.åœç•™æ—¶é—´_ç§’) > 0) {
            agg[t].durSum += num(r.åœç•™æ—¶é—´_ç§’);
            agg[t].durCnt++;
          }
        });

        const types = Object.keys(agg);
        const pvArr = types.map(t => agg[t].pv);
        const uvArr = types.map(t => agg[t].uv);

        Plotly.newPlot("typeChart", [
          { x: types, y: pvArr, name: "PV", type: "bar" },
          { x: types, y: uvArr, name: "UV", type: "bar" }
        ], {
          barmode: "group",
          margin: { t: 10, r: 10, b: 70, l: 55 },
          legend: { orientation: "h", y: -0.2 }
        });

        let html = "<table class='table'><thead><tr><th>é¡µé¢ç±»å‹</th><th>PV</th><th>UV</th><th>è®°å½•æ•°</th><th>å¹³å‡åœç•™ç§’</th></tr></thead><tbody>";
        types.forEach(t => {
          const a = agg[t];
          const avgDur = a.durCnt ? (a.durSum / a.durCnt).toFixed(2) : "-";
          html += `<tr>
      <td>${t}</td>
      <td>${a.pv.toLocaleString()}</td>
      <td>${a.uv.toLocaleString()}</td>
      <td>${a.count}</td>
      <td>${avgDur}</td>
    </tr>`;
        });
        html += "</tbody></table>";
        document.getElementById("typeTable").innerHTML = `<div class="table-wrap">${html}</div>`;
      }

      // ---------- ä¸‰ã€TOPï¼ˆå±•ç¤º TOP20ï¼Œå¯¼å‡º TOP500ï¼‰ ----------
      function renderTopAnalysis() {
        const topPvShow = pvSorted.slice(0, DISPLAY_TOP_N);
        const topDurShow = durSorted.slice(0, DISPLAY_TOP_N);

        // TOP PV
        let htmlPv = "<table class='table'><thead><tr>"
          + "<th>#</th><th>ç±»å‹</th><th>ID</th><th class='url'>URL</th>"
          + "<th>PV</th><th>UV</th><th>IP</th><th>è¾“å‡ºPV</th>"
          + "<th>å¹³å‡åœç•™ç§’</th><th>å¹³å‡äººå‡æµè§ˆ</th><th>è¦†ç›–Sheetæ•°</th><th>PVå æ¯”</th><th>UVå æ¯”</th>"
          + "</tr></thead><tbody>";

        topPvShow.forEach((r, i) => {
          htmlPv += "<tr>"
            + `<td>${i + 1}</td>`
            + `<td>${r.é¡µé¢ç±»å‹}</td>`
            + `<td>${r.é¡µé¢ID}</td>`
            + `<td class="url"><a href="${r.é¡µé¢URL}" target="_blank" rel="noopener">${r.é¡µé¢URL}</a></td>`
            + `<td>${num(r.PV).toLocaleString()}</td>`
            + `<td>${num(r.UV).toLocaleString()}</td>`
            + `<td>${num(r.IP).toLocaleString()}</td>`
            + `<td>${num(r.è¾“å‡ºPV).toLocaleString()}</td>`
            + `<td>${num(r.å¹³å‡åœç•™ç§’).toFixed(2)}</td>`
            + `<td>${num(r.å¹³å‡äººå‡æµè§ˆé¡µæ•°).toFixed(2)}</td>`
            + `<td>${r.è¦†ç›–Sheetæ•°}</td>`
            + `<td>${(num(r.PVå æ¯”) * 100).toFixed(2)}%</td>`
            + `<td>${(num(r.UVå æ¯”) * 100).toFixed(2)}%</td>`
            + "</tr>";
        });
        htmlPv += "</tbody></table>";
        document.getElementById("topPvTable").innerHTML = `<div class="table-wrap">${htmlPv}</div>`;

        // TOP åœç•™
        let htmlDur = "<table class='table'><thead><tr>"
          + "<th>#</th><th>ç±»å‹</th><th>ID</th><th class='url'>URL</th>"
          + "<th>å¹³å‡åœç•™ç§’</th><th>PV</th><th>UV</th><th>IP</th><th>è¾“å‡ºPV</th>"
          + "<th>å¹³å‡äººå‡æµè§ˆ</th><th>è¦†ç›–Sheetæ•°</th>"
          + "</tr></thead><tbody>";

        topDurShow.forEach((r, i) => {
          htmlDur += "<tr>"
            + `<td>${i + 1}</td>`
            + `<td>${r.é¡µé¢ç±»å‹}</td>`
            + `<td>${r.é¡µé¢ID}</td>`
            + `<td class="url"><a href="${r.é¡µé¢URL}" target="_blank" rel="noopener">${r.é¡µé¢URL}</a></td>`
            + `<td>${num(r.å¹³å‡åœç•™ç§’).toFixed(2)}</td>`
            + `<td>${num(r.PV).toLocaleString()}</td>`
            + `<td>${num(r.UV).toLocaleString()}</td>`
            + `<td>${num(r.IP).toLocaleString()}</td>`
            + `<td>${num(r.è¾“å‡ºPV).toLocaleString()}</td>`
            + `<td>${num(r.å¹³å‡äººå‡æµè§ˆé¡µæ•°).toFixed(2)}</td>`
            + `<td>${r.è¦†ç›–Sheetæ•°}</td>`
            + "</tr>";
        });
        htmlDur += "</tbody></table>";
        document.getElementById("topDurationTable").innerHTML = `<div class="table-wrap">${htmlDur}</div>`;

        // å¯¼å‡ºï¼šTOP500 PV
        document.getElementById("btnExportTopPV").onclick = () => {
          const rows = pvSorted.slice(0, EXPORT_TOP_N).map((r, idx) => ({
            æ’å: idx + 1,
            é¡µé¢ç±»å‹: r.é¡µé¢ç±»å‹,
            é¡µé¢ID: r.é¡µé¢ID,
            é¡µé¢URL: r.é¡µé¢URL,
            PV: r.PV,
            UV: r.UV,
            IP: r.IP,
            è¾“å‡ºPV: r.è¾“å‡ºPV,
            å¹³å‡åœç•™ç§’: Number(num(r.å¹³å‡åœç•™ç§’).toFixed(2)),
            å¹³å‡äººå‡æµè§ˆé¡µæ•°: Number(num(r.å¹³å‡äººå‡æµè§ˆé¡µæ•°).toFixed(2)),
            è¦†ç›–Sheetæ•°: r.è¦†ç›–Sheetæ•°,
            è¦†ç›–Sheet: r.è¦†ç›–Sheet,
            PVå æ¯”ç™¾åˆ†æ¯”: Number((num(r.PVå æ¯”) * 100).toFixed(4)),
            UVå æ¯”ç™¾åˆ†æ¯”: Number((num(r.UVå æ¯”) * 100).toFixed(4))
          }));
          downloadCsv(`TOP${EXPORT_TOP_N}-PV.csv`, rows);
        };

        // å¯¼å‡ºï¼šTOP500 åœç•™
        document.getElementById("btnExportTopDur").onclick = () => {
          const rows = durSorted.slice(0, EXPORT_TOP_N).map((r, idx) => ({
            æ’å: idx + 1,
            é¡µé¢ç±»å‹: r.é¡µé¢ç±»å‹,
            é¡µé¢ID: r.é¡µé¢ID,
            é¡µé¢URL: r.é¡µé¢URL,
            å¹³å‡åœç•™ç§’: Number(num(r.å¹³å‡åœç•™ç§’).toFixed(2)),
            PV: r.PV,
            UV: r.UV,
            IP: r.IP,
            è¾“å‡ºPV: r.è¾“å‡ºPV,
            å¹³å‡äººå‡æµè§ˆé¡µæ•°: Number(num(r.å¹³å‡äººå‡æµè§ˆé¡µæ•°).toFixed(2)),
            è¦†ç›–Sheetæ•°: r.è¦†ç›–Sheetæ•°,
            è¦†ç›–Sheet: r.è¦†ç›–Sheet
          }));
          downloadCsv(`TOP${EXPORT_TOP_N}-åœç•™.csv`, rows);
        };

        // å¯¼å‡ºï¼šå…¨é‡èšåˆï¼ˆPVæ’åºï¼‰
        document.getElementById("btnExportAllAgg").onclick = () => {
          const rows = pvSorted.map((r, idx) => ({
            PVæ’å: idx + 1,
            é¡µé¢ç±»å‹: r.é¡µé¢ç±»å‹,
            é¡µé¢ID: r.é¡µé¢ID,
            é¡µé¢URL: r.é¡µé¢URL,
            PV: r.PV,
            UV: r.UV,
            IP: r.IP,
            è¾“å‡ºPV: r.è¾“å‡ºPV,
            å¹³å‡åœç•™ç§’: Number(num(r.å¹³å‡åœç•™ç§’).toFixed(2)),
            å¹³å‡äººå‡æµè§ˆé¡µæ•°: Number(num(r.å¹³å‡äººå‡æµè§ˆé¡µæ•°).toFixed(2)),
            è¦†ç›–Sheetæ•°: r.è¦†ç›–Sheetæ•°,
            è¦†ç›–Sheet: r.è¦†ç›–Sheet,
            PVå æ¯”ç™¾åˆ†æ¯”: Number((num(r.PVå æ¯”) * 100).toFixed(4)),
            UVå æ¯”ç™¾åˆ†æ¯”: Number((num(r.UVå æ¯”) * 100).toFixed(4))
          }));
          downloadCsv(`å…¨éƒ¨èšåˆæ’è¡Œ-PVæ’åº.csv`, rows);
        };
      }

      // ---------- å››ã€æŒ‰ Sheet å¯¹æ¯” ----------
      function renderSheetComparison(map) {
        const rows = [];
        for (const sheet in map) {
          const list = map[sheet];
          const pv = list.reduce((s, r) => s + num(r.æµè§ˆæ¬¡æ•°), 0);
          const uv = list.reduce((s, r) => s + num(r.ç‹¬ç«‹è®¿å®¢), 0);
          const durSum = list.reduce((s, r) => s + num(r.åœç•™æ—¶é—´_ç§’), 0);
          const durCnt = list.filter(r => num(r.åœç•™æ—¶é—´_ç§’) > 0).length;
          rows.push({
            sheet,
            pv,
            uv,
            dur: durCnt ? durSum / durCnt : 0,
            count: list.length
          });
        }

        let html = "<table class='table'><thead><tr><th>Sheet</th><th>è®°å½•æ•°</th><th>PV</th><th>UV</th><th>å¹³å‡åœç•™ç§’</th></tr></thead><tbody>";
        rows.forEach(r => {
          html += `<tr>
      <td>${r.sheet}</td>
      <td>${r.count}</td>
      <td>${r.pv.toLocaleString()}</td>
      <td>${r.uv.toLocaleString()}</td>
      <td>${r.dur.toFixed(2)}</td>
    </tr>`;
        });
        html += "</tbody></table>";
        document.getElementById("sheetTable").innerHTML = `<div class="table-wrap">${html}</div>`;

        Plotly.newPlot("sheetChart", [
          { x: rows.map(r => r.sheet), y: rows.map(r => r.pv), name: "PV", type: "bar" },
          { x: rows.map(r => r.sheet), y: rows.map(r => r.uv), name: "UV", type: "bar" }
        ], {
          barmode: "group",
          margin: { t: 10, r: 10, b: 60, l: 55 },
          legend: { orientation: "h", y: -0.2 }
        });
      }
    </script>

    <script src="js/utils.js"></script>
    <script src="js/nav.js"></script>
    <script src="js/auth.js"></script>
    <script>
      renderNav({
        title: 'å‹ç›Ÿå¤šè¡¨åˆ†æ',
        icon: 'ğŸ“„',
        showFileInput: true,
        fileAccept: '.xlsx,.xls',
        fileLabel: 'ğŸ“¤ é€‰æ‹© XLSX',
        onFileChange: (e) => {
          const file = e.target.files[0];
          if (file) handleFile({ target: { files: [file] } });
        }
      });
      initAuth('youmeng-traffic');
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ORC æ—¥å¿—è§£æå·¥å…· - ICviews Tools [è¿­ä»£2]</title>
    <link rel="stylesheet" href="gemini-ui.css" />
    <link rel="stylesheet" href="design-system-modern.css" />
    <link rel="stylesheet" href="tool-pages-interactions.css" />
    <!-- SheetJS for Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- JSZip for Multiple Files Export -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        body {
            background-color: var(--gem-color-bg-body);
            min-height: 100vh;
        }

        .main-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 24px;
        }

        .dropzone {
            border: 2px dashed #CBD5E1;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            background: #F8FAFC;
            transition: all 0.2s;
            cursor: pointer;
        }

        .dropzone:hover,
        .dropzone.active {
            border-color: var(--gem-color-accent);
            background: #EFF6FF;
        }

        .file-list {
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .file-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .status-badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 99px;
            background: #EEF2FF;
            color: #4F46E5;
        }

        .status-badge.success {
            background: #DCFCE7;
            color: #166534;
        }

        .status-badge.error {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* Console Output Style */
        #console-output {
            background: #1E293B;
            color: #E2E8F0;
            padding: 16px;
            border-radius: 12px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-top: 24px;
            display: none;
        }

        .log-line {
            margin-bottom: 4px;
            border-bottom: 1px solid #334155;
            padding-bottom: 2px;
        }

        .log-error {
            color: #F87171;
        }

        .log-success {
            color: #4ADE80;
        }
    </style>
</head>

<body>

    <!-- Access Control Overlay -->
    <div id="auth-screen"
        style="position:fixed;inset:0;background:rgba(255,255,255,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px);">
        <div class="gem-card" style="width:360px;padding:32px;">
            <h2 style="font-size:20px;margin-bottom:8px;">ğŸ” ORC æ—¥å¿—è§£æ</h2>
            <p style="font-size:13px;color:#64748B;margin-bottom:24px;">è¯·è¾“å…¥æˆæƒç è®¿é—®æœ¬å·¥å…·</p>
            <input type="text" id="auth-code" class="gem-input" placeholder="è¯·è¾“å…¥æˆæƒç " style="margin-bottom:16px;">
            <button id="auth-btn" class="gem-btn gem-btn-primary w-full">ç¡®è®¤è¿›å…¥</button>
            <div id="auth-error" style="color:#EF4444;font-size:12px;margin-top:12px;min-height:20px;"></div>
        </div>
    </div>

    <div id="app" style="display:none;">
        <nav class="gem-navbar">
            <a href="#" class="gem-navbar-brand">
                <span class="gem-navbar-icon">ğŸªµ</span>
                <span>ORC æ—¥å¿—è§£æ</span>
            </a>
            <div class="gem-navbar-actions">
                <!-- App Switcher -->
                <div class="gem-app-switcher">
                    <button class="gem-app-switcher-btn" title="åˆ‡æ¢å·¥å…·">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                            <path
                                d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z" />
                        </svg>
                    </button>
                    <div class="gem-app-switcher-menu">
                        <a href="content-dashboard.html" class="gem-app-item">
                            <span class="gem-app-icon">ğŸ“ˆ</span>
                            <span>å†…å®¹æ•°æ®</span>
                        </a>
                        <a href="bandao-ops-dashboard.html" class="gem-app-item">
                            <span class="gem-app-icon">ğŸ§­</span>
                            <span>ä¸“æ /å¸–å­</span>
                        </a>
                        <a href="page-traffic-dashboard.html" class="gem-app-item">
                            <span class="gem-app-icon">ğŸŒ</span>
                            <span>é¡µé¢æµé‡</span>
                        </a>
                        <a href="youmeng.html" class="gem-app-item">
                            <span class="gem-app-icon">ğŸ“„</span>
                            <span>å‹ç›Ÿå¤šè¡¨</span>
                        </a>
                        <a href="image-compress.html" class="gem-app-item">
                            <span class="gem-app-icon">ğŸ—œï¸</span>
                            <span>å›¾ç‰‡å‹ç¼©</span>
                        </a>
                        <a href="yiban-dashboard.html" class="gem-app-item">
                            <span class="gem-app-icon">ğŸ“Š</span>
                            <span>å£¹ä¼´æ•°æ®</span>
                        </a>
                        <a href="article-formatter.html" class="gem-app-item">
                            <span class="gem-app-icon">ğŸ“</span>
                            <span>æ–‡ç« æ’ç‰ˆ</span>
                        </a>
                        <a href="image-stitch.html" class="gem-app-item">
                            <span class="gem-app-icon">ğŸ–¼ï¸</span>
                            <span>é•¿å›¾æ‹¼æ¥</span>
                        </a>
                    </div>
                </div>

                <a href="index.html" class="gem-btn gem-btn-secondary" style="font-size:13px; margin-left: 12px;">ğŸ 
                    è¿”å›é¦–é¡µ</a>
            </div>
        </nav>

        <div class="main-container">
            <div style="text-align:center;margin-bottom:32px;">
                <h1>ORC æ—¥å¿—æ‰¹é‡è§£æ</h1>
                <p></p>
                <div class="gem-chip">âš ï¸ å®éªŒæ€§åŠŸèƒ½ (Powered by DuckDB-Wasm)</div>
            </div>

            <div class="gem-card">
                <div class="dropzone" id="dropzone">
                    <div style="font-size:48px;margin-bottom:16px;">ğŸ“‚</div>
                    <div style="font-size:16px;font-weight:600;color:#1E293B;margin-bottom:8px;">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  ORC æ–‡ä»¶</div>
                    <div style="font-size:13px;color:#64748B;">æ”¯æŒæ‰¹é‡ä¸Šä¼ ï¼Œå•ä¸ªæ–‡ä»¶å¤§å°å»ºè®®ä¸è¶…è¿‡ 100MB</div>
                    <input type="file" id="fileInput" multiple accept=".orc" style="display:none;">
                </div>

                <div id="processing-area" style="display:none; margin-top: 24px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px;">
                        <div>
                            <h3 style="margin:0;">æ±‡æ€»è¡¨</h3>
                            <p id="merged-summary" style="margin:4px 0 0 0;font-size:13px;color:#64748B;">å·²åŠ è½½ 0 ä¸ªæ–‡ä»¶ï¼Œå…± 0 è¡Œ</p>
                        </div>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <input type="text" id="merged-search-input" class="gem-input" placeholder="ğŸ” æœç´¢ç­›é€‰ï¼ˆå¤šåˆ—å†…å®¹ï¼‰" style="width:220px;height:36px;font-size:13px;padding:6px 12px;">
                            <button id="export-merged-btn" class="gem-btn gem-btn-primary" disabled>ğŸ“¥ å¯¼å‡ºæ±‡æ€»è¡¨ Excel</button>
                        </div>
                    </div>
                    <!-- å·²åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼ˆä»…å±•ç¤ºï¼‰ -->
                    <div id="loaded-files-list" style="font-size:12px;color:#64748B;margin-bottom:8px;"></div>
                    <!-- æ–‡ä»¶çŠ¶æ€ Tabï¼ˆç”¨äºæ˜¾ç¤ºå„æ–‡ä»¶è§£æçŠ¶æ€ï¼‰ -->
                    <div id="file-tabs-container" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;"></div>
                    <!-- å•è¡¨é¢„è§ˆåŒº -->
                    <div id="main-preview-area" style="min-height:200px;">
                        <div id="active-preview-container"></div>
                    </div>
                </div>

                <div id="console-output"></div>
            </div>
        </div>
    </div>

    <!-- Auth & UI Logic (Standard Script) -->
    <script>
        // --- Auth Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            initDropzone();
        });

        function initAuth() {
            const savedCode = localStorage.getItem('orc_auth_code');
            if (verifyCode(savedCode)) {
                showApp();
            }

            const btn = document.getElementById('auth-btn');
            if (btn) {
                btn.onclick = () => {
                    const code = document.getElementById('auth-code').value.trim();
                    if (verifyCode(code)) {
                        localStorage.setItem('orc_auth_code', code);
                        showApp();
                    } else {
                        document.getElementById('auth-error').textContent = 'æˆæƒç æ— æ•ˆ';
                    }
                };
            }
        }

        function verifyCode(code) {
            const validCodes = ['dcone2025', 'ORC-2025-A1B2', 'ORC-2025-C3D4'];
            return validCodes.includes(code);
        }

        function showApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';

            // Trigger DuckDB init if available
            if (window.initDuckDB) {
                window.initDuckDB();
            } else {
                // If module hasn't loaded yet, set a flag
                window.appReady = true;
            }
        }

        // --- è¡¨å¤´æ˜¾ç¤ºåç§°ï¼ˆæŒ‰åˆ—é¡ºåºï¼Œä¸ ORC åˆ—ä¸€ä¸€å¯¹åº”ï¼‰---
        const HEADER_NAMES = [
            'ç¼–å·', 'ç¼–ç ', 'æµè§ˆå™¨ç‰ˆæœ¬/æ“ä½œbiotin', 'IPæ®µ', 'è®¾å¤‡åˆ†æ ‡ç‡', 'è®¾å¤‡è¯­è¨€', 'è·³è½¬é“¾æ¥', 'æ¥æº', 'è®¿é—®é“¾æ¥', 'æŒ‡å‘åŸŸå',
            'å…¶ä»–ä¿¡æ¯', 'å…¶ä»–ä¿¡æ¯', 'çœä»½å›½å®¶', 'å¸‚', 'ç½‘ç»œæœåŠ¡å•†', 'ç³»ç»Ÿç‰ˆæœ¬', 'æ“ä½œç³»ç»Ÿ', 'æµè§ˆå™¨', 'æµè§ˆå™¨å†…æ ¸',
            'å…¶ä»–', 'å…¶ä»–', 'å…¶ä»–', 'å…¶ä»–', 'å…¶ä»–', 'å…¶ä»–', 'å…¶ä»–', 'å…¶ä»–', 'å…¶ä»–', 'å…¶ä»–', 'å…¶ä»–', 'é¡µé¢æ ‡é¢˜', 'å…¶ä»–', 'è®¾å¤‡æ‰€å±', 'å…¶ä»–'
        ];

        // --- UI Interactions ---
        window.processedFiles = {};
        window.mergedData = [];           // å¤šæ–‡ä»¶åˆå¹¶åçš„å…¨éƒ¨è¡Œ
        window.mergedFileNames = [];      // å·²åŠ è½½æ–‡ä»¶åï¼ˆä»…å±•ç¤ºï¼‰
        window.activeFileId = null;

        // Placeholder until module loadsï¼ˆä¸ module å†… handleFiles è¡Œä¸ºä¸€è‡´ï¼šæ±‡æ€»è¡¨ + äº‘ç«¯è§£æï¼‰
        if (!window.handleFiles) {
            window.handleFiles = (files) => {
                if (!files.length) return;
                window.mergedData = [];
                window.mergedFileNames = [];
                document.getElementById('processing-area').style.display = 'block';
                document.getElementById('console-output').style.display = 'block';
                document.getElementById('export-merged-btn').disabled = true;
                var container = document.getElementById('file-tabs-container');
                if (!container) return;
                container.innerHTML = '';
                Array.from(files).forEach((file, idx) => {
                    var fileId = 'f_' + Date.now() + '_' + idx;
                    window.mergedFileNames.push({ name: file.name, id: fileId, ok: false });
                    var btnTab = document.createElement('button');
                    btnTab.className = 'gem-btn gem-btn-secondary file-tab-btn';
                    btnTab.id = 'tab-' + fileId;
                    btnTab.style.cssText = 'white-space:nowrap; display:flex; align-items:center; gap:8px; padding:8px 16px; border:1px solid #E2E8F0; background:white; color:#64748B;';
                    btnTab.innerHTML = '<span>ğŸ“„ ' + file.name + '</span><div id="status-icon-' + fileId + '" style="font-size:10px;">â³</div>';
                    btnTab.onclick = () => window._switchFile(fileId);
                    container.appendChild(btnTab);
                    window.fallbackToServer(file, fileId);
                });
                updateLoadedFilesList();
                renderMergedTable();
            };
        }

        function initDropzone() {
            const dz = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');

            if (dz && fileInput) {
                dz.onclick = () => fileInput.click();
                dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('active'); };
                dz.ondragleave = () => dz.classList.remove('active');
                dz.ondrop = (e) => {
                    e.preventDefault();
                    dz.classList.remove('active');
                    if (window.handleFiles) window.handleFiles(e.dataTransfer.files);
                };

                fileInput.onchange = (e) => {
                    if (window.handleFiles) window.handleFiles(e.target.files);
                }
            }

            const exportBtn = document.getElementById('export-merged-btn');
            if (exportBtn) exportBtn.onclick = () => window.exportMergedExcel && window.exportMergedExcel();

            const searchInput = document.getElementById('merged-search-input');
            if (searchInput) {
                let timeout = null;
                searchInput.oninput = (e) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => window.filterMergedTable(e.target.value), 300);
                };
            }
        }

        // Global UI handlersï¼ˆä¿ç•™å…¼å®¹ï¼‰
        window.downloadSingle = (fileId) => { if (window._downloadSingle) window._downloadSingle(fileId); }
        window.downloadActiveFile = () => window.exportMergedExcel && window.exportMergedExcel();
        window.switchFile = (fileId) => { if (window._switchFile) window._switchFile(fileId); }
        window.togglePreview = (fileId) => { if (window._togglePreview) window._togglePreview(fileId); }

        // Logger Helper
        window.log = (msg, type = 'info') => {
            const out = document.getElementById('console-output');
            if (!out) return;
            const div = document.createElement('div');
            div.className = `log-line log-${type}`;
            div.textContent = `> ${msg}`;
            out.appendChild(div);
            out.scrollTop = out.scrollHeight;
            console.log(msg);
        }

        window.updateFileStatus = (fileId, text, type) => {
            const icon = document.getElementById(`status-icon-${fileId}`);
            if (icon) {
                if (type === 'success') icon.textContent = 'âœ…';
                else if (type === 'error') icon.textContent = 'âŒ';
                else icon.textContent = 'â³';
            }
            // Also update list item status if exists
            const el = document.getElementById(`status-${fileId}`);
            if (el) {
                el.textContent = text;
                el.className = `status-badge ${type}`;
            }
        }

        // --- Core File Processing Logic (Non-Wasm/Fallback) ---

        window.fallbackToServer = async function (file, fileId) {
            window.updateFileStatus(fileId, 'ä¸Šä¼ äº‘ç«¯è§£æ...', 'running');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const resp = await fetch('/api/parse-orc', {
                    method: 'POST',
                    body: formData
                });

                if (!resp.ok) throw new Error(`Server Error: ${resp.status}`);

                const json = await resp.json();
                if (json.error) throw new Error(json.error);

                window.generateExcel(json.data, file.name, fileId);

            } catch (err) {
                window.updateFileStatus(fileId, 'è§£æå¤±è´¥: ' + err.message, 'error');
                var entry = (window.mergedFileNames || []).find(f => f.id === fileId);
                if (entry) entry.ok = false;
                updateLoadedFilesList();
                log(err.message, 'error');
            }
        }

        window.generateExcel = function (data, fileName, fileId) {
            const rows = Array.isArray(data) ? data : [];
            const normalized = rows.map(row => {
                if (row && typeof row === 'object' && !Array.isArray(row)) return row;
                if (Array.isArray(row)) {
                    const obj = {};
                    row.forEach((val, i) => { obj[String(i)] = val; });
                    return obj;
                }
                return {};
            });

            window.mergedData = window.mergedData.concat(normalized);
            const entry = (window.mergedFileNames || []).find(f => f.id === fileId);
            if (entry) entry.ok = true;

            window.processedFiles[fileId] = { name: fileName.replace('.orc', '.xlsx'), data: normalized, originalName: fileName };
            window.updateFileStatus(fileId, 'âœ… è§£ææˆåŠŸ', 'success');

            updateLoadedFilesList();
            renderMergedTable();
            var btn = document.getElementById('export-merged-btn');
            if (btn) btn.disabled = false;
        }

        function updateLoadedFilesList() {
            const list = document.getElementById('loaded-files-list');
            if (!list) return;
            const names = window.mergedFileNames || [];
            if (!names.length) {
                list.innerHTML = '';
                return;
            }
            list.innerHTML = 'å·²åŠ è½½æ–‡ä»¶: ' + names.map(f => f.name + (f.ok ? ' âœ…' : ' âŒ')).join('ã€');
        }

        function getOrderedKeys(row) {
            const keys = Object.keys(row);
            const numeric = keys.every(k => /^\d+$/.test(k));
            return numeric ? keys.map(Number).sort((a, b) => a - b).map(String) : keys;
        }

        function getDisplayHeaders(keys) {
            return keys.map((k, i) => HEADER_NAMES[i] ?? 'å…¶ä»–');
        }

        window.renderMergedTable = function (data) {
            const container = document.getElementById('active-preview-container');
            if (!container) return;
            const source = data != null ? data : window.mergedData;
            if (!source || !source.length) {
                container.innerHTML = '<div style="padding:24px;text-align:center;color:#64748B;">æš‚æ— æ•°æ®ï¼Œè¯·ä¸Šä¼  ORC æ–‡ä»¶</div>';
                const summary = document.getElementById('merged-summary');
                if (summary) summary.textContent = 'å·²åŠ è½½ 0 ä¸ªæ–‡ä»¶ï¼Œå…± 0 è¡Œ';
                return;
            }
            const keys = getOrderedKeys(source[0]);
            const displayHeaders = getDisplayHeaders(keys);
            const previewRows = source.slice(0, 500);
            const total = source.length;

            const tableStyle = 'width:100%;border-collapse:separate;border-spacing:0;font-size:12px;min-width:800px;';
            const thStyle = 'text-align:left;padding:10px 12px;border-bottom:2px solid #E2E8F0;background:#F8FAFC;white-space:nowrap;position:sticky;top:0;z-index:10;font-weight:600;color:#475569;';
            const tdStyle = 'padding:8px 12px;border-bottom:1px solid #E2E8F0;white-space:nowrap;max-width:280px;overflow:hidden;text-overflow:ellipsis;color:#334155;';

            let html = `
            <div style="margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                <div style="font-size:12px;color:#64748B;">å…± ${total} è¡Œï¼Œè¡¨æ ¼ä¸­å±•ç¤ºå‰ ${Math.min(500, total)} è¡Œ</div>
                <div style="font-size:11px;color:#94A3B8;">ğŸ’¡ æŒ‰ä½ Shift æ¨ªå‘æ»šåŠ¨æŸ¥çœ‹æ›´å¤šåˆ—</div>
            </div>
            <div style="max-height:480px;overflow:auto;border:1px solid #E2E8F0;border-radius:8px;box-shadow:inset 0 2px 4px rgba(0,0,0,0.02);">
                <table style="${tableStyle}">
                    <thead><tr>`;
            displayHeaders.forEach(h => html += `<th style="${thStyle}">${h}</th>`);
            html += '</tr></thead><tbody>';

            previewRows.forEach((row, idx) => {
                const bg = idx % 2 === 0 ? '#fff' : '#F8FAFC';
                html += `<tr style="background:${bg};" onmouseover="this.style.background='#F1F5F9'" onmouseout="this.style.background='${bg}'">`;
                keys.forEach(k => {
                    const val = row[k] !== undefined ? row[k] : '';
                    const strVal = String(val);
                    html += `<td style="${tdStyle}" title="${strVal.replace(/"/g, '&quot;')}">${strVal}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;

            const fileCount = (window.mergedFileNames || []).length;
            const summary = document.getElementById('merged-summary');
            if (summary) summary.textContent = `å·²åŠ è½½ ${fileCount} ä¸ªæ–‡ä»¶ï¼Œå…± ${total} è¡Œ`;
        }

        window.filterMergedTable = function (keyword) {
            const term = (keyword || '').toLowerCase().trim();
            if (!term) {
                renderMergedTable(window.mergedData);
                return;
            }
            const filtered = window.mergedData.filter(row =>
                Object.values(row).some(v => String(v).toLowerCase().includes(term))
            );
            renderMergedTable(filtered);
            document.getElementById('merged-summary').textContent =
                `å·²åŠ è½½ ${(window.mergedFileNames || []).length} ä¸ªæ–‡ä»¶ï¼Œç­›é€‰å ${filtered.length} è¡Œ`;
        }

        window.exportMergedExcel = function () {
            const data = window.mergedData;
            if (!data || !data.length) return;
            const keys = getOrderedKeys(data[0]);
            const displayHeaders = getDisplayHeaders(keys);
            const rows = data.map(row => {
                const obj = {};
                keys.forEach((k, i) => { obj[displayHeaders[i]] = row[k]; });
                return obj;
            });
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ±‡æ€»æ•°æ®');
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ORC_æ±‡æ€»_${new Date().toISOString().slice(0, 10)}.xlsx`;
            a.click();
        }

        window._switchFile = function (fileId) {
            window.activeFileId = fileId;
            renderMergedTable();
        }
    </script>

    <!-- DuckDB Wasm Scripts -->
    <!-- Recommended CDN setup for DuckDB-Wasm -->
    <script type="module">
        import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm';

        // Global exports
        window.duckdb = duckdb;

        // --- DuckDB Logic ---
        let db = null;
        let conn = null;
        let initPromise = null;

        // Expose init function
        window.initDuckDB = async function () {
            if (initPromise) return initPromise;

            initPromise = (async () => {
                log('Initializing DuckDB-Wasm...');
                try {
                    const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
                    const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);
                    const worker_url = URL.createObjectURL(
                        new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
                    );

                    const worker = new Worker(worker_url);
                    const logger = new duckdb.ConsoleLogger();
                    db = new duckdb.AsyncDuckDB(logger, worker);
                    await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
                    conn = await db.connect();

                    log('âœ… DuckDB Ready!', 'success');
                } catch (err) {
                    log('âŒ DuckDB Init Failed: ' + err.message, 'error');
                    console.error(err);
                    throw err;
                }
            })();

            return initPromise;
        }

        // Check if we should init immediately (if auth passed before module loaded)
        if (window.appReady) {
            window.initDuckDB();
        }

        async function processFile(file, fileId) {
            // Initial placeholder state
            window.processedFiles[fileId] = {
                name: file.name.replace('.orc', '.xlsx'), // Placeholder name
                blob: null,
                data: null,
                originalName: file.name
            };

            // If no active file, switch to this one immediately (loading state)
            if (!window.activeFileId) {
                window._switchFile(fileId);
            }

            // Ensure DB is ready
            if (!db) {
                updateFileStatus(fileId, 'åˆå§‹åŒ–DB...', 'running');
                try {
                    await window.initDuckDB();
                } catch (err) {
                    updateFileStatus(fileId, 'DBåˆå§‹åŒ–å¤±è´¥', 'error');
                    return;
                }
            }

            updateFileStatus(fileId, 'è§£æä¸­...', 'running');
            const tableName = 't_' + fileId.replace(/[^a-zA-Z0-9]/g, '_');

            try {
                // 1. Register File
                await db.registerFileHandle(file.name, file, duckdb.DuckDBDataProtocol.BROWSER_FILEREADING, true);
                log(`Processing ${file.name}...`);
                const result = await conn.query(`SELECT * FROM '${file.name}' LIMIT 10`);

                // Convert to Array
                const rows = result.toArray().map(row => row.toJSON());

                // Export to Excel
                if (rows.length > 0) {
                    generateExcel(rows, file.name, fileId);
                } else {
                    updateFileStatus(fileId, 'æ— æ•°æ®', 'error');
                }

            } catch (err) {
                // Determine if it's a "missing table" error which is expected for ORC in Wasm without extension
                const isExpectedError = err.message.includes('Table with name') && err.message.includes('does not exist');

                if (isExpectedError) {
                    log(`æœ¬åœ° DuckDB æš‚ä¸æ”¯æŒç›´è¯»æ­¤ ORC (éœ€è¦æ‰©å±•)ï¼Œè‡ªåŠ¨åˆ‡æ¢è‡³äº‘ç«¯ Python è§£æ...`, 'warning');
                } else {
                    log(`æœ¬åœ°è§£æå‡ºé”™: ${err.message}ï¼Œå°è¯•äº‘ç«¯è§£æ...`, 'warning');
                }

                // === FALLBACK TO SERVER API ===
                fallbackToServer(file, fileId);
            }
        }



        window.handleFiles = function (files) {
            if (!files.length) return;

            window.mergedData = [];
            window.mergedFileNames = [];

            document.getElementById('processing-area').style.display = 'block';
            document.getElementById('console-output').style.display = 'block';
            document.getElementById('export-merged-btn').disabled = true;
            document.getElementById('merged-search-input').value = '';

            const container = document.getElementById('file-tabs-container');
            container.innerHTML = '';

            Array.from(files).forEach((file, idx) => {
                const fileId = `f_${Date.now()}_${idx}`;

                window.mergedFileNames.push({ name: file.name, id: fileId, ok: false });

                const btn = document.createElement('button');
                btn.className = 'gem-btn gem-btn-secondary file-tab-btn';
                btn.id = `tab-${fileId}`;
                btn.style.cssText = 'white-space:nowrap; display:flex; align-items:center; gap:8px; padding:8px 16px; border:1px solid #E2E8F0; background:white; color:#64748B;';
                btn.innerHTML = `<span>ğŸ“„ ${file.name}</span><div id="status-icon-${fileId}" style="font-size:10px;">â³</div>`;
                btn.onclick = () => window._switchFile(fileId);
                container.appendChild(btn);

                processFile(file, fileId);
            });

            updateLoadedFilesList();
            renderMergedTable();
        }


    </script>
</body>

</html>
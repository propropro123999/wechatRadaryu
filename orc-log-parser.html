<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ORC æ—¥å¿—è§£æå·¥å…· - ICviews Tools</title>
    <link rel="stylesheet" href="gemini-ui.css" />
    <link rel="stylesheet" href="design-system-modern.css" />
    <link rel="stylesheet" href="tool-pages-interactions.css" />
    <!-- SheetJS for Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- JSZip for Multiple Files Export -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        body {
            background-color: var(--gem-color-bg-body);
            min-height: 100vh;
        }

        .main-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 24px;
        }

        .dropzone {
            border: 2px dashed #CBD5E1;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            background: #F8FAFC;
            transition: all 0.2s;
            cursor: pointer;
        }

        .dropzone:hover,
        .dropzone.active {
            border-color: var(--gem-color-accent);
            background: #EFF6FF;
        }

        .file-list {
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .file-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .status-badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 99px;
            background: #EEF2FF;
            color: #4F46E5;
        }

        .status-badge.success {
            background: #DCFCE7;
            color: #166534;
        }

        .status-badge.error {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* Console Output Style */
        #console-output {
            background: #1E293B;
            color: #E2E8F0;
            padding: 16px;
            border-radius: 12px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-top: 24px;
            display: none;
        }

        .log-line {
            margin-bottom: 4px;
            border-bottom: 1px solid #334155;
            padding-bottom: 2px;
        }

        .log-error {
            color: #F87171;
        }

        .log-success {
            color: #4ADE80;
        }
    </style>
</head>

<body>

    <!-- Access Control Overlay -->
    <div id="auth-screen"
        style="position:fixed;inset:0;background:rgba(255,255,255,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px);">
        <div class="gem-card" style="width:360px;padding:32px;">
            <h2 style="font-size:20px;margin-bottom:8px;">ğŸ” ORC æ—¥å¿—è§£æ</h2>
            <p style="font-size:13px;color:#64748B;margin-bottom:24px;">è¯·è¾“å…¥æˆæƒç è®¿é—®æœ¬å·¥å…·</p>
            <input type="text" id="auth-code" class="gem-input" placeholder="è¯·è¾“å…¥æˆæƒç " style="margin-bottom:16px;">
            <button id="auth-btn" class="gem-btn gem-btn-primary w-full">ç¡®è®¤è¿›å…¥</button>
            <div id="auth-error" style="color:#EF4444;font-size:12px;margin-top:12px;min-height:20px;"></div>
        </div>
    </div>

    <div id="app" style="display:none;">
        <nav class="gem-navbar">
            <a href="#" class="gem-navbar-brand">
                <span class="gem-navbar-icon">ğŸªµ</span>
                <span>ORC æ—¥å¿—è§£æ</span>
            </a>
            <div class="gem-navbar-actions">
                <a href="index.html" class="gem-btn gem-btn-secondary" style="font-size:13px;">ğŸ  è¿”å›é¦–é¡µ</a>
            </div>
        </nav>

        <div class="main-container">
            <div style="text-align:center;margin-bottom:32px;">
                <h1>ORC æ—¥å¿—æ‰¹é‡è§£æ</h1>
                <p></p>
                <div class="gem-chip">âš ï¸ å®éªŒæ€§åŠŸèƒ½ (Powered by DuckDB-Wasm)</div>
            </div>

            <div class="gem-card">
                <div class="dropzone" id="dropzone">
                    <div style="font-size:48px;margin-bottom:16px;">ğŸ“‚</div>
                    <div style="font-size:16px;font-weight:600;color:#1E293B;margin-bottom:8px;">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  ORC æ–‡ä»¶</div>
                    <div style="font-size:13px;color:#64748B;">æ”¯æŒæ‰¹é‡ä¸Šä¼ ï¼Œå•ä¸ªæ–‡ä»¶å¤§å°å»ºè®®ä¸è¶…è¿‡ 100MB</div>
                    <input type="file" id="fileInput" multiple accept=".orc" style="display:none;">
                </div>

                <div id="processing-area" style="display:none; margin-top: 24px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <h3 style="margin:0;">æ–‡ä»¶åˆ—è¡¨</h3>
                        <div style="display:flex; gap:12px;">
                            <button id="download-active-btn" class="gem-btn gem-btn-secondary" style="display:none;"
                                onclick="downloadActiveFile()">â¬‡ï¸ ä¸‹è½½å½“å‰æ–‡ä»¶</button>
                            <button id="download-all-btn" class="gem-btn gem-btn-primary" disabled>
                                ğŸ“¦ æ‰“åŒ…ä¸‹è½½æ‰€æœ‰
                            </button>
                        </div>
                    </div>

                    <!-- File Tabs Container -->
                    <div id="file-tabs-container"
                        style="display:flex; gap:12px; overflow-x:auto; padding-bottom:8px; margin-bottom:16px; border-bottom:1px solid #E2E8F0;">
                        <!-- Tabs will be injected here -->
                    </div>

                    <!-- Single Preview Area -->
                    <div id="main-preview-area" style="min-height:200px; display:none;">
                        <div id="active-file-header" style="margin-bottom:12px; font-weight:600; color:#334155;"></div>
                        <div id="active-preview-container"></div>
                    </div>
                </div>

                <div id="console-output"></div>
            </div>
        </div>
    </div>

    <!-- Auth & UI Logic (Standard Script) -->
    <script>
        // --- Auth Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            initDropzone();
        });

        function initAuth() {
            const savedCode = localStorage.getItem('orc_auth_code');
            if (verifyCode(savedCode)) {
                showApp();
            }

            const btn = document.getElementById('auth-btn');
            if (btn) {
                btn.onclick = () => {
                    const code = document.getElementById('auth-code').value.trim();
                    if (verifyCode(code)) {
                        localStorage.setItem('orc_auth_code', code);
                        showApp();
                    } else {
                        document.getElementById('auth-error').textContent = 'æˆæƒç æ— æ•ˆ';
                    }
                };
            }
        }

        function verifyCode(code) {
            const validCodes = ['dcone2025', 'ORC-2025-A1B2', 'ORC-2025-C3D4'];
            return validCodes.includes(code);
        }

        function showApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';

            // Trigger DuckDB init if available
            if (window.initDuckDB) {
                window.initDuckDB();
            } else {
                // If module hasn't loaded yet, set a flag
                window.appReady = true;
            }
        }

        // --- UI Interactions ---
        // Expose global state for module to use
        window.processedFiles = {};
        window.activeFileId = null;

        // Placeholder until module loads
        if (!window.handleFiles) {
            window.handleFiles = (files) => {
                console.warn("Module not loaded yet");
                const out = document.getElementById('console-output');
                if (out) {
                    out.style.display = 'block';
                    const msgId = `msg-${Date.now()}`;
                    if (!document.getElementById('force-cloud-btn')) {
                        out.innerHTML += `
                            <div id="${msgId}" class="log-line log-warning">
                                > â³ ç³»ç»Ÿç»„ä»¶åˆå§‹åŒ–è¾ƒæ…¢(ç½‘ç»œåŸå› )... 
                                <button id="force-cloud-btn" class="gem-btn gem-btn-xs gem-btn-primary" style="margin-left:8px; padding: 2px 8px; font-size:11px;">
                                    â˜ï¸ å¼ºåˆ¶äº‘ç«¯è§£æ
                                </button>
                            </div>
                        `;
                        // Bind click event asynchronously to ensure element exists
                        setTimeout(() => {
                            const btn = document.getElementById('force-cloud-btn');
                            if (btn) {
                                btn.onclick = () => {
                                    btn.textContent = "æ­£åœ¨äº‘ç«¯è§£æ...";
                                    btn.disabled = true;

                                    // Manually run the file processing loop via Fallback
                                    const container = document.getElementById('file-tabs-container');
                                    Array.from(files).forEach((file, idx) => {
                                        const fileId = `f_${Date.now()}_${idx}`;

                                        // UI: Create Tab (Inline fallback)
                                        const btnTab = document.createElement('button');
                                        btnTab.className = 'gem-btn gem-btn-secondary file-tab-btn';
                                        btnTab.id = `tab-${fileId}`;
                                        btnTab.style.cssText = 'white-space:nowrap; display:flex; align-items:center; gap:8px; padding:8px 16px; border:1px solid #E2E8F0; background:white; color:#64748B;';
                                        btnTab.innerHTML = `<span>ğŸ“„ ${file.name}</span><div id="status-icon-${fileId}" style="font-size:10px;">â³</div>`;
                                        btnTab.onclick = () => window._switchFile(fileId);
                                        container.appendChild(btnTab);

                                        window.fallbackToServer(file, fileId);
                                    });
                                };
                            }
                        }, 100);
                    }
                } else {
                    alert("ç³»ç»Ÿåˆå§‹åŒ–ä¸­... å¦‚é•¿æ—¶é—´æ— ååº”è¯·åˆ·æ–°é¡µé¢");
                }
            };
        }

        function initDropzone() {
            const dz = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');

            if (dz && fileInput) {
                dz.onclick = () => fileInput.click();
                dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('active'); };
                dz.ondragleave = () => dz.classList.remove('active');
                dz.ondrop = (e) => {
                    e.preventDefault();
                    dz.classList.remove('active');
                    if (window.handleFiles) window.handleFiles(e.dataTransfer.files);
                };

                fileInput.onchange = (e) => {
                    if (window.handleFiles) window.handleFiles(e.target.files);
                }
            }

            const dlBtn = document.getElementById('download-all-btn');
            if (dlBtn) {
                dlBtn.onclick = () => {
                    if (window.downloadAll) window.downloadAll();
                }
            }
        }

        // Global UI handlers
        window.downloadSingle = (fileId) => { if (window._downloadSingle) window._downloadSingle(fileId); }
        window.downloadActiveFile = () => { if (window._downloadActiveFile) window._downloadActiveFile(); }
        window.switchFile = (fileId) => { if (window._switchFile) window._switchFile(fileId); }
        window.togglePreview = (fileId) => { if (window._togglePreview) window._togglePreview(fileId); }

        // Logger Helper
        window.log = (msg, type = 'info') => {
            const out = document.getElementById('console-output');
            if (!out) return;
            const div = document.createElement('div');
            div.className = `log-line log-${type}`;
            div.textContent = `> ${msg}`;
            out.appendChild(div);
            out.scrollTop = out.scrollHeight;
            console.log(msg);
        }

        window.updateFileStatus = (fileId, text, type) => {
            const icon = document.getElementById(`status-icon-${fileId}`);
            if (icon) {
                if (type === 'success') icon.textContent = 'âœ…';
                else if (type === 'error') icon.textContent = 'âŒ';
                else icon.textContent = 'â³';
            }
            // Also update list item status if exists
            const el = document.getElementById(`status-${fileId}`);
            if (el) {
                el.textContent = text;
                el.className = `status-badge ${type}`;
            }
        }

        // --- Core File Processing Logic (Non-Wasm/Fallback) ---

        window.fallbackToServer = async function (file, fileId) {
            window.updateFileStatus(fileId, 'ä¸Šä¼ äº‘ç«¯è§£æ...', 'running');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const resp = await fetch('/api/parse-orc', {
                    method: 'POST',
                    body: formData
                });

                if (!resp.ok) throw new Error(`Server Error: ${resp.status}`);

                const json = await resp.json();
                if (json.error) throw new Error(json.error);

                window.generateExcel(json.data, file.name, fileId);

            } catch (err) {
                window.updateFileStatus(fileId, 'è§£æå¤±è´¥: ' + err.message, 'error');
                log(err.message, 'error');
            }
        }

        window.generateExcel = function (data, fileName, fileId) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "LogData");

            // Convert to Blob for later zip or download
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });

            // Save to global list
            window.processedFiles[fileId] = {
                name: fileName.replace('.orc', '.xlsx'),
                blob: blob,
                data: data,
                originalName: fileName
            };

            window.updateFileStatus(fileId, 'âœ… è§£ææˆåŠŸ', 'success');

            // If this is the active file, re-render to show data
            if (window.activeFileId === fileId) {
                window._switchFile(fileId);
            }

            enableDownloadAll();
        }

        window.downloadAll = async function () {
            const zip = new JSZip();
            Object.values(window.processedFiles).forEach(f => {
                zip.file(f.name, f.blob);
            });

            const content = await zip.generateAsync({ type: "blob" });
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ORC_Parsed_${new Date().toISOString().slice(0, 10)}.zip`;
            a.click();
        }

        window._downloadSingle = function (fileId) {
            const f = window.processedFiles[fileId];
            if (!f) return;
            const url = URL.createObjectURL(f.blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = f.name;
            a.click();
        }

        window._switchFile = function (fileId) {
            // Update Active State
            document.querySelectorAll('.file-tab-btn').forEach(b => {
                b.style.borderColor = '#E2E8F0';
                b.style.background = 'white';
                b.style.color = '#64748B';
            });

            const activeTab = document.getElementById(`tab-${fileId}`);
            if (activeTab) {
                activeTab.style.borderColor = 'var(--gem-color-accent)';
                activeTab.style.background = '#EFF6FF';
                activeTab.style.color = 'var(--gem-color-accent)';
            }

            window.activeFileId = fileId;
            const fileData = window.processedFiles[fileId];

            // Render Preview
            const previewArea = document.getElementById('main-preview-area');
            const previewContainer = document.getElementById('active-preview-container');
            const header = document.getElementById('active-file-header');
            const downloadBtn = document.getElementById('download-active-btn');

            previewArea.style.display = 'block';
            previewContainer.innerHTML = ''; // Clear previous

            if (fileData) {
                // Header with Search
                header.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span>å½“å‰é¢„è§ˆ: ${fileData.name.replace('.xlsx', '.orc')}</span>
                        <input type="text" id="preview-search-${fileId}" 
                            class="gem-input" 
                            placeholder="ğŸ” æœç´¢å…³é”®è¯..." 
                            style="width:200px; height:32px; font-size:12px; padding:4px 12px;"
                        >
                    </div>
                `;

                downloadBtn.style.display = 'block';

                // Bind Search Event
                const searchInput = document.getElementById(`preview-search-${fileId}`);
                if (searchInput) {
                    let timeout = null;
                    searchInput.oninput = (e) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            window.filterPreview(fileId, e.target.value);
                        }, 300);
                    };
                }

                if (fileData.data) {
                    window.renderPreviewTable(fileData.data, previewContainer);
                } else {
                    previewContainer.innerHTML = '<div style="padding:24px;text-align:center;color:#64748B;">æ•°æ®è§£æä¸­æˆ–æš‚æ— é¢„è§ˆæ•°æ®...</div>';
                }
            } else {
                header.textContent = 'åŠ è½½ä¸­...';
                downloadBtn.style.display = 'none';
                previewContainer.innerHTML = '<div style="padding:24px;text-align:center;color:#64748B;">æ­£åœ¨å¤„ç†...</div>';
            }
        }

        window.filterPreview = function (fileId, keyword) {
            const f = window.processedFiles[fileId];
            const container = document.getElementById('active-preview-container');

            if (!f || !f.data) return;

            const term = keyword.toLowerCase().trim();
            if (!term) {
                window.renderPreviewTable(f.data, container);
                return;
            }

            const filtered = f.data.filter(row => {
                return Object.values(row).some(val =>
                    String(val).toLowerCase().includes(term)
                );
            });

            window.renderPreviewTable(filtered, container);
        }

        window._downloadActiveFile = function () {
            if (window.activeFileId) window._downloadSingle(window.activeFileId);
        }

        window._togglePreview = function (fileId) {
            const el = document.getElementById(`preview-${fileId}`);
            if (el.style.display === 'none') {
                el.style.display = 'block';
                if (!el.dataset.rendered) {
                    const f = window.processedFiles[fileId];
                    if (f && f.data) {
                        window.renderPreviewTable(f.data, el);
                        el.dataset.rendered = 'true';
                    }
                }
            } else {
                el.style.display = 'none';
            }
        }

        window.renderPreviewTable = function (data, container) {
            if (!data || !data.length) {
                container.innerHTML = '<div style="color:#64748B;font-size:12px;">æ— æ•°æ®é¢„è§ˆ</div>';
                return;
            }
            const previewData = data.slice(0, 50);
            const headers = Object.keys(previewData[0]);

            const tableStyle = `width:100%;border-collapse:separate;border-spacing:0;font-size:12px;min-width:800px;`;
            const thStyle = `text-align:left;padding:12px 16px;border-bottom:2px solid #E2E8F0;background:#F8FAFC;white-space:nowrap;position:sticky;top:0;z-index:10;font-weight:600;color:#475569;`;
            const tdStyle = `padding:10px 16px;border-bottom:1px solid #E2E8F0;white-space:nowrap;max-width:300px;overflow:hidden;text-overflow:ellipsis;color:#334155;`;

            let html = `
            <div style="margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:12px;color:#64748B;">é¢„è§ˆå‰ 50 è¡Œæ•°æ® (å…± ${data.length} è¡Œ)</div>
                <div style="font-size:11px;color:#94A3B8;">ğŸ’¡ æŒ‰ä½ Shift æ»šåŠ¨æŸ¥çœ‹æ›´å¤šåˆ—</div>
            </div>
            <div style="max-height: 400px; overflow: auto; border: 1px solid #E2E8F0; border-radius: 8px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);">
                <table style="${tableStyle}">
                    <thead><tr>`;

            headers.forEach(h => html += `<th style="${thStyle}">${h}</th>`);
            html += `</tr></thead><tbody>`;

            previewData.forEach((row, idx) => {
                const bg = idx % 2 === 0 ? '#fff' : '#F8FAFC';
                html += `<tr style="background:${bg}; transition: background 0.1s;" onmouseover="this.style.background='#F1F5F9'" onmouseout="this.style.background='${bg}'">`;
                headers.forEach(h => {
                    const val = row[h] !== undefined ? row[h] : '';
                    const strVal = String(val);
                    html += `<td style="${tdStyle}" title="${strVal.replace(/"/g, '&quot;')}">${strVal}</td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function enableDownloadAll() {
            const btn = document.getElementById('download-all-btn');
            if (btn) btn.disabled = false;
        }
    </script>

    <!-- DuckDB Wasm Scripts -->
    <!-- Recommended CDN setup for DuckDB-Wasm -->
    <script type="module">
        import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm';

        // Global exports
        window.duckdb = duckdb;

        // --- DuckDB Logic ---
        let db = null;
        let conn = null;
        let initPromise = null;

        // Expose init function
        window.initDuckDB = async function () {
            if (initPromise) return initPromise;

            initPromise = (async () => {
                log('Initializing DuckDB-Wasm...');
                try {
                    const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
                    const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);
                    const worker_url = URL.createObjectURL(
                        new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
                    );

                    const worker = new Worker(worker_url);
                    const logger = new duckdb.ConsoleLogger();
                    db = new duckdb.AsyncDuckDB(logger, worker);
                    await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
                    conn = await db.connect();

                    log('âœ… DuckDB Ready!', 'success');
                } catch (err) {
                    log('âŒ DuckDB Init Failed: ' + err.message, 'error');
                    console.error(err);
                    throw err;
                }
            })();

            return initPromise;
        }

        // Check if we should init immediately (if auth passed before module loaded)
        if (window.appReady) {
            window.initDuckDB();
        }

        async function processFile(file, fileId) {
            // Initial placeholder state
            window.processedFiles[fileId] = {
                name: file.name.replace('.orc', '.xlsx'), // Placeholder name
                blob: null,
                data: null,
                originalName: file.name
            };

            // If no active file, switch to this one immediately (loading state)
            if (!window.activeFileId) {
                window._switchFile(fileId);
            }

            // Ensure DB is ready
            if (!db) {
                updateFileStatus(fileId, 'åˆå§‹åŒ–DB...', 'running');
                try {
                    await window.initDuckDB();
                } catch (err) {
                    updateFileStatus(fileId, 'DBåˆå§‹åŒ–å¤±è´¥', 'error');
                    return;
                }
            }

            updateFileStatus(fileId, 'è§£æä¸­...', 'running');
            const tableName = 't_' + fileId.replace(/[^a-zA-Z0-9]/g, '_');

            try {
                // 1. Register File
                await db.registerFileHandle(file.name, file, duckdb.DuckDBDataProtocol.BROWSER_FILEREADING, true);
                log(`Processing ${file.name}...`);
                const result = await conn.query(`SELECT * FROM '${file.name}' LIMIT 10`);

                // Convert to Array
                const rows = result.toArray().map(row => row.toJSON());

                // Export to Excel
                if (rows.length > 0) {
                    generateExcel(rows, file.name, fileId);
                } else {
                    updateFileStatus(fileId, 'æ— æ•°æ®', 'error');
                }

            } catch (err) {
                // Determine if it's a "missing table" error which is expected for ORC in Wasm without extension
                const isExpectedError = err.message.includes('Table with name') && err.message.includes('does not exist');

                if (isExpectedError) {
                    log(`æœ¬åœ° DuckDB æš‚ä¸æ”¯æŒç›´è¯»æ­¤ ORC (éœ€è¦æ‰©å±•)ï¼Œè‡ªåŠ¨åˆ‡æ¢è‡³äº‘ç«¯ Python è§£æ...`, 'warning');
                } else {
                    log(`æœ¬åœ°è§£æå‡ºé”™: ${err.message}ï¼Œå°è¯•äº‘ç«¯è§£æ...`, 'warning');
                }

                // === FALLBACK TO SERVER API ===
                fallbackToServer(file, fileId);
            }
        }



        window.handleFiles = function (files) {
            if (!files.length) return;

            document.getElementById('processing-area').style.display = 'block';
            document.getElementById('console-output').style.display = 'block';

            // Note: We append to existing tabs if adding more files
            const container = document.getElementById('file-tabs-container');

            Array.from(files).forEach((file, idx) => {
                const fileId = `f_${Date.now()}_${idx}`;

                // Create Tab
                const btn = document.createElement('button');
                btn.className = 'gem-btn gem-btn-secondary file-tab-btn';
                btn.id = `tab-${fileId}`;
                btn.style.cssText = 'white-space:nowrap; display:flex; align-items:center; gap:8px; padding:8px 16px; border:1px solid #E2E8F0; background:white; color:#64748B;';
                btn.innerHTML = `
                <span>ğŸ“„ ${file.name}</span>
                <div id="status-icon-${fileId}" style="font-size:10px;">â³</div>
                `;
                btn.onclick = () => window._switchFile(fileId);

                container.appendChild(btn);

                processFile(file, fileId);
            });
        }


    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å†…å®¹è¿è¥æ•°æ® Dashboardï¼ˆæœ¬åœ°ç‰ˆï¼‰</title>
  <link rel="stylesheet" href="design-system-modern.css" />
  <link rel="stylesheet" href="tool-pages-interactions.css" />
  <!-- Plotly ç”¨äºç”»å›¾ -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- SheetJS è¯»å– Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- è¯äº‘ -->
  <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei",
        sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f7f8fa;
      color: #0f172a;
    }
    .topbar {
      background: #ffffff;
      color: #0f172a;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.04);
    }
    .topbar-title {
      font-size: 16px;
      font-weight: 700;
    }
    .file-input {
      background: #ffffff;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      color: #0f172a;
      cursor: pointer;
      transition: border-color 0.18s ease, box-shadow 0.18s ease, transform 0.12s ease;
    }
    .file-input:hover {
      border-color: #bfdbfe;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.08);
      transform: translateY(-1px);
    }
    .hint {
      font-size: 11px;
      color: #6b7280;
    }
    .topbar-home {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #f3f4f6;
      color: #0f172a;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.18s ease;
      border: 1px solid #d1d5db;
    }
    .topbar-home:hover {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.25);
    }
    .container {
      max-width: 1220px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 6px;
      color: #0f172a;
    }
    h2 {
      font-size: 20px;
      margin: 24px 0 12px;
      color: #0f172a;
    }
    .sub-title {
      color: #6b7280;
      margin-bottom: 18px;
      font-size: 13px;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background-color: #eef2ff;
      color: #4f46e5;
      font-size: 11px;
      margin-left: 8px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 18px 20px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
      transition: transform 0.16s ease, box-shadow 0.16s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 26px rgba(37, 99, 235, 0.08);
    }
    .card-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .card-value {
      font-size: 24px;
      font-weight: 700;
      color: #0f172a;
    }
    .card-desc {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .chart-block {
      background: #fff;
      border-radius: 16px;
      padding: 18px 20px;
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.06);
      margin-bottom: 20px;
      border: 1px solid #e5e7eb;
      transition: transform 0.16s ease, box-shadow 0.16s ease;
    }
    .chart-block:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.08);
    }
    .chart-title {
      font-size: 16px;
      margin-bottom: 4px;
      color: #0f172a;
      font-weight: 700;
    }
    .chart-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 10px;
    }
    .chart {
      width: 100%;
      height: 340px;
    }
    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }
    .data-table th,
    .data-table td {
      border-bottom: 1px solid #e5e7eb;
      padding: 10px 12px;
      text-align: left;
    }
    .data-table th {
      background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
      font-weight: 700;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
    }
    .data-table tbody tr:nth-child(odd) {
      background-color: #fbfdff;
    }
    .data-table tbody tr:hover {
      background-color: #f3f6ff;
      transition: background-color 0.15s ease;
    }
    .footer {
      margin-top: 24px;
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }
    #loading {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }
    #error {
      font-size: 13px;
      color: #b91c1c;
      margin-top: 8px;
    }

    /* ===== æˆæƒå±‚æ ·å¼ ===== */
    #auth-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.92);
      z-index: 9999;
      backdrop-filter: blur(8px);
    }

    .auth-card {
      width: 360px;
      max-width: 90vw;
      padding: 24px;
      border-radius: 16px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 16px 48px rgba(15, 23, 42, 0.16);
    }

    .auth-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #0f172a;
    }

    .auth-subtitle {
      font-size: 12px;
      color: #475569;
      margin-bottom: 16px;
    }

    .auth-label {
      font-size: 12px;
      color: #475569;
      margin-bottom: 6px;
      display: block;
      font-weight: 600;
    }

    .auth-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #f8fafc;
      color: #0f172a;
      outline: none;
      font-size: 13px;
      margin-bottom: 14px;
      box-sizing: border-box;
      transition: border-color 0.18s, box-shadow 0.18s, transform 0.12s ease;
    }

    .auth-input:focus {
      border-color: #bfdbfe;
      box-shadow: 0 0 0 3px rgba(191, 219, 254, 0.55);
      transform: translateY(-1px);
    }

    .auth-btn {
      width: 100%;
      border: none;
      border-radius: 10px;
      padding: 11px 16px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
      transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
    }

    .auth-btn:hover {
      transform: translateY(-2px);
    }

    .auth-error {
      margin-top: 10px;
      font-size: 11px;
      color: #dc2626;
      min-height: 16px;
    }

    .auth-card.shake {
      animation: shake 0.3s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      50% { transform: translateX(6px); }
      75% { transform: translateX(-3px); }
    }

    #app {
      display: none;
    }
  </style>
</head>
<body>
  <!-- æˆæƒå±‚ -->
  <div id="auth-screen">
    <div class="auth-card" id="auth-card">
      <div class="auth-title">ğŸ” ä¸“æ  / å¸–å­å·¥å…·</div>
      <div class="auth-subtitle">è¯·è¾“å…¥æˆæƒç è®¿é—®æœ¬å·¥å…·</div>

      <label class="auth-label" for="auth-code">æˆæƒç </label>
      <input
        id="auth-code"
        class="auth-input"
        type="text"
        placeholder="è¯·è¾“å…¥æˆæƒç "
        autocomplete="off"
      />

      <button class="auth-btn" id="auth-btn">ç¡®è®¤è¿›å…¥</button>

      <div class="auth-error" id="auth-error"></div>
    </div>
  </div>

  <!-- çœŸæ­£çš„åº”ç”¨ -->
  <div id="app">
  <div class="topbar">
    <div style="flex:1;">
      <div class="topbar-title">ä¸“æ  / å¸–å­å·¥å…·ï¼ˆæœ¬åœ°ç‰ˆï¼‰</div>
      <div class="hint">
        æ”¯æŒçš„åˆ—åç¤ºä¾‹ï¼šåŠ¨æ€ID / åŠ¨æ€æ ‡é¢˜ / äº§ä¸šåŠ¨æ€æ ‡é¢˜ / å‘å¸ƒè€… / ä½œè€… / æ¥æº / ç‚¹èµæ•° / è¯„è®ºæ•° / åˆ›å»ºæ—¶é—´ / å‘å¸ƒæ—¶é—´ / æ›´æ–°æ—¶é—´ï¼ˆç‚¹èµå’Œè¯„è®ºå¯é€‰ï¼‰
      </div>
    </div>
    <div style="display:flex; gap:12px; align-items:center;">
      <label class="file-input">
        é€‰æ‹© Excel æ–‡ä»¶
        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" />
      </label>
      <a href="index-modern.html" class="topbar-home">â† è¿”å›é¦–é¡µ</a>
    </div>
  </div>

  <div class="container">
    <h1>ä¸“æ  / å¸–å­å·¥å…·</h1>
    <div class="sub-title" id="dateRange">
      è¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹© Excel æ–‡ä»¶
      <span class="tag">ç¦»çº¿æœ¬åœ°åˆ†æï¼Œä¸ä¼šä¸Šä¼ æ•°æ®</span>
    </div>

    <div id="loading"></div>
    <div id="error"></div>

    <div class="cards" id="summaryCards" style="display:none;">
      <div class="card">
        <div class="card-label">ç´¯è®¡å‘å¸ƒå†…å®¹</div>
        <div class="card-value" id="totalPosts">-</div>
        <div class="card-desc">ç»Ÿè®¡å‘¨æœŸå†…äº§ç”Ÿçš„å…¨éƒ¨åŠ¨æ€æ•°é‡</div>
      </div>
      <div class="card">
        <div class="card-label">ç´¯è®¡ç‚¹èµæ•°</div>
        <div class="card-value" id="totalLikes">-</div>
        <div class="card-desc">å¯ç”¨äºè®¡ç®—äººå‡ & å•ç¯‡å¹³å‡äº’åŠ¨ï¼ˆæ²¡æœ‰ç‚¹èµåˆ—æ—¶ä¸º 0ï¼‰</div>
      </div>
      <div class="card">
        <div class="card-label">ç´¯è®¡è¯„è®ºæ•°</div>
        <div class="card-value" id="totalComments">-</div>
        <div class="card-desc">è¡¡é‡æ·±åº¦äº’åŠ¨ & è®¨è®ºåº¦ï¼ˆæ²¡æœ‰è¯„è®ºåˆ—æ—¶ä¸º 0ï¼‰</div>
      </div>
      <div class="card">
        <div class="card-label">ä½œè€…æ€»æ•°</div>
        <div class="card-value" id="authorCount">-</div>
        <div class="card-desc">ä¼˜å…ˆè¯†åˆ«â€œå‘å¸ƒè€… / ä½œè€… / æ¥æº / æ“ä½œäººâ€</div>
      </div>
      <div class="card">
        <div class="card-label">äººå‡å‘æ–‡æ•°</div>
        <div class="card-value" id="avgPostsPerAuthor">-</div>
        <div class="card-desc">ç´¯è®¡å‘æ–‡ Ã· ä½œè€…æ€»æ•°</div>
      </div>
    </div>

    <!-- ä¸€ã€æ•´ä½“è¶‹åŠ¿ -->
    <h2>ä¸€ã€æ•´ä½“è¶‹åŠ¿</h2>
    <div class="chart-block">
      <div class="chart-title">æ¯æ—¥å†…å®¹å‘å¸ƒè¶‹åŠ¿</div>
      <div class="chart-subtitle">è§‚å¯Ÿæ•´ä½“èŠ‚å¥ã€å†…å®¹â€œé«˜å³°æ—¥â€å’Œâ€œä½è°·æ—¥â€</div>
      <div id="dailyChart" class="chart"></div>
    </div>
    <div class="chart-block">
      <div class="chart-title">æŒ‰æœˆå‘å¸ƒå†…å®¹æ•°é‡</div>
      <div class="chart-subtitle">å¯ç”¨äºå¹´ç»ˆæ€»ç»“ä¸­çš„â€œæœˆåº¦å¯¹æ¯”â€</div>
      <div id="monthlyChart" class="chart"></div>
    </div>

    <!-- äºŒã€æ—¶æ®µåˆ†å¸ƒ -->
    <h2>äºŒã€å‘å¸ƒæ—¶æ®µä¸æ´»è·ƒåº¦</h2>
    <div class="chart-block">
      <div class="chart-title">æŒ‰å°æ—¶åˆ†å¸ƒçš„å‘æ–‡æ•°é‡</div>
      <div class="chart-subtitle">è¯†åˆ«é«˜æ•ˆå‘å¸ƒæ—¶é—´æ®µï¼Œç”¨äºâ€œæœ€ä½³æŠ•æ”¾æ—¶æœºâ€åˆ†æ</div>
      <div id="hourChart" class="chart"></div>
    </div>

    <!-- ä¸‰ã€å‘å¸ƒè€…è¡¨ç° -->
    <h2>ä¸‰ã€å‘å¸ƒè€…è¡¨ç°</h2>
    <div class="chart-block">
      <div class="chart-title">ä¸åŒå‘å¸ƒè€…çš„å†…å®¹äº§å‡ºä¸äº’åŠ¨</div>
      <div class="chart-subtitle">å¯æ”¯æŒâ€œå¤´éƒ¨ä½œè€…â€â€œè…°éƒ¨ä½œè€…â€åˆ†å±‚è¯´æ˜</div>
      <div id="publisherChart" class="chart"></div>
    </div>
    <div class="chart-block">
      <div class="chart-title">å‘å¸ƒè€… TOP 20ï¼ˆæŒ‰å‘æ–‡æ•°ï¼‰</div>
      <div class="chart-subtitle">å‘æ–‡æ•°ä¼˜å…ˆï¼Œå…¶æ¬¡æŒ‰ç‚¹èµæ•°ã€è¯„è®ºæ•°æ’åºï¼›æ”¯æŒå¯¼å‡º TOP 50 æ•°æ®</div>
      <div style="display:flex; justify-content:flex-end; margin-bottom:8px;">
        <button class="upload-btn" id="authorExportBtn" style="margin-left:0;">å¯¼å‡º TOP 50 CSV</button>
      </div>
      <div id="authorTopTable"></div>
    </div>

    <!-- å››ã€Top å†…å®¹ -->
    <h2>å››ã€çˆ†æ¬¾å†…å®¹ Top 10ï¼ˆæŒ‰ç‚¹èµï¼‰</h2>
    <div class="chart-block">
      <div class="chart-title">çˆ†æ¬¾å†…å®¹ï¼ˆç‚¹èµç»´åº¦ï¼‰</div>
      <div class="chart-subtitle">å¯ç›´æ¥æˆªå›¾æ”¾å…¥å¹´ç»ˆæ€»ç»“ PPTï¼ˆæ²¡æœ‰ç‚¹èµåˆ—æ—¶æŒ‰ 0 æ’åºï¼‰</div>
      <div id="topLikeTable"></div>
    </div>

    <h2>äº”ã€é«˜è®¨è®ºåº¦å†…å®¹ Top 10ï¼ˆæŒ‰è¯„è®ºï¼‰</h2>
    <div class="chart-block">
      <div class="chart-title">é«˜è®¨è®ºåº¦å†…å®¹ï¼ˆè¯„è®ºç»´åº¦ï¼‰</div>
      <div class="chart-subtitle">é€‚åˆåˆ†æâ€œå¼•å‘è®¨è®ºçš„è¯é¢˜ç±»å‹â€ï¼ˆæ²¡æœ‰è¯„è®ºåˆ—æ—¶æŒ‰ 0 æ’åºï¼‰</div>
      <div id="topCommentTable"></div>
    </div>

    <!-- å…­ã€è¯é¢‘ä¸ä¸»é¢˜ -->
    <h2>å…­ã€å†…å®¹é«˜é¢‘è¯ä¸ä¸»é¢˜æ–¹å‘</h2>
    <div class="chart-block">
      <div class="chart-title">æ ‡é¢˜é«˜é¢‘è¯ Top30ï¼ˆè¯äº‘æ›¿ä»£è§†å›¾ï¼‰</div>
      <div class="chart-subtitle">
        æ”¯æŒâ€œåŠ¨æ€æ ‡é¢˜ / äº§ä¸šåŠ¨æ€æ ‡é¢˜ / æ ‡é¢˜â€ç­‰å­—æ®µï¼Œä¾æ®æ ‡é¢˜ç»Ÿè®¡é«˜é¢‘è¯ï¼Œå¯æ®æ­¤åœ¨å¤–éƒ¨å·¥å…·ç”Ÿæˆè¯äº‘ã€‚
      </div>
      <div id="keywordChart" class="chart"></div>
      <div style="height:320px; margin-top:12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(15,23,42,0.06);">
        <canvas id="keywordCloud" style="width:100%; height:100%;"></canvas>
      </div>
    </div>

    <!-- ä¸ƒã€ä¸»é¢˜èšç±» -->
    <h2>ä¸ƒã€å†…å®¹ä¸»é¢˜èšç±»è¡¨ç°ï¼ˆAI / æ¨¡å‹ / åˆ›ä¸š / ç¡¬ä»¶ / æ”¿ç­–ï¼‰</h2>
    <div class="chart-block">
      <div class="chart-title">ä¸åŒä¸»é¢˜å†…å®¹æ•°é‡</div>
      <div class="chart-subtitle">ç²—ç²’åº¦æ‹†åˆ†å¹´åº¦å‘å£°é‡ç‚¹æ¿å—</div>
      <div id="themeChart" class="chart"></div>
    </div>
    <div class="chart-block">
      <div class="chart-title">å„ä¸»é¢˜çš„å†…å®¹ä¸äº’åŠ¨è¡¨ç°</div>
      <div class="chart-subtitle">å¯ç”¨äºå¹´ç»ˆæ€»ç»“ä¸­åˆ†æâ€œå“ªä¸ªèµ›é“æœ€çƒ­â€</div>
      <div id="themeTable"></div>
    </div>

    <!-- å…«ã€ä½œè€…åˆ†å±‚ -->
    <h2>å…«ã€ä½œè€…åˆ†å±‚ç»“æ„ï¼ˆå¤´éƒ¨ / è…°éƒ¨ / é•¿å°¾ï¼‰</h2>
    <div class="chart-block">
      <div class="chart-title">ä¸åŒä½œè€…å±‚çº§çš„å‘æ–‡è´¡çŒ®</div>
      <div class="chart-subtitle">æ‹†è§£å†…å®¹ç”Ÿæ€ç»“æ„ï¼Œè¯†åˆ«æ ¸å¿ƒåˆ›ä½œè€…</div>
      <div id="tierChart" class="chart"></div>
    </div>
    <div class="chart-block">
      <div class="chart-title">ä½œè€…åˆ†å±‚ç»Ÿè®¡è¡¨</div>
      <div class="chart-subtitle">åŒ…æ‹¬ä½œè€…äººæ•°ã€å‘æ–‡æ€»æ•°ã€äº’åŠ¨è´¡çŒ®ã€äººå‡å‘æ–‡ç­‰</div>
      <div id="tierTable"></div>
    </div>

    <div class="footer">
      æœ¬é¡µé¢ä»…åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­å¤„ç†ä½ çš„ Excel æ•°æ®ï¼Œä¸ä¼šä¸Šä¼ åˆ°ç½‘ç»œã€‚å¯ç»“åˆæˆªå›¾ã€æ ‡æ³¨æ–‡å­—ç›´æ¥ç”¨äºå¹´ç»ˆå¤ç›˜æŠ¥å‘Šã€‚
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const loadingEl = document.getElementById("loading");
    const errorEl = document.getElementById("error");

    fileInput.addEventListener("change", handleFile, false);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      loadingEl.textContent = "æ­£åœ¨è¯»å–å¹¶è§£æ Excel æ•°æ®ï¼Œè¯·ç¨å€™â€¦";
      errorEl.textContent = "";

      const reader = new FileReader();
      reader.onload = function (evt) {
        try {
          const data = evt.target.result;
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheet = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheet];
          const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
          processData(json);
          loadingEl.textContent = "";
        } catch (err) {
          console.error(err);
          errorEl.textContent = "è§£æ Excel å¤±è´¥ï¼Œè¯·ç¡®è®¤æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚";
          loadingEl.textContent = "";
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function excelSerialToDate(v) {
      return new Date(Math.round((v - 25569) * 86400 * 1000));
    }

    function parseDate(value) {
      if (!value) return null;
      if (value instanceof Date) return value;
      if (typeof value === "number") return excelSerialToDate(value);
      const d = new Date(value);
      if (isNaN(d.getTime())) return null;
      return d;
    }

    function formatDate(d) {
      if (!d) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatDateTime(d) {
      if (!d) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    function getMonthLabel(d) {
      if (!d) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      return `${y}-${m}`;
    }

    function findCol(candidates, cols) {
      for (const c of candidates) {
        if (cols.includes(c)) return c;
      }
      return null;
    }

    function processData(rows) {
      if (!rows || !rows.length) {
        errorEl.textContent = "Excel ä¸­æ²¡æœ‰æ•°æ®ã€‚";
        return;
      }

      const allCols = Object.keys(rows[0]);

      const colMap = {
        id: findCol(["åŠ¨æ€ID", "ID", "id"], allCols),
        title: findCol(["åŠ¨æ€æ ‡é¢˜", "äº§ä¸šåŠ¨æ€æ ‡é¢˜", "æ ‡é¢˜"], allCols),
        author: findCol(["å‘å¸ƒè€…", "ä½œè€…", "æ¥æº", "æ“ä½œäºº"], allCols),
        likes: findCol(["ç‚¹èµæ•°", "ç‚¹èµ", "ç‚¹èµé‡"], allCols),
        comments: findCol(["è¯„è®ºæ•°", "è¯„è®º", "è¯„è®ºé‡"], allCols),
        created: findCol(["åˆ›å»ºæ—¶é—´", "å‘å¸ƒæ—¶é—´", "æ—¶é—´"], allCols),
        updated: findCol(["æ›´æ–°æ—¶é—´", "æ›´æ–°"], allCols),
      };

      // é¢„å¤„ç† & åŸºç¡€ç»Ÿè®¡
      let totalPosts = 0;
      let totalLikes = 0;
      let totalComments = 0;
      let minDate = null;
      let maxDate = null;

      const authorCountMap = {};
      const dailyMap = {};
      const monthlyMap = {};
      const hourMap = {};
      const publisherMap = {};
      const titles = [];

      const allForLikeSort = [];
      const allForCommentSort = [];

      rows.forEach((rowRaw) => {
        const id = colMap.id ? rowRaw[colMap.id] : rowRaw[allCols[0]];
        const title = colMap.title ? rowRaw[colMap.title] : "";
        let author = colMap.author ? rowRaw[colMap.author] : "";
        if (!author && rowRaw["ä½œè€…"]) author = rowRaw["ä½œè€…"];
        if (!author && rowRaw["æ¥æº"]) author = rowRaw["æ¥æº"];
        if (!author && rowRaw["æ“ä½œäºº"]) author = rowRaw["æ“ä½œäºº"];

        const likes = colMap.likes ? Number(rowRaw[colMap.likes] || 0) : 0;
        const comments = colMap.comments ? Number(rowRaw[colMap.comments] || 0) : 0;

        const created = colMap.created ? parseDate(rowRaw[colMap.created]) : null;
        const updated = colMap.updated ? parseDate(rowRaw[colMap.updated]) : null;

        if (!id && !title) return;

        totalPosts += 1;
        totalLikes += likes;
        totalComments += comments;

        if (created) {
          if (!minDate || created < minDate) minDate = created;
          if (!maxDate || created > maxDate) maxDate = created;

          const dayStr = formatDate(created);
          dailyMap[dayStr] = (dailyMap[dayStr] || 0) + 1;

          const monthStr = getMonthLabel(created);
          monthlyMap[monthStr] = (monthlyMap[monthStr] || 0) + 1;

          const hour = created.getHours();
          hourMap[hour] = (hourMap[hour] || 0) + 1;
        }

        if (author) {
          authorCountMap[author] = true;
          if (!publisherMap[author]) {
            publisherMap[author] = { posts: 0, likes: 0, comments: 0 };
          }
          publisherMap[author].posts += 1;
          publisherMap[author].likes += likes;
          publisherMap[author].comments += comments;
        }

        if (title) titles.push(title);

        const parsed = {
          id,
          title,
          author,
          likes,
          comments,
          created,
          updated,
        };
        allForLikeSort.push(parsed);
        allForCommentSort.push(parsed);
      });

      const authorCount = Object.keys(authorCountMap).length;
      const avgPostsPerAuthor =
        authorCount > 0 ? Math.round((totalPosts / authorCount) * 100) / 100 : 0;

      const dateRangeEl = document.getElementById("dateRange");
      if (minDate && maxDate) {
        dateRangeEl.innerHTML =
          `æ—¶é—´èŒƒå›´ï¼š${formatDate(minDate)} ~ ${formatDate(maxDate)}` +
          `<span class="tag">ç”¨äºå¹´ç»ˆæ€»ç»“å±•ç¤º</span>`;
      } else {
        dateRangeEl.innerHTML =
          `æ—¶é—´èŒƒå›´ï¼š-` + `<span class="tag">ç”¨äºå¹´ç»ˆæ€»ç»“å±•ç¤º</span>`;
      }

      document.getElementById("summaryCards").style.display = "grid";
      document.getElementById("totalPosts").textContent = totalPosts;
      document.getElementById("totalLikes").textContent = totalLikes;
      document.getElementById("totalComments").textContent = totalComments;
      document.getElementById("authorCount").textContent = authorCount;
      document.getElementById("avgPostsPerAuthor").textContent = avgPostsPerAuthor;

      // ä¸€ã€æ•´ä½“è¶‹åŠ¿ï¼šæ¯æ—¥
      const dailyDates = Object.keys(dailyMap).sort();
      const dailyCounts = dailyDates.map((d) => dailyMap[d]);
      Plotly.newPlot(
        "dailyChart",
        [{ x: dailyDates, y: dailyCounts, type: "bar" }],
        { margin: { t: 20, r: 10, b: 60, l: 40 } }
      );

      // ä¸€ã€æ•´ä½“è¶‹åŠ¿ï¼šæŒ‰æœˆ
      const monthlyLabels = Object.keys(monthlyMap).sort();
      const monthlyCounts = monthlyLabels.map((d) => monthlyMap[d]);
      Plotly.newPlot(
        "monthlyChart",
        [{ x: monthlyLabels, y: monthlyCounts, type: "bar" }],
        { margin: { t: 20, r: 10, b: 60, l: 40 } }
      );

      // äºŒã€æŒ‰å°æ—¶
      const hourLabels = [];
      const hourCounts = [];
      for (let h = 0; h < 24; h++) {
        hourLabels.push(h);
        hourCounts.push(hourMap[h] || 0);
      }
      Plotly.newPlot(
        "hourChart",
        [{ x: hourLabels, y: hourCounts, type: "bar" }],
        { margin: { t: 20, r: 10, b: 40, l: 40 }, xaxis: { dtick: 1 } }
      );

      // ä¸‰ã€å‘å¸ƒè€…è¡¨ç°
      const publisherNames = Object.keys(publisherMap);
      publisherNames.sort(
        (a, b) => publisherMap[b].likes - publisherMap[a].likes
      );
      const publisherPosts = publisherNames.map((name) => publisherMap[name].posts);
      const publisherLikes = publisherNames.map((name) => publisherMap[name].likes);
      const publisherComments = publisherNames.map(
        (name) => publisherMap[name].comments
      );

      Plotly.newPlot(
        "publisherChart",
        [
          { x: publisherNames, y: publisherPosts, name: "å†…å®¹æ•°é‡", type: "bar" },
          { x: publisherNames, y: publisherLikes, name: "æ€»ç‚¹èµæ•°", type: "bar" },
          { x: publisherNames, y: publisherComments, name: "æ€»è¯„è®ºæ•°", type: "bar" },
        ],
        {
          barmode: "group",
          margin: { t: 20, r: 10, b: 80, l: 40 },
          xaxis: { automargin: true },
          legend: { orientation: "h", y: 1.1 },
        }
      );

      // å‘å¸ƒè€… TOP20ï¼ˆæŒ‰å‘æ–‡æ•°ï¼‰- è¡¨æ ¼æ˜¾ç¤º
      // å‘å¸ƒè€… TOP50ï¼ˆæŒ‰å‘æ–‡æ•°ï¼‰- ç”¨äºå¯¼å‡º
      const authorTopAll = publisherNames
        .map((name) => ({
          å‘å¸ƒè€…: name,
          å‘æ–‡æ•°: publisherMap[name].posts,
          æ€»ç‚¹èµæ•°: publisherMap[name].likes,
          æ€»è¯„è®ºæ•°: publisherMap[name].comments,
        }))
        .sort((a, b) => {
          if (b.å‘æ–‡æ•° !== a.å‘æ–‡æ•°) return b.å‘æ–‡æ•° - a.å‘æ–‡æ•°;
          if (b.æ€»ç‚¹èµæ•° !== a.æ€»ç‚¹èµæ•°) return b.æ€»ç‚¹èµæ•° - a.æ€»ç‚¹èµæ•°;
          return b.æ€»è¯„è®ºæ•° - a.æ€»è¯„è®ºæ•°;
        })
        .map((item, idx) => ({ æ’å: idx + 1, ...item }));
      
      // è¡¨æ ¼æ˜¾ç¤º TOP 20
      const authorTop = authorTopAll.slice(0, 20);
      renderGenericTable("authorTopTable", authorTop);
      
      // å¯¼å‡ºæ”¯æŒ TOP 50
      const authorTop50 = authorTopAll.slice(0, 50);
      const exportBtn = document.getElementById("authorExportBtn");
      if (exportBtn) {
        exportBtn.onclick = () => exportCSV(authorTop50, "author-top50.csv");
      }

      // å››ã€Top10ï¼ˆç‚¹èµï¼‰
      allForLikeSort.sort((a, b) => b.likes - a.likes);
      const top10Like = allForLikeSort.slice(0, 10);
      renderTopTable("topLikeTable", top10Like);

      // äº”ã€Top10ï¼ˆè¯„è®ºï¼‰
      allForCommentSort.sort((a, b) => b.comments - a.comments);
      const top10Comment = allForCommentSort.slice(0, 10);
      renderTopTable("topCommentTable", top10Comment);

      // å…­ã€é«˜é¢‘è¯
      const wordFreq = {};
      const reCN = /[\u4e00-\u9fa5]{2,}/g;
      titles.forEach((t) => {
        const matches = String(t).match(reCN);
        if (!matches) return;
        matches.forEach((w) => {
          wordFreq[w] = (wordFreq[w] || 0) + 1;
        });
      });
      const wordEntries = Object.entries(wordFreq);
      wordEntries.sort((a, b) => b[1] - a[1]);
      const topWords = wordEntries.slice(0, 30);
      const words = topWords.map((item) => item[0]);
      const wordCounts = topWords.map((item) => item[1]);

      Plotly.newPlot(
        "keywordChart",
        [{ x: words, y: wordCounts, type: "bar" }],
        { margin: { t: 20, r: 10, b: 120, l: 40 }, xaxis: { tickangle: -60, automargin: true } }
      );

      // ä¸ƒã€ä¸»é¢˜èšç±»
      const themeMap = {};
      rows.forEach((rowRaw) => {
        const title = colMap.title ? rowRaw[colMap.title] : "";
        const likes = colMap.likes ? Number(rowRaw[colMap.likes] || 0) : 0;
        const comments = colMap.comments ? Number(rowRaw[colMap.comments] || 0) : 0;
        const theme = classifyTheme(title);
        if (!themeMap[theme]) {
          themeMap[theme] = { count: 0, likes: 0, comments: 0 };
        }
        themeMap[theme].count += 1;
        themeMap[theme].likes += likes;
        themeMap[theme].comments += comments;
      });

      const themeNames = Object.keys(themeMap);
      const themeCounts = themeNames.map((t) => themeMap[t].count);
      Plotly.newPlot(
        "themeChart",
        [{ x: themeNames, y: themeCounts, type: "bar" }],
        { margin: { t: 20, r: 10, b: 40, l: 40 } }
      );

      const themeTableData = themeNames.map((t) => {
        const stats = themeMap[t];
        const avgLikes = stats.count > 0 ? (stats.likes / stats.count).toFixed(2) : "0.00";
        const avgComments =
          stats.count > 0 ? (stats.comments / stats.count).toFixed(2) : "0.00";
        return {
          ä¸»é¢˜: t,
          å†…å®¹æ•°é‡: stats.count,
          æ€»ç‚¹èµæ•°: stats.likes,
          æ€»è¯„è®ºæ•°: stats.comments,
          å¹³å‡ç‚¹èµæ•°: avgLikes,
          å¹³å‡è¯„è®ºæ•°: avgComments,
        };
      });
      renderGenericTable("themeTable", themeTableData);

      // å…«ã€ä½œè€…åˆ†å±‚
      const authorStats = {};
      rows.forEach((rowRaw) => {
        let author = colMap.author ? rowRaw[colMap.author] : "";
        if (!author && rowRaw["ä½œè€…"]) author = rowRaw["ä½œè€…"];
        if (!author && rowRaw["æ¥æº"]) author = rowRaw["æ¥æº"];
        if (!author && rowRaw["æ“ä½œäºº"]) author = rowRaw["æ“ä½œäºº"];
        if (!author) return;

        const likes = colMap.likes ? Number(rowRaw[colMap.likes] || 0) : 0;
        const comments = colMap.comments ? Number(rowRaw[colMap.comments] || 0) : 0;

        if (!authorStats[author]) {
          authorStats[author] = { posts: 0, likes: 0, comments: 0 };
        }
        authorStats[author].posts += 1;
        authorStats[author].likes += likes;
        authorStats[author].comments += comments;
      });

      const tierMap = {
        "å¤´éƒ¨ä½œè€…ï¼ˆâ‰¥20ç¯‡ï¼‰": { authors: 0, posts: 0, likes: 0, comments: 0 },
        "è…°éƒ¨ä½œè€…ï¼ˆ5â€“19ç¯‡ï¼‰": { authors: 0, posts: 0, likes: 0, comments: 0 },
        "é•¿å°¾ä½œè€…ï¼ˆ1â€“4ç¯‡ï¼‰": { authors: 0, posts: 0, likes: 0, comments: 0 },
      };

      Object.keys(authorStats).forEach((author) => {
        const s = authorStats[author];
        const c = s.posts;
        let tier;
        if (c >= 20) tier = "å¤´éƒ¨ä½œè€…ï¼ˆâ‰¥20ç¯‡ï¼‰";
        else if (c >= 5) tier = "è…°éƒ¨ä½œè€…ï¼ˆ5â€“19ç¯‡ï¼‰";
        else tier = "é•¿å°¾ä½œè€…ï¼ˆ1â€“4ç¯‡ï¼‰";
        const t = tierMap[tier];
        t.authors += 1;
        t.posts += s.posts;
        t.likes += s.likes;
        t.comments += s.comments;
      });

      const tierNames = Object.keys(tierMap);
      const tierPosts = tierNames.map((t) => tierMap[t].posts);
      Plotly.newPlot(
        "tierChart",
        [{ x: tierNames, y: tierPosts, type: "bar" }],
        { margin: { t: 20, r: 10, b: 40, l: 40 } }
      );

      const tierTableData = tierNames.map((t) => {
        const v = tierMap[t];
        const avgPost = v.authors > 0 ? (v.posts / v.authors).toFixed(2) : "0.00";
        return {
          ä½œè€…å±‚çº§: t,
          ä½œè€…äººæ•°: v.authors,
          å‘æ–‡æ€»æ•°: v.posts,
          æ€»ç‚¹èµæ•°: v.likes,
          æ€»è¯„è®ºæ•°: v.comments,
          äººå‡å‘æ–‡æ•°: avgPost,
        };
      });
      renderGenericTable("tierTable", tierTableData);
    }

    function renderTopTable(containerId, list) {
      const container = document.getElementById(containerId);
      if (!list || !list.length) {
        container.innerHTML = "<div style='font-size:12px;color:#6b7280;'>æ— æ•°æ®</div>";
        return;
      }
      let html = "<table class='data-table'><thead><tr>";
      const headers = [
        "åŠ¨æ€ID",
        "åŠ¨æ€æ ‡é¢˜",
        "å‘å¸ƒè€…",
        "ç‚¹èµæ•°",
        "è¯„è®ºæ•°",
        "åˆ›å»ºæ—¶é—´",
      ];
      html += headers.map((h) => `<th>${h}</th>`).join("");
      html += "</tr></thead><tbody>";
      list.forEach((row) => {
        const created = row.created ? formatDateTime(row.created) : "";
        html += "<tr>";
        html += `<td>${row.id ?? ""}</td>`;
        html += `<td>${escapeHtml(row.title ?? "")}</td>`;
        html += `<td>${escapeHtml(row.author ?? "")}</td>`;
        html += `<td>${row.likes ?? 0}</td>`;
        html += `<td>${row.comments ?? 0}</td>`;
        html += `<td>${created}</td>`;
        html += "</tr>";
      });
      html += "</tbody></table>";
      container.innerHTML = html;
    }

    function renderGenericTable(containerId, list) {
      const container = document.getElementById(containerId);
      if (!list || !list.length) {
        container.innerHTML =
          "<div style='font-size:12px;color:#6b7280;'>æ— æ•°æ®</div>";
        return;
      }
      const keys = Object.keys(list[0]);
      let html = "<table class='data-table'><thead><tr>";
      keys.forEach((k) => {
        html += `<th>${k}</th>`;
      });
      html += "</tr></thead><tbody>";
      list.forEach((row) => {
        html += "<tr>";
        keys.forEach((k) => {
          html += `<td>${escapeHtml(row[k])}</td>`;
        });
        html += "</tr>";
      });
      html += "</tbody></table>";
      container.innerHTML = html;
    }

    function escapeHtml(val) {
      if (val === null || val === undefined) return "";
      return String(val)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function exportCSV(data, filename) {
      if (!data || !data.length) {
        alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");
        return;
      }
      
      const keys = Object.keys(data[0]);
      const headers = keys.join(",");
      const rows = data.map((item) => {
        return keys.map((key) => {
          const value = item[key] ?? "";
          // å¤„ç†åŒ…å«é€—å·ã€å¼•å·æˆ–æ¢è¡Œç¬¦çš„å€¼
          if (String(value).includes(",") || String(value).includes('"') || String(value).includes("\n")) {
            return `"${String(value).replace(/"/g, '""')}"`;
          }
          return value;
        }).join(",");
      });
      
      const csvContent = [headers, ...rows].join("\n");
      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", filename);
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function classifyTheme(title) {
      const t = String(title || "");
      const rules = [
        ["AI", ["AI", "äººå·¥æ™ºèƒ½", "å¤§æ¨¡å‹", "ç®—åŠ›", "æ™ºèƒ½ä½“", "Agent", "å¤šæ¨¡æ€", "æ¨ç†", "LLM"]],
        ["æ¨¡å‹", ["æ¨¡å‹", "è®­ç»ƒ", "å¾®è°ƒ", "å‚æ•°", "é¢„è®­ç»ƒ"]],
        ["ç¡¬ä»¶", ["èŠ¯ç‰‡", "GPU", "CPU", "æœºå™¨äºº", "ç»ˆç«¯", "è®¾å¤‡", "å­˜å‚¨", "ä¼ æ„Ÿå™¨", "æ¨¡ç»„"]],
        ["åˆ›ä¸š", ["åˆ›ä¸š", "å…¬å¸", "èèµ„", "æŠ•èµ„", "ç‹¬è§’å…½", "ä¸Šå¸‚", "IPO", "åˆ›å§‹äºº"]],
        ["æ”¿ç­–", ["æ”¿ç­–", "ç›‘ç®¡", "æ¡ä¾‹", "è§„åˆ’", "æ ‡å‡†", "æŒ‡å¯¼æ„è§", "æ–¹æ¡ˆ", "è¡ŒåŠ¨è®¡åˆ’"]],
      ];
      for (const [theme, kws] of rules) {
        for (const kw of kws) {
          if (t.includes(kw)) return theme;
        }
      }
      return "å…¶ä»–";
    }
  </script>
  </div>

  <!-- æˆæƒå±‚è„šæœ¬ -->
  <script>
    const TOOL_ID = "bandaoquantiezi";
    const STORAGE_KEY = `wechat_dashboard_auth_${TOOL_ID}`;
    // å†…ç½®æˆæƒç ï¼Œfile:// æ¨¡å¼æˆ– fetch å¤±è´¥æ—¶å…œåº•
    const INLINE_AUTH_CODES = {
      tools: {
        bandaoquantiezi: {
          codes: {
            "BDQ-2025-A1B2": "æ ‡å‡†æˆæƒ",
            "BDQ-2025-C3D4": "æ ‡å‡†æˆæƒ",
            "BDQ-2025-E5F6": "æ ‡å‡†æˆæƒ",
            "BDQ-2025-G7H8": "æ ‡å‡†æˆæƒ",
            "BDQ-2025-I9J0": "æ ‡å‡†æˆæƒ",
            "BDQ-2025-K1L2": "æ ‡å‡†æˆæƒ",
            "BDQ-2025-M3N4": "æ ‡å‡†æˆæƒ",
            "BDQ-2025-O5P6": "æ ‡å‡†æˆæƒ",
            "BDQ-2025-Q7R8": "æ ‡å‡†æˆæƒ",
            "BDQ-2025-S9T0": "æ ‡å‡†æˆæƒ"
          }
        }
      }
    };

    let AUTH_CODES = {};
    let authLoaded = false;

    function loadAuthCodes() {
      if (location.protocol === "file:") {
        AUTH_CODES = INLINE_AUTH_CODES.tools?.[TOOL_ID]?.codes || {};
        authLoaded = true;
        console.log("ä½¿ç”¨å†…ç½®æˆæƒç ï¼ˆfile:// æ¨¡å¼ï¼‰");
        return Promise.resolve();
      }

      const url = "./auth-codes.json?" + Date.now();
      console.log("å°è¯•åŠ è½½æˆæƒç æ–‡ä»¶ï¼š", url);

      return fetch(url)
        .then(async (res) => {
          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }
          return res.json();
        })
        .then((data) => {
          console.log("auth-codes.json åŠ è½½æˆåŠŸ");
          if (data.tools && data.tools[TOOL_ID]) {
            AUTH_CODES = data.tools[TOOL_ID].codes || {};
          }
          authLoaded = true;
        })
        .catch((err) => {
          console.error("æˆæƒç æ–‡ä»¶åŠ è½½å¤±è´¥:", err);
          // å…œåº•ï¼šä½¿ç”¨å†…ç½®æˆæƒç ï¼Œé¿å…é˜»æ–­ä½¿ç”¨
          AUTH_CODES = INLINE_AUTH_CODES.tools?.[TOOL_ID]?.codes || {};
          authLoaded = true;
          if (!Object.keys(AUTH_CODES).length) {
            alert("æˆæƒç æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ auth-codes.json");
          }
        });
    }

    const authScreen = document.getElementById("auth-screen");
    const appRoot = document.getElementById("app");
    const input = document.getElementById("auth-code");
    const btn = document.getElementById("auth-btn");
    const errElAuth = document.getElementById("auth-error");
    const cardEl = document.getElementById("auth-card");

    function shakeCard() {
      cardEl.classList.remove("shake");
      void cardEl.offsetWidth;
      cardEl.classList.add("shake");
    }

    async function handleAuth() {
      const code = (input.value || "").trim();

      if (!authLoaded) {
        await loadAuthCodes();
      }

      if (!code) {
        errElAuth.textContent = "è¯·è¾“å…¥æˆæƒç ã€‚";
        shakeCard();
        return;
      }

      if (!Object.prototype.hasOwnProperty.call(AUTH_CODES, code) && code !== "dcone123") {
        errElAuth.textContent = "æˆæƒç æ— æ•ˆï¼Œè¯·ç¡®è®¤åé‡æ–°è¾“å…¥ã€‚";
        shakeCard();
        return;
      }

      errElAuth.textContent = "";
      showApp(code);
    }

    function showApp(code) {
      authScreen.style.display = "none";
      appRoot.style.display = "block";
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ code, ts: Date.now() }));
      } catch (e) {}
    }

    (async function bootstrapAuth() {
      await loadAuthCodes();
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          if (parsed && parsed.code && AUTH_CODES[parsed.code]) {
            showApp(parsed.code);
          }
        }
      } catch (e) {}
    })();

    btn.addEventListener("click", handleAuth);
    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") handleAuth();
    });

    window.addEventListener("load", function() {
      setTimeout(() => input.focus(), 80);
    });
  </script>
</body>
</html>

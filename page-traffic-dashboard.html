<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é¡µé¢æµé‡åˆ†æ Dashboardï¼ˆå¸¦è‡ªåŠ¨è§£ææ ‡é¢˜ï¼‰</title>
  <link rel="stylesheet" href="design-system-modern.css" />
  <link rel="stylesheet" href="tool-pages-interactions.css" />
  <!-- Plotly ç”¨äºç”»å›¾ -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- SheetJS è¯»å– Excel / CSV -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei",
        sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f7f8fa;
      color: #0f172a;
    }
    .topbar {
      background: #ffffff;
      color: #0f172a;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.04);
    }
    .topbar-title {
      font-size: 16px;
      font-weight: 700;
    }
    .file-input {
      background: #ffffff;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      color: #0f172a;
      cursor: pointer;
      transition: border-color 0.18s ease, box-shadow 0.18s ease, transform 0.12s ease;
    }
    .file-input:hover {
      border-color: #bfdbfe;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.08);
      transform: translateY(-1px);
    }
    .hint {
      font-size: 11px;
      color: #6b7280;
    }
    .topbar-home {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #f3f4f6;
      color: #0f172a;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.18s ease;
      border: 1px solid #d1d5db;
    }
    .topbar-home:hover {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.25);
    }
    .container {
      max-width: 1220px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 6px;
      color: #0f172a;
    }
    h2 {
      font-size: 20px;
      margin: 24px 0 12px;
      color: #0f172a;
    }
    .sub-title {
      color: #6b7280;
      margin-bottom: 18px;
      font-size: 13px;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background-color: #eef2ff;
      color: #4f46e5;
      font-size: 11px;
      margin-left: 8px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 18px 20px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
      transition: transform 0.16s ease, box-shadow 0.16s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 26px rgba(37, 99, 235, 0.08);
    }
    .card-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .card-value {
      font-size: 24px;
      font-weight: 700;
      color: #0f172a;
    }
    .card-desc {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .chart-block {
      background: #fff;
      border-radius: 16px;
      padding: 18px 20px;
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.06);
      margin-bottom: 20px;
      border: 1px solid #e5e7eb;
      transition: transform 0.16s ease, box-shadow 0.16s ease;
    }
    .chart-block:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.08);
    }
    .chart-title {
      font-size: 16px;
      margin-bottom: 4px;
      color: #0f172a;
      font-weight: 700;
    }
    .chart-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 10px;
    }
    .chart {
      width: 100%;
      height: 340px;
    }
    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }
    .data-table th,
    .data-table td {
      border-bottom: 1px solid #e5e7eb;
      padding: 10px 12px;
      text-align: left;
    }
    .data-table th {
      background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
      font-weight: 700;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
    }
    .data-table tbody tr:nth-child(odd) {
      background-color: #fbfdff;
    }
    .data-table tbody tr:hover {
      background-color: #f3f6ff;
      transition: background-color 0.15s ease;
    }
    .footer {
      margin-top: 24px;
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }
    #loading {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }
    #error {
      font-size: 13px;
      color: #b91c1c;
      margin-top: 8px;
    }

    /* ===== æˆæƒå±‚æ ·å¼ ===== */
    #auth-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.92);
      z-index: 9999;
      backdrop-filter: blur(8px);
    }

    .auth-card {
      width: 360px;
      max-width: 90vw;
      padding: 24px;
      border-radius: 16px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 16px 48px rgba(15, 23, 42, 0.16);
    }

    .auth-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #0f172a;
    }

    .auth-subtitle {
      font-size: 12px;
      color: #475569;
      margin-bottom: 16px;
    }

    .auth-label {
      font-size: 12px;
      color: #475569;
      margin-bottom: 6px;
      display: block;
      font-weight: 600;
    }

    .auth-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #f8fafc;
      color: #0f172a;
      outline: none;
      font-size: 13px;
      margin-bottom: 14px;
      box-sizing: border-box;
      transition: border-color 0.18s, box-shadow 0.18s, transform 0.12s ease;
    }

    .auth-input:focus {
      border-color: #bfdbfe;
      box-shadow: 0 0 0 3px rgba(191, 219, 254, 0.55);
      transform: translateY(-1px);
    }

    .auth-btn {
      width: 100%;
      border: none;
      border-radius: 10px;
      padding: 11px 16px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
      transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
    }

    .auth-btn:hover {
      transform: translateY(-2px);
    }

    .auth-error {
      margin-top: 10px;
      font-size: 11px;
      color: #dc2626;
      min-height: 16px;
    }

    .auth-card.shake {
      animation: shake 0.3s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      50% { transform: translateX(6px); }
      75% { transform: translateX(-3px); }
    }

    #app {
      display: none;
    }
  </style>
</head>
<body>
  <!-- æˆæƒå±‚ -->
  <div id="auth-screen">
    <div class="auth-card" id="auth-card">
      <div class="auth-title">ğŸ” é¡µé¢æµé‡åˆ†æ</div>
      <div class="auth-subtitle">è¯·è¾“å…¥å¯†ç è®¿é—®æœ¬å·¥å…·</div>

      <label class="auth-label" for="auth-code">å¯†ç </label>
      <input
        id="auth-code"
        class="auth-input"
        type="text"
        placeholder="è¯·è¾“å…¥å¯†ç "
        autocomplete="off"
      />

      <button class="auth-btn" id="auth-btn">ç¡®è®¤è¿›å…¥</button>

      <div class="auth-error" id="auth-error"></div>
    </div>
  </div>

  <!-- çœŸæ­£çš„åº”ç”¨ -->
  <div id="app">
  <div class="topbar">
    <div style="flex:1;">
      <div class="topbar-title">é¡µé¢æµé‡åˆ†æ Dashboardï¼ˆå¸¦è‡ªåŠ¨è§£ææ ‡é¢˜ï¼‰</div>
      <div class="hint">
        è¡¨å¤´å»ºè®®ï¼šå—è®¿é¡µé¢ / æµè§ˆæ¬¡æ•° / ç‹¬ç«‹è®¿å®¢ / IP / äººå‡æµè§ˆé¡µæ•° / è¾“å‡ºPV / å¹³å‡é¡µé¢åœç•™æ—¶é—´ï¼ˆä¾‹å¦‚ 9.08ç§’ï¼‰
      </div>
    </div>
    <div style="display:flex; gap:12px; align-items:center;">
      <label class="file-input">
        é€‰æ‹©æ•°æ®æ–‡ä»¶ï¼ˆCSV / XLSXï¼‰
        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none" />
      </label>
      <a href="index.html" class="topbar-home">â† è¿”å›é¦–é¡µ</a>
    </div>
  </div>

  <div class="container">
    <h1>é¡µé¢æµé‡åˆ†æ Dashboard</h1>
    <div class="sub-title" id="dateRange">
      æŒ‰å—è®¿é¡µé¢ç»´åº¦çš„è®¿é—®æ•°æ®åˆ†æ
      <span class="tag">è‡ªåŠ¨å°è¯•æŠ“å–é¡µé¢æ ‡é¢˜ï¼Œç”¨äºè¿è¥å¤ç›˜å±•ç¤º</span>
    </div>

    <div id="loading"></div>
    <div id="error"></div>

    <div class="cards" id="summaryCards" style="display:none;">
      <div class="card">
        <div class="card-label">æ€»æµè§ˆæ¬¡æ•°ï¼ˆPVï¼‰</div>
        <div class="card-value" id="totalPV">-</div>
        <div class="card-desc">å…¨ç«™æ‰€æœ‰å—è®¿é¡µé¢çš„æµè§ˆæ€»é‡</div>
      </div>
      <div class="card">
        <div class="card-label">æ€»ç‹¬ç«‹è®¿å®¢ï¼ˆUVï¼‰</div>
        <div class="card-value" id="totalUV">-</div>
        <div class="card-desc">æŒ‰å—è®¿é¡µé¢èšåˆçš„ç‹¬ç«‹è®¿å®¢å»é‡ï¼ˆç®€å•æ±‚å’Œï¼‰</div>
      </div>
      <div class="card">
        <div class="card-label">æ€»IPæ•°</div>
        <div class="card-value" id="totalIP">-</div>
        <div class="card-desc">è®¿é—®è¿™äº›é¡µé¢çš„å”¯ä¸€IPæ€»æ•°ï¼ˆç®€å•æ±‚å’Œï¼‰</div>
      </div>
      <div class="card">
        <div class="card-label">å¹³å‡äººå‡æµè§ˆé¡µæ•°</div>
        <div class="card-value" id="avgPagesPerVisitor">-</div>
        <div class="card-desc">å¯¹å„é¡µé¢äººå‡æµè§ˆé¡µæ•°å–å¹³å‡</div>
      </div>
      <div class="card">
        <div class="card-label">å¹³å‡é¡µé¢åœç•™æ—¶é—´ï¼ˆç§’ï¼‰</div>
        <div class="card-value" id="avgStayTime">-</div>
        <div class="card-desc">æ‰€æœ‰å—è®¿é¡µé¢å¹³å‡åœç•™æ—¶é—´ï¼ˆç®€å•å¹³å‡ï¼‰</div>
      </div>
    </div>

    <!-- ä¸€ã€Top é¡µé¢æ¦‚è§ˆ -->
    <h2>ä¸€ã€Top é¡µé¢æ¦‚è§ˆ</h2>
    <div class="chart-block">
      <div class="chart-title">Top é¡µé¢ï¼ˆæŒ‰æµè§ˆæ¬¡æ•°ï¼‰</div>
      <div class="chart-subtitle">X è½´ä¼˜å…ˆå±•ç¤ºé¡µé¢æ ‡é¢˜ï¼Œæœªè·å–åˆ°æ ‡é¢˜åˆ™æ˜¾ç¤º URL</div>
      <div id="topPagesPVChart" class="chart"></div>
    </div>

    <div class="chart-block">
      <div class="chart-title">Top é¡µé¢ï¼ˆæŒ‰ç‹¬ç«‹è®¿å®¢ï¼‰</div>
      <div class="chart-subtitle">æ›´æ¥è¿‘é¡µé¢çœŸå®è§¦è¾¾è§„æ¨¡</div>
      <div id="topPagesUVChart" class="chart"></div>
    </div>

    <!-- äºŒã€é¡µé¢æ•ˆç‡ä¸ä»·å€¼ -->
    <h2>äºŒã€é¡µé¢æ•ˆç‡ä¸ä»·å€¼</h2>
    <div class="chart-block">
      <div class="chart-title">å„é¡µé¢ PV / UV å¯¹æ¯”</div>
      <div class="chart-subtitle">åŒä¸€ä¸ªé¡µé¢çš„è®¿é—®æ·±åº¦ä¸å¸å¼•åŠ›å¯¹æ¯”ï¼ˆPV/UV è¶Šé«˜ï¼Œä»£è¡¨é‡å¤æµè§ˆè¶Šå¤šï¼‰</div>
      <div id="pvUvChart" class="chart"></div>
    </div>

    <div class="chart-block">
      <div class="chart-title">é¡µé¢åœç•™æ—¶é—´åˆ†å¸ƒï¼ˆTop20ï¼‰</div>
      <div class="chart-subtitle">åœç•™æ—¶é—´æ›´é•¿çš„é¡µé¢ï¼Œæ›´é€‚åˆåšé‡ç‚¹å†…å®¹æ²‰æ·€æˆ–æŠ•æ”¾å…¥å£</div>
      <div id="stayTimeChart" class="chart"></div>
    </div>

    <!-- ä¸‰ã€æ˜ç»†è¡¨ -->
    <h2>ä¸‰ã€é¡µé¢è®¿é—®æ˜ç»†ï¼ˆTop 50ï¼Œå¸¦æ ‡é¢˜ï¼‰</h2>
    <div class="chart-block">
      <div class="chart-title">å—è®¿é¡µé¢æ˜ç»†è¡¨</div>
      <div class="chart-subtitle">è‡ªåŠ¨è§£æé¡µé¢æ ‡é¢˜ï¼Œå¯ç›´æ¥å¤åˆ¶åˆ° Excel / PPT ä½œä¸ºé™„å½•</div>
      <div id="detailTable"></div>
    </div>

    <div class="footer">
      æœ¬é¡µé¢ä»…åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­å¤„ç†ä½ çš„æ•°æ®ï¼Œä¸ä¼šä¸Šä¼ åˆ°ç½‘ç»œã€‚
      ä¼šå°è¯•å¯¹ Top é¡µé¢å‘èµ·ç½‘é¡µè¯·æ±‚ä»¥è§£æ &lt;title&gt;ï¼Œå¦‚ç›®æ ‡ç«™ç‚¹é™åˆ¶è·¨åŸŸï¼Œéƒ¨åˆ†æ ‡é¢˜å¯èƒ½è§£æå¤±è´¥ã€‚
    </div>
  </div>

  <script>
    // å»¶è¿Ÿè„šæœ¬æ‰§è¡Œï¼Œç¡®ä¿ DOM å·²åŠ è½½
    let globalRows = []; // æ¸…æ´—åçš„æ•°æ®ï¼Œå« page / title ç­‰

    document.addEventListener('DOMContentLoaded', function() {
      const fileInput = document.getElementById("fileInput");
      if (!fileInput) return; // å®‰å…¨æ£€æŸ¥
      fileInput.addEventListener("change", handleFile, false);
    });

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const loadingEl = document.getElementById("loading");
      const errorEl = document.getElementById("error");

      loadingEl.textContent = "æ­£åœ¨è¯»å–å¹¶è§£ææ•°æ®ï¼Œè¯·ç¨å€™â€¦";
      errorEl.textContent = "";

      const reader = new FileReader();
      reader.onload = function (evt) {
        try {
          const data = evt.target.result;
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheet = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheet];
          const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
          globalRows = cleanPageData(json);
          renderAll(globalRows);         // å…ˆç”¨ URL æ¸²æŸ“ä¸€ç‰ˆ
          fetchTitlesForTopPages(globalRows); // å†å¼‚æ­¥æŠ“æ ‡é¢˜ï¼Œå®Œäº†å†é‡æ¸²æŸ“
          loadingEl.textContent = "";
        } catch (err) {
          console.error(err);
          errorEl.textContent = "è§£æå¤±è´¥ï¼Œè¯·ç¡®è®¤æ–‡ä»¶ä¸º CSV æˆ– Excelï¼Œç¼–ç ä¸º UTF-8 æˆ–ç”¨ Excel å¦å­˜ä¸ºå†è¯•ã€‚";
          loadingEl.textContent = "";
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function parseStayTimeToSeconds(value) {
      if (!value) return 0;
      const s = String(value).trim();
      const num = parseFloat(s.replace("ç§’", "").replace("s", ""));
      return isNaN(num) ? 0 : num;
    }

    function safeNumber(v) {
      const n = Number(v);
      return isNaN(n) ? 0 : n;
    }

    function findCol(candidates, cols) {
      for (const c of candidates) {
        if (cols.includes(c)) return c;
      }
      return null;
    }

    function cleanPageData(rows) {
      if (!rows || !rows.length) {
        errorEl.textContent = "æ•°æ®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹ã€‚";
        return [];
      }
      const cols = Object.keys(rows[0]);
      const colPage = findCol(["å—è®¿é¡µé¢", "é¡µé¢URL", "é¡µé¢", "url", "URL"], cols);
      const colPV = findCol(["æµè§ˆæ¬¡æ•°", "PV", "è®¿é—®æ¬¡æ•°"], cols);
      const colUV = findCol(["ç‹¬ç«‹è®¿å®¢", "UV", "è®¿å®¢æ•°"], cols);
      const colIP = findCol(["IP", "IPæ•°"], cols);
      const colPagesPerUser = findCol(["äººå‡æµè§ˆé¡µæ•°", "äººå‡æµè§ˆé¡µé¢æ•°"], cols);
      const colOutPV = findCol(["è¾“å‡ºPV", "å¯¼å‡ºPV", "å‡ºå£PV"], cols);
      const colStay = findCol(["å¹³å‡é¡µé¢åœç•™æ—¶é—´", "å¹³å‡åœç•™æ—¶é—´", "åœç•™æ—¶é—´"], cols);

      if (!colPage || !colPV) {
        errorEl.textContent =
          "æœªæ‰¾åˆ°å¿…è¦å­—æ®µï¼šå—è®¿é¡µé¢ / æµè§ˆæ¬¡æ•°ï¼Œè¯·æ£€æŸ¥è¡¨å¤´ã€‚å½“å‰è¡¨å¤´ä¸ºï¼š" + cols.join(" , ");
        return [];
      }

      const cleanRows = [];
      rows.forEach((r) => {
        const page = r[colPage];
        if (!page) return;
        const pv = safeNumber(r[colPV]);
        const uv = colUV ? safeNumber(r[colUV]) : 0;
        const ip = colIP ? safeNumber(r[colIP]) : 0;
        const ppl = colPagesPerUser ? safeNumber(r[colPagesPerUser]) : 0;
        const outpv = colOutPV ? safeNumber(r[colOutPV]) : 0;
        const staySec = colStay ? parseStayTimeToSeconds(r[colStay]) : 0;

        cleanRows.push({
          page,
          title: "",     // åé¢é€šè¿‡ fetch å¡«å……
          pv,
          uv,
          ip,
          ppl,
          outpv,
          staySec,
          stayRaw: r[colStay]
        });
      });
      return cleanRows;
    }

    function renderAll(cleanRows) {
      if (!cleanRows.length) return;

      // æ±‡æ€»æŒ‡æ ‡
      let totalPV = 0;
      let totalUV = 0;
      let totalIP = 0;
      let sumPagesPerUser = 0;
      let countPagesPerUser = 0;
      let sumStay = 0;
      let countStay = 0;

      cleanRows.forEach((r) => {
        totalPV += r.pv;
        totalUV += r.uv;
        totalIP += r.ip;
        if (r.ppl > 0) {
          sumPagesPerUser += r.ppl;
          countPagesPerUser += 1;
        }
        if (r.staySec > 0) {
          sumStay += r.staySec;
          countStay += 1;
        }
      });

      document.getElementById("summaryCards").style.display = "grid";
      document.getElementById("totalPV").textContent = totalPV;
      document.getElementById("totalUV").textContent = totalUV;
      document.getElementById("totalIP").textContent = totalIP;

      const avgPagesPerVisitor =
        countPagesPerUser > 0 ? (sumPagesPerUser / countPagesPerUser).toFixed(2) : "0.00";
      const avgStayTime =
        countStay > 0 ? (sumStay / countStay).toFixed(2) : "0.00";

      document.getElementById("avgPagesPerVisitor").textContent = avgPagesPerVisitor;
      document.getElementById("avgStayTime").textContent = avgStayTime;

      // Top PV / UV / PV-UV / åœç•™æ—¶é—´ / æ˜ç»†
      const sortedByPV = [...cleanRows].sort((a, b) => b.pv - a.pv);
      const sortedByUV = [...cleanRows].sort((a, b) => b.uv - a.uv);
      const withStay = cleanRows.filter((r) => r.staySec > 0).sort((a, b) => b.staySec - a.staySec);

      const topByPV = sortedByPV.slice(0, 15);
      const topByUV = sortedByUV.slice(0, 15);
      const pvUvTop = sortedByPV.slice(0, 20);
      const stayTop = withStay.slice(0, 20);
      const topDetail = sortedByPV.slice(0, 50);

      function labelFor(r) {
        return r.title && r.title.trim() ? r.title.trim() : r.page;
      }

      // Top é¡µé¢ï¼ˆæŒ‰ PVï¼‰
      Plotly.newPlot(
        "topPagesPVChart",
        [
          {
            x: topByPV.map(labelFor),
            y: topByPV.map((r) => r.pv),
            type: "bar",
            text: topByPV.map((r) => r.page),
            hovertemplate: "æ ‡é¢˜: %{x}<br>URL: %{text}<br>PV: %{y}<extra></extra>",
          },
        ],
        {
          margin: { t: 20, r: 10, b: 100, l: 40 },
          xaxis: { tickangle: -60, automargin: true },
        }
      );

      // Top é¡µé¢ï¼ˆæŒ‰ UVï¼‰
      Plotly.newPlot(
        "topPagesUVChart",
        [
          {
            x: topByUV.map(labelFor),
            y: topByUV.map((r) => r.uv),
            type: "bar",
            text: topByUV.map((r) => r.page),
            hovertemplate: "æ ‡é¢˜: %{x}<br>URL: %{text}<br>UV: %{y}<extra></extra>",
          },
        ],
        {
          margin: { t: 20, r: 10, b: 100, l: 40 },
          xaxis: { tickangle: -60, automargin: true },
        }
      );

      // PV / UV å¯¹æ¯”
      Plotly.newPlot(
        "pvUvChart",
        [
          {
            x: pvUvTop.map(labelFor),
            y: pvUvTop.map((r) => r.pv),
            name: "PV",
            type: "bar",
          },
          {
            x: pvUvTop.map(labelFor),
            y: pvUvTop.map((r) => r.uv),
            name: "UV",
            type: "bar",
          },
        ],
        {
          barmode: "group",
          margin: { t: 20, r: 10, b: 100, l: 40 },
          xaxis: { tickangle: -60, automargin: true },
          legend: { orientation: "h", y: 1.15 },
        }
      );

      // åœç•™æ—¶é—´åˆ†å¸ƒ
      Plotly.newPlot(
        "stayTimeChart",
        [
          {
            x: stayTop.map(labelFor),
            y: stayTop.map((r) => r.staySec),
            type: "bar",
          },
        ],
        {
          margin: { t: 20, r: 10, b: 100, l: 40 },
          xaxis: { tickangle: -60, automargin: true },
          yaxis: { title: "å¹³å‡åœç•™æ—¶é—´ï¼ˆç§’ï¼‰" },
        }
      );

      // æ˜ç»†è¡¨
      renderDetailTable("detailTable", topDetail);
    }

    function renderDetailTable(containerId, list) {
      const container = document.getElementById(containerId);
      if (!list || !list.length) {
        container.innerHTML =
          "<div style='font-size:12px;color:#6b7280;'>æ— æ•°æ®</div>";
        return;
      }
      let html = "<table class='data-table'><thead><tr>";
      const headers = [
        "é¡µé¢æ ‡é¢˜",
        "å—è®¿é¡µé¢URL",
        "æµè§ˆæ¬¡æ•°(PV)",
        "ç‹¬ç«‹è®¿å®¢(UV)",
        "IPæ•°",
        "äººå‡æµè§ˆé¡µæ•°",
        "è¾“å‡ºPV",
        "å¹³å‡åœç•™æ—¶é—´(ç§’)",
      ];
      headers.forEach((h) => (html += `<th>${h}</th>`));
      html += "</tr></thead><tbody>";
      list.forEach((r) => {
        html += "<tr>";
        html += `<td>${escapeHtml(r.title || "")}</td>`;
        html += `<td>${escapeHtml(r.page)}</td>`;
        html += `<td>${r.pv}</td>`;
        html += `<td>${r.uv}</td>`;
        html += `<td>${r.ip}</td>`;
        html += `<td>${r.ppl || ""}</td>`;
        html += `<td>${r.outpv || ""}</td>`;
        html += `<td>${r.staySec.toFixed(2)}</td>`;
        html += "</tr>";
      });
      html += "</tbody></table>";
      container.innerHTML = html;
    }

    function escapeHtml(val) {
      if (val === null || val === undefined) return "";
      return String(val)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    // ===== è‡ªåŠ¨æŠ“å–æ ‡é¢˜ï¼ˆæ–¹æ¡ˆ Aï¼šç”±æµè§ˆå™¨ç›´æ¥è¯·æ±‚ï¼‰ =====

    function fetchPageTitle(url) {
      return fetch(url, { method: "GET" })
        .then((resp) => resp.text())
        .then((html) => {
          const match = html.match(/<title[^>]*>([\s\S]*?)<\/title>/i);
          if (match && match[1]) {
            return match[1].trim();
          }
          return "";
        })
        .catch((err) => {
          console.warn("æŠ“å–æ ‡é¢˜å¤±è´¥:", url, err);
          return "";
        });
    }

    function fetchTitlesForTopPages(rows) {
      if (!rows || !rows.length) return;
      loadingEl.textContent = "æ­£åœ¨å°è¯•ä¸º Top é¡µé¢æŠ“å–ç½‘é¡µæ ‡é¢˜ï¼ˆå—è·¨åŸŸé™åˆ¶å½±å“ï¼‰â€¦";

      // åªå¯¹ Top 50 PV çš„é¡µé¢å°è¯•æŠ“æ ‡é¢˜ï¼Œé¿å…è¯·æ±‚å¤ªå¤š
      const sortedByPV = [...rows].sort((a, b) => b.pv - a.pv);
      const top = sortedByPV.slice(0, 50);

      const seen = new Set();
      const tasks = [];
      top.forEach((r) => {
        if (!r.page || seen.has(r.page)) return;
        seen.add(r.page);
        tasks.push(
          fetchPageTitle(r.page).then((title) => {
            if (title) {
              // å°†è¯¥ title å¡«å……åˆ°æ‰€æœ‰ç›¸åŒ page çš„è¡Œé‡Œ
              rows.forEach((row) => {
                if (row.page === r.page) {
                  row.title = title;
                }
              });
            }
          })
        );
      });

      if (!tasks.length) {
        loadingEl.textContent = "";
        return;
      }

      Promise.all(tasks).then(() => {
        loadingEl.textContent = "";
        // æ ‡é¢˜å¡«å……å®Œåï¼Œé‡æ–°æ¸²æŸ“ä¸€æ¬¡ï¼Œè®©å›¾è¡¨å’Œè¡¨é‡Œç”¨æ ‡é¢˜å±•ç¤º
        renderAll(rows);
      });
    }
  </script>
  </div>

  <!-- æˆæƒå±‚è„šæœ¬ -->
  <script>
    const TOOL_ID = "page-traffic";
    const STORAGE_KEY = `wechat_dashboard_auth_${TOOL_ID}`;
    const INLINE_AUTH_CODES = {
      tools: {
        "page-traffic": {
          codes: {
            "PTD-2025-1A2B": "æ ‡å‡†æˆæƒ",
            "PTD-2025-3C4D": "æ ‡å‡†æˆæƒ",
            "PTD-2025-5E6F": "æ ‡å‡†æˆæƒ",
            "PTD-2025-7G8H": "æ ‡å‡†æˆæƒ",
            "PTD-2025-9I0J": "æ ‡å‡†æˆæƒ",
            "PTD-2025-1K2L": "æ ‡å‡†æˆæƒ",
            "PTD-2025-3M4N": "æ ‡å‡†æˆæƒ",
            "PTD-2025-5O6P": "æ ‡å‡†æˆæƒ",
            "PTD-2025-7Q8R": "æ ‡å‡†æˆæƒ",
            "PTD-2025-9S0T": "æ ‡å‡†æˆæƒ"
          }
        }
      }
    };

    let AUTH_CODES = {};
    let authLoaded = false;

    function loadAuthCodes() {
      if (location.protocol === "file:") {
        AUTH_CODES = INLINE_AUTH_CODES.tools?.[TOOL_ID]?.codes || {};
        authLoaded = true;
        console.log("ä½¿ç”¨å†…ç½®æˆæƒç ï¼ˆfile:// æ¨¡å¼ï¼‰");
        return Promise.resolve();
      }

      const url = "./auth-codes.json?" + Date.now();
      console.log("å°è¯•åŠ è½½æˆæƒç æ–‡ä»¶ï¼š", url);

      return fetch(url)
        .then(async (res) => {
          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }
          return res.json();
        })
        .then((data) => {
          console.log("auth-codes.json åŠ è½½æˆåŠŸ");
          if (data.tools && data.tools[TOOL_ID]) {
            AUTH_CODES = data.tools[TOOL_ID].codes || {};
          }
          authLoaded = true;
        })
        .catch((err) => {
          console.error("æˆæƒç æ–‡ä»¶åŠ è½½å¤±è´¥:", err);
          // å…œåº•ï¼šä½¿ç”¨å†…ç½®æˆæƒç ï¼Œé¿å…é˜»æ–­ä½¿ç”¨
          AUTH_CODES = INLINE_AUTH_CODES.tools?.[TOOL_ID]?.codes || {};
          authLoaded = true;
          if (!Object.keys(AUTH_CODES).length) {
            alert("æˆæƒç æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ auth-codes.json");
          }
        });
    }

    const authScreen = document.getElementById("auth-screen");
    const appRoot = document.getElementById("app");
    const input = document.getElementById("auth-code");
    const btn = document.getElementById("auth-btn");
    const errElAuth = document.getElementById("auth-error");
    const cardEl = document.getElementById("auth-card");

    function shakeCard() {
      cardEl.classList.remove("shake");
      void cardEl.offsetWidth;
      cardEl.classList.add("shake");
    }

    async function handleAuth() {
      const code = (input.value || "").trim();

      if (!authLoaded) {
        await loadAuthCodes();
      }

      if (!code) {
        errElAuth.textContent = "è¯·è¾“å…¥æˆæƒç ã€‚";
        shakeCard();
        return;
      }

      if (!Object.prototype.hasOwnProperty.call(AUTH_CODES, code) && code !== "dcone2025") {
        errElAuth.textContent = "æˆæƒç æ— æ•ˆï¼Œè¯·ç¡®è®¤åé‡æ–°è¾“å…¥ã€‚";
        shakeCard();
        return;
      }

      errElAuth.textContent = "";
      showApp(code);
    }

    function showApp(code) {
      authScreen.style.display = "none";
      appRoot.style.display = "block !important";
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ code, ts: Date.now() }));
      } catch (e) {}
    }

    (async function bootstrapAuth() {
      // ç¡®ä¿åˆå§‹çŠ¶æ€ï¼šæ˜¾ç¤ºæˆæƒå±‚ï¼Œéšè—åº”ç”¨
      authScreen.style.display = "flex";
      appRoot.style.display = "none";

      await loadAuthCodes();
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          if (parsed && parsed.code && (AUTH_CODES[parsed.code] || parsed.code === "dcone2025")) {
            showApp(parsed.code);
            return;
          }
        }
      } catch (e) {}

      // å¦‚æœæ²¡æœ‰æœ‰æ•ˆæˆæƒï¼Œæ˜¾ç¤ºæˆæƒå±‚ï¼ˆåŒé‡ä¿éšœï¼‰
      authScreen.style.display = "flex";
      appRoot.style.display = "none";
    })();

    if (btn) btn.addEventListener("click", handleAuth);
    if (input) input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") handleAuth();
    });

    window.addEventListener("load", function() {
      if (input) setTimeout(() => input.focus(), 80);
    });
  </script>
</body>
</html>

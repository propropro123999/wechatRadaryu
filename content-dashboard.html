<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å†…å®¹æ•°æ®å‡½æ•°åˆ†æå·¥å…·ï¼ˆå‡½æ•°è¿è¡Œåœ¨æµè§ˆå™¨ï¼‰</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* ===== æˆæƒç™»å½•å±‚æ ·å¼ ===== */
    * {
      box-sizing: border-box;
    }
    #auth-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(56,189,248,0.15), transparent 55%),
                  radial-gradient(circle at bottom, rgba(129,140,248,0.2), transparent 55%),
                  rgba(15,23,42,0.96);
      z-index: 9999;
    }
    .auth-card {
      width: 360px;
      max-width: 90vw;
      padding: 24px 24px 20px;
      border-radius: 20px;
      background: rgba(15,23,42,0.92);
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: 0 24px 80px rgba(0,0,0,0.7);
      backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
    }
    .auth-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: conic-gradient(from 140deg,
        rgba(56,189,248,0.12),
        rgba(94,234,212,0.08),
        rgba(129,140,248,0.05),
        transparent 55%);
      opacity: 0.5;
      mix-blend-mode: screen;
      pointer-events: none;
    }
    .auth-inner {
      position: relative;
      z-index: 1;
    }
    .auth-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #e5e7eb;
    }
    .auth-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(52,211,153,0.7);
      color: #bbf7d0;
      background: linear-gradient(to right, rgba(22,163,74,0.25), rgba(15,118,110,0.35));
    }
    .auth-subtitle {
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 16px;
    }
    .auth-label {
      font-size: 12px;
      color: #cbd5f5;
      margin-bottom: 6px;
      display: block;
    }
    .auth-input {
      width: 100%;
      padding: 10px 11px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      outline: none;
      font-size: 13px;
      letter-spacing: 0.04em;
      transition: border-color 0.18s, box-shadow 0.18s, background 0.18s, transform 0.12s;
    }
    .auth-input::placeholder {
      color: #6b7280;
      letter-spacing: 0;
    }
    .auth-input:focus {
      border-color: rgba(56,189,248,0.85);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.45);
      background: rgba(15,23,42,0.98);
      transform: translateY(-0.5px);
    }
    .auth-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 14px;
      gap: 10px;
    }
    .auth-btn {
      flex: 0 0 auto;
      border: none;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg,#38bdf8,#6366f1);
      color: #f9fafb;
      box-shadow: 0 12px 30px rgba(37,99,235,0.45);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;
      white-space: nowrap;
    }
    .auth-btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 16px 40px rgba(37,99,235,0.55);
    }
    .auth-btn:active {
      transform: translateY(0);
      box-shadow: 0 8px 24px rgba(15,23,42,0.9);
      filter: brightness(0.97);
    }
    .auth-hint {
      font-size: 11px;
      color: #64748b;
      text-align: left;
      flex: 1;
    }
    .auth-meta {
      margin-top: 12px;
      font-size: 11px;
      color: #64748b;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      flex-wrap: wrap;
    }
    .auth-error {
      margin-top: 8px;
      font-size: 11px;
      color: #fecaca;
      min-height: 14px;
    }
    .auth-card.shake {
      animation: shake 0.26s ease-in-out;
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-3px); }
      100% { transform: translateX(0); }
    }

    /* Dashboard æ ¹èŠ‚ç‚¹ï¼šåˆå§‹éšè—ï¼Œæˆæƒåæ˜¾ç¤º */
    #app {
      display: none;
    }

    /* ======== Dashboard æ ·å¼ ======== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei",
        sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f7;
    }
    .topbar {
      background: #111827;
      color: #e5e7eb;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .topbar-title {
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
    }

    /* é†’ç›®çš„ä¸Šä¼ æŒ‰é’®ï¼ˆæ–¹æ¡ˆ Aï¼‰ */
    .upload-btn {
      background: linear-gradient(135deg,#3b82f6,#6366f1);
      color: #fff;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 12px rgba(99,102,241,0.35);
      transition: transform .12s, box-shadow .12s, filter .12s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 8px;
      white-space: nowrap;
    }
    .upload-btn input {
      display: none;
    }
    .upload-btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.08);
      box-shadow: 0 8px 20px rgba(99,102,241,0.45);
    }

    .topbar-spacer {
      flex: 1;
    }

    /* é¡¶éƒ¨æç¤ºæ¡ï¼ˆæ–¹æ¡ˆ Cï¼‰ */
    .upload-hint-bar {
      background: #fef3c7;
      color: #92400e;
      font-size: 12px;
      padding: 6px 16px;
      border-bottom: 1px solid #fcd34d;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .container {
      max-width: 1220px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 6px;
    }
    h2 {
      font-size: 20px;
      margin: 24px 0 12px;
    }
    .sub-title {
      color: #6b7280;
      margin-bottom: 18px;
      font-size: 13px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
    }
    .card-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .card-value {
      font-size: 22px;
      font-weight: 600;
      color: #111827;
    }
    .chart-block {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
      margin-bottom: 20px;
    }
    .chart {
      width: 100%;
      height: 340px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .data-table th,
    .data-table td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
    }
    .rank-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    #loading{font-size:12px;color:#6b7280;margin-top:6px;}
    #error{font-size:12px;color:#b91c1c;margin-top:6px;}

    /* ===== ä½¿ç”¨è¯´æ˜å¡ç‰‡ UI ===== */
    .usage-card {
      background: #ffffff;
      border-radius: 14px;
      padding: 12px 16px 4px;
      margin-bottom: 20px;
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
      border: 1px solid rgba(148,163,184,0.35);
    }
    .usage-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
    }
    .usage-icon-wrap {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 20%, #e0f2fe, #eff6ff);
      font-size: 18px;
    }
    .usage-title-block {
      flex: 1;
      min-width: 0;
    }
    .usage-title-main {
      font-size: 15px;
      font-weight: 600;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .usage-tag {
      font-size: 11px;
      padding: 1px 8px;
      border-radius: 999px;
      background: #ecfdf5;
      color: #16a34a;
      border: 1px solid rgba(34,197,94,0.35);
      white-space: nowrap;
    }
    .usage-title-sub {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }
    .usage-chip {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #4b5563;
      margin-right: 6px;
      white-space: nowrap;
    }
    .usage-chevron {
      font-size: 16px;
      color: #6b7280;
      transition: transform 0.16s ease;
    }
    .usage-chevron.expanded {
      transform: rotate(180deg);
    }
    .usage-card-body {
      font-size: 13px;
      color: #374151;
      line-height: 1.7;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed #e5e7eb;
    }
    .usage-card-body ul {
      padding-left: 18px;
      margin: 4px 0 10px;
    }
    .usage-card-body h4 {
      margin: 10px 0 4px;
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }

    /* ===== é¦–æ¬¡ä½¿ç”¨å¼¹çª—æ ·å¼ ===== */
    .usage-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      backdrop-filter: blur(3px);
    }
    .usage-modal-card {
      width: min(420px, 92vw);
      background: #f9fafb;
      border-radius: 18px;
      padding: 18px 18px 14px;
      box-shadow: 0 22px 60px rgba(15,23,42,0.45);
      border: 1px solid rgba(148,163,184,0.5);
    }
    .usage-modal-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .usage-modal-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 20%, #bfdbfe, #eff6ff);
      font-size: 18px;
    }
    .usage-modal-title-text {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }
    .usage-modal-body {
      font-size: 13px;
      color: #4b5563;
      line-height: 1.6;
      margin-bottom: 14px;
    }
    .usage-modal-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .usage-modal-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg,#3b82f6,#6366f1);
      color: #f9fafb;
      box-shadow: 0 12px 30px rgba(37,99,235,0.45);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .usage-modal-btn:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }
    .usage-modal-skip {
      font-size: 12px;
      color: #6b7280;
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
  </style>
</head>

<body>
  <!-- æˆæƒå±‚ -->
  <div id="auth-screen">
    <div class="auth-card" id="auth-card">
      <div class="auth-inner">
        <div class="auth-title">
          ğŸ” å†…éƒ¨æ•°æ®è®¿é—®
          <span class="auth-badge">Authorization Required</span>
        </div>
        <div class="auth-subtitle">
          è¯·è¾“å…¥æˆæƒç è®¿é—®ã€Œå†…å®¹è¡¨ç° Dashboardã€ã€‚æœ¬é¡µä»…ä¾›ç»æˆæƒçš„å†…éƒ¨æˆå‘˜ / åˆä½œæ–¹ä½¿ç”¨ã€‚
        </div>

        <label class="auth-label" for="auth-code">æˆæƒç </label>
        <input
          id="auth-code"
          class="auth-input"
          type="text"
          placeholder="ä¾‹å¦‚ï¼šICV-2025-7QAF"
          autocomplete="off"
        />

        <div class="auth-actions">
          <div class="auth-hint">æ¯ä¸ªæˆæƒç å¯¹åº”ä¸€æ¬¡å‘æ”¾å¯¹è±¡ï¼Œå¯æŒ‰éœ€åˆ†å‘ã€‚</div>
          <button class="auth-btn" id="auth-btn">ç¡®è®¤è¿›å…¥</button>
        </div>

        <div class="auth-error" id="auth-error"></div>

        <div class="auth-meta">
          <span id="auth-info-version">å½“å‰ç‰ˆæœ¬ï¼šWeChat å†…å®¹ Dashboard</span>
          <span id="auth-info-tag">æœªæˆæƒ</span>
        </div>
      </div>
    </div>
  </div>

  <!-- çœŸæ­£çš„ Dashboard æ ¹èŠ‚ç‚¹ï¼šæˆæƒåæ˜¾ç¤º -->
  <div id="app">
    <div class="topbar">
      <div class="topbar-title">å†…å®¹æ•°æ®å‡½æ•°åˆ†æå·¥å…·ï¼ˆè¿è¡Œåœ¨æµè§ˆå™¨ï¼‰</div>
      <label class="upload-btn">
        ğŸ“¤ é€‰æ‹©è¡¨æ ¼æ–‡ä»¶ï¼ˆCSV / XLSXï¼‰
        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
      </label>
      <div class="topbar-spacer"></div>
    </div>

    <!-- é¡¶éƒ¨æç¤ºæ¡ -->
    <div class="upload-hint-bar">
      âš ï¸ ä½¿ç”¨å‰è¯·å…ˆç‚¹å‡»ä¸Šæ–¹ã€ŒğŸ“¤ é€‰æ‹©è¡¨æ ¼æ–‡ä»¶ï¼ˆCSV / XLSXï¼‰ã€å¯¼å…¥å…¬ä¼—å·å†…å®¹æ•°æ®ã€‚
    </div>

    <div class="container">
      <h1>å†…å®¹æ•°æ®å‡½æ•°åˆ†æå·¥å…·</h1>
      <div class="sub-title" id="dateRange">æŒ‰å†…å®¹ç»´åº¦çš„é˜…è¯»ã€åˆ†äº«ã€è½¬åŒ–åˆ†æ</div>

      <!-- é¦–æ¬¡ä½¿ç”¨å¼¹çª— -->
      <div id="usageModal" class="usage-modal-backdrop">
        <div class="usage-modal-card">
          <div class="usage-modal-title">
            <div class="usage-modal-icon">ğŸ‘‹</div>
            <div class="usage-modal-title-text">æ¬¢è¿ä½¿ç”¨å…¬ä¼—å·å†…å®¹è¡¨ç° Dashboard</div>
          </div>
          <div class="usage-modal-body">
            è¿™æ˜¯ä¸€ä¸ªåœ¨ <b>æœ¬åœ°æµè§ˆå™¨è¿è¡Œ</b> çš„æ•°æ®åˆ†æå·¥å…·ï¼Œä¸ä¼šæŠŠ Excel / CSV
            ä¸Šä¼ åˆ°äº‘ç«¯ã€‚<br />
            å»ºè®®å…ˆå¿«é€Ÿæµè§ˆä¸€ä¸‹ä¸‹æ–¹çš„ã€Œä½¿ç”¨è¯´æ˜ã€ï¼Œå†å¼€å§‹é€‰å–å…¬ä¼—å·å¯¼å‡ºçš„æ•°æ®è¡¨ã€‚
          </div>
          <div class="usage-modal-actions">
            <div class="usage-modal-skip" id="usageModalSkip">
              ç›´æ¥è¿›å…¥ï¼Œä¸å†æç¤º
            </div>
            <button class="usage-modal-btn" id="usageModalBtn">
              ğŸ‘ æˆ‘çŸ¥é“äº†ï¼Œå¼€å§‹ä½¿ç”¨
            </button>
          </div>
        </div>
      </div>

      <!-- ä½¿ç”¨è¯´æ˜å¡ç‰‡ï¼ˆå¯æŠ˜å ï¼‰ -->
      <div class="usage-card" id="usageCard">
        <div class="usage-card-header" id="usageToggle">
          <div class="usage-icon-wrap">ğŸ“˜</div>
          <div class="usage-title-block">
            <div class="usage-title-main">
              ä½¿ç”¨è¯´æ˜ Â· Dashboard ä½¿ç”¨æŒ‡å—
              <span class="usage-tag">é¦–æ¬¡ä½¿ç”¨å»ºè®®é˜…è¯»</span>
            </div>
            <div class="usage-title-sub">
              æ”¯æŒ CSV / XLSXï¼Œæœ¬åœ°è§£æå…¬ä¼—å·å†…å®¹ç»´åº¦æ•°æ®ï¼Œç”Ÿæˆé˜…è¯» / åˆ†äº« / å®Œè¯» / å››è±¡é™ç­‰åˆ†æã€‚å¦‚ä¸ä¼šä½¿ç”¨è”ç³»æˆ‘ -luyu
            </div>
          </div>
          <div class="usage-chip">ç‚¹å‡»æŠ˜å  / å±•å¼€</div>
          <div class="usage-chevron expanded" id="usageChevron">âŒ„</div>
        </div>
        <div class="usage-card-body" id="usageBody">
          <h4>0ï¼‰Excel ä»å“ªé‡Œä¸‹è½½ï¼Ÿï¼ˆå…¬ä¼—å·åå°ï¼‰</h4>
          <ul>
            <li>ç™»å½•å…¬ä¼—å·åå°ï¼Œå·¦ä¾§å¯¼èˆªè¿›å…¥ <b>ã€Œæ•°æ®åˆ†æ &gt; å†…å®¹åˆ†æã€</b>ï¼›</li>
            <li>ä¸Šæ–¹åˆ‡æ¢åˆ° <b>ã€Œå·²å‘è¡¨å†…å®¹ &gt; å·²é€šçŸ¥å†…å®¹ã€</b>ï¼›</li>
            <li>åœ¨å³ä¾§ç‚¹å‡» <b>ã€Œä¸‹è½½æ•°æ®æ˜ç»†ã€</b>ï¼Œå³å¯è·å¾—æœ¬å·¥å…·ä½¿ç”¨çš„ Excel / CSV æ–‡ä»¶ã€‚</li>
          </ul>
          <div style="margin:6px 0 14px;">
            <img
              src="wechat-export-location.png"
              alt="å…¬ä¼—å·åå°ä¸‹è½½å†…å®¹åˆ†ææ•°æ®æ˜ç»†çš„ä½ç½®ç¤ºæ„å›¾"
              style="max-width:100%;border-radius:10px;border:1px solid #e5e7eb;display:block;"
            />
            <div style="font-size:11px;color:#6b7280;margin-top:4px;">
              ç¤ºä¾‹ï¼šåœ¨ã€Œæ•°æ®åˆ†æ &gt; å†…å®¹åˆ†æ &gt; å·²é€šçŸ¥å†…å®¹ã€å³ä¾§ï¼Œç‚¹å‡»ã€Œä¸‹è½½æ•°æ®æ˜ç»†ã€å¯¼å‡º Excelã€‚
            </div>
          </div>

          <h4>1ï¼‰å·¥å…·ç®€ä»‹</h4>
          <ul>
            <li>å¯¼å…¥å…¬ä¼—å·åå°å¯¼å‡ºçš„ CSV / XLSX å†…å®¹ç»´åº¦æ•°æ®ï¼›</li>
            <li>è‡ªåŠ¨è¯†åˆ«æ ‡é¢˜ã€é˜…è¯»æ¬¡æ•°ã€åˆ†äº«æ¬¡æ•°ã€å®Œè¯»ç‡ç­‰å­—æ®µï¼›</li>
            <li>ä¸€é”®ç”Ÿæˆå¤šç§å›¾è¡¨ä¸ Top æ¦œå•ï¼›</li>
            <li>æ‰€æœ‰è®¡ç®—åœ¨æœ¬åœ°æµè§ˆå™¨å®Œæˆï¼Œä¸ä¸Šä¼ ä»»ä½•æ•°æ®ã€‚</li>
          </ul>

          <h4>2ï¼‰åŸºç¡€ä½¿ç”¨æµç¨‹</h4>
          <ul>
            <li><b>Step 1ï¼š</b> è¾“å…¥æˆæƒç ï¼Œè¿›å…¥ Dashboard ä¸»ç•Œé¢ï¼›</li>
            <li><b>Step 2ï¼š</b> å…ˆé¡¶éƒ¨ç‚¹å‡»ã€ŒğŸ“¤ ä¸Šä¼ è¡¨æ ¼æ–‡ä»¶ï¼ˆCSV / XLSXï¼‰ã€å¹¶é€‰æ‹©å¯¼å‡ºçš„æ•°æ®è¡¨ï¼›</li>
            <li><b>Step 3ï¼š</b> ç­‰å¾…è§£æå®Œæˆï¼Œé¡µé¢ä¼šè‡ªåŠ¨åˆ·æ–°å›¾è¡¨å’Œæ¦œå•ï¼Œæ— éœ€æ‰‹åŠ¨è¿è¡Œã€‚</li>
          </ul>

          <h4>3ï¼‰é¡µé¢æ¨¡å—æ¦‚è§ˆ</h4>
          <ul>
            <li>Summary æ€»è§ˆå¡ç‰‡ï¼šæ–‡ç« æ•°ã€é˜…è¯»ã€åˆ†äº«ã€å®Œè¯»ç‡ç­‰æ ¸å¿ƒæŒ‡æ ‡ï¼›</li>
            <li>Top10 é˜…è¯»æŸ±çŠ¶å›¾ &amp; é˜…è¯» Ã— åˆ†äº«æ•£ç‚¹å›¾ï¼›</li>
            <li>å®Œè¯»ç‡ / é€è¾¾é˜…è¯»ç‡æ’è¡Œæ¦œï¼ˆTop50ï¼‰ï¼›</li>
            <li>å†…å®¹æ˜ç»†è¡¨ï¼ˆæŒ‰é˜…è¯»æ¬¡æ•° Top100ï¼‰ï¼›</li>
            <li>11 ç»„å…³é”®æŒ‡æ ‡ TOP æ¦œå•ï¼›</li>
            <li>é˜…è¯» Ã— æ€»åˆ†äº«æ¬¡æ•°å››è±¡é™åˆ†æï¼ˆé™„è‡ªåŠ¨ç”Ÿæˆæ´å¯Ÿè¯´æ˜ï¼‰ã€‚</li>
          </ul>

          <h4>4ï¼‰å››è±¡é™å›¾è¯´æ˜</h4>
          <ul>
            <li>ä»¥æ ·æœ¬ä¸­ä½æ•°ä¸ºç•Œï¼Œè‡ªåŠ¨åˆ’åˆ†ã€Œé«˜ / ä½é˜…è¯»ã€ä¸ã€Œé«˜ / ä½åˆ†äº«ã€ï¼›</li>
            <li>ã€Œé«˜é˜…è¯» Â· é«˜åˆ†äº«ã€é€šå¸¸æ˜¯å¤´éƒ¨çˆ†æ¬¾å†…å®¹ï¼›</li>
            <li>ã€Œä½é˜…è¯» Â· é«˜åˆ†äº«ã€å¯ä»¥ä½œä¸ºå°ä¼—ä½†é«˜å£ç¢‘å†…å®¹å‚è€ƒï¼›</li>
            <li>æ–‡æ¡ˆä¼˜åŒ–æˆ–æ¨é€ç­–ç•¥è°ƒæ•´å¯ä»¥é‡ç‚¹è§‚å¯Ÿå„è±¡é™å æ¯”å˜åŒ–ã€‚</li>
          </ul>

          <h4>5ï¼‰å°æç¤º</h4>
          <ul>
            <li>å»ºè®®ä½¿ç”¨ Chrome / Edge æµè§ˆå™¨è®¿é—®ï¼›</li>
            <li>å°½é‡ä¿ç•™å…¬ä¼—å·é»˜è®¤å¯¼å‡ºçš„å­—æ®µåï¼Œé¿å…å­—æ®µæ— æ³•è¯†åˆ«ï¼›</li>
            <li>æˆæƒç ä»…ä¿å­˜åœ¨å½“å‰æµè§ˆå™¨ localStorage ä¸­ï¼Œä¸‹æ¬¡è®¿é—®ä¼šè‡ªåŠ¨ç™»å½•ã€‚</li>
          </ul>
        </div>
      </div>

      <div id="loading"></div>
      <div id="error"></div>

      <!-- Summary å¡ç‰‡ -->
      <div class="cards" id="summaryCards" style="display:none;">
        <div class="card">
          <div class="card-label">æ–‡ç« æ€»æ•°</div>
          <div class="card-value" id="totalArticles">-</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»é˜…è¯»æ¬¡æ•°</div>
          <div class="card-value" id="totalReadCount">-</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»é˜…è¯»äººæ•°</div>
          <div class="card-value" id="totalReaders">-</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»åˆ†äº«æ¬¡æ•°</div>
          <div class="card-value" id="totalShareCount">-</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»é€è¾¾äººæ•°</div>
          <div class="card-value" id="totalDelivered">-</div>
        </div>
        <div class="card">
          <div class="card-label">å¹³å‡é€è¾¾é˜…è¯»ç‡</div>
          <div class="card-value" id="avgDeliverReadRate">-</div>
        </div>
        <div class="card">
          <div class="card-label">å¹³å‡é˜…è¯»å®Œæˆç‡</div>
          <div class="card-value" id="avgFinishRate">-</div>
        </div>
      </div>

      <h2>äºŒã€Top å†…å®¹è¡¨ç°</h2>
      <div class="chart-block">
        <div class="chart-title">Top10 å†…å®¹ï¼ˆæŒ‰æ€»é˜…è¯»æ¬¡æ•°ï¼‰</div>
        <div id="topReadChart" class="chart"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">é˜…è¯»æ¬¡æ•° vs åˆ†äº«æ¬¡æ•°</div>
        <div id="readShareScatter" class="chart"></div>
      </div>

      <h2>ä¸‰ã€è½¬åŒ–ä¸å®Œæˆåº¦</h2>
      <div class="chart-block">
        <div class="chart-title">é˜…è¯»å®Œæˆç‡ï¼ˆTop50ï¼‰</div>
        <div id="finishRateChart" class="chart"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">é€è¾¾é˜…è¯»ç‡ï¼ˆTop50ï¼‰</div>
        <div id="deliverRateChart" class="chart"></div>
      </div>

      <h2>å››ã€å†…å®¹æ˜ç»†ï¼ˆTop100 æŒ‰é˜…è¯»æ¬¡æ•°ï¼‰</h2>
      <div class="chart-block">
        <div class="chart-title">å†…å®¹æ˜ç»†è¡¨</div>
        <div id="detailTable"></div>
      </div>

      <h2>äº”ã€å…³é”®æŒ‡æ ‡ TOP æ¦œå•</h2>
      <div class="chart-block">
        <div class="chart-title">æ ¸å¿ƒæŒ‡æ ‡ Top3 æ¦œå•</div>
        <div id="keyRanks" class="rank-grid"></div>
      </div>

      <!-- å…­ã€é˜…è¯» Ã— æ€»åˆ†äº«æ¬¡æ•°å››è±¡é™åˆ†æ -->
      <h2>å…­ã€é˜…è¯» Ã— æ€»åˆ†äº«æ¬¡æ•°å››è±¡é™åˆ†æ</h2>
      <div class="chart-block">
        <div class="chart-title">é˜…è¯»é‡ vs æ€»åˆ†äº«æ¬¡æ•°ï¼ˆå››è±¡é™ï¼‰</div>
        <div id="quadrantChart" class="chart"></div>
        <div id="quadrantInsight" style="font-size:12px;color:#6b7280;margin-top:8px;"></div>
      </div>

      <div class="footer" style="font-size:11px;color:#9ca3af;margin-top:24px;text-align:center;">
        æœ¬é¡µé¢ä»…åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­è¿è¡Œï¼Œä¸ä¼šä¸Šä¼ ä»»ä½•æ•°æ®ã€‚
      </div>
    </div>
  </div>

  <!-- ===== Dashboard è„šæœ¬ ===== -->
  <script>
    const fileInput = document.getElementById("fileInput");
    const loadingEl = document.getElementById("loading");
    const errorEl = document.getElementById("error");

    fileInput.addEventListener("change", handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      loadingEl.textContent = "è§£æä¸­ï¼Œè¯·ç¨å€™â€¦";
      errorEl.textContent = "";

      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const workbook = XLSX.read(evt.target.result, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
          process(rows);
        } catch (err) {
          console.error(err);
          errorEl.textContent = "æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼æˆ–å¦å­˜ä¸º UTF-8 åå†è¯•ã€‚";
        }
        loadingEl.textContent = "";
      };
      reader.readAsArrayBuffer(file);
    }

    function num(v) {
      if (v === null || v === undefined || v === "") return 0;
      return Number(String(v).replace(/,/g, "")) || 0;
    }
    function pct(v) {
      if (!v) return 0;
      const s = String(v).trim();
      if (s.endsWith("%")) return parseFloat(s.slice(0, -1)) || 0;
      return parseFloat(s) || 0;
    }
    function dateParse(v) {
      let d = new Date(v);
      if (!isNaN(d)) return d;
      if (typeof v === "number")
        return new Date(Math.round((v - 25569) * 86400 * 1000));
      return null;
    }
    function dateFmt(d) {
      if (!d) return "";
      return (
        d.getFullYear() +
        "-" +
        String(d.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(d.getDate()).padStart(2, "0")
      );
    }

    function findCol(names, cols) {
      for (const n of names) if (cols.includes(n)) return n;
      return null;
    }

    function process(rows) {
      if (!rows.length) {
        errorEl.textContent = "æ–‡ä»¶ä¸ºç©º";
        return;
      }

      const cols = Object.keys(rows[0]);

      const colTitle = findCol(["å†…å®¹æ ‡é¢˜", "æ ‡é¢˜"], cols);
      const colTime = findCol(["å‘è¡¨æ—¶é—´", "å‘å¸ƒæ—¶é—´"], cols);
      const colReadUser = findCol(["æ€»é˜…è¯»äººæ•°"], cols);
      const colReadCount = findCol(["æ€»é˜…è¯»æ¬¡æ•°"], cols);
      const colShareCount = findCol(["æ€»åˆ†äº«æ¬¡æ•°"], cols);
      const colFirstShare = findCol(["é¦–æ¬¡åˆ†äº«æ¬¡æ•°"], cols);
      const colShareRead = findCol(["åˆ†äº«äº§ç”Ÿé˜…è¯»æ¬¡æ•°"], cols);
      const colFinishRate = findCol(["é˜…è¯»å®Œæˆç‡", "é˜…è¯»å®Œæˆç‡(%)"], cols);
      const colDeliverRate = findCol(["é€è¾¾é˜…è¯»ç‡", "é€è¾¾é˜…è¯»ç‡(%)"], cols);
      const colMsgRead = findCol(["å…¬ä¼—å·æ¶ˆæ¯é˜…è¯»æ¬¡æ•°"], cols);
      const colDelivered = findCol(["é€è¾¾äººæ•°"], cols);
      const colFollow = findCol(["é˜…è¯»åå…³æ³¨äººæ•°"], cols);

      if (!colTitle || !colReadCount) {
        errorEl.textContent = "ç¼ºå°‘å¿…è¦å­—æ®µï¼šå†…å®¹æ ‡é¢˜ã€æ€»é˜…è¯»æ¬¡æ•°";
        return;
      }

      let data = rows.map(r => {
        const readUser = num(r[colReadUser]);
        const shareCount = num(r[colShareCount]);
        const firstShare = num(r[colFirstShare]);
        const shareRead = num(r[colShareRead]);
        const follow = num(r[colFollow]);
        const time = dateParse(r[colTime]);

        return {
          title: r[colTitle],
          time,
          readUser,
          readCount: num(r[colReadCount]),
          shareCount,
          firstShare,
          shareRead,
          finishRate: pct(r[colFinishRate]),
          deliverRate: pct(r[colDeliverRate]),
          msgRead: num(r[colMsgRead]),
          delivered: num(r[colDelivered]),
          follow,

          // é¦–æ¬¡åˆ†äº«ç‡ï¼ˆ%ï¼‰
          firstShareRate:
            readUser > 0 ? (firstShare / readUser) * 100 : 0,

          // æ¯æ¬¡åˆ†äº«å¸¦æ¥çš„é˜…è¯»æ•°
          readPerShare:
            shareCount > 0 ? (shareRead / shareCount) : 0,

          // é˜…è¯»åå…³æ³¨ç‡ï¼ˆ%ï¼‰
          attentionRate:
            readUser > 0
              ? (follow / readUser) * 100
              : 0
        };
      });

      renderSummary(data);
      renderTopRead(data);
      renderReadShare(data);
      renderFinishRate(data);
      renderDeliverRate(data);
      renderDetail(data);
      renderRanks(data);
      renderQuadrant(data); // å››è±¡é™åˆ†æ
    }

    function renderSummary(data) {
      document.getElementById("summaryCards").style.display = "grid";

      document.getElementById("totalArticles").textContent = data.length;
      document.getElementById("totalReadCount").textContent = sum(data, "readCount");
      document.getElementById("totalReaders").textContent = sum(data, "readUser");
      document.getElementById("totalShareCount").textContent = sum(data, "shareCount");
      document.getElementById("totalDelivered").textContent = sum(data, "delivered");

      document.getElementById("avgDeliverReadRate").textContent =
        avg(data, "deliverRate").toFixed(2) + "%";
      document.getElementById("avgFinishRate").textContent =
        avg(data, "finishRate").toFixed(2) + "%";

      const times = data.map(d => d.time).filter(Boolean);
      if (times.length) {
        const min = new Date(Math.min(...times));
        const max = new Date(Math.max(...times));
        document.getElementById("dateRange").textContent =
          "æ—¶é—´èŒƒå›´ï¼š" + dateFmt(min) + " ~ " + dateFmt(max);
      }
    }

    function sum(arr, key) {
      return arr.reduce((a, b) => a + (b[key] || 0), 0);
    }
    function avg(arr, key) {
      const v = arr.map(r => r[key]).filter(v => v > 0);
      return v.length ? v.reduce((a, b) => a + b, 0) / v.length : 0;
    }

    function topN(arr, key, n = 3) {
      return arr
        .filter(r => r[key] > 0)
        .sort((a, b) => b[key] - a[key])
        .slice(0, n);
    }

    function renderTopRead(data) {
      const top = data
        .slice()
        .sort((a, b) => b.readCount - a.readCount)
        .slice(0, 10);

      Plotly.newPlot("topReadChart", [
        {
          x: top.map(x => x.title),
          y: top.map(x => x.readCount),
          type: "bar"
        }
      ], {
        margin: { b: 120 }
      });
    }

    function renderReadShare(data) {
      Plotly.newPlot("readShareScatter", [
        {
          x: data.map(x => x.readCount),
          y: data.map(x => x.shareCount),
          mode: "markers",
          type: "scatter",
          text: data.map(x => x.title)
        }
      ], {
        xaxis: { title: "é˜…è¯»æ¬¡æ•°" },
        yaxis: { title: "åˆ†äº«æ¬¡æ•°" }
      });
    }

    function renderFinishRate(data) {
      const list = data
        .filter(x => x.finishRate > 0)
        .sort((a, b) => b.finishRate - a.finishRate)
        .slice(0, 50);

      Plotly.newPlot("finishRateChart", [
        {
          x: list.map(x => x.title),
          y: list.map(x => x.finishRate),
          type: "bar"
        }
      ], { margin: { b: 120 } });
    }

    function renderDeliverRate(data) {
      const list = data
        .filter(x => x.deliverRate > 0)
        .sort((a, b) => b.deliverRate - a.deliverRate)
        .slice(0, 50);

      Plotly.newPlot("deliverRateChart", [
        {
          x: list.map(x => x.title),
          y: list.map(x => x.deliverRate),
          type: "bar"
        }
      ], { margin: { b: 120 } });
    }

    function renderDetail(data) {
      const top = data
        .slice()
        .sort((a, b) => b.readCount - a.readCount)
        .slice(0, 100);

      let html = "<table class='data-table'><thead><tr>";
      const headers = [
        "å†…å®¹æ ‡é¢˜", "å‘è¡¨æ—¶é—´", "æ€»é˜…è¯»äººæ•°", "æ€»é˜…è¯»æ¬¡æ•°",
        "æ€»åˆ†äº«æ¬¡æ•°", "é¦–æ¬¡åˆ†äº«æ¬¡æ•°", "åˆ†äº«äº§ç”Ÿé˜…è¯»æ¬¡æ•°",
        "é˜…è¯»å®Œæˆç‡(%)", "é€è¾¾é˜…è¯»ç‡(%)",
        "å…¬ä¼—å·æ¶ˆæ¯é˜…è¯»æ¬¡æ•°", "é€è¾¾äººæ•°", "é˜…è¯»åå…³æ³¨äººæ•°"
      ];
      headers.forEach(h => html += `<th>${h}</th>`);
      html += "</tr></thead><tbody>";

      top.forEach(r => {
        html += "<tr>";
        html += `<td>${escapeHtml(r.title)}</td>`;
        html += `<td>${r.time ? dateFmt(r.time) : ""}</td>`;
        html += `<td>${r.readUser}</td>`;
        html += `<td>${r.readCount}</td>`;
        html += `<td>${r.shareCount}</td>`;
        html += `<td>${r.firstShare}</td>`;
        html += `<td>${r.shareRead}</td>`;
        html += `<td>${r.finishRate.toFixed(2)}</td>`;
        html += `<td>${r.deliverRate.toFixed(2)}</td>`;
        html += `<td>${r.msgRead}</td>`;
        html += `<td>${r.delivered}</td>`;
        html += `<td>${r.follow}</td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";
      document.getElementById("detailTable").innerHTML = html;
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;");
    }

    function renderRanks(data) {
      let html = "";

      const rankItems = [
        ["é˜…è¯»è¡¨ç° TOP3ï¼ˆæŒ‰é˜…è¯»æ¬¡æ•°ï¼‰", "readCount", ""],
        ["å…¬ä¼—å·æ¶ˆæ¯é˜…è¯»æ¬¡æ•° TOP3", "msgRead", ""],
        ["å®Œè¯»ç‡ TOP3", "finishRate", "%"],
        ["åˆ†äº«æ„æ„¿ TOP3ï¼ˆæŒ‰é¦–æ¬¡åˆ†äº«ç‡ï¼‰", "firstShareRate","%"],
        ["åˆ†äº«åŠ¨åŠ› TOP3ï¼ˆæŒ‰é¦–æ¬¡åˆ†äº«æ¬¡æ•°ï¼‰", "firstShare", ""],
        ["äºŒæ¬¡ä¼ æ’­ TOP3ï¼ˆæŒ‰åˆ†äº«äº§ç”Ÿé˜…è¯»ï¼‰", "shareRead", ""],
        ["åˆ†äº«æ•ˆç‡ TOP3ï¼ˆæ¯æ¬¡åˆ†äº«å¸¦æ¥é˜…è¯»ï¼‰", "readPerShare",""],
        ["åˆ†äº«è§„æ¨¡ TOP3ï¼ˆæ€»åˆ†äº«æ¬¡æ•°ï¼‰", "shareCount", ""],
        ["å…³æ³¨æ–°å¢è´¡çŒ® TOP3", "follow", ""],
        ["æ ‡é¢˜å¸å¼•åŠ› TOP3ï¼ˆé€è¾¾é˜…è¯»ç‡ï¼‰", "deliverRate", "%"],
        ["ç”¨æˆ·å…³æ³¨å¼•åŠ› TOP3", "attentionRate", "%"]
      ];

      rankItems.forEach(([title, key, suffix]) => {
        const top = topN(data, key, 3);
        if (!top.length) return;

        html += `<div class="rank-block-item">
          <div style="font-size:13px;font-weight:600;margin-bottom:6px;">${title}</div>
          <table class='data-table'><thead><tr>
            <th>æ’å</th><th>å†…å®¹æ ‡é¢˜</th><th>å€¼</th>
          </tr></thead><tbody>`;

        top.forEach((r, i) => {
          html += `<tr>
            <td>${i + 1}</td>
            <td>${escapeHtml(r.title)}</td>
            <td>${r[key].toFixed ? r[key].toFixed(2) : r[key]}${suffix}</td>
          </tr>`;
        });

        html += "</tbody></table></div>";
      });

      document.getElementById("keyRanks").innerHTML = html;
    }

    // é˜…è¯» Ã— æ€»åˆ†äº«æ¬¡æ•°å››è±¡é™åˆ†æ
    function renderQuadrant(data) {
      const points = data
        .filter(d => d.readCount > 0 && d.shareCount > 0)
        .map(d => ({
          title: d.title,
          read: d.readCount,
          share: d.shareCount
        }));

      const insightEl = document.getElementById("quadrantInsight");

      if (!points.length) {
        insightEl.textContent = "æš‚æ— è¶³å¤Ÿçš„é˜…è¯»ä¸åˆ†äº«æ•°æ®ï¼Œæš‚æ— æ³•ç»˜åˆ¶å››è±¡é™åˆ†æã€‚";
        return;
      }

      const reads = points.map(p => p.read).slice().sort((a, b) => a - b);
      const shares = points.map(p => p.share).slice().sort((a, b) => a - b);

      function median(arr) {
        if (!arr.length) return 0;
        const n = arr.length;
        const mid = Math.floor(n / 2);
        return n % 2 === 1
          ? arr[mid]
          : (arr[mid - 1] + arr[mid]) / 2;
      }

      const readMid = median(reads);
      const shareMid = median(shares);

      const minRead = Math.min(...reads);
      const maxRead = Math.max(...reads);
      const minShare = Math.min(...shares);
      const maxShare = Math.max(...shares);

      const xPadding = (maxRead - minRead) * 0.1;
      const yPadding = (maxShare - minShare) * 0.1;

      const xMinRange = Math.max(0, minRead - xPadding);
      const xMaxRange = maxRead + xPadding;
      const yMinRange = Math.max(0, minShare - yPadding);
      const yMaxRange = maxShare + yPadding;

      const xCenter = (xMinRange + xMaxRange) / 2;
      const yCenter = (yMinRange + yMaxRange) / 2;

      const q1 = [];
      const q2 = [];
      const q3 = [];
      const q4 = [];

      points.forEach(p => {
        if (p.read >= readMid && p.share >= shareMid) {
          q1.push(p);
        } else if (p.read < readMid && p.share >= shareMid) {
          q2.push(p);
        } else if (p.read < readMid && p.share < shareMid) {
          q3.push(p);
        } else {
          q4.push(p);
        }
      });

      function makeTrace(list, name, symbol) {
        return {
          x: list.map(p => p.read),
          y: list.map(p => p.share),
          mode: "markers",
          type: "scatter",
          name,
          text: list.map(p => p.title),
          marker: {
            size: 9,
            symbol
          }
        };
      }

      Plotly.newPlot("quadrantChart", [
        makeTrace(q1, "é«˜é˜…è¯» Â· é«˜åˆ†äº«", "circle"),
        makeTrace(q2, "ä½é˜…è¯» Â· é«˜åˆ†äº«", "triangle-up"),
        makeTrace(q3, "ä½é˜…è¯» Â· ä½åˆ†äº«", "square"),
        makeTrace(q4, "é«˜é˜…è¯» Â· ä½åˆ†äº«", "diamond")
      ], {
        xaxis: {
          title: "æ€»é˜…è¯»æ¬¡æ•°",
          zeroline: false,
          range: [xMinRange, xMaxRange]
        },
        yaxis: {
          title: "æ€»åˆ†äº«æ¬¡æ•°",
          zeroline: false,
          range: [yMinRange, yMaxRange]
        },
        shapes: [
          {
            type: "line",
            x0: readMid,
            x1: readMid,
            y0: yMinRange,
            y1: yMaxRange,
            line: { dash: "dot", width: 1 }
          },
          {
            type: "line",
            x0: xMinRange,
            x1: xMaxRange,
            y0: shareMid,
            y1: shareMid,
            line: { dash: "dot", width: 1 }
          }
        ],
        margin: { t: 30 }
      });

      const total = points.length;
      const pct = n => ((n / total) * 100).toFixed(1);

      insightEl.innerHTML =
        `åŸºäº ${total} ç¯‡å…·å¤‡ã€Œé˜…è¯» + æ€»åˆ†äº«æ¬¡æ•°ã€æ•°æ®çš„å†…å®¹ï¼Œä½¿ç”¨æ ·æœ¬ä¸­ä½æ•°ä½œä¸ºé«˜/ä½åˆ†ç•Œï¼š` +
        `æ€»é˜…è¯»æ¬¡æ•°ä¸­ä½æ•°çº¦ä¸º <b>${Math.round(readMid)}</b>ï¼Œæ€»åˆ†äº«æ¬¡æ•°ä¸­ä½æ•°çº¦ä¸º <b>${Math.round(shareMid)}</b>ã€‚<br>` +
        `å„è±¡é™æ–‡ç« æ•°é‡ä¸å æ¯”åˆ†åˆ«ä¸ºï¼š` +
        `é«˜é˜…è¯»Â·é«˜åˆ†äº« ${q1.length} ç¯‡ï¼ˆ${pct(q1.length)}%ï¼‰ï¼Œ` +
        `ä½é˜…è¯»Â·é«˜åˆ†äº« ${q2.length} ç¯‡ï¼ˆ${pct(q2.length)}%ï¼‰ï¼Œ` +
        `ä½é˜…è¯»Â·ä½åˆ†äº« ${q3.length} ç¯‡ï¼ˆ${pct(q3.length)}%ï¼‰ï¼Œ` +
        `é«˜é˜…è¯»Â·ä½åˆ†äº« ${q4.length} ç¯‡ï¼ˆ${pct(q4.length)}%ï¼‰ã€‚`;
    }
  </script>

  <!-- ===== æˆæƒé€»è¾‘è„šæœ¬ + ä½¿ç”¨è¯´æ˜äº¤äº’ ===== -->
  <script>
    const TOOL_ID = "content-analysis";
    const STORAGE_KEY = `wechat_dashboard_auth_${TOOL_ID}`;
    const USAGE_INTRO_KEY = `wechat_dashboard_intro_seen_${TOOL_ID}`;
    // æœ¬åœ°æ–‡ä»¶æ¨¡å¼ä¸‹ï¼ˆfile://ï¼‰æ— æ³• fetchï¼Œæœ¬åœ°å†…ç½®æˆæƒç å…œåº•
    const INLINE_AUTH_CODES = {
      tools: {
        "content-analysis": {
          codes: {
            "ICV-2025-7QAF": "æ ‡å‡†æˆæƒ",
            "ICV-2025-P3ZD": "æ ‡å‡†æˆæƒ",
            "ICV-2025-L8XK": "æ ‡å‡†æˆæƒ",
            "ICV-2025-G2MW": "æ ‡å‡†æˆæƒ",
            "ICV-2025-R9CE": "æ ‡å‡†æˆæƒ",
            "ICV-2025-H4VU": "æ ‡å‡†æˆæƒ",
            "ICV-2025-Y1SN": "æ ‡å‡†æˆæƒ",
            "ICV-2025-K5BJ": "æ ‡å‡†æˆæƒ",
            "ICV-2025-X7TP": "æ ‡å‡†æˆæƒ",
            "ICV-2025-W6QD": "æ ‡å‡†æˆæƒ"
          }
        }
      }
    };

    // åŠ¨æ€åŠ è½½æˆæƒç 
    let AUTH_CODES = {};
    let authLoaded = false;

    function loadAuthCodes() {
      // file:// ä¸‹ç›´æ¥ç”¨å†…ç½®æˆæƒç ï¼Œé¿å… fetch è¢«æµè§ˆå™¨æ‹¦æˆª
      if (location.protocol === "file:") {
        AUTH_CODES = INLINE_AUTH_CODES.tools?.[TOOL_ID]?.codes || {};
        authLoaded = true;
        console.log("ä½¿ç”¨å†…ç½®æˆæƒç ï¼ˆfile:// æ¨¡å¼ï¼‰");
        return Promise.resolve();
      }
      const url = "./auth-codes.json?" + Date.now();
      console.log("å°è¯•åŠ è½½æˆæƒç æ–‡ä»¶ï¼š", url);

      return fetch(url)
        .then(async (res) => {
          if (!res.ok) {
            const text = await res.text().catch(() => "");
            console.error("auth-codes.json å“åº”å¼‚å¸¸ï¼š", res.status, res.statusText, text);
            throw new Error("HTTP " + res.status);
          }
          return res.json();
        })
        .then((data) => {
          console.log("auth-codes.json åŠ è½½æˆåŠŸï¼š", data);
          // æå–å½“å‰å·¥å…·çš„æˆæƒç 
          if (data.tools && data.tools[TOOL_ID]) {
            AUTH_CODES = data.tools[TOOL_ID].codes || {};
          } else if (typeof data === 'object') {
            // å…¼å®¹æ—§æ ¼å¼
            AUTH_CODES = data;
          }
          authLoaded = true;
        })
        .catch((err) => {
          console.error("æˆæƒç æ–‡ä»¶åŠ è½½å¤±è´¥:", err);
          // å…œåº•ï¼šå¦‚æœæœ‰å†…ç½®æˆæƒç åˆ™ç»§ç»­ä½¿ç”¨ï¼Œé¿å…é˜»æ–­ä½¿ç”¨
          AUTH_CODES = INLINE_AUTH_CODES.tools?.[TOOL_ID]?.codes || {};
          authLoaded = true;
          if (!Object.keys(AUTH_CODES).length) {
            alert("æˆæƒç æ–‡ä»¶åŠ è½½å¤±è´¥ï¼š\n" +
              "1ï¼‰ç¡®è®¤æ ¹ç›®å½•å­˜åœ¨ auth-codes.json\n" +
              "2ï¼‰ç¡®è®¤éƒ¨ç½²åå¯ä»¥ç›´æ¥è®¿é—® /auth-codes.json\n" +
              "3ï¼‰ç¡®è®¤æ–‡ä»¶å†…å®¹æ˜¯åˆæ³• JSONï¼ˆæ— å¤šä½™é€—å·/æ³¨é‡Šï¼‰");
          }
        });
    }

    const authScreen = document.getElementById("auth-screen");
    const appRoot = document.getElementById("app");
    const input = document.getElementById("auth-code");
    const btn = document.getElementById("auth-btn");
    const errElAuth = document.getElementById("auth-error");
    const cardEl = document.getElementById("auth-card");
    const infoTag = document.getElementById("auth-info-tag");

    function initUsageGuide() {
      const card = document.getElementById("usageCard");
      const body = document.getElementById("usageBody");
      const chevron = document.getElementById("usageChevron");
      const toggle = document.getElementById("usageToggle");
      const modal = document.getElementById("usageModal");
      const modalBtn = document.getElementById("usageModalBtn");
      const modalSkip = document.getElementById("usageModalSkip");

      if (!card || !body || !chevron || !toggle) return;

      let expanded = true;
      function setExpanded(state) {
        expanded = state;
        body.style.display = state ? "block" : "none";
        if (state) {
          chevron.classList.add("expanded");
        } else {
          chevron.classList.remove("expanded");
        }
      }

      setExpanded(true);

      toggle.addEventListener("click", function () {
        setExpanded(!expanded);
      });

      const seen = (function () {
        try {
          return localStorage.getItem(USAGE_INTRO_KEY);
        } catch (e) {
          return null;
        }
      })();

      if (!seen && modal) {
        modal.style.display = "flex";
      }

      function closeModalAndRemember() {
        if (modal) modal.style.display = "none";
        try {
          localStorage.setItem(USAGE_INTRO_KEY, "1");
        } catch (e) {}
      }

      if (modalBtn) {
        modalBtn.addEventListener("click", closeModalAndRemember);
      }
      if (modalSkip) {
        modalSkip.addEventListener("click", closeModalAndRemember);
      }
    }

    function showApp(code) {
      const label = AUTH_CODES[code] || "å·²æˆæƒè®¿é—®";
      infoTag.textContent = label;
      authScreen.style.display = "none";
      appRoot.style.display = "block";
      try {
        localStorage.setItem(
          STORAGE_KEY,
          JSON.stringify({ code, label, ts: Date.now() })
        );
      } catch (e) {}
      try {
        initUsageGuide();
      } catch (e) {
        console.warn("initUsageGuide error:", e);
      }
    }

    function shakeCard() {
      cardEl.classList.remove("shake");
      void cardEl.offsetWidth;
      cardEl.classList.add("shake");
    }

    async function handleAuth() {
      const code = (input.value || "").trim();

      if (!authLoaded) {
        await loadAuthCodes();
      }

      if (!code) {
        errElAuth.textContent = "è¯·è¾“å…¥æˆæƒç ã€‚";
        shakeCard();
        return;
      }
      if (!Object.prototype.hasOwnProperty.call(AUTH_CODES, code)) {
        errElAuth.textContent = "æˆæƒç æ— æ•ˆï¼Œè¯·ç¡®è®¤åé‡æ–°è¾“å…¥ã€‚";
        shakeCard();
        return;
      }
      errElAuth.textContent = "";
      showApp(code);
    }

    (async function bootstrapAuth() {
      await loadAuthCodes();

      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        const parsed = JSON.parse(saved);
        if (parsed && parsed.code && AUTH_CODES[parsed.code]) {
          showApp(parsed.code);
        }
      } catch (e) {
        // ignore
      }
    })();

    btn.addEventListener("click", function () {
      handleAuth();
    });

    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") handleAuth();
    });

    window.addEventListener("load", function() {
      setTimeout(() => input.focus(), 80);
    });
  </script>
</body>
</html>

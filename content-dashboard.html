<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å†…å®¹æ•°æ®å‡½æ•°åˆ†æå·¥å…·ï¼ˆå‡½æ•°è¿è¡Œåœ¨æµè§ˆå™¨ï¼‰</title>
  <link rel="stylesheet" href="gemini-ui.css" />
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* Specific Layout Overrides */
    #auth-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(20px);
      z-index: 9999;
    }

    .auth-card-custom {
      width: 400px;
      max-width: 90vw;
    }

    #app {
      display: none;
    }

    .chart {
      width: 100%;
      height: 400px;
    }

    .upload-hint-bar {
      background: #FFF8E1;
      color: #B06000;
      font-size: 13px;
      padding: 12px 24px;
      border-bottom: 1px solid #FFE082;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .rank-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
    }

    /* Usage Modal specific */
    .usage-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      backdrop-filter: blur(4px);
    }

    /* Shake animation */
    .shake {
      animation: shake 0.3s cubic-bezier(.36, .07, .19, .97) both;
    }

    @keyframes shake {

      10%,
      90% {
        transform: translate3d(-1px, 0, 0);
      }

      20%,
      80% {
        transform: translate3d(2px, 0, 0);
      }

      30%,
      50%,
      70% {
        transform: translate3d(-4px, 0, 0);
      }

      40%,
      60% {
        transform: translate3d(4px, 0, 0);
      }
    }
  </style>
</head>

<body>
  <!-- æˆæƒå±‚ -->
  <div id="auth-screen">
    <div class="gem-card auth-card-custom animate-fade-in" id="auth-card">
      <div style="margin-bottom: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
          <h2 style="font-size: 20px; margin: 0;">ğŸ” å†…éƒ¨æ•°æ®è®¿é—®</h2>
          <span class="gem-chip gem-chip-accent" style="font-size: 11px;">Auth Required</span>
        </div>
        <p style="font-size: 13px;">è¯·è¾“å…¥æˆæƒç è®¿é—®ã€Œå†…å®¹è¡¨ç° Dashboardã€ã€‚<br>æœ¬é¡µä»…ä¾›ç»æˆæƒçš„å†…éƒ¨æˆå‘˜ / åˆä½œæ–¹ä½¿ç”¨ã€‚</p>
      </div>

      <div style="margin-bottom: 20px;">
        <label
          style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--gem-color-text-secondary);">æˆæƒç </label>
        <input id="auth-code" class="gem-input" type="text" placeholder="ä¾‹å¦‚ï¼šICV-2025-7QAF" autocomplete="off" />
      </div>

      <div class="flex items-center justify-between gap-4">
        <span style="font-size: 12px; color: var(--gem-color-text-tertiary);">æŒ‰éœ€åˆ†å‘ï¼Œä¸€æ¬¡ä¸€ç </span>
        <button class="gem-btn gem-btn-primary" id="auth-btn">ç¡®è®¤è¿›å…¥</button>
      </div>

      <div id="auth-error" style="color: #D93025; font-size: 12px; margin-top: 12px; min-height: 16px;"></div>

      <div
        style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #F0F4F9; font-size: 11px; color: var(--gem-color-text-tertiary); display: flex; justify-content: space-between;">
        <span>WeChat å†…å®¹ Dashboard</span>
        <span id="auth-info-tag">æœªæˆæƒ</span>
      </div>
    </div>
  </div>

  <!-- çœŸæ­£çš„ Dashboard æ ¹èŠ‚ç‚¹ï¼šæˆæƒåæ˜¾ç¤º -->
  <div id="app" class="animate-fade-in">
    <!-- Unified Navbar -->
    <nav class="gem-navbar">
      <a href="#" class="gem-navbar-brand">
        <span class="gem-navbar-icon">ğŸ“ˆ</span>
        <span>å†…å®¹æ•°æ®å‡½æ•°åˆ†æ</span>
      </a>

      <div class="gem-navbar-actions">
        <!-- Specific Action for this tool -->
        <label class="gem-btn gem-btn-primary gem-btn-sm">
          ğŸ“¤ é€‰æ‹© CSV / XLSX
          <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;" />
        </label>

        <!-- App Switcher -->
        <div class="gem-app-switcher">
          <button class="gem-app-switcher-btn" title="åˆ‡æ¢å·¥å…·">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path
                d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z" />
            </svg>
          </button>
          <div class="gem-app-switcher-menu">
            <a href="content-dashboard.html" class="gem-app-item">
              <span class="gem-app-icon">ğŸ“ˆ</span>
              <span>å†…å®¹æ•°æ®</span>
            </a>
            <a href="bandao-ops-dashboard.html" class="gem-app-item">
              <span class="gem-app-icon">ğŸ§­</span>
              <span>ä¸“æ /å¸–å­</span>
            </a>
            <a href="page-traffic-dashboard.html" class="gem-app-item">
              <span class="gem-app-icon">ğŸŒ</span>
              <span>é¡µé¢æµé‡</span>
            </a>
            <a href="youmeng.html" class="gem-app-item">
              <span class="gem-app-icon">ğŸ“„</span>
              <span>å‹ç›Ÿå¤šè¡¨</span>
            </a>
            <a href="image-compress.html" class="gem-app-item">
              <span class="gem-app-icon">ğŸ—œï¸</span>
              <span>å›¾ç‰‡å‹ç¼©</span>
            </a>
            <a href="yiban-dashboard.html" class="gem-app-item">
              <span class="gem-app-icon">ğŸ“Š</span>
              <span>å£¹ä¼´æ•°æ®</span>
            </a>
            <a href="article-formatter.html" class="gem-app-item">
              <span class="gem-app-icon">ğŸ“</span>
              <span>æ–‡ç« æ’ç‰ˆ</span>
            </a>
            <a href="image-stitch.html" class="gem-app-item">
              <span class="gem-app-icon">ğŸ–¼ï¸</span>
              <span>é•¿å›¾æ‹¼æ¥</span>
            </a>
          </div>
        </div>

        <a href="index.html" class="gem-btn gem-btn-secondary gem-btn-sm">
          ğŸ  é¦–é¡µ
        </a>
      </div>
    </nav>

    <!-- é¡¶éƒ¨æç¤ºæ¡ -->
    <div class="upload-hint-bar">
      âš ï¸ ä½¿ç”¨å‰è¯·å…ˆç‚¹å‡»å³ä¸Šè§’æŒ‰é’®å¯¼å…¥å…¬ä¼—å·å†…å®¹æ•°æ®ã€‚
    </div>

    <div class="container">
      <div style="margin-bottom: 32px;">
        <h1>å†…å®¹æ•°æ®è¡¨ç°</h1>
        <p id="dateRange">å¤šç»´åº¦çš„é˜…è¯»ã€åˆ†äº«ã€è½¬åŒ–åˆ†ææ´å¯Ÿ</p>
      </div>

      <!-- é¦–æ¬¡ä½¿ç”¨å¼¹çª— -->
      <div id="usageModal" class="usage-modal-backdrop">
        <div class="gem-card" style="width: 420px; max-width: 90vw;">
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 40px; margin-bottom: 12px;">ğŸ‘‹</div>
            <h3 style="font-size: 18px; margin-bottom: 8px;">æ¬¢è¿ä½¿ç”¨å†…å®¹è¡¨ç° Dashboard</h3>
            <p style="font-size: 14px;">æœ¬åœ°æµè§ˆå™¨è¿è¡Œï¼Œæ•°æ®å‡åœ¨æœ¬åœ°è§£æä¸ä¸Šä¼ ã€‚</p>
          </div>
          <div class="flex justify-between items-center" style="margin-top: 24px;">
            <span class="gem-chip" id="usageModalSkip" style="cursor: pointer; background: transparent;">ä¸å†æç¤º</span>
            <button class="gem-btn gem-btn-primary" id="usageModalBtn">å¼€å§‹ä½¿ç”¨</button>
          </div>
        </div>
      </div>

      <!-- ä½¿ç”¨è¯´æ˜å¡ç‰‡ -->
      <div class="gem-card" id="usageCard" style="margin-bottom: 24px;">
        <div class="flex items-center justify-between cursor-pointer" id="usageToggle" style="cursor: pointer;">
          <div class="flex items-center gap-4">
            <div
              style="width: 36px; height: 36px; background: #E8F0FE; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">
              ğŸ“˜</div>
            <div>
              <div style="font-weight: 600; font-size: 16px; margin-bottom: 2px;">Dashboard ä½¿ç”¨æŒ‡å—</div>
              <div style="font-size: 12px; color: var(--gem-color-text-tertiary);">æ”¯æŒ CSV / XLSXï¼Œæœ¬åœ°è§£æå…¬ä¼—å·å†…å®¹ç»´åº¦æ•°æ®</div>
            </div>
          </div>
          <div id="usageChevron" style="transition: transform 0.2s;">â–¼</div>
        </div>

        <div id="usageBody" style="margin-top: 24px; padding-top: 16px; border-top: 1px dashed #E0E3E7;">
          <!-- Existing content preserved but simplified styles where needed -->
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 24px;">
            <div>
              <h4 style="font-size: 14px; margin-bottom: 8px;">1. æ•°æ®è·å–</h4>
              <p style="font-size: 13px;">å…¬ä¼—å·åå° > æ•°æ®åˆ†æ > å†…å®¹åˆ†æ > å·²é€šçŸ¥å†…å®¹ > ä¸‹è½½æ•°æ®æ˜ç»†ã€‚</p>
              <img src="wechat-export-location.png"
                style="max-width: 100%; border-radius: 8px; border: 1px solid #E0E3E7;" />
            </div>
            <div>
              <h4 style="font-size: 14px; margin-bottom: 8px;">2. åŠŸèƒ½æ¦‚è§ˆ</h4>
              <ul style="font-size: 13px; color: var(--gem-color-text-secondary); padding-left: 20px;">
                <li>Summary: æ ¸å¿ƒæŒ‡æ ‡æ¦‚è§ˆ</li>
                <li>Top Chart: é˜…è¯»ä¸åˆ†äº«åˆ†å¸ƒ</li>
                <li>Quad Chart: å››è±¡é™å†…å®¹è¯Šæ–­</li>
                <li>Rankings: 11ä¸ªç»´åº¦çš„è‡ªåŠ¨æ¦œå•</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div id="loading" style="text-align: center; color: var(--gem-color-accent); font-weight: 500; margin: 20px 0;">
      </div>
      <div id="error" style="text-align: center; color: #D93025; margin: 20px 0;"></div>

      <!-- Summary å¡ç‰‡ -->
      <div class="cards-grid" id="summaryCards" style="display:none;">
        <div class="gem-card flex flex-col items-center text-center">
          <div style="font-size: 12px; color: var(--gem-color-text-tertiary); margin-bottom: 4px;">æ–‡ç« æ€»æ•°</div>
          <div style="font-size: 24px; font-weight: 700;" id="totalArticles">-</div>
        </div>
        <div class="gem-card flex flex-col items-center text-center">
          <div style="font-size: 12px; color: var(--gem-color-text-tertiary); margin-bottom: 4px;">æ€»é˜…è¯»æ¬¡æ•°</div>
          <div style="font-size: 24px; font-weight: 700;" id="totalReadCount">-</div>
        </div>
        <div class="gem-card flex flex-col items-center text-center">
          <div style="font-size: 12px; color: var(--gem-color-text-tertiary); margin-bottom: 4px;">æ€»é˜…è¯»äººæ•°</div>
          <div style="font-size: 24px; font-weight: 700;" id="totalReaders">-</div>
        </div>
        <div class="gem-card flex flex-col items-center text-center">
          <div style="font-size: 12px; color: var(--gem-color-text-tertiary); margin-bottom: 4px;">æ€»åˆ†äº«æ¬¡æ•°</div>
          <div style="font-size: 24px; font-weight: 700;" id="totalShareCount">-</div>
        </div>
        <div class="gem-card flex flex-col items-center text-center">
          <div style="font-size: 12px; color: var(--gem-color-text-tertiary); margin-bottom: 4px;">æ€»é€è¾¾äººæ•°</div>
          <div style="font-size: 24px; font-weight: 700;" id="totalDelivered">-</div>
        </div>
        <div class="gem-card flex flex-col items-center text-center">
          <div style="font-size: 12px; color: var(--gem-color-text-tertiary); margin-bottom: 4px;">å¹³å‡é€è¾¾é˜…è¯»ç‡</div>
          <div style="font-size: 24px; font-weight: 700;" id="avgDeliverReadRate">-</div>
        </div>
        <div class="gem-card flex flex-col items-center text-center">
          <div style="font-size: 12px; color: var(--gem-color-text-tertiary); margin-bottom: 4px;">å¹³å‡é˜…è¯»å®Œæˆç‡</div>
          <div style="font-size: 24px; font-weight: 700;" id="avgFinishRate">-</div>
        </div>
      </div>

      <h2 style="margin: 32px 0 16px;">äºŒã€Top å†…å®¹è¡¨ç°</h2>
      <div class="gem-card" style="margin-bottom: 24px;">
        <h3>Top10 å†…å®¹ï¼ˆæŒ‰æ€»é˜…è¯»æ¬¡æ•°ï¼‰</h3>
        <div id="topReadChart" class="chart"></div>
      </div>

      <div class="gem-card" style="margin-bottom: 24px;">
        <h3>é˜…è¯»æ¬¡æ•° vs åˆ†äº«æ¬¡æ•°</h3>
        <div id="readShareScatter" class="chart"></div>
      </div>

      <h2>ä¸‰ã€è½¬åŒ–ä¸å®Œæˆåº¦</h2>
      <div class="gem-card" style="margin-bottom: 24px;">
        <h3>é˜…è¯»å®Œæˆç‡ï¼ˆTop50ï¼‰</h3>
        <div id="finishRateChart" class="chart"></div>
      </div>

      <div class="gem-card" style="margin-bottom: 24px;">
        <h3>é€è¾¾é˜…è¯»ç‡ï¼ˆTop50ï¼‰</h3>
        <div id="deliverRateChart" class="chart"></div>
      </div>

      <h2>å››ã€å†…å®¹æ˜ç»†ï¼ˆTop100 æŒ‰é˜…è¯»æ¬¡æ•°ï¼‰</h2>
      <div class="gem-card" style="margin-bottom: 24px;">
        <h3>å†…å®¹æ˜ç»†è¡¨</h3>
        <div id="detailTable"></div>
      </div>

      <h2>äº”ã€å…³é”®æŒ‡æ ‡ TOP æ¦œå•</h2>
      <div class="gem-card" style="margin-bottom: 24px;">
        <h3>æ ¸å¿ƒæŒ‡æ ‡ Top3 æ¦œå•</h3>
        <div id="keyRanks" class="rank-grid"></div>
      </div>

      <!-- å…­ã€é˜…è¯» Ã— æ€»åˆ†äº«æ¬¡æ•°å››è±¡é™åˆ†æ -->
      <h2>å…­ã€é˜…è¯» Ã— æ€»åˆ†äº«æ¬¡æ•°å››è±¡é™åˆ†æ</h2>
      <div class="gem-card" style="margin-bottom: 24px;">
        <h3>é˜…è¯»é‡ vs æ€»åˆ†äº«æ¬¡æ•°ï¼ˆå››è±¡é™ï¼‰</h3>
        <div id="quadrantChart" class="chart"></div>
        <div id="quadrantInsight" style="font-size:12px;color:#6b7280;margin-top:8px;"></div>
      </div>

      <div class="footer" style="font-size:11px;color:#9ca3af;margin-top:24px;text-align:center;">
        æœ¬é¡µé¢ä»…åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­è¿è¡Œï¼Œä¸ä¼šä¸Šä¼ ä»»ä½•æ•°æ®ã€‚
      </div>
    </div>
  </div>

  <!-- ===== Dashboard è„šæœ¬ ===== -->
  <script>
    const fileInput = document.getElementById("fileInput");
    const loadingEl = document.getElementById("loading");
    const errorEl = document.getElementById("error");

    fileInput.addEventListener("change", handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      loadingEl.textContent = "è§£æä¸­ï¼Œè¯·ç¨å€™â€¦";
      errorEl.textContent = "";

      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const workbook = XLSX.read(evt.target.result, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
          process(rows);
        } catch (err) {
          console.error(err);
          errorEl.textContent = "æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼æˆ–å¦å­˜ä¸º UTF-8 åå†è¯•ã€‚";
        }
        loadingEl.textContent = "";
      };
      reader.readAsArrayBuffer(file);
    }

    function num(v) {
      if (v === null || v === undefined || v === "") return 0;
      return Number(String(v).replace(/,/g, "")) || 0;
    }
    function pct(v) {
      if (!v) return 0;
      const s = String(v).trim();
      if (s.endsWith("%")) return parseFloat(s.slice(0, -1)) || 0;
      return parseFloat(s) || 0;
    }
    function dateParse(v) {
      let d = new Date(v);
      if (!isNaN(d)) return d;
      if (typeof v === "number")
        return new Date(Math.round((v - 25569) * 86400 * 1000));
      return null;
    }
    function dateFmt(d) {
      if (!d) return "";
      return (
        d.getFullYear() +
        "-" +
        String(d.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(d.getDate()).padStart(2, "0")
      );
    }

    function findCol(names, cols) {
      for (const n of names) if (cols.includes(n)) return n;
      return null;
    }

    function process(rows) {
      if (!rows.length) {
        errorEl.textContent = "æ–‡ä»¶ä¸ºç©º";
        return;
      }

      const cols = Object.keys(rows[0]);

      const colTitle = findCol(["å†…å®¹æ ‡é¢˜", "æ ‡é¢˜"], cols);
      const colTime = findCol(["å‘è¡¨æ—¶é—´", "å‘å¸ƒæ—¶é—´"], cols);
      const colReadUser = findCol(["æ€»é˜…è¯»äººæ•°"], cols);
      const colReadCount = findCol(["æ€»é˜…è¯»æ¬¡æ•°"], cols);
      const colShareCount = findCol(["æ€»åˆ†äº«æ¬¡æ•°"], cols);
      const colFirstShare = findCol(["é¦–æ¬¡åˆ†äº«æ¬¡æ•°"], cols);
      const colShareRead = findCol(["åˆ†äº«äº§ç”Ÿé˜…è¯»æ¬¡æ•°"], cols);
      const colFinishRate = findCol(["é˜…è¯»å®Œæˆç‡", "é˜…è¯»å®Œæˆç‡(%)"], cols);
      const colDeliverRate = findCol(["é€è¾¾é˜…è¯»ç‡", "é€è¾¾é˜…è¯»ç‡(%)"], cols);
      const colMsgRead = findCol(["å…¬ä¼—å·æ¶ˆæ¯é˜…è¯»æ¬¡æ•°"], cols);
      const colDelivered = findCol(["é€è¾¾äººæ•°"], cols);
      const colFollow = findCol(["é˜…è¯»åå…³æ³¨äººæ•°"], cols);

      if (!colTitle || !colReadCount) {
        errorEl.textContent = "ç¼ºå°‘å¿…è¦å­—æ®µï¼šå†…å®¹æ ‡é¢˜ã€æ€»é˜…è¯»æ¬¡æ•°";
        return;
      }

      let data = rows.map(r => {
        const readUser = num(r[colReadUser]);
        const shareCount = num(r[colShareCount]);
        const firstShare = num(r[colFirstShare]);
        const shareRead = num(r[colShareRead]);
        const follow = num(r[colFollow]);
        const time = dateParse(r[colTime]);

        return {
          title: r[colTitle],
          time,
          readUser,
          readCount: num(r[colReadCount]),
          shareCount,
          firstShare,
          shareRead,
          finishRate: pct(r[colFinishRate]),
          deliverRate: pct(r[colDeliverRate]),
          msgRead: num(r[colMsgRead]),
          delivered: num(r[colDelivered]),
          follow,

          // é¦–æ¬¡åˆ†äº«ç‡ï¼ˆ%ï¼‰
          firstShareRate:
            readUser > 0 ? (firstShare / readUser) * 100 : 0,

          // æ¯æ¬¡åˆ†äº«å¸¦æ¥çš„é˜…è¯»æ•°
          readPerShare:
            shareCount > 0 ? (shareRead / shareCount) : 0,

          // é˜…è¯»åå…³æ³¨ç‡ï¼ˆ%ï¼‰
          attentionRate:
            readUser > 0
              ? (follow / readUser) * 100
              : 0
        };
      });

      renderSummary(data);
      renderTopRead(data);
      renderReadShare(data);
      renderFinishRate(data);
      renderDeliverRate(data);
      renderDetail(data);
      renderRanks(data);
      renderQuadrant(data); // å››è±¡é™åˆ†æ
    }

    function renderSummary(data) {
      document.getElementById("summaryCards").style.display = "grid";

      document.getElementById("totalArticles").textContent = data.length;
      document.getElementById("totalReadCount").textContent = sum(data, "readCount");
      document.getElementById("totalReaders").textContent = sum(data, "readUser");
      document.getElementById("totalShareCount").textContent = sum(data, "shareCount");
      document.getElementById("totalDelivered").textContent = sum(data, "delivered");

      document.getElementById("avgDeliverReadRate").textContent =
        avg(data, "deliverRate").toFixed(2) + "%";
      document.getElementById("avgFinishRate").textContent =
        avg(data, "finishRate").toFixed(2) + "%";

      const times = data.map(d => d.time).filter(Boolean);
      if (times.length) {
        const min = new Date(Math.min(...times));
        const max = new Date(Math.max(...times));
        document.getElementById("dateRange").textContent =
          "æ—¶é—´èŒƒå›´ï¼š" + dateFmt(min) + " ~ " + dateFmt(max);
      }
    }

    function sum(arr, key) {
      return arr.reduce((a, b) => a + (b[key] || 0), 0);
    }
    function avg(arr, key) {
      const v = arr.map(r => r[key]).filter(v => v > 0);
      return v.length ? v.reduce((a, b) => a + b, 0) / v.length : 0;
    }

    function topN(arr, key, n = 3) {
      return arr
        .filter(r => r[key] > 0)
        .sort((a, b) => b[key] - a[key])
        .slice(0, n);
    }

    function renderTopRead(data) {
      const top = data
        .slice()
        .sort((a, b) => b.readCount - a.readCount)
        .slice(0, 10);

      Plotly.newPlot("topReadChart", [
        {
          x: top.map(x => x.title),
          y: top.map(x => x.readCount),
          type: "bar"
        }
      ], {
        margin: { b: 120 }
      });
    }

    function renderReadShare(data) {
      Plotly.newPlot("readShareScatter", [
        {
          x: data.map(x => x.readCount),
          y: data.map(x => x.shareCount),
          mode: "markers",
          type: "scatter",
          text: data.map(x => x.title)
        }
      ], {
        xaxis: { title: "é˜…è¯»æ¬¡æ•°" },
        yaxis: { title: "åˆ†äº«æ¬¡æ•°" }
      });
    }

    function renderFinishRate(data) {
      const list = data
        .filter(x => x.finishRate > 0)
        .sort((a, b) => b.finishRate - a.finishRate)
        .slice(0, 50);

      Plotly.newPlot("finishRateChart", [
        {
          x: list.map(x => x.title),
          y: list.map(x => x.finishRate),
          type: "bar"
        }
      ], { margin: { b: 120 } });
    }

    function renderDeliverRate(data) {
      const list = data
        .filter(x => x.deliverRate > 0)
        .sort((a, b) => b.deliverRate - a.deliverRate)
        .slice(0, 50);

      Plotly.newPlot("deliverRateChart", [
        {
          x: list.map(x => x.title),
          y: list.map(x => x.deliverRate),
          type: "bar"
        }
      ], { margin: { b: 120 } });
    }

    function renderDetail(data) {
      const top = data
        .slice()
        .sort((a, b) => b.readCount - a.readCount)
        .slice(0, 100);

      let html = "<div style='overflow-x: auto;'><table class='gem-table'><thead><tr>";
      const headers = [
        "å†…å®¹æ ‡é¢˜", "å‘è¡¨æ—¶é—´", "æ€»é˜…è¯»äººæ•°", "æ€»é˜…è¯»æ¬¡æ•°",
        "æ€»åˆ†äº«æ¬¡æ•°", "é¦–æ¬¡åˆ†äº«æ¬¡æ•°", "åˆ†äº«äº§ç”Ÿé˜…è¯»æ¬¡æ•°",
        "é˜…è¯»å®Œæˆç‡(%)", "é€è¾¾é˜…è¯»ç‡(%)",
        "å…¬ä¼—å·æ¶ˆæ¯é˜…è¯»æ¬¡æ•°", "é€è¾¾äººæ•°", "é˜…è¯»åå…³æ³¨äººæ•°"
      ];
      headers.forEach(h => html += `<th>${h}</th>`);
      html += "</tr></thead><tbody>";

      top.forEach(r => {
        html += "<tr>";
        html += `<td>${escapeHtml(r.title)}</td>`;
        html += `<td>${r.time ? dateFmt(r.time) : ""}</td>`;
        html += `<td>${r.readUser}</td>`;
        html += `<td>${r.readCount}</td>`;
        html += `<td>${r.shareCount}</td>`;
        html += `<td>${r.firstShare}</td>`;
        html += `<td>${r.shareRead}</td>`;
        html += `<td>${r.finishRate.toFixed(2)}</td>`;
        html += `<td>${r.deliverRate.toFixed(2)}</td>`;
        html += `<td>${r.msgRead}</td>`;
        html += `<td>${r.delivered}</td>`;
        html += `<td>${r.follow}</td>`;
        html += "</tr>";
      });

      html += "</tbody></table></div>";
      document.getElementById("detailTable").innerHTML = html;
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function renderRanks(data) {
      let html = "";

      const rankItems = [
        ["é˜…è¯»è¡¨ç° TOP3ï¼ˆæŒ‰é˜…è¯»æ¬¡æ•°ï¼‰", "readCount", ""],
        ["å…¬ä¼—å·æ¶ˆæ¯é˜…è¯»æ¬¡æ•° TOP3", "msgRead", ""],
        ["å®Œè¯»ç‡ TOP3", "finishRate", "%"],
        ["åˆ†äº«æ„æ„¿ TOP3ï¼ˆæŒ‰é¦–æ¬¡åˆ†äº«ç‡ï¼‰", "firstShareRate", "%"],
        ["åˆ†äº«åŠ¨åŠ› TOP3ï¼ˆæŒ‰é¦–æ¬¡åˆ†äº«æ¬¡æ•°ï¼‰", "firstShare", ""],
        ["äºŒæ¬¡ä¼ æ’­ TOP3ï¼ˆæŒ‰åˆ†äº«äº§ç”Ÿé˜…è¯»ï¼‰", "shareRead", ""],
        ["åˆ†äº«æ•ˆç‡ TOP3ï¼ˆæ¯æ¬¡åˆ†äº«å¸¦æ¥é˜…è¯»ï¼‰", "readPerShare", ""],
        ["åˆ†äº«è§„æ¨¡ TOP3ï¼ˆæ€»åˆ†äº«æ¬¡æ•°ï¼‰", "shareCount", ""],
        ["å…³æ³¨æ–°å¢è´¡çŒ® TOP3", "follow", ""],
        ["æ ‡é¢˜å¸å¼•åŠ› TOP3ï¼ˆé€è¾¾é˜…è¯»ç‡ï¼‰", "deliverRate", "%"],
        ["ç”¨æˆ·å…³æ³¨å¼•åŠ› TOP3", "attentionRate", "%"]
      ];

      rankItems.forEach(([title, key, suffix]) => {
        const top = topN(data, key, 3);
        if (!top.length) return;

        html += `<div class="rank-block-item" style="overflow-x: auto;">
          <div style="font-size:13px;font-weight:600;margin-bottom:6px;">${title}</div>
          <table class='gem-table'><thead><tr>
            <th>æ’å</th><th>å†…å®¹æ ‡é¢˜</th><th>å€¼</th>
          </tr></thead><tbody>`;

        top.forEach((r, i) => {
          html += `<tr>
            <td>${i + 1}</td>
            <td>${escapeHtml(r.title)}</td>
            <td>${r[key].toFixed ? r[key].toFixed(2) : r[key]}${suffix}</td>
          </tr>`;
        });

        html += "</tbody></table></div>";
      });

      document.getElementById("keyRanks").innerHTML = html;
    }

    // é˜…è¯» Ã— æ€»åˆ†äº«æ¬¡æ•°å››è±¡é™åˆ†æ
    function renderQuadrant(data) {
      const points = data
        .filter(d => d.readCount > 0 && d.shareCount > 0)
        .map(d => ({
          title: d.title,
          read: d.readCount,
          share: d.shareCount
        }));

      const insightEl = document.getElementById("quadrantInsight");

      if (!points.length) {
        insightEl.textContent = "æš‚æ— è¶³å¤Ÿçš„é˜…è¯»ä¸åˆ†äº«æ•°æ®ï¼Œæš‚æ— æ³•ç»˜åˆ¶å››è±¡é™åˆ†æã€‚";
        return;
      }

      const reads = points.map(p => p.read).slice().sort((a, b) => a - b);
      const shares = points.map(p => p.share).slice().sort((a, b) => a - b);

      function median(arr) {
        if (!arr.length) return 0;
        const n = arr.length;
        const mid = Math.floor(n / 2);
        return n % 2 === 1
          ? arr[mid]
          : (arr[mid - 1] + arr[mid]) / 2;
      }

      const readMid = median(reads);
      const shareMid = median(shares);

      const minRead = Math.min(...reads);
      const maxRead = Math.max(...reads);
      const minShare = Math.min(...shares);
      const maxShare = Math.max(...shares);

      const xPadding = (maxRead - minRead) * 0.1;
      const yPadding = (maxShare - minShare) * 0.1;

      const xMinRange = Math.max(0, minRead - xPadding);
      const xMaxRange = maxRead + xPadding;
      const yMinRange = Math.max(0, minShare - yPadding);
      const yMaxRange = maxShare + yPadding;

      const xCenter = (xMinRange + xMaxRange) / 2;
      const yCenter = (yMinRange + yMaxRange) / 2;

      const q1 = [];
      const q2 = [];
      const q3 = [];
      const q4 = [];

      points.forEach(p => {
        if (p.read >= readMid && p.share >= shareMid) {
          q1.push(p);
        } else if (p.read < readMid && p.share >= shareMid) {
          q2.push(p);
        } else if (p.read < readMid && p.share < shareMid) {
          q3.push(p);
        } else {
          q4.push(p);
        }
      });

      function makeTrace(list, name, symbol) {
        return {
          x: list.map(p => p.read),
          y: list.map(p => p.share),
          mode: "markers",
          type: "scatter",
          name,
          text: list.map(p => p.title),
          marker: {
            size: 9,
            symbol
          }
        };
      }

      Plotly.newPlot("quadrantChart", [
        makeTrace(q1, "é«˜é˜…è¯» Â· é«˜åˆ†äº«", "circle"),
        makeTrace(q2, "ä½é˜…è¯» Â· é«˜åˆ†äº«", "triangle-up"),
        makeTrace(q3, "ä½é˜…è¯» Â· ä½åˆ†äº«", "square"),
        makeTrace(q4, "é«˜é˜…è¯» Â· ä½åˆ†äº«", "diamond")
      ], {
        xaxis: {
          title: "æ€»é˜…è¯»æ¬¡æ•°",
          zeroline: false,
          range: [xMinRange, xMaxRange]
        },
        yaxis: {
          title: "æ€»åˆ†äº«æ¬¡æ•°",
          zeroline: false,
          range: [yMinRange, yMaxRange]
        },
        shapes: [
          {
            type: "line",
            x0: readMid,
            x1: readMid,
            y0: yMinRange,
            y1: yMaxRange,
            line: { dash: "dot", width: 1 }
          },
          {
            type: "line",
            x0: xMinRange,
            x1: xMaxRange,
            y0: shareMid,
            y1: shareMid,
            line: { dash: "dot", width: 1 }
          }
        ],
        margin: { t: 30 }
      });

      const total = points.length;
      const pct = n => ((n / total) * 100).toFixed(1);

      insightEl.innerHTML =
        `åŸºäº ${total} ç¯‡å…·å¤‡ã€Œé˜…è¯» + æ€»åˆ†äº«æ¬¡æ•°ã€æ•°æ®çš„å†…å®¹ï¼Œä½¿ç”¨æ ·æœ¬ä¸­ä½æ•°ä½œä¸ºé«˜/ä½åˆ†ç•Œï¼š` +
        `æ€»é˜…è¯»æ¬¡æ•°ä¸­ä½æ•°çº¦ä¸º <b>${Math.round(readMid)}</b>ï¼Œæ€»åˆ†äº«æ¬¡æ•°ä¸­ä½æ•°çº¦ä¸º <b>${Math.round(shareMid)}</b>ã€‚<br>` +
        `å„è±¡é™æ–‡ç« æ•°é‡ä¸å æ¯”åˆ†åˆ«ä¸ºï¼š` +
        `é«˜é˜…è¯»Â·é«˜åˆ†äº« ${q1.length} ç¯‡ï¼ˆ${pct(q1.length)}%ï¼‰ï¼Œ` +
        `ä½é˜…è¯»Â·é«˜åˆ†äº« ${q2.length} ç¯‡ï¼ˆ${pct(q2.length)}%ï¼‰ï¼Œ` +
        `ä½é˜…è¯»Â·ä½åˆ†äº« ${q3.length} ç¯‡ï¼ˆ${pct(q3.length)}%ï¼‰ï¼Œ` +
        `é«˜é˜…è¯»Â·ä½åˆ†äº« ${q4.length} ç¯‡ï¼ˆ${pct(q4.length)}%ï¼‰ã€‚`;
    }
  </script>

  <!-- ===== æˆæƒé€»è¾‘è„šæœ¬ + ä½¿ç”¨è¯´æ˜äº¤äº’ ===== -->
  <script>
    const TOOL_ID = "content-analysis";
    const STORAGE_KEY = `wechat_dashboard_auth_${TOOL_ID}`;
    const USAGE_INTRO_KEY = `wechat_dashboard_intro_seen_${TOOL_ID}`;
    // æœ¬åœ°æ–‡ä»¶æ¨¡å¼ä¸‹ï¼ˆfile://ï¼‰æ— æ³• fetchï¼Œæœ¬åœ°å†…ç½®æˆæƒç å…œåº•
    const INLINE_AUTH_CODES = {
      tools: {
        "content-analysis": {
          codes: {
            "ICV-2025-7QAF": "æ ‡å‡†æˆæƒ",
            "ICV-2025-P3ZD": "æ ‡å‡†æˆæƒ",
            "ICV-2025-L8XK": "æ ‡å‡†æˆæƒ",
            "ICV-2025-G2MW": "æ ‡å‡†æˆæƒ",
            "ICV-2025-R9CE": "æ ‡å‡†æˆæƒ",
            "ICV-2025-H4VU": "æ ‡å‡†æˆæƒ",
            "ICV-2025-Y1SN": "æ ‡å‡†æˆæƒ",
            "ICV-2025-K5BJ": "æ ‡å‡†æˆæƒ",
            "ICV-2025-X7TP": "æ ‡å‡†æˆæƒ",
            "ICV-2025-W6QD": "æ ‡å‡†æˆæƒ"
          }
        }
      }
    };

    // åŠ¨æ€åŠ è½½æˆæƒç 
    let AUTH_CODES = {};
    let authLoaded = false;

    function loadAuthCodes() {
      // file:// ä¸‹ç›´æ¥ç”¨å†…ç½®æˆæƒç ï¼Œé¿å… fetch è¢«æµè§ˆå™¨æ‹¦æˆª
      if (location.protocol === "file:") {
        AUTH_CODES = INLINE_AUTH_CODES.tools?.[TOOL_ID]?.codes || {};
        authLoaded = true;
        console.log("ä½¿ç”¨å†…ç½®æˆæƒç ï¼ˆfile:// æ¨¡å¼ï¼‰");
        return Promise.resolve();
      }
      const url = "./auth-codes.json?" + Date.now();
      console.log("å°è¯•åŠ è½½æˆæƒç æ–‡ä»¶ï¼š", url);

      return fetch(url)
        .then(async (res) => {
          if (!res.ok) {
            const text = await res.text().catch(() => "");
            console.error("auth-codes.json å“åº”å¼‚å¸¸ï¼š", res.status, res.statusText, text);
            throw new Error("HTTP " + res.status);
          }
          return res.json();
        })
        .then((data) => {
          console.log("auth-codes.json åŠ è½½æˆåŠŸï¼š", data);
          // æå–å½“å‰å·¥å…·çš„æˆæƒç 
          if (data.tools && data.tools[TOOL_ID]) {
            AUTH_CODES = data.tools[TOOL_ID].codes || {};
          } else if (typeof data === 'object') {
            // å…¼å®¹æ—§æ ¼å¼
            AUTH_CODES = data;
          }
          authLoaded = true;
        })
        .catch((err) => {
          console.error("æˆæƒç æ–‡ä»¶åŠ è½½å¤±è´¥:", err);
          // å…œåº•ï¼šå¦‚æœæœ‰å†…ç½®æˆæƒç åˆ™ç»§ç»­ä½¿ç”¨ï¼Œé¿å…é˜»æ–­ä½¿ç”¨
          AUTH_CODES = INLINE_AUTH_CODES.tools?.[TOOL_ID]?.codes || {};
          authLoaded = true;
          if (!Object.keys(AUTH_CODES).length) {
            alert("æˆæƒç æ–‡ä»¶åŠ è½½å¤±è´¥ï¼š\n" +
              "1ï¼‰ç¡®è®¤æ ¹ç›®å½•å­˜åœ¨ auth-codes.json\n" +
              "2ï¼‰ç¡®è®¤éƒ¨ç½²åå¯ä»¥ç›´æ¥è®¿é—® /auth-codes.json\n" +
              "3ï¼‰ç¡®è®¤æ–‡ä»¶å†…å®¹æ˜¯åˆæ³• JSONï¼ˆæ— å¤šä½™é€—å·/æ³¨é‡Šï¼‰");
          }
        });
    }

    const authScreen = document.getElementById("auth-screen");
    const appRoot = document.getElementById("app");
    const input = document.getElementById("auth-code");
    const btn = document.getElementById("auth-btn");
    const errElAuth = document.getElementById("auth-error");
    const cardEl = document.getElementById("auth-card");
    const infoTag = document.getElementById("auth-info-tag");

    function initUsageGuide() {
      const card = document.getElementById("usageCard");
      const body = document.getElementById("usageBody");
      const chevron = document.getElementById("usageChevron");
      const toggle = document.getElementById("usageToggle");
      const modal = document.getElementById("usageModal");
      const modalBtn = document.getElementById("usageModalBtn");
      const modalSkip = document.getElementById("usageModalSkip");

      if (!card || !body || !chevron || !toggle) return;

      let expanded = true;
      function setExpanded(state) {
        expanded = state;
        body.style.display = state ? "block" : "none";
        if (state) {
          chevron.classList.add("expanded");
        } else {
          chevron.classList.remove("expanded");
        }
      }

      setExpanded(true);

      toggle.addEventListener("click", function () {
        setExpanded(!expanded);
      });

      const seen = (function () {
        try {
          return localStorage.getItem(USAGE_INTRO_KEY);
        } catch (e) {
          return null;
        }
      })();

      if (!seen && modal) {
        modal.style.display = "flex";
      }

      function closeModalAndRemember() {
        if (modal) modal.style.display = "none";
        try {
          localStorage.setItem(USAGE_INTRO_KEY, "1");
        } catch (e) { }
      }

      if (modalBtn) {
        modalBtn.addEventListener("click", closeModalAndRemember);
      }
      if (modalSkip) {
        modalSkip.addEventListener("click", closeModalAndRemember);
      }
    }

    function showApp(code) {
      const label = AUTH_CODES[code] || "å·²æˆæƒè®¿é—®";
      infoTag.textContent = label;
      authScreen.style.display = "none";
      appRoot.style.display = "block";
      try {
        localStorage.setItem(
          STORAGE_KEY,
          JSON.stringify({ code, label, ts: Date.now() })
        );
      } catch (e) { }
      try {
        initUsageGuide();
      } catch (e) {
        console.warn("initUsageGuide error:", e);
      }
    }

    function shakeCard() {
      cardEl.classList.remove("shake");
      void cardEl.offsetWidth;
      cardEl.classList.add("shake");
    }

    async function handleAuth() {
      const code = (input.value || "").trim();

      if (!authLoaded) {
        await loadAuthCodes();
      }

      if (!code) {
        errElAuth.textContent = "è¯·è¾“å…¥æˆæƒç ã€‚";
        shakeCard();
        return;
      }
      if (!Object.prototype.hasOwnProperty.call(AUTH_CODES, code)) {
        errElAuth.textContent = "æˆæƒç æ— æ•ˆï¼Œè¯·ç¡®è®¤åé‡æ–°è¾“å…¥ã€‚";
        shakeCard();
        return;
      }
      errElAuth.textContent = "";
      showApp(code);
    }

    (async function bootstrapAuth() {
      await loadAuthCodes();

      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        const parsed = JSON.parse(saved);
        if (parsed && parsed.code && AUTH_CODES[parsed.code]) {
          showApp(parsed.code);
        }
      } catch (e) {
        // ignore
      }
    })();

    btn.addEventListener("click", function () {
      handleAuth();
    });

    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") handleAuth();
    });

    window.addEventListener("load", function () {
      setTimeout(() => input.focus(), 80);
    });
  </script>
</body>

</html>
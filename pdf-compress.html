<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF å‹ç¼©å·¥å…· - é«˜æ•ˆå‹ç¼©ï¼Œæœ¬åœ°å¤„ç†</title>

  <!-- è®¾è®¡ç³»ç»Ÿ -->
  <link rel="stylesheet" href="ui.css" />

  <!-- PDF å¤„ç†åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.269/build/pdf.min.js"></script>

  <!-- JSZip ç”¨äºä¸‹è½½ -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    /* ===== é¡µé¢ç‰¹å®šæ ·å¼ ===== */
    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #f0f4f8 100%);
      min-height: 100vh;
    }

    /* ===== ä¸»å®¹å™¨ ===== */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--space-3xl) var(--space-lg);
    }

    /* ===== é¡¶éƒ¨å¡ç‰‡ ===== */
    .intro-card {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: white;
      padding: var(--space-3xl);
      border-radius: var(--radius-xl);
      margin-bottom: var(--space-3xl);
      box-shadow: 0 12px 32px rgba(59, 130, 246, 0.2);
    }

    .intro-title {
      font-size: var(--text-3xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-md);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .intro-desc {
      font-size: var(--text-lg);
      opacity: 0.95;
      line-height: 1.6;
    }

    /* ===== å†…å®¹ç½‘æ ¼ ===== */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-2xl);
    }

    /* ===== å¡ç‰‡ ===== */
    .card {
      background: var(--color-bg-primary);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-2xl);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      transition: all var(--transition-base);
    }

    .card:hover {
      border-color: var(--color-primary);
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.12);
    }

    .card-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-2xl);
      color: var(--color-text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .card-icon {
      font-size: 28px;
    }

    /* ===== ä¸Šä¼ åŒºåŸŸ ===== */
    .upload-area {
      border: 2px dashed var(--color-primary);
      border-radius: var(--radius-lg);
      padding: var(--space-3xl);
      text-align: center;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%);
      cursor: pointer;
      transition: all var(--transition-base);
      position: relative;
    }

    .upload-area:hover {
      border-color: var(--color-primary-dark);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
    }

    .upload-area.dragover {
      border-color: var(--color-primary-dark);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(147, 51, 234, 0.15) 100%);
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: var(--space-md);
      opacity: 0.8;
    }

    .upload-text {
      font-size: var(--text-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
      margin-bottom: var(--space-sm);
    }

    .upload-hint {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    .upload-input {
      display: none;
    }

    /* ===== æ§åˆ¶é¢æ¿ ===== */
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-2xl);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .form-label {
      font-size: var(--text-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .form-label-value {
      color: var(--color-primary);
      font-weight: var(--font-weight-bold);
      font-size: var(--text-md);
    }

    .form-input,
    .form-select {
      padding: var(--space-md);
      border: 1px solid var(--color-border-medium);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      background: var(--color-bg-secondary);
      color: var(--color-text-primary);
      transition: all var(--transition-base);
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .range-input {
      width: 100%;
      cursor: pointer;
    }

    .strength-buttons {
      display: flex;
      gap: var(--space-sm);
    }

    .strength-btn {
      flex: 1;
      padding: var(--space-md);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      background: var(--color-bg-secondary);
      color: var(--color-text-primary);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .strength-btn:hover {
      border-color: var(--color-primary);
      background: var(--color-primary-bg);
    }

    .strength-btn.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    /* ===== é¢„è§ˆé¢æ¿ ===== */
    .preview-panel {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-2xl);
      margin-bottom: var(--space-2xl);
      display: none;
    }

    .preview-panel.show {
      display: block;
    }

    .preview-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-2xl);
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .info-label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      font-weight: var(--font-weight-semibold);
    }

    .info-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text-primary);
    }

    .preview-canvas {
      width: 100%;
      max-height: 400px;
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      background: white;
      margin-bottom: var(--space-lg);
    }

    .preview-controls {
      display: flex;
      justify-content: center;
      gap: var(--space-md);
      flex-wrap: wrap;
    }

    .preview-btn {
      padding: var(--space-sm) var(--space-lg);
      border: 1px solid var(--color-border-light);
      background: var(--color-bg-primary);
      color: var(--color-primary);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: var(--font-weight-semibold);
      transition: all var(--transition-base);
    }

    .preview-btn:hover {
      background: var(--color-primary-bg);
      border-color: var(--color-primary);
    }

    /* ===== è¿›åº¦æ¡ ===== */
    .progress-section {
      display: none;
    }

    .progress-section.show {
      display: block;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--space-md);
      font-size: var(--text-sm);
    }

    .progress-bar-container {
      width: 100%;
      height: 24px;
      background: var(--color-bg-secondary);
      border-radius: var(--radius-full);
      overflow: hidden;
      border: 1px solid var(--color-border-light);
      margin-bottom: var(--space-md);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: var(--text-xs);
      font-weight: var(--font-weight-bold);
    }

    /* ===== æŒ‰é’® ===== */
    .btn-group {
      display: flex;
      gap: var(--space-md);
      flex-wrap: wrap;
    }

    .btn {
      padding: var(--space-md) var(--space-2xl);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--text-md);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--color-primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: var(--color-bg-secondary);
      color: var(--color-primary);
      border: 1px solid var(--color-primary);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--color-primary-bg);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== ç»“æœé¢æ¿ ===== */
    .result-section {
      display: none;
    }

    .result-section.show {
      display: block;
    }

    .result-card {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: var(--radius-lg);
      padding: var(--space-2xl);
      text-align: center;
    }

    .result-icon {
      font-size: 48px;
      margin-bottom: var(--space-md);
    }

    .result-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text-primary);
      margin-bottom: var(--space-md);
    }

    .result-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-2xl);
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .stat-label {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    .stat-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text-primary);
    }

    .compression-rate {
      font-size: var(--text-3xl);
      font-weight: var(--font-weight-bold);
      color: #22c55e;
    }

    /* ===== è­¦å‘Šæç¤º ===== */
    .alert {
      padding: var(--space-lg);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-lg);
      display: none;
    }

    .alert.show {
      display: flex;
      align-items: flex-start;
      gap: var(--space-md);
    }

    .alert-icon {
      font-size: 20px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-xs);
    }

    .alert-message {
      font-size: var(--text-sm);
      line-height: 1.5;
    }

    .alert-warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
    }

    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .alert-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }

    /* ===== è®¤è¯å±å¹• ===== */
    #auth-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(20px);
      z-index: 9999;
    }

    .auth-card {
      background: white;
      border-radius: var(--radius-xl);
      padding: var(--space-3xl);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      width: 100%;
      max-width: 400px;
    }

    .auth-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-lg);
      text-align: center;
    }

    .auth-input {
      width: 100%;
      padding: var(--space-md);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      font-size: var(--text-md);
      margin-bottom: var(--space-lg);
    }

    .auth-btn {
      width: 100%;
      padding: var(--space-md);
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-weight: var(--font-weight-bold);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .auth-btn:hover {
      background: var(--color-primary-dark);
    }

    .auth-hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .controls {
        grid-template-columns: 1fr;
      }

      .preview-controls {
        flex-direction: column;
      }

      .preview-btn {
        width: 100%;
      }

      .btn-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <!-- è®¤è¯å±å¹• -->
  <div id="auth-screen">
    <div class="auth-card">
      <h2 class="auth-title">ğŸ” æˆæƒéªŒè¯</h2>
      <p style="text-align: center; color: var(--color-text-secondary); margin-bottom: var(--space-lg);">
        è¯·è¾“å…¥å·¥å…·æˆæƒç 
      </p>
      <input type="password" id="auth-code" class="auth-input" placeholder="è¾“å…¥æˆæƒç " />
      <button class="auth-btn" onclick="verifyAuth()">ç¡®è®¤</button>
      <p style="text-align: center; font-size: var(--text-xs); color: var(--color-text-tertiary); margin-top: var(--space-lg);">
        ğŸ’¡ æˆæƒç å·²é€šè¿‡é‚®ä»¶å‘é€
      </p>
    </div>
  </div>

  <!-- ä¸»åº”ç”¨ -->
  <div id="app" class="auth-hidden">
    <div id="nav-container"></div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
      <!-- ä»‹ç»å¡ç‰‡ -->
      <div class="intro-card">
        <div class="intro-title">æ™ºèƒ½ PDF å‹ç¼©</div>
        <div class="intro-desc">
          åœ¨æµè§ˆå™¨ä¸­å®æ—¶å‹ç¼© PDF æ–‡ä»¶ï¼Œæ— éœ€ä¸Šä¼ ï¼Œæ•°æ®å®Œå…¨ä¿ç•™åœ¨æœ¬åœ°ã€‚æ™ºèƒ½é™ä½å›¾ç‰‡åˆ†è¾¨ç‡ï¼Œç§»é™¤å†—ä½™èµ„æºï¼Œè½»æ¾å‡å°æ–‡ä»¶ä½“ç§¯ã€‚
        </div>
      </div>

      <!-- å†…å®¹ç½‘æ ¼ -->
      <div class="content-grid">
        <!-- ä¸Šä¼ å¡ç‰‡ -->
        <div class="card">
          <div class="card-title">
            <span class="card-icon">ğŸ“</span>
            <span>ä¸Šä¼  PDF</span>
          </div>

          <div id="upload-alert" class="alert alert-warning">
            <div class="alert-icon">âš ï¸</div>
            <div class="alert-content">
              <div class="alert-title">æ–‡ä»¶é™åˆ¶</div>
              <div class="alert-message">å•ä¸ªæ–‡ä»¶æœ€å¤§ 200MBã€‚è¶…å¤§æ–‡ä»¶å¯èƒ½å¯¼è‡´æµè§ˆå™¨ç¼“æ…¢ã€‚</div>
            </div>
          </div>

          <div class="upload-area" id="upload-area" ondrop="handleDrop(event)" ondragover="handleDragOver(event)"
            ondragleave="handleDragLeave(event)" onclick="document.getElementById('file-input').click();">
            <div class="upload-icon">ğŸ“¤</div>
            <div class="upload-text">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼  PDF</div>
            <div class="upload-hint">æ”¯æŒ .pdf æ ¼å¼ Â· æœ€å¤§ 200MB</div>
            <input type="file" id="file-input" class="upload-input" accept=".pdf" onchange="handleFileSelect(event)" />
          </div>

          <!-- é¢„è§ˆé¢æ¿ -->
          <div id="preview-panel" class="preview-panel">
            <div class="preview-info">
              <div class="info-item">
                <span class="info-label">æ–‡ä»¶å</span>
                <span class="info-value" id="file-name">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">åŸå§‹å¤§å°</span>
                <span class="info-value" id="file-size">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">é¡µæ•°</span>
                <span class="info-value" id="file-pages">-</span>
              </div>
            </div>

            <canvas id="preview-canvas" class="preview-canvas"></canvas>

            <div class="preview-controls">
              <button class="preview-btn" onclick="previousPage()">â† ä¸Šä¸€é¡µ</button>
              <span id="page-indicator" style="display: flex; align-items: center; color: var(--color-text-secondary);">ç¬¬ 1 é¡µ</span>
              <button class="preview-btn" onclick="nextPage()">ä¸‹ä¸€é¡µ â†’</button>
            </div>
          </div>
        </div>

        <!-- å‹ç¼©å‚æ•°å¡ç‰‡ -->
        <div class="card">
          <div class="card-title">
            <span class="card-icon">âš™ï¸</span>
            <span>å‹ç¼©å‚æ•°</span>
          </div>

          <div class="controls">
            <!-- å›¾ç‰‡è´¨é‡ -->
            <div class="form-group">
              <label class="form-label">
                <span>å›¾ç‰‡è´¨é‡</span>
                <span class="form-label-value" id="quality-value">70%</span>
              </label>
              <input type="range" id="quality-slider" class="range-input" min="10" max="100" value="70"
                oninput="updateQualityValue()" />
              <small style="color: var(--color-text-tertiary);">é™ä½è´¨é‡å¯ä»¥å‡å°æ–‡ä»¶ä½“ç§¯</small>
            </div>

            <!-- æœ€å¤§å®½åº¦ -->
            <div class="form-group">
              <label class="form-label">
                <span>æœ€å¤§å®½åº¦ (px)</span>
                <span class="form-label-value" id="max-width-value">1280</span>
              </label>
              <input type="number" id="max-width" class="form-input" min="600" max="2560" value="1280"
                oninput="updateMaxWidthValue()" />
              <small style="color: var(--color-text-tertiary);">è¶…è¿‡æ­¤å®½åº¦çš„å›¾ç‰‡å°†è¢«ç¼©æ”¾</small>
            </div>

            <!-- å‹ç¼©å¼ºåº¦ -->
            <div class="form-group">
              <label class="form-label">
                <span>å‹ç¼©å¼ºåº¦</span>
              </label>
              <div class="strength-buttons">
                <button class="strength-btn active" onclick="setStrength('fast')">ğŸš€ å¿«é€Ÿ</button>
                <button class="strength-btn" onclick="setStrength('medium')">âš–ï¸ å‡è¡¡</button>
                <button class="strength-btn" onclick="setStrength('maximum')">ğŸ“¦ æœ€å°</button>
              </div>
              <small id="strength-hint" style="color: var(--color-text-tertiary);">ä¿ç•™é«˜è´¨é‡ï¼Œå‹ç¼©ç‡ 40%</small>
            </div>
          </div>

          <!-- é¢å¤–é€‰é¡¹ -->
          <div style="margin-top: var(--space-2xl); padding-top: var(--space-2xl); border-top: 1px solid var(--color-border-light);">
            <label style="display: flex; align-items: center; gap: var(--space-md); cursor: pointer;">
              <input type="checkbox" id="remove-metadata" checked style="width: 18px; height: 18px; cursor: pointer;" />
              <span>ç§»é™¤å…ƒæ•°æ®ï¼ˆå¯å‡å°ä½“ç§¯ï¼‰</span>
            </label>

            <!-- å¼€å§‹å‹ç¼©æŒ‰é’® -->
            <div style="margin-top: var(--space-2xl); display: flex; justify-content: flex-end;">
              <button class="btn btn-primary" onclick="compressPDF()" style="padding: var(--space-md) var(--space-3xl);">
                ğŸš€ å¼€å§‹å‹ç¼©
              </button>
            </div>
          </div>
        </div>

        <!-- è¿›åº¦å¡ç‰‡ -->
        <div id="progress-card" class="card" style="display: none;">
          <div class="card-title">
            <span class="card-icon">â³</span>
            <span>å‹ç¼©ä¸­...</span>
          </div>

          <div class="progress-info">
            <span id="progress-text">å‡†å¤‡ä¸­...</span>
            <span id="progress-percent">0%</span>
          </div>

          <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
          </div>

          <div style="color: var(--color-text-secondary); font-size: var(--text-sm);">
            å¤„ç†ä¸­: <span id="progress-detail">-</span>
          </div>
        </div>

        <!-- ç»“æœå¡ç‰‡ -->
        <div id="result-card" class="card" style="display: none;">
          <div class="result-card">
            <div class="result-icon">âœ…</div>
            <div class="result-title">å‹ç¼©å®Œæˆï¼</div>

            <div class="result-stats">
              <div class="stat-item">
                <span class="stat-label">åŸå§‹å¤§å°</span>
                <span class="stat-value" id="result-original">0 MB</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">å‹ç¼©å</span>
                <span class="stat-value" id="result-compressed">0 MB</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">å‹ç¼©ç‡</span>
                <span class="compression-rate" id="result-rate">0%</span>
              </div>
            </div>

            <div class="btn-group" style="justify-content: center;">
              <button class="btn btn-primary" onclick="downloadPDF()">
                â¬‡ï¸ ä¸‹è½½å‹ç¼©æ–‡ä»¶
              </button>
              <button class="btn btn-secondary" onclick="resetTool()">
                ğŸ”„ å†æ¥ä¸€æ¬¡
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å·¥å…·è„šæœ¬ -->
  <script>
    // ===== æˆæƒç³»ç»Ÿ =====
    const AUTH_CODES = {
      'pdf-compress': {
        'PDF-2025-A1B2': true,
        'PDF-2025-C3D4': true,
        'PDF-2025-E5F6': true,
        'PDF-2025-G7H8': true,
        'dcone2025': true  // ä¸»å¯†ç 
      }
    };

    let isAuthenticated = false;

    function verifyAuth() {
      const code = document.getElementById('auth-code').value.trim();
      if (AUTH_CODES['pdf-compress'][code]) {
        isAuthenticated = true;
        localStorage.setItem('pdf-compress-auth', code);
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app').classList.remove('auth-hidden');
      } else {
        alert('âŒ æˆæƒç é”™è¯¯ï¼Œè¯·é‡è¯•');
        document.getElementById('auth-code').value = '';
      }
    }

    function checkAuth() {
      const savedCode = localStorage.getItem('pdf-compress-auth');
      if (savedCode && AUTH_CODES['pdf-compress'][savedCode]) {
        isAuthenticated = true;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app').classList.remove('auth-hidden');
      }
    }

    document.addEventListener('DOMContentLoaded', checkAuth);

    // ===== å…¨å±€å˜é‡ =====
    let currentPDF = null;
    let currentPDFPages = [];
    let currentPageIndex = 0;
    let compressedPDFData = null;
    let compressionStats = {
      original: 0,
      compressed: 0
    };
    let pdfWorker = null;

    // ===== ä¸Šä¼ å¤„ç† =====
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        loadPDF(file);
      }
    }

    function handleDrop(event) {
      event.preventDefault();
      event.stopPropagation();
      document.getElementById('upload-area').classList.remove('dragover');

      const files = event.dataTransfer.files;
      if (files.length > 0 && files[0].type === 'application/pdf') {
        loadPDF(files[0]);
      } else {
        alert('âŒ è¯·ä¸Šä¼  PDF æ–‡ä»¶');
      }
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      document.getElementById('upload-area').classList.add('dragover');
    }

    function handleDragLeave(event) {
      event.preventDefault();
      document.getElementById('upload-area').classList.remove('dragover');
    }

    async function loadPDF(file) {
      try {
        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        if (file.size > 200 * 1024 * 1024) {
          alert('âŒ æ–‡ä»¶è¿‡å¤§ï¼ˆ>200MBï¼‰ï¼Œè¯·é€‰æ‹©è¾ƒå°çš„ PDF');
          return;
        }

        compressionStats.original = file.size;

        const arrayBuffer = await file.arrayBuffer();
        const { PDFDocument } = PDFLib;
        currentPDF = await PDFDocument.load(arrayBuffer);

        // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = formatFileSize(file.size);
        document.getElementById('file-pages').textContent = currentPDF.getPageCount();

        currentPDFPages = currentPDF.getPages();
        currentPageIndex = 0;

        // æ˜¾ç¤ºé¢„è§ˆ
        await renderPreview();
        document.getElementById('preview-panel').classList.add('show');

        // æ˜¾ç¤ºä¸Šä¼ æç¤º
        document.getElementById('upload-alert').classList.add('show');
      } catch (error) {
        alert('âŒ PDF åŠ è½½å¤±è´¥ï¼š' + error.message);
        console.error(error);
      }
    }

    async function renderPreview() {
      try {
        const page = currentPDFPages[currentPageIndex];
        const canvas = document.getElementById('preview-canvas');

        // ä½¿ç”¨ PDF.js æ¸²æŸ“
        const pdfData = await currentPDF.save();
        const pdfUrl = URL.createObjectURL(new Blob([pdfData], { type: 'application/pdf' }));

        const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
        const pdfPage = await pdf.getPage(currentPageIndex + 1);

        const scale = 1.5;
        const viewport = pdfPage.getViewport({ scale });
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        const context = canvas.getContext('2d');
        await pdfPage.render({
          canvasContext: context,
          viewport: viewport
        }).promise;

        document.getElementById('page-indicator').textContent = `ç¬¬ ${currentPageIndex + 1} é¡µ`;
      } catch (error) {
        console.error('é¢„è§ˆæ¸²æŸ“å¤±è´¥ï¼š', error);
      }
    }

    function previousPage() {
      if (currentPageIndex > 0) {
        currentPageIndex--;
        renderPreview();
      }
    }

    function nextPage() {
      if (currentPageIndex < currentPDFPages.length - 1) {
        currentPageIndex++;
        renderPreview();
      }
    }

    // ===== å‚æ•°æ§åˆ¶ =====
    function updateQualityValue() {
      const value = document.getElementById('quality-slider').value;
      document.getElementById('quality-value').textContent = value + '%';
    }

    function updateMaxWidthValue() {
      const value = document.getElementById('max-width').value;
      document.getElementById('max-width-value').textContent = value;
    }

    function setStrength(strength) {
      document.querySelectorAll('.strength-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      const hints = {
        'fast': 'ä¿ç•™é«˜è´¨é‡ï¼Œå‹ç¼©ç‡ 40%',
        'medium': 'ä¸­ç­‰è´¨é‡ï¼Œå‹ç¼©ç‡ 60%',
        'maximum': 'é™ä½è´¨é‡ï¼Œå‹ç¼©ç‡ 80%'
      };

      const settings = {
        'fast': { quality: 85, maxWidth: 1280 },
        'medium': { quality: 70, maxWidth: 960 },
        'maximum': { quality: 50, maxWidth: 640 }
      };

      const config = settings[strength];
      document.getElementById('quality-slider').value = config.quality;
      document.getElementById('max-width').value = config.maxWidth;
      updateQualityValue();
      updateMaxWidthValue();
      document.getElementById('strength-hint').textContent = hints[strength];

      // ä¿å­˜é€‰æ‹©
      localStorage.setItem('pdf-strength', strength);
    }

    // ===== å‹ç¼©å¤„ç† =====
    async function compressPDF() {
      if (!currentPDF) {
        alert('âŒ è¯·å…ˆä¸Šä¼  PDF æ–‡ä»¶');
        return;
      }

      // éšè—é¢„è§ˆï¼Œæ˜¾ç¤ºè¿›åº¦
      document.getElementById('preview-panel').classList.remove('show');
      document.getElementById('result-card').style.display = 'none';
      document.getElementById('progress-card').style.display = 'block';

      const quality = parseInt(document.getElementById('quality-slider').value);
      const maxWidth = parseInt(document.getElementById('max-width').value);
      const removeMetadata = document.getElementById('remove-metadata').checked;

      try {
        // åœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œå‹ç¼©ï¼ˆé¿å… Worker è·¯å¾„é—®é¢˜ï¼‰
        const { PDFDocument } = PDFLib;
        const pages = currentPDF.getPages();
        const totalPages = pages.length;

        // é€é¡µå¤„ç†
        for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
          const page = pages[pageIndex];
          const resources = page.node.Resources;

          if (resources && resources.XObject) {
            const xobjects = resources.XObject.entries();
            for (const [name, ref] of xobjects) {
              try {
                const xobj = currentPDF.context.lookup(ref);
                if (xobj.Subtype && xobj.Subtype.toString() === 'Image') {
                  // æ ‡è®°å¤„ç†
                  xobj.Interpolate = true;
                }
              } catch (e) {
                console.warn('å¤„ç†å›¾ç‰‡å¤±è´¥:', e);
              }
            }
          }

          // æ›´æ–°è¿›åº¦
          const progress = Math.round(((pageIndex + 1) / totalPages) * 100);
          document.getElementById('progress-text').textContent = `å‹ç¼©ä¸­...`;
          document.getElementById('progress-percent').textContent = progress + '%';
          document.getElementById('progress-bar').style.width = progress + '%';
          document.getElementById('progress-detail').textContent = `é¡µé¢ ${pageIndex + 1}/${totalPages}`;

          // è®©æµè§ˆå™¨æœ‰æœºä¼šé‡æ–°ç»˜åˆ¶è¿›åº¦
          await new Promise(resolve => setTimeout(resolve, 0));
        }

        // ç§»é™¤å…ƒæ•°æ®
        if (removeMetadata) {
          try {
            currentPDF.setTitle('');
            currentPDF.setAuthor('');
            currentPDF.setSubject('');
            currentPDF.setKeywords([]);
            currentPDF.setProducer('');
            currentPDF.setCreator('');
          } catch (e) {
            console.warn('ç§»é™¤å…ƒæ•°æ®å¤±è´¥:', e);
          }
        }

        // ä¿å­˜å‹ç¼©åçš„ PDF
        compressedPDFData = await currentPDF.save();
        compressionStats.compressed = compressedPDFData.byteLength;
        showResult();
      } catch (error) {
        alert('âŒ å‹ç¼©å¤±è´¥ï¼š' + error.message);
        console.error('å‹ç¼©é”™è¯¯:', error);
        document.getElementById('progress-card').style.display = 'none';
      }
    }

    function showResult() {
      document.getElementById('progress-card').style.display = 'none';
      document.getElementById('result-card').style.display = 'block';

      const original = compressionStats.original;
      const compressed = compressionStats.compressed;
      const rate = Math.round((1 - compressed / original) * 100);

      document.getElementById('result-original').textContent = formatFileSize(original);
      document.getElementById('result-compressed').textContent = formatFileSize(compressed);
      document.getElementById('result-rate').textContent = rate + '%';
    }

    function downloadPDF() {
      if (!compressedPDFData) {
        alert('âŒ æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶');
        return;
      }

      const fileName = document.getElementById('file-name').textContent;
      const baseName = fileName.replace('.pdf', '');
      const downloadName = `${baseName}-å‹ç¼©.pdf`;

      const blob = new Blob([compressedPDFData], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = downloadName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function resetTool() {
      currentPDF = null;
      currentPDFPages = [];
      currentPageIndex = 0;
      compressedPDFData = null;

      document.getElementById('file-input').value = '';
      document.getElementById('preview-panel').classList.remove('show');
      document.getElementById('result-card').style.display = 'none';
      document.getElementById('progress-card').style.display = 'none';
      document.getElementById('upload-alert').classList.remove('show');
    }

    // ===== å·¥å…·å‡½æ•° =====
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
  </script>

  <script src="js/utils.js"></script>
  <script src="js/nav.js"></script>
  <script>
    renderNav({
      title: 'PDF å‹ç¼©',
      icon: 'ğŸ“„'
    });
  </script>
</body>

</html>

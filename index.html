<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å·²å‘è¡¨å†…å®¹æ•°æ®å‡½æ•°åˆ†æå·¥å…·ï¼ˆå‡½æ•°è¿è¡Œåœ¨æœ¬åœ°Â·V2ï¼‰</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* ===== æˆæƒç™»å½•å±‚æ ·å¼ï¼ˆä¸æ”¹åŸ Dashboard æ ·å¼ï¼‰ ===== */
    * {
      box-sizing: border-box;
    }
    #auth-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(56,189,248,0.15), transparent 55%),
                  radial-gradient(circle at bottom, rgba(129,140,248,0.2), transparent 55%),
                  rgba(15,23,42,0.96);
      z-index: 9999;
    }
    .auth-card {
      width: 360px;
      max-width: 90vw;
      padding: 24px 24px 20px;
      border-radius: 20px;
      background: rgba(15,23,42,0.92);
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: 0 24px 80px rgba(0,0,0,0.7);
      backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
    }
    .auth-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: conic-gradient(from 140deg,
        rgba(56,189,248,0.12),
        rgba(94,234,212,0.08),
        rgba(129,140,248,0.05),
        transparent 55%);
      opacity: 0.5;
      mix-blend-mode: screen;
      pointer-events: none;
    }
    .auth-inner {
      position: relative;
      z-index: 1;
    }
    .auth-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #e5e7eb;
    }
    .auth-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(52,211,153,0.7);
      color: #bbf7d0;
      background: linear-gradient(to right, rgba(22,163,74,0.25), rgba(15,118,110,0.35));
    }
    .auth-subtitle {
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 16px;
    }
    .auth-label {
      font-size: 12px;
      color: #cbd5f5;
      margin-bottom: 6px;
      display: block;
    }
    .auth-input {
      width: 100%;
      padding: 10px 11px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      outline: none;
      font-size: 13px;
      letter-spacing: 0.04em;
      transition: border-color 0.18s, box-shadow 0.18s, background 0.18s, transform 0.12s;
    }
    .auth-input::placeholder {
      color: #6b7280;
      letter-spacing: 0;
    }
    .auth-input:focus {
      border-color: rgba(56,189,248,0.85);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.45);
      background: rgba(15,23,42,0.98);
      transform: translateY(-0.5px);
    }
    .auth-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 14px;
      gap: 10px;
    }
    .auth-btn {
      flex: 0 0 auto;
      border: none;
      border-radius: 999px;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg,#38bdf8,#6366f1);
      color: #f9fafb;
      box-shadow: 0 12px 30px rgba(37,99,235,0.45);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;
      white-space: nowrap;
    }
    .auth-btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 16px 40px rgba(37,99,235,0.55);
    }
    .auth-btn:active {
      transform: translateY(0);
      box-shadow: 0 8px 24px rgba(15,23,42,0.9);
      filter: brightness(0.97);
    }
    .auth-hint {
      font-size: 11px;
      color: #64748b;
      text-align: left;
      flex: 1;
    }
    .auth-meta {
      margin-top: 12px;
      font-size: 11px;
      color: #64748b;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      flex-wrap: wrap;
    }
    .auth-error {
      margin-top: 8px;
      font-size: 11px;
      color: #fecaca;
      min-height: 14px;
    }
    .auth-card.shake {
      animation: shake 0.26s ease-in-out;
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-3px); }
      100% { transform: translateX(0); }
    }

    /* Dashboard æ ¹èŠ‚ç‚¹ï¼šåˆå§‹éšè—ï¼Œæˆæƒåæ˜¾ç¤º */
    #app {
      display: none;
    }

    /* ======== Dashboard æ ·å¼ ======== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei",
        sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f7;
    }
    .topbar {
      background: #111827;
      color: #e5e7eb;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .topbar-title {
      font-size: 16px;
      font-weight: 600;
    }
    .file-input {
      background: #111827;
      border: 1px solid #4b5563;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      color: #e5e7eb;
      cursor: pointer;
    }
    .file-input input {
      display: none;
    }
    .hint {
      font-size: 11px;
      color: #9ca3af;
    }
    .container {
      max-width: 1220px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 6px;
    }
    h2 {
      font-size: 20px;
      margin: 24px 0 12px;
    }
    .sub-title {
      color: #6b7280;
      margin-bottom: 18px;
      font-size: 13px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
    }
    .card-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .card-value {
      font-size: 22px;
      font-weight: 600;
      color: #111827;
    }
    .chart-block {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
      margin-bottom: 20px;
    }
    .chart {
      width: 100%;
      height: 340px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .data-table th,
    .data-table td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
    }
    .rank-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .rank-block-item {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 12px;
      background-color: #f9fafb;
    }
    #loading{font-size:12px;color:#6b7280;margin-top:6px;}
    #error{font-size:12px;color:#b91c1c;margin-top:6px;}
  </style>
</head>

<body>
  <!-- æˆæƒå±‚ -->
  <div id="auth-screen">
    <div class="auth-card" id="auth-card">
      <div class="auth-inner">
        <div class="auth-title">
          ğŸ” å†…éƒ¨æ•°æ®è®¿é—®
          <span class="auth-badge">Authorization Required</span>
        </div>
        <div class="auth-subtitle">
          è¯·è¾“å…¥æˆæƒç è®¿é—®ã€Œå†…å®¹è¡¨ç° Dashboardã€ã€‚æœ¬é¡µä»…ä¾›ç»æˆæƒçš„å†…éƒ¨æˆå‘˜ / åˆä½œæ–¹ä½¿ç”¨ã€‚
        </div>

        <label class="auth-label" for="auth-code">æˆæƒç </label>
        <input
          id="auth-code"
          class="auth-input"
          type="text"
          placeholder="ä¾‹å¦‚ï¼šICV-2025-7QAF"
          autocomplete="off"
        />

        <div class="auth-actions">
          <div class="auth-hint">æ¯ä¸ªæˆæƒç å¯¹åº”ä¸€æ¬¡å‘æ”¾å¯¹è±¡ï¼Œå¯æŒ‰éœ€åˆ†å‘ã€‚</div>
          <button class="auth-btn" id="auth-btn">ç¡®è®¤è¿›å…¥</button>
        </div>

        <div class="auth-error" id="auth-error"></div>

        <div class="auth-meta">
          <span id="auth-info-version">å½“å‰ç‰ˆæœ¬ï¼šWeChat å†…å®¹ Dashboard</span>
          <span id="auth-info-tag">æœªæˆæƒ</span>
        </div>
      </div>
    </div>
  </div>

  <!-- çœŸæ­£çš„ Dashboard æ ¹èŠ‚ç‚¹ï¼šæˆæƒåæ˜¾ç¤º -->
  <div id="app">
    <div class="topbar">
      <div class="topbar-title">å·²å‘è¡¨å†…å®¹æ•°æ®å‡½æ•°åˆ†æå·¥å…·ï¼ˆè¿è¡Œåœ¨æµè§ˆå™¨ï¼‰</div>
      <label class="file-input">
        é€‰æ‹©æ•°æ®æ–‡ä»¶ï¼ˆCSV / XLSXï¼‰
        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
      </label>
      <div class="hint">
        ä½¿ç”¨æ³¨æ„å¿…é¡»åŒ…å«å­—æ®µï¼šå†…å®¹æ ‡é¢˜ã€æ€»é˜…è¯»äººæ•°ã€æ€»é˜…è¯»æ¬¡æ•°ã€é˜…è¯»å®Œæˆç‡ã€é€è¾¾é˜…è¯»ç‡ã€æ€»åˆ†äº«æ¬¡æ•°ã€é¦–æ¬¡åˆ†äº«æ¬¡æ•°ã€åˆ†äº«äº§ç”Ÿé˜…è¯»æ¬¡æ•°...
      </div>
    </div>

    <div class="container">
      <h1>å…¬ä¼—å·å†…å®¹è¡¨ç° Dashboard</h1>
      <div class="sub-title" id="dateRange">æŒ‰å†…å®¹ç»´åº¦çš„é˜…è¯»ã€åˆ†äº«ã€è½¬åŒ–åˆ†æ</div>

      <div id="loading"></div>
      <div id="error"></div>

      <!-- Summary å¡ç‰‡ -->
      <div class="cards" id="summaryCards" style="display:none;">
        <div class="card">
          <div class="card-label">æ–‡ç« æ€»æ•°</div>
          <div class="card-value" id="totalArticles">-</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»é˜…è¯»æ¬¡æ•°</div>
          <div class="card-value" id="totalReadCount">-</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»é˜…è¯»äººæ•°</div>
          <div class="card-value" id="totalReaders">-</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»åˆ†äº«æ¬¡æ•°</div>
          <div class="card-value" id="totalShareCount">-</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»é€è¾¾äººæ•°</div>
          <div class="card-value" id="totalDelivered">-</div>
        </div>
        <div class="card">
          <div class="card-label">å¹³å‡é€è¾¾é˜…è¯»ç‡</div>
          <div class="card-value" id="avgDeliverReadRate">-</div>
        </div>
        <div class="card">
          <div class="card-label">å¹³å‡é˜…è¯»å®Œæˆç‡</div>
          <div class="card-value" id="avgFinishRate">-</div>
        </div>
      </div>

      <h2>äºŒã€Top å†…å®¹è¡¨ç°</h2>
      <div class="chart-block">
        <div class="chart-title">Top10 å†…å®¹ï¼ˆæŒ‰æ€»é˜…è¯»æ¬¡æ•°ï¼‰</div>
        <div id="topReadChart" class="chart"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">é˜…è¯»æ¬¡æ•° vs åˆ†äº«æ¬¡æ•°</div>
        <div id="readShareScatter" class="chart"></div>
      </div>

      <h2>ä¸‰ã€è½¬åŒ–ä¸å®Œæˆåº¦</h2>
      <div class="chart-block">
        <div class="chart-title">é˜…è¯»å®Œæˆç‡ï¼ˆTop50ï¼‰</div>
        <div id="finishRateChart" class="chart"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">é€è¾¾é˜…è¯»ç‡ï¼ˆTop50ï¼‰</div>
        <div id="deliverRateChart" class="chart"></div>
      </div>

      <h2>å››ã€å†…å®¹æ˜ç»†ï¼ˆTop100 æŒ‰é˜…è¯»æ¬¡æ•°ï¼‰</h2>
      <div class="chart-block">
        <div class="chart-title">å†…å®¹æ˜ç»†è¡¨</div>
        <div id="detailTable"></div>
      </div>

      <h2>äº”ã€å…³é”®æŒ‡æ ‡ TOP æ¦œå•</h2>
      <div class="chart-block">
        <div class="chart-title">æ ¸å¿ƒæŒ‡æ ‡ Top3 æ¦œå•</div>
        <div id="keyRanks" class="rank-grid"></div>
      </div>

      <!-- å…­ã€é˜…è¯» Ã— æ€»åˆ†äº«æ¬¡æ•°å››è±¡é™åˆ†æ -->
      <h2>å…­ã€é˜…è¯» Ã— æ€»åˆ†äº«æ¬¡æ•°å››è±¡é™åˆ†æ</h2>
      <div class="chart-block">
        <div class="chart-title">é˜…è¯»é‡ vs æ€»åˆ†äº«æ¬¡æ•°ï¼ˆå››è±¡é™ï¼‰</div>
        <div id="quadrantChart" class="chart"></div>
        <div id="quadrantInsight" style="font-size:12px;color:#6b7280;margin-top:8px;"></div>
      </div>

      <div class="footer" style="font-size:11px;color:#9ca3af;margin-top:24px;text-align:center;">
        æœ¬é¡µé¢ä»…åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­è¿è¡Œï¼Œä¸ä¼šä¸Šä¼ ä»»ä½•æ•°æ®ã€‚
      </div>
    </div>
  </div>

  <!-- ===== Dashboard è„šæœ¬ ===== -->
  <script>
    const fileInput = document.getElementById("fileInput");
    const loadingEl = document.getElementById("loading");
    const errorEl = document.getElementById("error");

    fileInput.addEventListener("change", handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      loadingEl.textContent = "è§£æä¸­ï¼Œè¯·ç¨å€™â€¦";
      errorEl.textContent = "";

      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const workbook = XLSX.read(evt.target.result, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
          process(rows);
        } catch (err) {
          console.error(err);
          errorEl.textContent = "æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼æˆ–å¦å­˜ä¸º UTF-8 åå†è¯•ã€‚";
        }
        loadingEl.textContent = "";
      };
      reader.readAsArrayBuffer(file);
    }

    function num(v) {
      if (v === null || v === undefined || v === "") return 0;
      return Number(String(v).replace(/,/g, "")) || 0;
    }
    function pct(v) {
      if (!v) return 0;
      const s = String(v).trim();
      if (s.endsWith("%")) return parseFloat(s.slice(0, -1)) || 0;
      return parseFloat(s) || 0;
    }
    function dateParse(v) {
      let d = new Date(v);
      if (!isNaN(d)) return d;
      if (typeof v === "number")
        return new Date(Math.round((v - 25569) * 86400 * 1000));
      return null;
    }
    function dateFmt(d) {
      if (!d) return "";
      return (
        d.getFullYear() +
        "-" +
        String(d.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(d.getDate()).padStart(2, "0")
      );
    }

    function findCol(names, cols) {
      for (const n of names) if (cols.includes(n)) return n;
      return null;
    }

    function process(rows) {
      if (!rows.length) {
        errorEl.textContent = "æ–‡ä»¶ä¸ºç©º";
        return;
      }

      const cols = Object.keys(rows[0]);

      const colTitle = findCol(["å†…å®¹æ ‡é¢˜", "æ ‡é¢˜"], cols);
      const colTime = findCol(["å‘è¡¨æ—¶é—´", "å‘å¸ƒæ—¶é—´"], cols);
      const colReadUser = findCol(["æ€»é˜…è¯»äººæ•°"], cols);
      const colReadCount = findCol(["æ€»é˜…è¯»æ¬¡æ•°"], cols);
      const colShareCount = findCol(["æ€»åˆ†äº«æ¬¡æ•°"], cols);
      const colFirstShare = findCol(["é¦–æ¬¡åˆ†äº«æ¬¡æ•°"], cols);
      const colShareRead = findCol(["åˆ†äº«äº§ç”Ÿé˜…è¯»æ¬¡æ•°"], cols);
      const colFinishRate = findCol(["é˜…è¯»å®Œæˆç‡", "é˜…è¯»å®Œæˆç‡(%)"], cols);
      const colDeliverRate = findCol(["é€è¾¾é˜…è¯»ç‡", "é€è¾¾é˜…è¯»ç‡(%)"], cols);
      const colMsgRead = findCol(["å…¬ä¼—å·æ¶ˆæ¯é˜…è¯»æ¬¡æ•°"], cols);
      const colDelivered = findCol(["é€è¾¾äººæ•°"], cols);
      const colFollow = findCol(["é˜…è¯»åå…³æ³¨äººæ•°"], cols);

      if (!colTitle || !colReadCount) {
        errorEl.textContent = "ç¼ºå°‘å¿…è¦å­—æ®µï¼šå†…å®¹æ ‡é¢˜ã€æ€»é˜…è¯»æ¬¡æ•°";
        return;
      }

      let data = rows.map(r => {
        const readUser = num(r[colReadUser]);
        const shareCount = num(r[colShareCount]);
        const firstShare = num(r[colFirstShare]);
        const shareRead = num(r[colShareRead]);
        const follow = num(r[colFollow]);
        const time = dateParse(r[colTime]);

        return {
          title: r[colTitle],
          time,
          readUser,
          readCount: num(r[colReadCount]),
          shareCount,
          firstShare,
          shareRead,
          finishRate: pct(r[colFinishRate]),
          deliverRate: pct(r[colDeliverRate]),
          msgRead: num(r[colMsgRead]),
          delivered: num(r[colDelivered]),
          follow,

          // é¦–æ¬¡åˆ†äº«ç‡ï¼ˆ%ï¼‰
          firstShareRate:
            readUser > 0 ? (firstShare / readUser) * 100 : 0,

          // æ¯æ¬¡åˆ†äº«å¸¦æ¥çš„é˜…è¯»æ•°
          readPerShare:
            shareCount > 0 ? (shareRead / shareCount) : 0,

          // é˜…è¯»åå…³æ³¨ç‡ï¼ˆ%ï¼‰
          attentionRate:
            readUser > 0
              ? (follow / readUser) * 100
              : 0
        };
      });

      renderSummary(data);
      renderTopRead(data);
      renderReadShare(data);
      renderFinishRate(data);
      renderDeliverRate(data);
      renderDetail(data);
      renderRanks(data);
      renderQuadrant(data); // å››è±¡é™åˆ†æ
    }

    function renderSummary(data) {
      document.getElementById("summaryCards").style.display = "grid";

      document.getElementById("totalArticles").textContent = data.length;
      document.getElementById("totalReadCount").textContent = sum(data, "readCount");
      document.getElementById("totalReaders").textContent = sum(data, "readUser");
      document.getElementById("totalShareCount").textContent = sum(data, "shareCount");
      document.getElementById("totalDelivered").textContent = sum(data, "delivered");

      document.getElementById("avgDeliverReadRate").textContent =
        avg(data, "deliverRate").toFixed(2) + "%";
      document.getElementById("avgFinishRate").textContent =
        avg(data, "finishRate").toFixed(2) + "%";

      const times = data.map(d => d.time).filter(Boolean);
      if (times.length) {
        const min = new Date(Math.min(...times));
        const max = new Date(Math.max(...times));
        document.getElementById("dateRange").textContent =
          "æ—¶é—´èŒƒå›´ï¼š" + dateFmt(min) + " ~ " + dateFmt(max);
      }
    }

    function sum(arr, key) {
      return arr.reduce((a, b) => a + (b[key] || 0), 0);
    }
    function avg(arr, key) {
      const v = arr.map(r => r[key]).filter(v => v > 0);
      return v.length ? v.reduce((a, b) => a + b, 0) / v.length : 0;
    }

    function topN(arr, key, n = 3) {
      return arr
        .filter(r => r[key] > 0)
        .sort((a, b) => b[key] - a[key])
        .slice(0, n);
    }

    function renderTopRead(data) {
      const top = data
        .slice()
        .sort((a, b) => b.readCount - a.readCount)
        .slice(0, 10);

      Plotly.newPlot("topReadChart", [
        {
          x: top.map(x => x.title),
          y: top.map(x => x.readCount),
          type: "bar"
        }
      ], {
        margin: { b: 120 }
      });
    }

    function renderReadShare(data) {
      Plotly.newPlot("readShareScatter", [
        {
          x: data.map(x => x.readCount),
          y: data.map(x => x.shareCount),
          mode: "markers",
          type: "scatter",
          text: data.map(x => x.title)
        }
      ], {
        xaxis: { title: "é˜…è¯»æ¬¡æ•°" },
        yaxis: { title: "åˆ†äº«æ¬¡æ•°" }
      });
    }

    function renderFinishRate(data) {
      const list = data
        .filter(x => x.finishRate > 0)
        .sort((a, b) => b.finishRate - a.finishRate)
        .slice(0, 50);

      Plotly.newPlot("finishRateChart", [
        {
          x: list.map(x => x.title),
          y: list.map(x => x.finishRate),
          type: "bar"
        }
      ], { margin: { b: 120 } });
    }

    function renderDeliverRate(data) {
      const list = data
        .filter(x => x.deliverRate > 0)
        .sort((a, b) => b.deliverRate - a.deliverRate)
        .slice(0, 50);

      Plotly.newPlot("deliverRateChart", [
        {
          x: list.map(x => x.title),
          y: list.map(x => x.deliverRate),
          type: "bar"
        }
      ], { margin: { b: 120 } });
    }

    function renderDetail(data) {
      const top = data
        .slice()
        .sort((a, b) => b.readCount - a.readCount)
        .slice(0, 100);

      let html = "<table class='data-table'><thead><tr>";
      const headers = [
        "å†…å®¹æ ‡é¢˜", "å‘è¡¨æ—¶é—´", "æ€»é˜…è¯»äººæ•°", "æ€»é˜…è¯»æ¬¡æ•°",
        "æ€»åˆ†äº«æ¬¡æ•°", "é¦–æ¬¡åˆ†äº«æ¬¡æ•°", "åˆ†äº«äº§ç”Ÿé˜…è¯»æ¬¡æ•°",
        "é˜…è¯»å®Œæˆç‡(%)", "é€è¾¾é˜…è¯»ç‡(%)",
        "å…¬ä¼—å·æ¶ˆæ¯é˜…è¯»æ¬¡æ•°", "é€è¾¾äººæ•°", "é˜…è¯»åå…³æ³¨äººæ•°"
      ];
      headers.forEach(h => html += `<th>${h}</th>`);
      html += "</tr></thead><tbody>";

      top.forEach(r => {
        html += "<tr>";
        html += `<td>${escapeHtml(r.title)}</td>`;
        html += `<td>${r.time ? dateFmt(r.time) : ""}</td>`;
        html += `<td>${r.readUser}</td>`;
        html += `<td>${r.readCount}</td>`;
        html += `<td>${r.shareCount}</td>`;
        html += `<td>${r.firstShare}</td>`;
        html += `<td>${r.shareRead}</td>`;
        html += `<td>${r.finishRate.toFixed(2)}</td>`;
        html += `<td>${r.deliverRate.toFixed(2)}</td>`;
        html += `<td>${r.msgRead}</td>`;
        html += `<td>${r.delivered}</td>`;
        html += `<td>${r.follow}</td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";
      document.getElementById("detailTable").innerHTML = html;
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;");
    }

    function renderRanks(data) {
      let html = "";

      const rankItems = [
        ["é˜…è¯»è¡¨ç° TOP3ï¼ˆæŒ‰é˜…è¯»æ¬¡æ•°ï¼‰", "readCount", ""],
        ["å…¬ä¼—å·æ¶ˆæ¯é˜…è¯»æ¬¡æ•° TOP3", "msgRead", ""],
        ["å®Œè¯»ç‡ TOP3", "finishRate", "%"],
        ["åˆ†äº«æ„æ„¿ TOP3ï¼ˆæŒ‰é¦–æ¬¡åˆ†äº«ç‡ï¼‰", "firstShareRate","%"],
        ["åˆ†äº«åŠ¨åŠ› TOP3ï¼ˆæŒ‰é¦–æ¬¡åˆ†äº«æ¬¡æ•°ï¼‰", "firstShare", ""],
        ["äºŒæ¬¡ä¼ æ’­ TOP3ï¼ˆæŒ‰åˆ†äº«äº§ç”Ÿé˜…è¯»ï¼‰", "shareRead", ""],
        ["åˆ†äº«æ•ˆç‡ TOP3ï¼ˆæ¯æ¬¡åˆ†äº«å¸¦æ¥é˜…è¯»ï¼‰", "readPerShare",""],
        ["åˆ†äº«è§„æ¨¡ TOP3ï¼ˆæ€»åˆ†äº«æ¬¡æ•°ï¼‰", "shareCount", ""],
        ["å…³æ³¨æ–°å¢è´¡çŒ® TOP3", "follow", ""],
        ["æ ‡é¢˜å¸å¼•åŠ› TOP3ï¼ˆé€è¾¾é˜…è¯»ç‡ï¼‰", "deliverRate", "%"],
        ["ç”¨æˆ·å…³æ³¨å¿ƒå¼•åŠ› TOP3", "attentionRate", "%"]
      ];

      rankItems.forEach(([title, key, suffix]) => {
        const top = topN(data, key, 3);
        if (!top.length) return;

        html += `<div class="rank-block-item">
          <div style="font-size:13px;font-weight:600;margin-bottom:6px;">${title}</div>
          <table class='data-table'><thead><tr>
            <th>æ’å</th><th>å†…å®¹æ ‡é¢˜</th><th>å€¼</th>
          </tr></thead><tbody>`;

        top.forEach((r, i) => {
          html += `<tr>
            <td>${i + 1}</td>
            <td>${escapeHtml(r.title)}</td>
            <td>${r[key].toFixed ? r[key].toFixed(2) : r[key]}${suffix}</td>
          </tr>`;
        });

        html += "</tbody></table></div>";
      });

      document.getElementById("keyRanks").innerHTML = html;
    }

    // é˜…è¯» Ã— æ€»åˆ†äº«æ¬¡æ•°å››è±¡é™åˆ†æï¼ˆç”¨ä¸­ä½æ•°åˆ†ç±»ï¼Œç”¨å›¾å½¢ä¸­å¿ƒç”»åå­—ï¼‰
    function renderQuadrant(data) {
      const points = data
        .filter(d => d.readCount > 0 && d.shareCount > 0)
        .map(d => ({
          title: d.title,
          read: d.readCount,
          share: d.shareCount
        }));

      const insightEl = document.getElementById("quadrantInsight");

      if (!points.length) {
        insightEl.textContent = "æš‚æ— è¶³å¤Ÿçš„é˜…è¯»ä¸åˆ†äº«æ•°æ®ï¼Œæš‚æ— æ³•ç»˜åˆ¶å››è±¡é™åˆ†æã€‚";
        return;
      }

      const reads = points.map(p => p.read).slice().sort((a, b) => a - b);
      const shares = points.map(p => p.share).slice().sort((a, b) => a - b);

      function median(arr) {
        if (!arr.length) return 0;
        const n = arr.length;
        const mid = Math.floor(n / 2);
        return n % 2 === 1
          ? arr[mid]
          : (arr[mid - 1] + arr[mid]) / 2;
      }

      // é€»è¾‘ä¸Šçš„é«˜/ä½åˆ†ç•Œï¼šä¸­ä½æ•°
      const readMid = median(reads);
      const shareMid = median(shares);

      const minRead = Math.min(...reads);
      const maxRead = Math.max(...reads);
      const minShare = Math.min(...shares);
      const maxShare = Math.max(...shares);

      // å¯è§†èŒƒå›´ï¼šç¨å¾®æ”¾å¤§ä¸€ç‚¹
      const xPadding = (maxRead - minRead) * 0.1;
      const yPadding = (maxShare - minShare) * 0.1;

      const xMinRange = Math.max(0, minRead - xPadding);
      const xMaxRange = maxRead + xPadding;
      const yMinRange = Math.max(0, minShare - yPadding);
      const yMaxRange = maxShare + yPadding;

      // è§†è§‰ä¸Šçš„åå­—ä¸­å¿ƒï¼šç”¨å¯è§†èŒƒå›´çš„ä¸­å¿ƒï¼ˆä¿è¯å±…ä¸­ï¼‰
      const xCenter = (xMinRange + xMaxRange) / 2;
      const yCenter = (yMinRange + yMaxRange) / 2;

      // å››è±¡é™åˆ†ç±»ä»ç„¶ç”¨ä¸­ä½æ•°ï¼ˆä¸æ˜¯ç”¨è§†è§‰ä¸­å¿ƒï¼‰
      const q1 = []; // é«˜é˜…è¯» Â· é«˜åˆ†äº«
      const q2 = []; // ä½é˜…è¯» Â· é«˜åˆ†äº«
      const q3 = []; // ä½é˜…è¯» Â· ä½åˆ†äº«
      const q4 = []; // é«˜é˜…è¯» Â· ä½åˆ†äº«

      points.forEach(p => {
        if (p.read >= readMid && p.share >= shareMid) {
          q1.push(p);
        } else if (p.read < readMid && p.share >= shareMid) {
          q2.push(p);
        } else if (p.read < readMid && p.share < shareMid) {
          q3.push(p);
        } else {
          q4.push(p);
        }
      });

      function makeTrace(list, name, symbol) {
        return {
          x: list.map(p => p.read),
          y: list.map(p => p.share),
          mode: "markers",
          type: "scatter",
          name,
          text: list.map(p => p.title),
          marker: {
            size: 9,
            symbol
          }
        };
      }

      Plotly.newPlot("quadrantChart", [
        makeTrace(q1, "é«˜é˜…è¯» Â· é«˜åˆ†äº«", "circle"),
        makeTrace(q2, "ä½é˜…è¯» Â· é«˜åˆ†äº«", "triangle-up"),
        makeTrace(q3, "ä½é˜…è¯» Â· ä½åˆ†äº«", "square"),
        makeTrace(q4, "é«˜é˜…è¯» Â· ä½åˆ†äº«", "diamond")
      ], {
        xaxis: {
          title: "æ€»é˜…è¯»æ¬¡æ•°",
          zeroline: false,
          range: [xMinRange, xMaxRange]
        },
        yaxis: {
          title: "æ€»åˆ†äº«æ¬¡æ•°",
          zeroline: false,
          range: [yMinRange, yMaxRange]
        },
        shapes: [
          {
            type: "line",
            x0: xCenter,
            x1: xCenter,
            y0: yMinRange,
            y1: yMaxRange,
            line: { dash: "dot", width: 1 }
          },
          {
            type: "line",
            x0: xMinRange,
            x1: xMaxRange,
            y0: yCenter,
            y1: yCenter,
            line: { dash: "dot", width: 1 }
          }
        ],
        margin: { t: 30 }
      });

      const total = points.length;
      const pct = n => ((n / total) * 100).toFixed(1);

      insightEl.innerHTML =
        `åŸºäº ${total} ç¯‡å…·å¤‡ã€Œé˜…è¯» + æ€»åˆ†äº«æ¬¡æ•°ã€æ•°æ®çš„å†…å®¹ï¼Œä½¿ç”¨æ ·æœ¬ä¸­ä½æ•°ä½œä¸ºé«˜/ä½åˆ†ç•Œï¼š` +
        `æ€»é˜…è¯»æ¬¡æ•°ä¸­ä½æ•°çº¦ä¸º <b>${Math.round(readMid)}</b>ï¼Œæ€»åˆ†äº«æ¬¡æ•°ä¸­ä½æ•°çº¦ä¸º <b>${Math.round(shareMid)}</b>ã€‚<br>` +
        `å„è±¡é™æ–‡ç« æ•°é‡ä¸å æ¯”åˆ†åˆ«ä¸ºï¼š` +
        `é«˜é˜…è¯»Â·é«˜åˆ†äº« ${q1.length} ç¯‡ï¼ˆ${pct(q1.length)}%ï¼‰ï¼Œ` +
        `ä½é˜…è¯»Â·é«˜åˆ†äº« ${q2.length} ç¯‡ï¼ˆ${pct(q2.length)}%ï¼‰ï¼Œ` +
        `ä½é˜…è¯»Â·ä½åˆ†äº« ${q3.length} ç¯‡ï¼ˆ${pct(q3.length)}%ï¼‰ï¼Œ` +
        `é«˜é˜…è¯»Â·ä½åˆ†äº« ${q4.length} ç¯‡ï¼ˆ${pct(q4.length)}%ï¼‰ã€‚`;
    }
  </script>

  <!-- ===== æˆæƒé€»è¾‘è„šæœ¬ ===== -->
  <script>
    // 30 ä¸ªæˆæƒç 
    const AUTH_CODES = {
      "ICV-2025-7QAF": "æ ‡å‡†æˆæƒ",
      "ICV-2025-P3ZD": "æ ‡å‡†æˆæƒ",
      "ICV-2025-L8XK": "æ ‡å‡†æˆæƒ",
      "ICV-2025-G2MW": "æ ‡å‡†æˆæƒ",
      "ICV-2025-R9CE": "æ ‡å‡†æˆæƒ",
      "ICV-2025-H4VU": "æ ‡å‡†æˆæƒ",
      "ICV-2025-Y1SN": "æ ‡å‡†æˆæƒ",
      "ICV-2025-K5BJ": "æ ‡å‡†æˆæƒ",
      "ICV-2025-X7TP": "æ ‡å‡†æˆæƒ",
      "ICV-2025-W6QD": "æ ‡å‡†æˆæƒ",
      "ICV-2025-B2LA": "æ ‡å‡†æˆæƒ",
      "ICV-2025-Z4RN": "æ ‡å‡†æˆæƒ",
      "ICV-2025-M9KS": "æ ‡å‡†æˆæƒ",
      "ICV-2025-T3HF": "æ ‡å‡†æˆæƒ",
      "ICV-2025-E8CP": "æ ‡å‡†æˆæƒ",
      "ICV-2025-A7UM": "æ ‡å‡†æˆæƒ",
      "ICV-2025-V1DG": "æ ‡å‡†æˆæƒ",
      "ICV-2025-S5QX": "æ ‡å‡†æˆæƒ",
      "ICV-2025-J6WP": "æ ‡å‡†æˆæƒ",
      "ICV-2025-U9FR": "æ ‡å‡†æˆæƒ",
      "ICV-2025-Q2NM": "æ ‡å‡†æˆæƒ",
      "ICV-2025-D4YS": "æ ‡å‡†æˆæƒ",
      "ICV-2025-C7KV": "æ ‡å‡†æˆæƒ",
      "ICV-2025-N8ZB": "æ ‡å‡†æˆæƒ",
      "ICV-2025-F3LW": "æ ‡å‡†æˆæƒ",
      "ICV-2025-P9JE": "æ ‡å‡†æˆæƒ",
      "ICV-2025-H2GV": "æ ‡å‡†æˆæƒ",
      "ICV-2025-Y5TC": "æ ‡å‡†æˆæƒ",
      "ICV-2025-K6MR": "æ ‡å‡†æˆæƒ",
      "ICV-2025-R8QN": "æ ‡å‡†æˆæƒ"
    };

    const STORAGE_KEY = "wechat_dashboard_auth";

    const authScreen = document.getElementById("auth-screen");
    const appRoot = document.getElementById("app");
    const input = document.getElementById("auth-code");
    const btn = document.getElementById("auth-btn");
    const errEl = document.getElementById("auth-error");
    const cardEl = document.getElementById("auth-card");
    const infoTag = document.getElementById("auth-info-tag");

    (function bootstrapAuth() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        const parsed = JSON.parse(saved);
        if (parsed && parsed.code && AUTH_CODES[parsed.code]) {
          showApp(parsed.code);
        }
      } catch (e) {
        // ignore
      }
    })();

    function showApp(code) {
      const label = AUTH_CODES[code] || "å·²æˆæƒè®¿é—®";
      infoTag.textContent = label;
      authScreen.style.display = "none";
      appRoot.style.display = "block";
      try {
        localStorage.setItem(
          STORAGE_KEY,
          JSON.stringify({ code, label, ts: Date.now() })
        );
      } catch (e) {}
    }

    function shakeCard() {
      cardEl.classList.remove("shake");
      void cardEl.offsetWidth;
      cardEl.classList.add("shake");
    }

    function handleAuth() {
      const code = (input.value || "").trim();
      if (!code) {
        errEl.textContent = "è¯·è¾“å…¥æˆæƒç ã€‚";
        shakeCard();
        return;
      }
      if (!Object.prototype.hasOwnProperty.call(AUTH_CODES, code)) {
        errEl.textContent = "æˆæƒç æ— æ•ˆï¼Œè¯·ç¡®è®¤åé‡æ–°è¾“å…¥ã€‚";
        shakeCard();
        return;
      }
      errEl.textContent = "";
      showApp(code);
    }

    btn.addEventListener("click", handleAuth);
    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") handleAuth();
    });

    window.addEventListener("load", function() {
      setTimeout(() => input.focus(), 80);
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å£¹ä¼´æ•°æ®åˆ†æå·¥å…·ï¼ˆæœ¬åœ°ç‰ˆï¼‰</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* ===== æˆæƒå±‚æ ·å¼ ===== */
    * { box-sizing: border-box; }
    #auth-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.96);
      z-index: 9999;
    }
    .auth-card {
      width: 360px;
      max-width: 90vw;
      padding: 24px;
      border-radius: 16px;
      background: white;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }
    .auth-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #111827;
    }
    .auth-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .auth-label {
      font-size: 12px;
      color: #374151;
      margin-bottom: 6px;
      display: block;
      font-weight: 500;
    }
    .auth-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #111827;
      outline: none;
      font-size: 13px;
      margin-bottom: 14px;
      box-sizing: border-box;
    }
    .auth-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .auth-btn {
      width: 100%;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      color: white;
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
      transition: all 0.2s ease;
    }
    .auth-btn:hover {
      transform: translateY(-2px);
    }
    .auth-error {
      margin-top: 10px;
      font-size: 11px;
      color: #dc2626;
      min-height: 16px;
    }
    .auth-card.shake {
      animation: shake 0.3s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      50% { transform: translateX(6px); }
      75% { transform: translateX(-3px); }
    }
    #app { display: none; }

    /* ===== Dashboard æ ·å¼ ===== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei",
        sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f7;
    }
    .topbar {
      background: #111827;
      color: #e5e7eb;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .topbar-title {
      font-size: 16px;
      font-weight: 600;
    }
    .file-input {
      background: #111827;
      border: 1px solid #4b5563;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      color: #e5e7eb;
      cursor: pointer;
    }
    .hint {
      font-size: 11px;
      color: #9ca3af;
    }
    .container {
      max-width: 1220px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 6px;
    }
    h2 {
      font-size: 20px;
      margin: 24px 0 12px;
    }
    .sub-title {
      color: #6b7280;
      margin-bottom: 18px;
      font-size: 13px;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background-color: #eef2ff;
      color: #4f46e5;
      font-size: 11px;
      margin-left: 8px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
    }
    .card-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .card-value {
      font-size: 22px;
      font-weight: 600;
      color: #111827;
    }
    .card-desc {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .chart-block {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
      margin-bottom: 20px;
    }
    .chart-title {
      font-size: 15px;
      margin-bottom: 4px;
    }
    .chart-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .chart {
      width: 100%;
      height: 340px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .data-table th,
    .data-table td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
    }
    .data-table th {
      background-color: #f9fafb;
      font-weight: 600;
    }
    .data-table tbody tr:nth-child(odd) {
      background-color: #fdfdfd;
    }
    #loading {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }
    #error {
      font-size: 13px;
      color: #b91c1c;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <!-- æˆæƒå±‚ -->
  <div id="auth-screen">
    <div class="auth-card" id="auth-card">
      <div class="auth-title">ğŸ” å£¹ä¼´æ•°æ®åˆ†æå·¥å…·</div>
      <div class="auth-subtitle">è¯·è¾“å…¥æˆæƒç è®¿é—®æœ¬å·¥å…·</div>

      <label class="auth-label" for="auth-code">æˆæƒç </label>
      <input
        id="auth-code"
        class="auth-input"
        type="text"
        placeholder="ä¾‹å¦‚ï¼šYB-2025-A1B2"
        autocomplete="off"
      />

      <button class="auth-btn" id="auth-btn">ç¡®è®¤è¿›å…¥</button>

      <div class="auth-error" id="auth-error"></div>
    </div>
  </div>

  <!-- çœŸæ­£çš„åº”ç”¨ -->
  <div id="app">
    <div class="topbar">
      <div class="topbar-title">å£¹ä¼´æ•°æ®åˆ†æå·¥å…·ï¼ˆæœ¬åœ°ç‰ˆï¼‰</div>
      <label class="file-input">
        é€‰æ‹© Excel æ–‡ä»¶
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" />
      </label>
      <div class="hint">
        æ”¯æŒå£¹ä¼´æ’ä»¶å¯¼å‡ºçš„ Excel è¡¨æ ¼ï¼Œè‡ªåŠ¨è¯†åˆ«é˜…è¯»ã€åˆ†äº«ã€äº’åŠ¨ç­‰å­—æ®µ
      </div>
    </div>

    <div class="container">
      <h1>å£¹ä¼´æ•°æ®åˆ†æ Dashboard</h1>
      <div class="sub-title" id="dateRange">
        è¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©å£¹ä¼´å¯¼å‡ºçš„ Excel æ–‡ä»¶
        <span class="tag">ç¦»çº¿æœ¬åœ°åˆ†æï¼Œä¸ä¼šä¸Šä¼ æ•°æ®</span>
      </div>

      <div id="loading"></div>
      <div id="error"></div>

      <!-- æ±‡æ€»å¡ç‰‡ -->
      <div class="cards" id="summaryCards" style="display:none;">
        <div class="card">
          <div class="card-label">æ–‡ç« æ€»æ•°</div>
          <div class="card-value" id="totalArticles">-</div>
          <div class="card-desc">ç»Ÿè®¡å‘¨æœŸå†…çš„æ–‡ç« æ•°é‡</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»é˜…è¯»äººæ•°</div>
          <div class="card-value" id="totalReaders">-</div>
          <div class="card-desc">ç´¯è®¡é˜…è¯»äººæ•°</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»é˜…è¯»é‡</div>
          <div class="card-value" id="totalReadCount">-</div>
          <div class="card-desc">ç´¯è®¡é˜…è¯»æ¬¡æ•°</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»åˆ†äº«é‡</div>
          <div class="card-value" id="totalShareCount">-</div>
          <div class="card-desc">ç´¯è®¡åˆ†äº«æ¬¡æ•°</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»ç‚¹èµæ•°</div>
          <div class="card-value" id="totalLikes">-</div>
          <div class="card-desc">ç´¯è®¡ç‚¹èµæ•°</div>
        </div>
        <div class="card">
          <div class="card-label">æ–°å¢å…³æ³¨</div>
          <div class="card-value" id="totalFollows">-</div>
          <div class="card-desc">ç´¯è®¡æ–°å¢å…³æ³¨äººæ•°</div>
        </div>
        <div class="card">
          <div class="card-label">å¹³å‡æ‰“å¼€ç‡</div>
          <div class="card-value" id="avgOpenRate">-</div>
          <div class="card-desc">å¹³å‡æ‰“å¼€ç‡</div>
        </div>
        <div class="card">
          <div class="card-label">å¹³å‡åˆ†äº«ç‡</div>
          <div class="card-value" id="avgShareRate">-</div>
          <div class="card-desc">å¹³å‡åˆ†äº«ç‡</div>
        </div>
      </div>

      <!-- ä¸€ã€é˜…è¯»æ¥æºåˆ†æ -->
      <h2>ä¸€ã€é˜…è¯»æ¥æºåˆ†å¸ƒ</h2>
      <div class="chart-block">
        <div class="chart-title">é˜…è¯»æ¥æºæ„æˆ</div>
        <div class="chart-subtitle">å…¬ä¼—å·ã€æœ‹å‹åœˆã€çœ‹ä¸€çœ‹ã€æœä¸€æœç­‰æ¥æºçš„é˜…è¯»é‡åˆ†å¸ƒ</div>
        <div id="readSourceChart" class="chart"></div>
      </div>

      <!-- äºŒã€Top å†…å®¹è¡¨ç° -->
      <h2>äºŒã€Top å†…å®¹è¡¨ç°</h2>
      <div class="chart-block">
        <div class="chart-title">Top10 å†…å®¹ï¼ˆæŒ‰é˜…è¯»äººæ•°ï¼‰</div>
        <div id="topReadChart" class="chart"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">é˜…è¯»äººæ•° vs åˆ†äº«é‡</div>
        <div id="readShareScatter" class="chart"></div>
      </div>

      <!-- ä¸‰ã€äº’åŠ¨åˆ†æ -->
      <h2>ä¸‰ã€äº’åŠ¨è¡¨ç°</h2>
      <div class="chart-block">
        <div class="chart-title">ç‚¹èµæ•° Top10</div>
        <div id="topLikesChart" class="chart"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">åˆ†äº«é‡ Top10</div>
        <div id="topShareChart" class="chart"></div>
      </div>

      <!-- å››ã€è½¬åŒ–ç‡åˆ†æ -->
      <h2>å››ã€è½¬åŒ–ç‡åˆ†æ</h2>
      <div class="chart-block">
        <div class="chart-title">æ‰“å¼€ç‡åˆ†å¸ƒï¼ˆTop20ï¼‰</div>
        <div id="openRateChart" class="chart"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">åˆ†äº«ç‡åˆ†å¸ƒï¼ˆTop20ï¼‰</div>
        <div id="shareRateChart" class="chart"></div>
      </div>

      <!-- äº”ã€æ—¶é—´è¶‹åŠ¿ -->
      <h2>äº”ã€å‘å¸ƒè¶‹åŠ¿</h2>
      <div class="chart-block">
        <div class="chart-title">æŒ‰æ—¥æœŸå‘å¸ƒæ•°é‡</div>
        <div id="dailyChart" class="chart"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">æŒ‰å°æ—¶å‘å¸ƒåˆ†å¸ƒ</div>
        <div id="hourChart" class="chart"></div>
      </div>

      <!-- å…­ã€å†…å®¹æ˜ç»† -->
      <h2>å…­ã€å†…å®¹æ˜ç»†ï¼ˆTop50 æŒ‰é˜…è¯»äººæ•°ï¼‰</h2>
      <div class="chart-block">
        <div class="chart-title">å†…å®¹æ˜ç»†è¡¨</div>
        <div id="detailTable"></div>
      </div>

      <div class="footer" style="font-size:11px;color:#9ca3af;margin-top:24px;text-align:center;">
        æœ¬é¡µé¢ä»…åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­å¤„ç†ä½ çš„ Excel æ•°æ®ï¼Œä¸ä¼šä¸Šä¼ åˆ°ç½‘ç»œã€‚
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const loadingEl = document.getElementById("loading");
    const errorEl = document.getElementById("error");

    fileInput.addEventListener("change", handleFile, false);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      loadingEl.textContent = "æ­£åœ¨è¯»å–å¹¶è§£æ Excel æ•°æ®ï¼Œè¯·ç¨å€™â€¦";
      errorEl.textContent = "";

      const reader = new FileReader();
      reader.onload = function (evt) {
        try {
          const data = evt.target.result;
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheet = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheet];
          const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
          processData(json);
          loadingEl.textContent = "";
        } catch (err) {
          console.error(err);
          errorEl.textContent = "è§£æ Excel å¤±è´¥ï¼Œè¯·ç¡®è®¤æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚";
          loadingEl.textContent = "";
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function num(v) {
      if (v === null || v === undefined || v === "") return 0;
      const s = String(v).replace(/,/g, "").replace(/%/g, "");
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    function pct(v) {
      if (!v) return 0;
      const s = String(v).trim();
      if (s.endsWith("%")) return parseFloat(s.slice(0, -1)) || 0;
      return parseFloat(s) || 0;
    }

    function parseDate(value) {
      if (!value) return null;
      if (value instanceof Date) return value;
      if (typeof value === "number") {
        return new Date(Math.round((value - 25569) * 86400 * 1000));
      }
      const d = new Date(value);
      if (isNaN(d.getTime())) return null;
      return d;
    }

    function formatDate(d) {
      if (!d) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function findCol(candidates, cols) {
      for (const c of candidates) {
        if (cols.includes(c)) return c;
      }
      return null;
    }

    function processData(rows) {
      if (!rows || !rows.length) {
        errorEl.textContent = "Excel ä¸­æ²¡æœ‰æ•°æ®ã€‚";
        return;
      }

      const allCols = Object.keys(rows[0]);

      // æ ¹æ®å£¹ä¼´è¡¨æ ¼å­—æ®µè¿›è¡ŒåŒ¹é…
      const colMap = {
        title: findCol(["æ ‡é¢˜", "æ–‡ç« æ ‡é¢˜", "å†…å®¹æ ‡é¢˜"], allCols) || allCols[0],
        date: findCol(["æ—¥æœŸ", "é˜…è¯»", "å‘å¸ƒæ—¶é—´", "å‘è¡¨æ—¶é—´"], allCols),
        hour: findCol(["å°æ—¶"], allCols),
        readCount: findCol(["é˜…è¯»é‡"], allCols),
        readers: findCol(["é˜…è¯»äººæ•°"], allCols),
        officialAccount: findCol(["å…¬ä¼—å·"], allCols),
        readingGroup: findCol(["é˜…è¯»ç»„"], allCols),
        moments: findCol(["æœ‹å‹åœˆ"], allCols),
        look: findCol(["çœ‹ä¸€çœ‹"], allCols),
        search: findCol(["æœä¸€æœ"], allCols),
        follows: findCol(["æ–°å¢å…³æ³¨"], allCols),
        shareCount: findCol(["åˆ†äº«é‡"], allCols),
        sharers: findCol(["åˆ†äº«äººæ•°"], allCols),
        sessionShare: findCol(["ä¼šè¯åˆ†äº«"], allCols),
        officialShare: findCol(["å…¬ä¼—å·åˆ†äº«"], allCols),
        otherShare: findCol(["å…¶ä»–åˆ†äº«"], allCols),
        likes: findCol(["ç‚¹èµæ•°", "ç‚¹èµé‡"], allCols),
        dislikes: findCol(["ç‚¹è¸©æ•°"], allCols),
        tips: findCol(["æ‰“èµæ•°"], allCols),
        openRate: findCol(["æ‰“å¼€ç‡"], allCols),
        shareRate: findCol(["åˆ†äº«ç‡"], allCols),
        readConversionRate: findCol(["é˜…è¯»è½¬åŒ–ç‡"], allCols),
        completionRate: findCol(["å®Œè¯»ç‡"], allCols),
        interactionRate: findCol(["äº’åŠ¨ç‡"], allCols),
      };

      const data = [];
      let minDate = null;
      let maxDate = null;
      const dailyMap = {};
      const hourMap = {};

      rows.forEach((row) => {
        const title = row[colMap.title] || "";
        const date = colMap.date ? parseDate(row[colMap.date]) : null;
        const hour = colMap.hour ? num(row[colMap.hour]) : null;

        const item = {
          title,
          date,
          hour,
          readCount: num(row[colMap.readCount]),
          readers: num(row[colMap.readers]),
          officialAccount: num(row[colMap.officialAccount]),
          readingGroup: num(row[colMap.readingGroup]),
          moments: num(row[colMap.moments]),
          look: num(row[colMap.look]),
          search: num(row[colMap.search]),
          follows: num(row[colMap.follows]),
          shareCount: num(row[colMap.shareCount]),
          sharers: num(row[colMap.sharers]),
          sessionShare: num(row[colMap.sessionShare]),
          officialShare: num(row[colMap.officialShare]),
          otherShare: num(row[colMap.otherShare]),
          likes: num(row[colMap.likes]),
          dislikes: num(row[colMap.dislikes]),
          tips: num(row[colMap.tips]),
          openRate: pct(row[colMap.openRate]),
          shareRate: pct(row[colMap.shareRate]),
          readConversionRate: pct(row[colMap.readConversionRate]),
          completionRate: pct(row[colMap.completionRate]),
          interactionRate: pct(row[colMap.interactionRate]),
        };

        data.push(item);

        if (date) {
          if (!minDate || date < minDate) minDate = date;
          if (!maxDate || date > maxDate) maxDate = date;

          const dayStr = formatDate(date);
          dailyMap[dayStr] = (dailyMap[dayStr] || 0) + 1;

          if (hour !== null && hour >= 0 && hour < 24) {
            hourMap[hour] = (hourMap[hour] || 0) + 1;
          }
        }
      });

      if (minDate && maxDate) {
        document.getElementById("dateRange").innerHTML =
          `æ—¶é—´èŒƒå›´ï¼š${formatDate(minDate)} ~ ${formatDate(maxDate)}` +
          `<span class="tag">ç”¨äºæ•°æ®åˆ†æå±•ç¤º</span>`;
      }

      renderSummary(data);
      renderReadSource(data);
      renderTopRead(data);
      renderReadShare(data);
      renderTopLikes(data);
      renderTopShare(data);
      renderOpenRate(data);
      renderShareRate(data);
      renderDailyChart(dailyMap);
      renderHourChart(hourMap);
      renderDetailTable(data);
    }

    function renderSummary(data) {
      document.getElementById("summaryCards").style.display = "grid";

      const total = data.length;
      const totalReaders = data.reduce((s, r) => s + r.readers, 0);
      const totalReadCount = data.reduce((s, r) => s + r.readCount, 0);
      const totalShareCount = data.reduce((s, r) => s + r.shareCount, 0);
      const totalLikes = data.reduce((s, r) => s + r.likes, 0);
      const totalFollows = data.reduce((s, r) => s + r.follows, 0);

      const openRates = data.map((r) => r.openRate).filter((v) => v > 0);
      const avgOpenRate =
        openRates.length > 0
          ? (openRates.reduce((a, b) => a + b, 0) / openRates.length).toFixed(2)
          : "0.00";

      const shareRates = data.map((r) => r.shareRate).filter((v) => v > 0);
      const avgShareRate =
        shareRates.length > 0
          ? (shareRates.reduce((a, b) => a + b, 0) / shareRates.length).toFixed(2)
          : "0.00";

      document.getElementById("totalArticles").textContent = total;
      document.getElementById("totalReaders").textContent = totalReaders.toLocaleString();
      document.getElementById("totalReadCount").textContent = totalReadCount.toLocaleString();
      document.getElementById("totalShareCount").textContent = totalShareCount.toLocaleString();
      document.getElementById("totalLikes").textContent = totalLikes.toLocaleString();
      document.getElementById("totalFollows").textContent = totalFollows.toLocaleString();
      document.getElementById("avgOpenRate").textContent = avgOpenRate + "%";
      document.getElementById("avgShareRate").textContent = avgShareRate + "%";
    }

    function renderReadSource(data) {
      const officialAccount = data.reduce((s, r) => s + r.officialAccount, 0);
      const readingGroup = data.reduce((s, r) => s + r.readingGroup, 0);
      const moments = data.reduce((s, r) => s + r.moments, 0);
      const look = data.reduce((s, r) => s + r.look, 0);
      const search = data.reduce((s, r) => s + r.search, 0);

      Plotly.newPlot(
        "readSourceChart",
        [
          {
            x: ["å…¬ä¼—å·", "é˜…è¯»ç»„", "æœ‹å‹åœˆ", "çœ‹ä¸€çœ‹", "æœä¸€æœ"],
            y: [officialAccount, readingGroup, moments, look, search],
            type: "bar",
          },
        ],
        { margin: { t: 20, r: 10, b: 40, l: 40 } }
      );
    }

    function renderTopRead(data) {
      const top = data
        .slice()
        .sort((a, b) => b.readers - a.readers)
        .slice(0, 10);

      Plotly.newPlot(
        "topReadChart",
        [
          {
            x: top.map((x) => x.title || "æœªå‘½å"),
            y: top.map((x) => x.readers),
            type: "bar",
          },
        ],
        { margin: { b: 120 } }
      );
    }

    function renderReadShare(data) {
      Plotly.newPlot(
        "readShareScatter",
        [
          {
            x: data.map((x) => x.readers),
            y: data.map((x) => x.shareCount),
            mode: "markers",
            type: "scatter",
            text: data.map((x) => x.title || "æœªå‘½å"),
          },
        ],
        {
          xaxis: { title: "é˜…è¯»äººæ•°" },
          yaxis: { title: "åˆ†äº«é‡" },
        }
      );
    }

    function renderTopLikes(data) {
      const top = data
        .slice()
        .sort((a, b) => b.likes - a.likes)
        .slice(0, 10);

      Plotly.newPlot(
        "topLikesChart",
        [
          {
            x: top.map((x) => x.title || "æœªå‘½å"),
            y: top.map((x) => x.likes),
            type: "bar",
          },
        ],
        { margin: { b: 120 } }
      );
    }

    function renderTopShare(data) {
      const top = data
        .slice()
        .sort((a, b) => b.shareCount - a.shareCount)
        .slice(0, 10);

      Plotly.newPlot(
        "topShareChart",
        [
          {
            x: top.map((x) => x.title || "æœªå‘½å"),
            y: top.map((x) => x.shareCount),
            type: "bar",
          },
        ],
        { margin: { b: 120 } }
      );
    }

    function renderOpenRate(data) {
      const list = data
        .filter((x) => x.openRate > 0)
        .sort((a, b) => b.openRate - a.openRate)
        .slice(0, 20);

      Plotly.newPlot(
        "openRateChart",
        [
          {
            x: list.map((x) => x.title || "æœªå‘½å"),
            y: list.map((x) => x.openRate),
            type: "bar",
          },
        ],
        { margin: { b: 120 }, yaxis: { title: "æ‰“å¼€ç‡ (%)" } }
      );
    }

    function renderShareRate(data) {
      const list = data
        .filter((x) => x.shareRate > 0)
        .sort((a, b) => b.shareRate - a.shareRate)
        .slice(0, 20);

      Plotly.newPlot(
        "shareRateChart",
        [
          {
            x: list.map((x) => x.title || "æœªå‘½å"),
            y: list.map((x) => x.shareRate),
            type: "bar",
          },
        ],
        { margin: { b: 120 }, yaxis: { title: "åˆ†äº«ç‡ (%)" } }
      );
    }

    function renderDailyChart(dailyMap) {
      const dates = Object.keys(dailyMap).sort();
      const counts = dates.map((d) => dailyMap[d]);

      Plotly.newPlot(
        "dailyChart",
        [{ x: dates, y: counts, type: "bar" }],
        { margin: { t: 20, r: 10, b: 60, l: 40 } }
      );
    }

    function renderHourChart(hourMap) {
      const hours = [];
      const counts = [];
      for (let h = 0; h < 24; h++) {
        hours.push(h);
        counts.push(hourMap[h] || 0);
      }

      Plotly.newPlot(
        "hourChart",
        [{ x: hours, y: counts, type: "bar" }],
        { margin: { t: 20, r: 10, b: 40, l: 40 }, xaxis: { dtick: 1 } }
      );
    }

    function renderDetailTable(data) {
      const top = data
        .slice()
        .sort((a, b) => b.readers - a.readers)
        .slice(0, 50);

      let html = "<table class='data-table'><thead><tr>";
      const headers = [
        "æ ‡é¢˜",
        "æ—¥æœŸ",
        "é˜…è¯»äººæ•°",
        "é˜…è¯»é‡",
        "åˆ†äº«é‡",
        "ç‚¹èµæ•°",
        "æ–°å¢å…³æ³¨",
        "æ‰“å¼€ç‡",
        "åˆ†äº«ç‡",
      ];
      html += headers.map((h) => `<th>${h}</th>`).join("");
      html += "</tr></thead><tbody>";

      top.forEach((row) => {
        html += "<tr>";
        html += `<td>${escapeHtml(row.title || "")}</td>`;
        html += `<td>${row.date ? formatDate(row.date) : ""}</td>`;
        html += `<td>${row.readers}</td>`;
        html += `<td>${row.readCount}</td>`;
        html += `<td>${row.shareCount}</td>`;
        html += `<td>${row.likes}</td>`;
        html += `<td>${row.follows}</td>`;
        html += `<td>${row.openRate.toFixed(2)}%</td>`;
        html += `<td>${row.shareRate.toFixed(2)}%</td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";
      document.getElementById("detailTable").innerHTML = html;
    }

    function escapeHtml(val) {
      if (val === null || val === undefined) return "";
      return String(val)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }
  </script>

  <!-- æˆæƒå±‚è„šæœ¬ -->
  <script>
    const TOOL_ID = "yiban-analysis";
    const STORAGE_KEY = `wechat_dashboard_auth_${TOOL_ID}`;
    const INLINE_AUTH_CODES = {
      tools: {
        yiban-analysis: {
          codes: {
            "YB-2025-A1B2": "æ ‡å‡†æˆæƒ",
            "YB-2025-C3D4": "æ ‡å‡†æˆæƒ",
            "YB-2025-E5F6": "æ ‡å‡†æˆæƒ",
            "YB-2025-G7H8": "æ ‡å‡†æˆæƒ",
            "YB-2025-I9J0": "æ ‡å‡†æˆæƒ",
            "YB-2025-K1L2": "æ ‡å‡†æˆæƒ",
            "YB-2025-M3N4": "æ ‡å‡†æˆæƒ",
            "YB-2025-O5P6": "æ ‡å‡†æˆæƒ",
            "YB-2025-Q7R8": "æ ‡å‡†æˆæƒ",
            "YB-2025-S9T0": "æ ‡å‡†æˆæƒ",
          },
        },
      },
    };

    let AUTH_CODES = {};
    let authLoaded = false;

    function loadAuthCodes() {
      if (location.protocol === "file:") {
        AUTH_CODES = INLINE_AUTH_CODES.tools?.[TOOL_ID]?.codes || {};
        authLoaded = true;
        console.log("ä½¿ç”¨å†…ç½®æˆæƒç ï¼ˆfile:// æ¨¡å¼ï¼‰");
        return Promise.resolve();
      }

      const url = "./auth-codes.json?" + Date.now();
      console.log("å°è¯•åŠ è½½æˆæƒç æ–‡ä»¶ï¼š", url);

      return fetch(url)
        .then(async (res) => {
          if (!res.ok) {
            const text = await res.text().catch(() => "");
            console.error("auth-codes.json å“åº”å¼‚å¸¸ï¼š", res.status, res.statusText, text);
            throw new Error("HTTP " + res.status);
          }
          return res.json();
        })
        .then((data) => {
          console.log("auth-codes.json åŠ è½½æˆåŠŸï¼š", data);
          // æå–å½“å‰å·¥å…·çš„æˆæƒç 
          if (data.tools && data.tools[TOOL_ID]) {
            AUTH_CODES = data.tools[TOOL_ID].codes || {};
          } else if (typeof data === 'object') {
            // å…¼å®¹æ—§æ ¼å¼
            AUTH_CODES = data;
          }
          authLoaded = true;
          console.log("æˆæƒç åŠ è½½å®Œæˆï¼Œå¯ç”¨æ•°é‡:", Object.keys(AUTH_CODES).length);
        })
        .catch((err) => {
          console.error("æˆæƒç æ–‡ä»¶åŠ è½½å¤±è´¥:", err);
          // å…œåº•ï¼šå¦‚æœæœ‰å†…ç½®æˆæƒç åˆ™ç»§ç»­ä½¿ç”¨ï¼Œé¿å…é˜»æ–­ä½¿ç”¨
          AUTH_CODES = INLINE_AUTH_CODES.tools?.[TOOL_ID]?.codes || {};
          authLoaded = true;
          console.log("ä½¿ç”¨å†…ç½®æˆæƒç å…œåº•ï¼Œå¯ç”¨æ•°é‡:", Object.keys(AUTH_CODES).length);
          if (!Object.keys(AUTH_CODES).length) {
            alert("æˆæƒç æ–‡ä»¶åŠ è½½å¤±è´¥ï¼š\n" +
              "1ï¼‰ç¡®è®¤æ ¹ç›®å½•å­˜åœ¨ auth-codes.json\n" +
              "2ï¼‰ç¡®è®¤éƒ¨ç½²åå¯ä»¥ç›´æ¥è®¿é—® /auth-codes.json\n" +
              "3ï¼‰ç¡®è®¤æ–‡ä»¶å†…å®¹æ˜¯åˆæ³• JSONï¼ˆæ— å¤šä½™é€—å·/æ³¨é‡Šï¼‰");
          }
        });
    }

    let authScreen, appRoot, input, btn, errElAuth, cardEl;

    function initAuthElements() {
      authScreen = document.getElementById("auth-screen");
      appRoot = document.getElementById("app");
      input = document.getElementById("auth-code");
      btn = document.getElementById("auth-btn");
      errElAuth = document.getElementById("auth-error");
      cardEl = document.getElementById("auth-card");

      if (!authScreen || !appRoot || !input || !btn || !errElAuth || !cardEl) {
        console.error("æˆæƒå…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥ DOM");
        return false;
      }
      return true;
    }

    function shakeCard() {
      if (!cardEl) return;
      cardEl.classList.remove("shake");
      void cardEl.offsetWidth;
      cardEl.classList.add("shake");
    }

    async function handleAuth() {
      console.log("handleAuth è¢«è°ƒç”¨");
      if (!input || !errElAuth) {
        console.error("æˆæƒå…ƒç´ æœªåˆå§‹åŒ–", { input, errElAuth });
        return;
      }

      const code = (input.value || "").trim();
      console.log("è¾“å…¥çš„æˆæƒç :", code);

      if (!authLoaded) {
        console.log("æˆæƒç æœªåŠ è½½ï¼Œå¼€å§‹åŠ è½½...");
        await loadAuthCodes();
      }

      if (!code) {
        errElAuth.textContent = "è¯·è¾“å…¥æˆæƒç ã€‚";
        shakeCard();
        return;
      }

      console.log("éªŒè¯æˆæƒç :", code);
      console.log("å¯ç”¨æˆæƒç åˆ—è¡¨:", Object.keys(AUTH_CODES));
      console.log("æˆæƒç å¯¹è±¡:", AUTH_CODES);

      if (!Object.prototype.hasOwnProperty.call(AUTH_CODES, code)) {
        console.log("æˆæƒç éªŒè¯å¤±è´¥:", code, "ä¸åœ¨åˆ—è¡¨ä¸­");
        errElAuth.textContent = "æˆæƒç æ— æ•ˆï¼Œè¯·ç¡®è®¤åé‡æ–°è¾“å…¥ã€‚";
        shakeCard();
        return;
      }

      console.log("æˆæƒç éªŒè¯æˆåŠŸï¼Œæ˜¾ç¤ºåº”ç”¨");
      errElAuth.textContent = "";
      showApp(code);
    }

    function showApp(code) {
      if (!authScreen || !appRoot) {
        console.error("æ— æ³•æ˜¾ç¤ºåº”ç”¨ï¼šå…ƒç´ æœªæ‰¾åˆ°");
        return;
      }
      authScreen.style.display = "none";
      appRoot.style.display = "block";
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ code, ts: Date.now() }));
      } catch (e) {
        console.warn("localStorage ä¿å­˜å¤±è´¥:", e);
      }
    }

    (async function bootstrapAuth() {
      console.log("å¼€å§‹åˆå§‹åŒ–æˆæƒç³»ç»Ÿ");
      // ç­‰å¾… DOM åŠ è½½å®Œæˆ
      if (document.readyState === "loading") {
        await new Promise((resolve) => {
          document.addEventListener("DOMContentLoaded", resolve);
        });
      }

      if (!initAuthElements()) {
        console.error("åˆå§‹åŒ–æˆæƒå…ƒç´ å¤±è´¥");
        return;
      }

      console.log("æˆæƒå…ƒç´ åˆå§‹åŒ–æˆåŠŸ");

      // ä¸´æ—¶ï¼šç›´æ¥è·³è¿‡æˆæƒï¼Œæ˜¾ç¤ºåº”ç”¨
      console.log("è·³è¿‡æˆæƒéªŒè¯ï¼Œç›´æ¥æ˜¾ç¤ºåº”ç”¨");
      showApp("test");

      // æ³¨é‡Šæ‰æˆæƒç›¸å…³ä»£ç ï¼Œæ–¹ä¾¿æµ‹è¯•
      /*
      await loadAuthCodes();
      console.log("æˆæƒç åŠ è½½å®Œæˆï¼Œå¯ç”¨æ•°é‡:", Object.keys(AUTH_CODES).length);

      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          if (parsed && parsed.code && AUTH_CODES[parsed.code]) {
            console.log("å‘ç°å·²ä¿å­˜çš„æˆæƒç ï¼Œè‡ªåŠ¨ç™»å½•");
            showApp(parsed.code);
            return;
          }
        }
      } catch (e) {
        console.warn("è¯»å–ä¿å­˜çš„æˆæƒä¿¡æ¯å¤±è´¥:", e);
      }

      // ç»‘å®šäº‹ä»¶
      console.log("ç»‘å®šäº‹ä»¶ç›‘å¬å™¨");
      btn.addEventListener("click", function(e) {
        console.log("æŒ‰é’®ç‚¹å‡»äº‹ä»¶è§¦å‘");
        e.preventDefault();
        handleAuth();
      });
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          console.log("å›è½¦é”®è§¦å‘");
          e.preventDefault();
          handleAuth();
        }
      });

      setTimeout(() => {
        if (input) {
          input.focus();
          console.log("è¾“å…¥æ¡†å·²èšç„¦");
        }
      }, 80);
      */
    })();
  </script>
</body>
</html>



<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å£¹ä¼´æ•°æ®åˆ†æå·¥å…·ï¼ˆæœ¬åœ°ç‰ˆï¼‰</title>
  <link rel="stylesheet" href="gemini-ui.css" />
  <link rel="stylesheet" href="design-system-modern.css" />
  <link rel="stylesheet" href="tool-pages-interactions.css" />
  <link rel="stylesheet" href="data-dense.css" />
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* ===== æˆæƒå±‚æ ·å¼ ===== */
    #auth-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.92);
      z-index: 9999;
      backdrop-filter: blur(8px);
    }

    .auth-card {
      width: 360px;
      max-width: 90vw;
      padding: 24px;
      border-radius: 16px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 16px 48px rgba(15, 23, 42, 0.12);
    }

    .auth-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #0f172a;
    }

    .auth-subtitle {
      font-size: 12px;
      color: #475569;
      margin-bottom: 16px;
    }

    .auth-label {
      font-size: 12px;
      color: #475569;
      margin-bottom: 6px;
      display: block;
      font-weight: 600;
    }

    .auth-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #f8fafc;
      color: #0f172a;
      outline: none;
      font-size: 13px;
      margin-bottom: 14px;
      box-sizing: border-box;
      transition: border-color 0.18s, box-shadow 0.18s, transform 0.12s ease;
    }

    .auth-input:focus {
      border-color: #bfdbfe;
      box-shadow: 0 0 0 3px rgba(191, 219, 254, 0.55);
      transform: translateY(-1px);
    }

    .auth-btn {
      width: 100%;
      border: none;
      border-radius: 10px;
      padding: 11px 16px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
      transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
    }

    .auth-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 36px rgba(37, 99, 235, 0.32);
      filter: brightness(1.02);
    }

    .auth-error {
      margin-top: 10px;
      font-size: 11px;
      color: #dc2626;
      min-height: 16px;
    }

    .auth-card.shake {
      animation: shake 0.3s ease-in-out;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-6px);
      }

      50% {
        transform: translateX(6px);
      }

      75% {
        transform: translateX(-3px);
      }
    }

    /* ===== é¡µé¢å¸ƒå±€æ ·å¼ ===== */
    #app {
      display: none;
      background-color: var(--color-bg-secondary);
      min-height: 100vh;
    }

    #app.visible {
      display: block;
    }

    .topbar {
      position: sticky;
      top: 0;
      background: var(--color-bg-primary);
      border-bottom: 1px solid var(--color-border-light);
      padding: var(--space-lg) var(--space-2xl);
      z-index: 100;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .topbar-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text-primary);
      margin-bottom: var(--space-md);
    }

    .file-input {
      display: inline-block;
      padding: var(--space-md) var(--space-lg);
      background: linear-gradient(135deg, var(--color-primary), #2563eb);
      color: white;
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: transform var(--transition-base), box-shadow var(--transition-base);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      margin-bottom: var(--space-md);
    }

    .file-input:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .hint {
      font-size: var(--text-xs);
      color: var(--color-text-tertiary);
      margin-top: var(--space-sm);
    }

    /* è¿”å›é¦–é¡µæŒ‰é’® */
    .topbar-home {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-lg);
      background: var(--color-bg-secondary);
      color: var(--color-text-primary);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      text-decoration: none;
      transition: all var(--transition-base);
      border: 1px solid var(--color-border-light);
    }

    .topbar-home:hover {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--space-3xl) var(--space-2xl);
    }

    .container h1 {
      margin-bottom: var(--space-md);
    }

    .sub-title {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-3xl);
    }

    .tag {
      display: inline-block;
      background-color: var(--color-info-bg);
      color: var(--color-info);
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-weight-semibold);
    }

    #loading,
    #error {
      padding: var(--space-lg) var(--space-2xl);
      margin-bottom: var(--space-2xl);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
    }

    #loading {
      background-color: var(--color-info-bg);
      color: var(--color-info);
    }

    #error {
      background-color: var(--color-error-bg);
      color: var(--color-error);
    }

    /* æ±‡æ€»å¡ç‰‡ */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-3xl);
    }

    .card {
      background: var(--color-bg-primary);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-2xl);
      transition: all var(--transition-base);
      box-shadow: var(--shadow-xs);
    }

    .card:hover {
      border-color: var(--color-primary-light);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .card-label {
      font-size: var(--text-xs);
      color: var(--color-text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-sm);
      font-weight: var(--font-weight-semibold);
    }

    .card-value {
      font-size: var(--text-3xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text-primary);
      margin-bottom: var(--space-sm);
      line-height: 1.2;
    }

    .card-desc {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
    }

    /* å›¾è¡¨å— */
    .chart-block {
      background: var(--color-bg-primary);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-2xl);
      margin-bottom: var(--space-2xl);
      box-shadow: var(--shadow-xs);
      transition: box-shadow var(--transition-base);
    }

    .chart-block:hover {
      box-shadow: var(--shadow-sm);
    }

    .chart-title {
      font-size: var(--text-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
      margin-bottom: var(--space-md);
    }

    .chart-subtitle {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-lg);
    }

    .chart {
      min-height: 350px;
      width: 100%;
    }

    /* h2 æ ·å¼ */
    .container h2 {
      font-size: var(--text-2xl);
      margin-top: var(--space-3xl);
      margin-bottom: var(--space-2xl);
      padding-top: var(--space-2xl);
      border-top: 2px solid var(--color-border-light);
      color: var(--color-primary);
    }

    .container h2:first-of-type {
      border-top: none;
      margin-top: 0;
    }

    .footer {
      text-align: center;
      margin-top: var(--space-3xl);
      padding-top: var(--space-2xl);
      border-top: 1px solid var(--color-border-light);
      font-size: var(--text-xs);
      color: var(--color-text-tertiary);
    }

    /* è¡¨æ ¼æ ·å¼ */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--text-sm);
    }

    table th {
      background-color: var(--color-bg-secondary);
      padding: var(--space-md) var(--space-lg);
      text-align: left;
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
      border-bottom: 1px solid var(--color-border-light);
    }

    table td {
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--color-border-light);
      color: var(--color-text-secondary);
    }

    table tr:hover {
      background-color: var(--color-bg-secondary);
    }

    /* å“åº”å¼ */
    @media (max-width: 1024px) {
      .container {
        padding: var(--space-2xl) var(--space-lg);
      }

      .cards {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .chart {
        min-height: 280px;
      }
    }

    @media (max-width: 768px) {
      .topbar {
        padding: var(--space-md) var(--space-lg);
      }

      .topbar-title {
        font-size: var(--text-xl);
      }

      .container {
        padding: var(--space-2xl) var(--space-md);
      }

      .cards {
        grid-template-columns: 1fr;
      }

      .chart {
        min-height: 250px;
      }

      .chart-block {
        padding: var(--space-lg);
      }

      .container h2 {
        font-size: var(--text-lg);
      }
    }
  </style>
</head>

<body>
  <!-- æˆæƒå±‚ -->
  <div id="auth-screen">
    <div class="auth-card" id="auth-card">
      <div class="auth-title">ğŸ” å£¹ä¼´æ•°æ®åˆ†æå·¥å…·</div>
      <div class="auth-subtitle">è¯·è¾“å…¥æˆæƒç è®¿é—®æœ¬å·¥å…·</div>

      <label class="auth-label" for="auth-code">æˆæƒç </label>
      <input id="auth-code" class="auth-input" type="text" placeholder="ä¾‹å¦‚ï¼šYB-2025-A1B2" autocomplete="off" />

      <button class="auth-btn" id="auth-btn">ç¡®è®¤è¿›å…¥</button>

      <div class="auth-error" id="auth-error"></div>
    </div>
  </div>

  <!-- çœŸæ­£çš„åº”ç”¨ -->
  <div id="app">
    <div class="topbar">
      <div>
        <div class="topbar-title">å£¹ä¼´æ•°æ®åˆ†æå·¥å…·ï¼ˆæœ¬åœ°ç‰ˆï¼‰</div>
        <div class="hint">
          æ”¯æŒå£¹ä¼´æ’ä»¶å¯¼å‡ºçš„ Excel è¡¨æ ¼ï¼Œè‡ªåŠ¨è¯†åˆ«é˜…è¯»ã€åˆ†äº«ã€äº’åŠ¨ç­‰å­—æ®µ
        </div>
      </div>
      <div style="display: flex; gap: var(--space-lg); align-items: center;">
        <label class="file-input">
          é€‰æ‹© Excel æ–‡ä»¶
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" />
        </label>
        <a href="image-stitch.html" class="topbar-home" style="margin-right:8px;">ğŸ–¼ï¸ é•¿å›¾æ‹¼æ¥</a>
        <a href="index.html" class="topbar-home">â† è¿”å›é¦–é¡µ</a>
      </div>
    </div>

    <div class="container">
      <h1>å£¹ä¼´æ•°æ®åˆ†æ Dashboard</h1>
      <div class="sub-title" id="dateRange">
        è¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©å£¹ä¼´å¯¼å‡ºçš„ Excel æ–‡ä»¶
        <span class="tag">ç¦»çº¿æœ¬åœ°åˆ†æï¼Œä¸ä¼šä¸Šä¼ æ•°æ®</span>
      </div>

      <div id="loading"></div>
      <div id="error"></div>

      <!-- æ±‡æ€»å¡ç‰‡ -->
      <div class="cards" id="summaryCards" style="display:none;">
        <div class="card">
          <div class="card-label">æ–‡ç« æ€»æ•°</div>
          <div class="card-value" id="totalArticles">-</div>
          <div class="card-desc">ç»Ÿè®¡å‘¨æœŸå†…çš„æ–‡ç« æ•°é‡</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»é˜…è¯»äººæ•°</div>
          <div class="card-value" id="totalReaders">-</div>
          <div class="card-desc">ç´¯è®¡é˜…è¯»äººæ•°</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»é˜…è¯»é‡</div>
          <div class="card-value" id="totalReadCount">-</div>
          <div class="card-desc">ç´¯è®¡é˜…è¯»æ¬¡æ•°</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»åˆ†äº«é‡</div>
          <div class="card-value" id="totalShareCount">-</div>
          <div class="card-desc">ç´¯è®¡åˆ†äº«æ¬¡æ•°</div>
        </div>
        <div class="card">
          <div class="card-label">æ€»ç‚¹èµæ•°</div>
          <div class="card-value" id="totalLikes">-</div>
          <div class="card-desc">ç´¯è®¡ç‚¹èµæ•°</div>
        </div>
        <div class="card">
          <div class="card-label">æ–°å¢å…³æ³¨</div>
          <div class="card-value" id="totalFollows">-</div>
          <div class="card-desc">ç´¯è®¡æ–°å¢å…³æ³¨äººæ•°</div>
        </div>
        <div class="card">
          <div class="card-label">å¹³å‡æ‰“å¼€ç‡</div>
          <div class="card-value" id="avgOpenRate">-</div>
          <div class="card-desc">å¹³å‡æ‰“å¼€ç‡</div>
        </div>
        <div class="card">
          <div class="card-label">å¹³å‡åˆ†äº«ç‡</div>
          <div class="card-value" id="avgShareRate">-</div>
          <div class="card-desc">å¹³å‡åˆ†äº«ç‡</div>
        </div>
      </div>

      <!-- ä¸€ã€Top å†…å®¹è¡¨ç° -->
      <h2>ä¸€ã€Top å†…å®¹è¡¨ç°</h2>
      <div class="chart-block">
        <div class="chart-title">Top10 å†…å®¹ï¼ˆæŒ‰é˜…è¯»äººæ•°ï¼‰</div>
        <div id="topReadChart" class="chart"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">é˜…è¯»äººæ•° vs åˆ†äº«é‡</div>
        <div id="readShareScatter" class="chart"></div>
      </div>

      <!-- äºŒã€äº’åŠ¨åˆ†æ -->
      <h2>äºŒã€äº’åŠ¨è¡¨ç°</h2>
      <div class="chart-block">
        <div class="chart-title">ç‚¹èµæ•° Top10</div>
        <div id="topLikesChart" class="chart"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">åˆ†äº«é‡ Top10</div>
        <div id="topShareChart" class="chart"></div>
      </div>

      <!-- ä¸‰ã€è½¬åŒ–ç‡åˆ†æ -->
      <h2>ä¸‰ã€è½¬åŒ–ç‡åˆ†æ</h2>
      <div class="chart-block">
        <div class="chart-title">æ‰“å¼€ç‡åˆ†å¸ƒï¼ˆTop20ï¼‰</div>
        <div id="openRateChart" class="chart"></div>
      </div>

      <!-- å››ã€æ ¸å¿ƒæŒ‡æ ‡ TOP 5 åˆ†æ -->
      <h2>å››ã€æ ¸å¿ƒæŒ‡æ ‡ TOP 5 åˆ†æ</h2>

      <div class="chart-block">
        <div class="chart-title">é˜…è¯»é‡ TOP 5</div>
        <div class="chart-subtitle">åæ˜ æ•´ä½“çš„å†…å®¹é˜…è¯»ç»“æœæ•°æ®</div>
        <div id="topReadCountTable"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">æœä¸€æœ TOP 5</div>
        <div class="chart-subtitle">åæ˜ è¿™äº›å†…å®¹çš„æœç´¢å–œå¥½ç¨‹åº¦</div>
        <div id="topSearchTable"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">çœ‹ä¸€çœ‹ç²¾é€‰ TOP 5</div>
        <div class="chart-subtitle">åæ˜ å†…å®¹åœ¨æ¨èç³»ç»Ÿä¸­çš„å—å–œå¥½ç¨‹åº¦</div>
        <div id="topLookTable"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">åˆ†äº«é‡ TOP 5</div>
        <div class="chart-subtitle">åæ˜ ç”¨æˆ·å¯¹å†…å®¹çš„åˆ†äº«åŠ¨åŠ›</div>
        <div id="topShareCountTable"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">æ‰“å¼€ç‡ TOP 5</div>
        <div class="chart-subtitle">ç»¼åˆåæ˜ ç²‰ä¸çš„æ´»è·ƒåº¦ã€æ ‡é¢˜çš„å¸å¼•åŠ›ã€æ¨é€çš„æ—¶é—´èŠ‚ç‚¹æ˜¯å¦æ°å½“</div>
        <div id="topOpenRateTable"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">æœ‹å‹åœˆæ‰“å¼€ç‡ TOP 5</div>
        <div class="chart-subtitle">åæ˜ åˆ†äº«åçš„äºŒæ¬¡ä¼ æ’­èƒ½åŠ›</div>
        <div id="topMomentsOpenRateTable"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">ç•™è¨€ç‡ TOP 5</div>
        <div class="chart-subtitle">åæ˜ ç”¨æˆ·å¯¹å†…å®¹äº§ç”Ÿçš„äº’åŠ¨ç¨‹åº¦</div>
        <div id="topCommentRateTable"></div>
      </div>

      <div class="chart-block">
        <div class="chart-title">é˜…è¯»åå…³æ³¨ TOP 5</div>
        <div class="chart-subtitle">åæ˜ ç”¨æˆ·å¯¹å½“å‰é˜…è¯»å†…å®¹çš„æŒç»­å…³æ³¨åº¦</div>
        <div id="topFollowsTable"></div>
      </div>

      <!-- å…­ã€å†…å®¹æ˜ç»† -->
      <h2>äº”ã€å†…å®¹æ˜ç»†ï¼ˆTop50 æŒ‰é˜…è¯»äººæ•°ï¼‰</h2>
      <div class="chart-block">
        <div class="chart-title">å†…å®¹æ˜ç»†è¡¨</div>
        <div id="detailTable"></div>
      </div>

      <div class="footer" style="font-size:11px;color:#9ca3af;margin-top:24px;text-align:center;">
        æœ¬é¡µé¢ä»…åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­å¤„ç†ä½ çš„ Excel æ•°æ®ï¼Œä¸ä¼šä¸Šä¼ åˆ°ç½‘ç»œã€‚
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const loadingEl = document.getElementById("loading");
    const errorEl = document.getElementById("error");

    fileInput.addEventListener("change", handleFile, false);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      loadingEl.textContent = "æ­£åœ¨è¯»å–å¹¶è§£æ Excel æ•°æ®ï¼Œè¯·ç¨å€™â€¦";
      errorEl.textContent = "";

      const reader = new FileReader();
      reader.onload = function (evt) {
        try {
          const data = evt.target.result;
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheet = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheet];
          const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
          processData(json);
          loadingEl.textContent = "";
        } catch (err) {
          console.error(err);
          errorEl.textContent = "è§£æ Excel å¤±è´¥ï¼Œè¯·ç¡®è®¤æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚";
          loadingEl.textContent = "";
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function num(v) {
      if (v === null || v === undefined || v === "") return 0;
      const s = String(v).replace(/,/g, "").replace(/%/g, "");
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    function pct(v) {
      if (!v) return 0;
      const s = String(v).trim();
      if (s.endsWith("%")) return parseFloat(s.slice(0, -1)) || 0;
      return parseFloat(s) || 0;
    }

    function parseDate(value) {
      if (!value) return null;
      if (value instanceof Date) return value;
      if (typeof value === "number") {
        return new Date(Math.round((value - 25569) * 86400 * 1000));
      }
      const d = new Date(value);
      if (isNaN(d.getTime())) return null;
      return d;
    }

    function formatDate(d) {
      if (!d) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function findCol(candidates, cols) {
      // å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
      for (const c of candidates) {
        if (cols.includes(c)) return c;
      }
      // å†å°è¯•å¿½ç•¥ç©ºæ ¼å’Œå¤§å°å†™çš„åŒ¹é…
      const normalizedCols = cols.map(col => String(col).replace(/\s+/g, "").toLowerCase());
      for (const c of candidates) {
        const normalized = String(c).replace(/\s+/g, "").toLowerCase();
        const index = normalizedCols.indexOf(normalized);
        if (index !== -1) {
          console.log(`å­—æ®µåŒ¹é…ï¼ˆå¿½ç•¥ç©ºæ ¼/å¤§å°å†™ï¼‰: "${c}" â†’ "${cols[index]}"`);
          return cols[index];  // è¿”å›åŸå§‹å­—æ®µå
        }
      }
      return null;
    }

    function processData(rows) {
      if (!rows || !rows.length) {
        errorEl.textContent = "Excel ä¸­æ²¡æœ‰æ•°æ®ã€‚";
        return;
      }

      const allCols = Object.keys(rows[0]);
      console.log("æ£€æµ‹åˆ°çš„è¡¨å¤´å­—æ®µ:", allCols);

      // æ ¹æ®å£¹ä¼´è¡¨æ ¼å­—æ®µè¿›è¡ŒåŒ¹é…
      const colMap = {
        title: findCol(["æ ‡é¢˜", "æ–‡ç« æ ‡é¢˜", "å†…å®¹æ ‡é¢˜"], allCols) || allCols[0],
        date: findCol(["æ—¥æœŸ", "é˜…è¯»", "å‘å¸ƒæ—¶é—´", "å‘è¡¨æ—¶é—´"], allCols),
        hour: findCol(["å°æ—¶"], allCols),
        readCount: findCol(["é˜…è¯»é‡"], allCols),
        readers: findCol(["é˜…è¯»äººæ•°"], allCols),
        officialAccount: findCol(["å…¬ä¼—å·"], allCols),
        readingGroup: findCol(["é˜…è¯»ç»„"], allCols),
        moments: findCol(["æœ‹å‹åœˆ"], allCols),
        look: findCol(["çœ‹ä¸€çœ‹", "çœ‹ä¸€çœ‹ç²¾é€‰", "çœ‹ä¸€çœ‹é˜…è¯»æ•°", "çœ‹ä¸€çœ‹é˜…è¯»", "ç²¾"], allCols),
        search: findCol(["æœä¸€æœ", "æœä¸€æœé˜…è¯»æ•°", "æœä¸€æœé˜…è¯»"], allCols),
        follows: findCol(["æ–°å¢å…³æ³¨", "é˜…è¯»åå…³æ³¨", "é˜…è¯»åå…³æ³¨äººæ•°", "å…³æ³¨äººæ•°", "æ–°å¢å…³æ³¨äººæ•°"], allCols),
        shareCount: findCol(["åˆ†äº«é‡"], allCols),
        sharers: findCol(["åˆ†äº«äººæ•°"], allCols),
        sessionShare: findCol(["ä¼šè¯åˆ†äº«"], allCols),
        officialShare: findCol(["å…¬ä¼—å·åˆ†äº«"], allCols),
        otherShare: findCol(["å…¶ä»–åˆ†äº«"], allCols),
        likes: findCol(["ç‚¹èµæ•°", "ç‚¹èµé‡"], allCols),
        dislikes: findCol(["ç‚¹è¸©æ•°"], allCols),
        tips: findCol(["æ‰“èµæ•°"], allCols),
        openRate: findCol(["æ‰“å¼€ç‡", "æ‰“å¼€ç‡(%)", "æ‰“å¼€ç‡%"], allCols),
        shareRate: findCol(["åˆ†äº«ç‡", "åˆ†äº«ç‡(%)", "åˆ†äº«ç‡%"], allCols),
        momentsOpenRate: findCol(["æœ‹å‹åœˆæ‰“", "æœ‹å‹åœˆæ‰“å¼€ç‡", "æœ‹å‹åœˆæ‰“å¼€ç‡(%)", "æœ‹å‹åœˆæ‰“å¼€ç‡%", "æœ‹å‹åœˆæ‰“å¼€"], allCols),
        readConversionRate: findCol(["é˜…è¯»è½¬åŒ–ç‡"], allCols),
        completionRate: findCol(["å®Œè¯»ç‡"], allCols),
        interactionRate: findCol(["äº’åŠ¨ç‡"], allCols),
        comments: findCol(["ç•™è¨€æ•°", "è¯„è®ºæ•°", "ç•™è¨€", "è¯„è®º"], allCols),
      };

      // è¾“å‡ºå­—æ®µåŒ¹é…ç»“æœï¼Œç”¨äºè°ƒè¯•
      console.log("å­—æ®µåŒ¹é…ç»“æœ:", colMap);
      console.log("å…³é”®å­—æ®µåŒ¹é…è¯¦æƒ…:", {
        look: colMap.look ? "âœ“ " + colMap.look : "âœ— æœªåŒ¹é…",
        momentsOpenRate: colMap.momentsOpenRate ? "âœ“ " + colMap.momentsOpenRate : "âœ— æœªåŒ¹é…ï¼ˆå°†è®¡ç®—ï¼‰",
        moments: colMap.moments ? "âœ“ " + colMap.moments : "âœ— æœªåŒ¹é…",
        readers: colMap.readers ? "âœ“ " + colMap.readers : "âœ— æœªåŒ¹é…"
      });

      // å¦‚æœå­—æ®µæœªåŒ¹é…ï¼Œå°è¯•è‡ªåŠ¨æŸ¥æ‰¾ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
      if (!colMap.look) {
        console.warn("âš ï¸ çœ‹ä¸€çœ‹å­—æ®µæœªåŒ¹é…ï¼Œå°è¯•åœ¨æ‰€æœ‰å­—æ®µä¸­æŸ¥æ‰¾...");
        const possibleCol = allCols.find(col => {
          const colStr = String(col);
          return colStr.includes("çœ‹") || colStr.toLowerCase().includes("look");
        });
        if (possibleCol) {
          console.log("æ‰¾åˆ°å¯èƒ½çš„å­—æ®µ:", possibleCol);
          colMap.look = possibleCol;
        }
      }
      if (!colMap.momentsOpenRate) {
        console.warn("âš ï¸ æœ‹å‹åœˆæ‰“å¼€ç‡å­—æ®µæœªåŒ¹é…ï¼Œå°è¯•åœ¨æ‰€æœ‰å­—æ®µä¸­æŸ¥æ‰¾...");
        const possibleCol = allCols.find(col => {
          const colStr = String(col);
          return (colStr.includes("æœ‹å‹åœˆ") && colStr.includes("æ‰“")) ||
            (colStr.includes("æœ‹å‹åœˆ") && (colStr.includes("æ‰“å¼€") || colStr.includes("æ‰“å¼€ç‡")));
        });
        if (possibleCol) {
          console.log("æ‰¾åˆ°å¯èƒ½çš„å­—æ®µ:", possibleCol);
          colMap.momentsOpenRate = possibleCol;
        }
      }

      const data = [];
      let minDate = null;
      let maxDate = null;
      const dailyMap = {};
      const hourMap = {};

      rows.forEach((row) => {
        const title = row[colMap.title] || "";
        const date = colMap.date ? parseDate(row[colMap.date]) : null;
        const hour = colMap.hour ? num(row[colMap.hour]) : null;

        const item = {
          title,
          date,
          hour,
          readCount: num(row[colMap.readCount]),
          readers: num(row[colMap.readers]),
          officialAccount: num(row[colMap.officialAccount]),
          readingGroup: num(row[colMap.readingGroup]),
          moments: num(row[colMap.moments]),
          look: (function () {
            if (!colMap.look) {
              if (rows.indexOf(row) === 0) {
                console.warn("âš ï¸ çœ‹ä¸€çœ‹å­—æ®µä»æœªåŒ¹é…");
              }
              return 0;
            }
            const rawValue = row[colMap.look];
            const parsedValue = num(rawValue);
            if (rows.indexOf(row) === 0) {
              console.log("ç¬¬ä¸€æ¡æ•°æ®çš„çœ‹ä¸€çœ‹å­—æ®µ:", {
                fieldName: colMap.look,
                rawValue: rawValue,
                parsedValue: parsedValue
              });
            }
            return parsedValue;
          })(),
          search: (function () {
            const rawValue = colMap.search ? row[colMap.search] : null;
            const parsedValue = num(rawValue);
            if (rows.indexOf(row) === 0) {
              console.log("ç¬¬ä¸€æ¡æ•°æ®çš„æœä¸€æœå­—æ®µ:", {
                fieldName: colMap.search,
                rawValue: rawValue,
                parsedValue: parsedValue
              });
            }
            return parsedValue;
          })(),
          follows: (function () {
            const rawValue = colMap.follows ? row[colMap.follows] : null;
            const parsedValue = num(rawValue);
            // è°ƒè¯•ç¬¬ä¸€æ¡æ•°æ®
            if (rows.indexOf(row) === 0) {
              console.log("ç¬¬ä¸€æ¡æ•°æ®çš„æ–°å¢å…³æ³¨å­—æ®µ:", {
                fieldName: colMap.follows,
                rawValue: rawValue,
                parsedValue: parsedValue
              });
            }
            return parsedValue;
          })(),
          shareCount: num(row[colMap.shareCount]),
          sharers: num(row[colMap.sharers]),
          sessionShare: num(row[colMap.sessionShare]),
          officialShare: num(row[colMap.officialShare]),
          otherShare: num(row[colMap.otherShare]),
          likes: num(row[colMap.likes]),
          dislikes: num(row[colMap.dislikes]),
          tips: num(row[colMap.tips]),
          openRate: (function () {
            const rawValue = colMap.openRate ? row[colMap.openRate] : null;
            const parsedValue = pct(rawValue);
            if (rows.indexOf(row) === 0) {
              console.log("ç¬¬ä¸€æ¡æ•°æ®çš„æ‰“å¼€ç‡å­—æ®µ:", {
                fieldName: colMap.openRate,
                rawValue: rawValue,
                parsedValue: parsedValue
              });
            }
            return parsedValue;
          })(),
          shareRate: (function () {
            const rawValue = colMap.shareRate ? row[colMap.shareRate] : null;
            const parsedValue = pct(rawValue);
            if (rows.indexOf(row) === 0) {
              console.log("ç¬¬ä¸€æ¡æ•°æ®çš„åˆ†äº«ç‡å­—æ®µ:", {
                fieldName: colMap.shareRate,
                rawValue: rawValue,
                parsedValue: parsedValue
              });
            }
            return parsedValue;
          })(),
          readConversionRate: pct(row[colMap.readConversionRate]),
          completionRate: pct(row[colMap.completionRate]),
          interactionRate: pct(row[colMap.interactionRate]),
          comments: num(row[colMap.comments]),
          // æœ‹å‹åœˆæ‰“å¼€ç‡ï¼šä¼˜å…ˆä½¿ç”¨è¡¨å¤´å­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™è®¡ç®—
          momentsOpenRate: (function () {
            // å¦‚æœæœ‰ç°æˆçš„å­—æ®µï¼Œç›´æ¥ä½¿ç”¨
            if (colMap.momentsOpenRate) {
              const rawValue = row[colMap.momentsOpenRate];
              const parsedValue = pct(rawValue);
              if (rows.indexOf(row) === 0) {
                console.log("ç¬¬ä¸€æ¡æ•°æ®çš„æœ‹å‹åœˆæ‰“å¼€ç‡ï¼ˆç›´æ¥è¯»å–ï¼‰:", {
                  fieldName: colMap.momentsOpenRate,
                  rawValue: rawValue,
                  parsedValue: parsedValue
                });
              }
              return parsedValue;
            }
            // å¦‚æœå­—æ®µæœªåŒ¹é…ï¼Œå°è¯•è®¡ç®—
            if (rows.indexOf(row) === 0) {
              console.warn("âš ï¸ æœ‹å‹åœˆæ‰“å¼€ç‡å­—æ®µæœªåŒ¹é…ï¼Œå°†ä½¿ç”¨è®¡ç®—å€¼");
            }
            // è®¡ç®—ï¼šæœ‹å‹åœˆé˜…è¯»æ•° / é˜…è¯»äººæ•° * 100
            const readers = num(row[colMap.readers]);
            const moments = num(row[colMap.moments]);
            const rate = readers > 0 ? (moments / readers * 100) : 0;
            if (rows.indexOf(row) === 0) {
              console.log("ç¬¬ä¸€æ¡æ•°æ®çš„æœ‹å‹åœˆæ‰“å¼€ç‡ï¼ˆè®¡ç®—ï¼‰:", {
                readersField: colMap.readers,
                readersValue: readers,
                momentsField: colMap.moments,
                momentsValue: moments,
                calculatedRate: rate
              });
            }
            return rate;
          })(),
          // è®¡ç®—ç•™è¨€ç‡ = ç•™è¨€æ•° / é˜…è¯»äººæ•° * 100
          commentRate: (function () {
            const readers = num(row[colMap.readers]);
            return (readers > 0 && colMap.comments) ? (num(row[colMap.comments]) / readers * 100) : 0;
          })(),
        };

        data.push(item);

        if (date) {
          if (!minDate || date < minDate) minDate = date;
          if (!maxDate || date > maxDate) maxDate = date;

          const dayStr = formatDate(date);
          dailyMap[dayStr] = (dailyMap[dayStr] || 0) + 1;

          if (hour !== null && hour >= 0 && hour < 24) {
            hourMap[hour] = (hourMap[hour] || 0) + 1;
          }
        }
      });

      if (minDate && maxDate) {
        document.getElementById("dateRange").innerHTML =
          `æ—¶é—´èŒƒå›´ï¼š${formatDate(minDate)} ~ ${formatDate(maxDate)}` +
          `<span class="tag">ç”¨äºæ•°æ®åˆ†æå±•ç¤º</span>`;
      }

      renderSummary(data);
      renderTopRead(data);
      renderReadShare(data);
      renderTopLikes(data);
      renderTopShare(data);
      renderOpenRate(data);

      // è°ƒè¯•ï¼šè¾“å‡ºæ•°æ®æ ·æœ¬
      if (data.length > 0) {
        console.log("æ•°æ®æ ·æœ¬ï¼ˆç¬¬ä¸€æ¡ï¼‰:", data[0]);
        console.log("æ•°æ®æ€»æ•°:", data.length);
      }

      renderTop5Tables(data);
      renderDetailTable(data);
    }

    function renderSummary(data) {
      document.getElementById("summaryCards").style.display = "grid";

      const total = data.length;
      const totalReaders = data.reduce((s, r) => s + r.readers, 0);
      const totalReadCount = data.reduce((s, r) => s + r.readCount, 0);
      const totalShareCount = data.reduce((s, r) => s + r.shareCount, 0);
      const totalLikes = data.reduce((s, r) => s + r.likes, 0);
      const totalFollows = data.reduce((s, r) => s + r.follows, 0);

      const openRates = data.map((r) => r.openRate).filter((v) => v > 0);
      const avgOpenRate =
        openRates.length > 0
          ? (openRates.reduce((a, b) => a + b, 0) / openRates.length).toFixed(2)
          : "0.00";

      const shareRates = data.map((r) => r.shareRate).filter((v) => v > 0);
      const avgShareRate =
        shareRates.length > 0
          ? (shareRates.reduce((a, b) => a + b, 0) / shareRates.length).toFixed(2)
          : "0.00";

      document.getElementById("totalArticles").textContent = total;
      document.getElementById("totalReaders").textContent = totalReaders.toLocaleString();
      document.getElementById("totalReadCount").textContent = totalReadCount.toLocaleString();
      document.getElementById("totalShareCount").textContent = totalShareCount.toLocaleString();
      document.getElementById("totalLikes").textContent = totalLikes.toLocaleString();
      document.getElementById("totalFollows").textContent = totalFollows.toLocaleString();
      document.getElementById("avgOpenRate").textContent = avgOpenRate + "%";
      document.getElementById("avgShareRate").textContent = avgShareRate + "%";
    }

    function renderReadSource(data) {
      const officialAccount = data.reduce((s, r) => s + r.officialAccount, 0);
      const readingGroup = data.reduce((s, r) => s + r.readingGroup, 0);
      const moments = data.reduce((s, r) => s + r.moments, 0);
      const look = data.reduce((s, r) => s + r.look, 0);
      const search = data.reduce((s, r) => s + r.search, 0);

      Plotly.newPlot(
        "readSourceChart",
        [
          {
            x: ["å…¬ä¼—å·", "é˜…è¯»ç»„", "æœ‹å‹åœˆ", "çœ‹ä¸€çœ‹", "æœä¸€æœ"],
            y: [officialAccount, readingGroup, moments, look, search],
            type: "bar",
          },
        ],
        { margin: { t: 20, r: 10, b: 40, l: 40 } }
      );
    }

    function renderTopRead(data) {
      const top = data
        .slice()
        .sort((a, b) => b.readers - a.readers)
        .slice(0, 10);

      Plotly.newPlot(
        "topReadChart",
        [
          {
            x: top.map((x) => x.title || "æœªå‘½å"),
            y: top.map((x) => x.readers),
            type: "bar",
          },
        ],
        { margin: { b: 120 } }
      );
    }

    function renderReadShare(data) {
      Plotly.newPlot(
        "readShareScatter",
        [
          {
            x: data.map((x) => x.readers),
            y: data.map((x) => x.shareCount),
            mode: "markers",
            type: "scatter",
            text: data.map((x) => x.title || "æœªå‘½å"),
          },
        ],
        {
          xaxis: { title: "é˜…è¯»äººæ•°" },
          yaxis: { title: "åˆ†äº«é‡" },
        }
      );
    }

    function renderTopLikes(data) {
      const top = data
        .slice()
        .sort((a, b) => b.likes - a.likes)
        .slice(0, 10);

      Plotly.newPlot(
        "topLikesChart",
        [
          {
            x: top.map((x) => x.title || "æœªå‘½å"),
            y: top.map((x) => x.likes),
            type: "bar",
          },
        ],
        { margin: { b: 120 } }
      );
    }

    function renderTopShare(data) {
      const top = data
        .slice()
        .sort((a, b) => b.shareCount - a.shareCount)
        .slice(0, 10);

      Plotly.newPlot(
        "topShareChart",
        [
          {
            x: top.map((x) => x.title || "æœªå‘½å"),
            y: top.map((x) => x.shareCount),
            type: "bar",
          },
        ],
        { margin: { b: 120 } }
      );
    }

    function renderOpenRate(data) {
      const list = data
        .filter((x) => x.openRate > 0)
        .sort((a, b) => b.openRate - a.openRate)
        .slice(0, 20);

      Plotly.newPlot(
        "openRateChart",
        [
          {
            x: list.map((x) => x.title || "æœªå‘½å"),
            y: list.map((x) => x.openRate),
            type: "bar",
          },
        ],
        { margin: { b: 120 }, yaxis: { title: "æ‰“å¼€ç‡ (%)" } }
      );
    }

    function renderShareRate(data) {
      console.log("åˆ†äº«ç‡æ•°æ®ç»Ÿè®¡:", {
        total: data.length,
        hasData: data.filter(item => item.shareRate > 0).length,
        maxValue: data.length > 0 ? Math.max(...data.map(item => item.shareRate)) : 0,
        minValue: data.length > 0 ? Math.min(...data.map(item => item.shareRate)) : 0,
        sampleValues: data.slice(0, 5).map(item => ({ title: item.title, shareRate: item.shareRate }))
      });

      const list = data
        .filter((x) => x.shareRate > 0)
        .sort((a, b) => b.shareRate - a.shareRate)
        .slice(0, 20);

      if (list.length === 0) {
        console.warn("åˆ†äº«ç‡æ•°æ®ä¸ºç©ºï¼Œå¯èƒ½å­—æ®µåŒ¹é…å¤±è´¥æˆ–æ‰€æœ‰æ•°æ®éƒ½æ˜¯0");
        // å³ä½¿æ²¡æœ‰æ•°æ®ï¼Œä¹Ÿæ˜¾ç¤ºä¸€ä¸ªç©ºå›¾è¡¨ï¼Œé¿å…æŠ¥é”™
        Plotly.newPlot(
          "shareRateChart",
          [{ x: [], y: [], type: "bar" }],
          { margin: { b: 120 }, yaxis: { title: "åˆ†äº«ç‡ (%)" } }
        );
        return;
      }

      Plotly.newPlot(
        "shareRateChart",
        [
          {
            x: list.map((x) => x.title || "æœªå‘½å"),
            y: list.map((x) => x.shareRate),
            type: "bar",
          },
        ],
        { margin: { b: 120 }, yaxis: { title: "åˆ†äº«ç‡ (%)" } }
      );
    }

    function renderDailyChart(dailyMap) {
      const dates = Object.keys(dailyMap).sort();
      const counts = dates.map((d) => dailyMap[d]);

      Plotly.newPlot(
        "dailyChart",
        [{ x: dates, y: counts, type: "bar" }],
        { margin: { t: 20, r: 10, b: 60, l: 40 } }
      );
    }

    function renderHourChart(hourMap) {
      const hours = [];
      const counts = [];
      for (let h = 0; h < 24; h++) {
        hours.push(h);
        counts.push(hourMap[h] || 0);
      }

      Plotly.newPlot(
        "hourChart",
        [{ x: hours, y: counts, type: "bar" }],
        { margin: { t: 20, r: 10, b: 40, l: 40 }, xaxis: { dtick: 1 } }
      );
    }

    function renderTop5Tables(data) {
      if (!data || data.length === 0) {
        console.warn("renderTop5Tables: æ•°æ®ä¸ºç©º");
        return;
      }

      // 1. é˜…è¯»é‡ TOP 5 - ä¸è¿‡æ»¤ï¼Œç›´æ¥å–å‰5
      const topReadCount = data
        .slice()
        .sort((a, b) => b.readCount - a.readCount)
        .slice(0, 5);
      console.log("é˜…è¯»é‡ TOP 5:", topReadCount.map(item => ({ title: item.title, readCount: item.readCount })));
      renderTop5Table("topReadCountTable", topReadCount, "é˜…è¯»é‡", (item) => item.readCount.toLocaleString());

      // 2. æœä¸€æœ TOP 5 - æ”¾å®½æ¡ä»¶ï¼Œå…è®¸ä¸º0
      const topSearch = data
        .slice()
        .filter((item) => item.search > 0)  // è¿‡æ»¤æ‰0å€¼
        .sort((a, b) => b.search - a.search)
        .slice(0, 5);
      console.log("æœä¸€æœ TOP 5:", topSearch.map(item => ({ title: item.title, search: item.search })));
      console.log("æœä¸€æœæ•°æ®ç»Ÿè®¡:", {
        total: data.length,
        hasData: data.filter(item => item.search > 0).length,
        maxValue: data.length > 0 ? Math.max(...data.map(item => item.search)) : 0,
        sampleValues: data.slice(0, 3).map(item => ({ title: item.title, search: item.search }))
      });
      renderTop5Table("topSearchTable", topSearch, "æœä¸€æœé˜…è¯»æ•°", (item) => item.search.toLocaleString());

      // 3. çœ‹ä¸€çœ‹ç²¾é€‰ TOP 5 - åªæ˜¾ç¤ºæœ‰æ•°æ®çš„ï¼ˆ>0ï¼‰
      const topLook = data
        .slice()
        .filter((item) => item.look > 0)  // è¿‡æ»¤æ‰0å€¼
        .sort((a, b) => b.look - a.look)
        .slice(0, 5);
      console.log("çœ‹ä¸€çœ‹ TOP 5:", topLook.map(item => ({ title: item.title, look: item.look })));
      console.log("çœ‹ä¸€çœ‹æ•°æ®ç»Ÿè®¡:", {
        total: data.length,
        hasData: data.filter(item => item.look > 0).length,
        maxValue: data.length > 0 ? Math.max(...data.map(item => item.look)) : 0,
        allValues: data.map(item => item.look).slice(0, 10),  // æ˜¾ç¤ºå‰10æ¡çš„å€¼
        sampleValues: data.slice(0, 5).map(item => ({ title: item.title, look: item.look }))
      });
      if (topLook.length === 0) {
        console.warn("âš ï¸ çœ‹ä¸€çœ‹ TOP 5 ä¸ºç©ºï¼Œå¯èƒ½åŸå› ï¼šå­—æ®µåŒ¹é…å¤±è´¥æˆ–æ‰€æœ‰æ•°æ®éƒ½æ˜¯0");
      }
      renderTop5Table("topLookTable", topLook, "çœ‹ä¸€çœ‹é˜…è¯»æ•°", (item) => item.look.toLocaleString());

      // 4. åˆ†äº«é‡ TOP 5 - åªæ˜¾ç¤ºæœ‰æ•°æ®çš„ï¼ˆ>0ï¼‰
      const topShareCount = data
        .slice()
        .filter((item) => item.shareCount > 0)  // è¿‡æ»¤æ‰0å€¼
        .sort((a, b) => b.shareCount - a.shareCount)
        .slice(0, 5);
      console.log("åˆ†äº«é‡ TOP 5:", topShareCount.map(item => ({ title: item.title, shareCount: item.shareCount })));
      console.log("åˆ†äº«é‡æ•°æ®ç»Ÿè®¡:", {
        total: data.length,
        hasData: data.filter(item => item.shareCount > 0).length,
        maxValue: data.length > 0 ? Math.max(...data.map(item => item.shareCount)) : 0,
        sampleValues: data.slice(0, 3).map(item => ({ title: item.title, shareCount: item.shareCount }))
      });
      renderTop5Table("topShareCountTable", topShareCount, "åˆ†äº«é‡", (item) => item.shareCount.toLocaleString());

      // 5. æ‰“å¼€ç‡ TOP 5 - åªæ˜¾ç¤ºæœ‰æ•°æ®çš„ï¼ˆ>0ï¼‰
      const topOpenRate = data
        .slice()
        .filter((item) => item.openRate > 0)  // è¿‡æ»¤æ‰0å€¼
        .sort((a, b) => b.openRate - a.openRate)
        .slice(0, 5);
      console.log("æ‰“å¼€ç‡ TOP 5:", topOpenRate.map(item => ({ title: item.title, openRate: item.openRate })));
      console.log("æ‰“å¼€ç‡æ•°æ®ç»Ÿè®¡:", {
        total: data.length,
        hasData: data.filter(item => item.openRate > 0).length,
        maxValue: data.length > 0 ? Math.max(...data.map(item => item.openRate)) : 0,
        sampleValues: data.slice(0, 3).map(item => ({ title: item.title, openRate: item.openRate }))
      });
      renderTop5Table("topOpenRateTable", topOpenRate, "æ‰“å¼€ç‡", (item) => item.openRate.toFixed(2) + "%");

      // 6. æœ‹å‹åœˆæ‰“å¼€ç‡ TOP 5 - åªæ˜¾ç¤ºæœ‰æ•°æ®çš„ï¼ˆ>0ï¼‰
      const topMomentsOpenRate = data
        .slice()
        .filter((item) => item.momentsOpenRate > 0)  // è¿‡æ»¤æ‰0å€¼
        .sort((a, b) => b.momentsOpenRate - a.momentsOpenRate)
        .slice(0, 5);
      console.log("æœ‹å‹åœˆæ‰“å¼€ç‡ TOP 5:", topMomentsOpenRate.map(item => ({ title: item.title, momentsOpenRate: item.momentsOpenRate })));
      console.log("æœ‹å‹åœˆæ‰“å¼€ç‡æ•°æ®ç»Ÿè®¡:", {
        total: data.length,
        hasData: data.filter(item => item.momentsOpenRate > 0).length,
        maxValue: data.length > 0 ? Math.max(...data.map(item => item.momentsOpenRate)) : 0,
        allValues: data.map(item => item.momentsOpenRate).slice(0, 10),  // æ˜¾ç¤ºå‰10æ¡çš„å€¼
        sampleValues: data.slice(0, 5).map(item => ({
          title: item.title,
          momentsOpenRate: item.momentsOpenRate,
          moments: item.moments,
          readers: item.readers
        }))
      });
      if (topMomentsOpenRate.length === 0) {
        console.warn("âš ï¸ æœ‹å‹åœˆæ‰“å¼€ç‡ TOP 5 ä¸ºç©ºï¼Œå¯èƒ½åŸå› ï¼šå­—æ®µåŒ¹é…å¤±è´¥æˆ–æ‰€æœ‰æ•°æ®éƒ½æ˜¯0");
      }
      renderTop5Table("topMomentsOpenRateTable", topMomentsOpenRate, "æœ‹å‹åœˆæ‰“å¼€ç‡", (item) => item.momentsOpenRate.toFixed(2) + "%");

      // 7. ç•™è¨€ç‡ TOP 5 - åªæ˜¾ç¤ºæœ‰æ•°æ®çš„ï¼ˆ>0ï¼‰
      const topCommentRate = data
        .slice()
        .filter((item) => item.commentRate > 0)  // è¿‡æ»¤æ‰0å€¼
        .sort((a, b) => b.commentRate - a.commentRate)
        .slice(0, 5);
      console.log("ç•™è¨€ç‡ TOP 5:", topCommentRate.map(item => ({ title: item.title, commentRate: item.commentRate })));
      console.log("ç•™è¨€ç‡æ•°æ®ç»Ÿè®¡:", {
        total: data.length,
        hasData: data.filter(item => item.commentRate > 0).length,
        maxValue: data.length > 0 ? Math.max(...data.map(item => item.commentRate)) : 0,
        sampleValues: data.slice(0, 3).map(item => ({ title: item.title, commentRate: item.commentRate }))
      });
      renderTop5Table("topCommentRateTable", topCommentRate, "ç•™è¨€ç‡", (item) => item.commentRate.toFixed(2) + "%");

      // 8. é˜…è¯»åå…³æ³¨ TOP 5 - åªæ˜¾ç¤ºæœ‰æ•°æ®çš„ï¼ˆ>0ï¼‰
      const topFollows = data
        .slice()
        .filter((item) => item.follows > 0)  // è¿‡æ»¤æ‰0å€¼
        .sort((a, b) => b.follows - a.follows)
        .slice(0, 5);
      console.log("é˜…è¯»åå…³æ³¨ TOP 5:", topFollows.map(item => ({ title: item.title, follows: item.follows })));
      console.log("é˜…è¯»åå…³æ³¨æ•°æ®ç»Ÿè®¡:", {
        total: data.length,
        hasData: data.filter(item => item.follows > 0).length,
        maxValue: data.length > 0 ? Math.max(...data.map(item => item.follows)) : 0,
        sampleValues: data.slice(0, 3).map(item => ({ title: item.title, follows: item.follows }))
      });
      renderTop5Table("topFollowsTable", topFollows, "æ–°å¢å…³æ³¨", (item) => item.follows.toLocaleString());
    }

    function renderTop5Table(containerId, list, valueLabel, valueFormatter) {
      const container = document.getElementById(containerId);
      if (!list || !list.length) {
        container.innerHTML = "<div style='font-size:12px;color:#6b7280;'>æš‚æ— æ•°æ®</div>";
        return;
      }

      let html = "<table class='data-table'><thead><tr>";
      html += "<th>æ’å</th><th>æ ‡é¢˜</th><th>æ—¥æœŸ</th><th>" + valueLabel + "</th><th>é˜…è¯»äººæ•°</th>";
      html += "</tr></thead><tbody>";

      list.forEach((row, index) => {
        html += "<tr>";
        html += `<td>${index + 1}</td>`;
        html += `<td>${escapeHtml(row.title || "æœªå‘½å")}</td>`;
        html += `<td>${row.date ? formatDate(row.date) : ""}</td>`;
        html += `<td><strong>${valueFormatter(row)}</strong></td>`;
        html += `<td>${row.readers.toLocaleString()}</td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";
      container.innerHTML = html;
    }

    function renderDetailTable(data) {
      const top = data
        .slice()
        .sort((a, b) => b.readers - a.readers)
        .slice(0, 50);

      let html = "<table class='data-table'><thead><tr>";
      const headers = [
        "æ ‡é¢˜",
        "æ—¥æœŸ",
        "é˜…è¯»äººæ•°",
        "é˜…è¯»é‡",
        "åˆ†äº«é‡",
        "ç‚¹èµæ•°",
        "æ–°å¢å…³æ³¨",
        "æ‰“å¼€ç‡",
        "åˆ†äº«ç‡",
      ];
      html += headers.map((h) => `<th>${h}</th>`).join("");
      html += "</tr></thead><tbody>";

      top.forEach((row) => {
        html += "<tr>";
        html += `<td>${escapeHtml(row.title || "")}</td>`;
        html += `<td>${row.date ? formatDate(row.date) : ""}</td>`;
        html += `<td>${row.readers}</td>`;
        html += `<td>${row.readCount}</td>`;
        html += `<td>${row.shareCount}</td>`;
        html += `<td>${row.likes}</td>`;
        html += `<td>${row.follows}</td>`;
        html += `<td>${row.openRate.toFixed(2)}%</td>`;
        html += `<td>${row.shareRate.toFixed(2)}%</td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";
      document.getElementById("detailTable").innerHTML = html;
    }

    function escapeHtml(val) {
      if (val === null || val === undefined) return "";
      return String(val)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }
  </script>

  <!-- æˆæƒå±‚è„šæœ¬ -->
  <script>
    const TOOL_ID = "yiban-analysis";
    const STORAGE_KEY = `wechat_dashboard_auth_${TOOL_ID}`;
    const INLINE_AUTH_CODES = {
      tools: {
        "yiban-analysis": {
          codes: {
            "YB-2025-A1B2": "æ ‡å‡†æˆæƒ",
            "YB-2025-C3D4": "æ ‡å‡†æˆæƒ",
            "YB-2025-E5F6": "æ ‡å‡†æˆæƒ",
            "YB-2025-G7H8": "æ ‡å‡†æˆæƒ",
            "YB-2025-I9J0": "æ ‡å‡†æˆæƒ",
            "YB-2025-K1L2": "æ ‡å‡†æˆæƒ",
            "YB-2025-M3N4": "æ ‡å‡†æˆæƒ",
            "YB-2025-O5P6": "æ ‡å‡†æˆæƒ",
            "YB-2025-Q7R8": "æ ‡å‡†æˆæƒ",
            "YB-2025-S9T0": "æ ‡å‡†æˆæƒ",
          },
        },
      },
    };

    let AUTH_CODES = {};
    let authLoaded = false;

    function loadAuthCodes() {
      if (location.protocol === "file:") {
        AUTH_CODES = INLINE_AUTH_CODES.tools?.[TOOL_ID]?.codes || {};
        authLoaded = true;
        console.log("ä½¿ç”¨å†…ç½®æˆæƒç ï¼ˆfile:// æ¨¡å¼ï¼‰");
        return Promise.resolve();
      }

      const url = "./auth-codes.json?" + Date.now();
      console.log("å°è¯•åŠ è½½æˆæƒç æ–‡ä»¶ï¼š", url);

      return fetch(url)
        .then(async (res) => {
          if (!res.ok) {
            const text = await res.text().catch(() => "");
            console.error("auth-codes.json å“åº”å¼‚å¸¸ï¼š", res.status, res.statusText, text);
            throw new Error("HTTP " + res.status);
          }
          return res.json();
        })
        .then((data) => {
          console.log("auth-codes.json åŠ è½½æˆåŠŸï¼š", data);
          // æå–å½“å‰å·¥å…·çš„æˆæƒç 
          if (data.tools && data.tools[TOOL_ID]) {
            AUTH_CODES = data.tools[TOOL_ID].codes || {};
          } else if (typeof data === 'object') {
            // å…¼å®¹æ—§æ ¼å¼
            AUTH_CODES = data;
          }
          authLoaded = true;
          console.log("æˆæƒç åŠ è½½å®Œæˆï¼Œå¯ç”¨æ•°é‡:", Object.keys(AUTH_CODES).length);
        })
        .catch((err) => {
          console.error("æˆæƒç æ–‡ä»¶åŠ è½½å¤±è´¥:", err);
          // å…œåº•ï¼šå¦‚æœæœ‰å†…ç½®æˆæƒç åˆ™ç»§ç»­ä½¿ç”¨ï¼Œé¿å…é˜»æ–­ä½¿ç”¨
          AUTH_CODES = INLINE_AUTH_CODES.tools?.[TOOL_ID]?.codes || {};
          authLoaded = true;
          console.log("ä½¿ç”¨å†…ç½®æˆæƒç å…œåº•ï¼Œå¯ç”¨æ•°é‡:", Object.keys(AUTH_CODES).length);
          if (!Object.keys(AUTH_CODES).length) {
            alert("æˆæƒç æ–‡ä»¶åŠ è½½å¤±è´¥ï¼š\n" +
              "1ï¼‰ç¡®è®¤æ ¹ç›®å½•å­˜åœ¨ auth-codes.json\n" +
              "2ï¼‰ç¡®è®¤éƒ¨ç½²åå¯ä»¥ç›´æ¥è®¿é—® /auth-codes.json\n" +
              "3ï¼‰ç¡®è®¤æ–‡ä»¶å†…å®¹æ˜¯åˆæ³• JSONï¼ˆæ— å¤šä½™é€—å·/æ³¨é‡Šï¼‰");
          }
        });
    }

    let authScreen, appRoot, input, btn, errElAuth, cardEl;

    function initAuthElements() {
      authScreen = document.getElementById("auth-screen");
      appRoot = document.getElementById("app");
      input = document.getElementById("auth-code");
      btn = document.getElementById("auth-btn");
      errElAuth = document.getElementById("auth-error");
      cardEl = document.getElementById("auth-card");

      if (!authScreen || !appRoot || !input || !btn || !errElAuth || !cardEl) {
        console.error("æˆæƒå…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥ DOM");
        return false;
      }
      return true;
    }

    function shakeCard() {
      if (!cardEl) return;
      cardEl.classList.remove("shake");
      void cardEl.offsetWidth;
      cardEl.classList.add("shake");
    }

    async function handleAuth() {
      console.log("handleAuth è¢«è°ƒç”¨");
      if (!input || !errElAuth) {
        console.error("æˆæƒå…ƒç´ æœªåˆå§‹åŒ–", { input, errElAuth });
        return;
      }

      const code = (input.value || "").trim();
      console.log("è¾“å…¥çš„æˆæƒç :", code);

      if (!authLoaded) {
        console.log("æˆæƒç æœªåŠ è½½ï¼Œå¼€å§‹åŠ è½½...");
        await loadAuthCodes();
      }

      if (!code) {
        errElAuth.textContent = "è¯·è¾“å…¥æˆæƒç ã€‚";
        shakeCard();
        return;
      }

      console.log("éªŒè¯æˆæƒç :", code);
      console.log("å¯ç”¨æˆæƒç åˆ—è¡¨:", Object.keys(AUTH_CODES));
      console.log("æˆæƒç å¯¹è±¡:", AUTH_CODES);

      // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æˆæƒç æˆ–é»˜è®¤å¯†ç 
      const isValidCode = Object.prototype.hasOwnProperty.call(AUTH_CODES, code);
      const isDefaultPassword = code === "dcone123";

      if (!isValidCode && !isDefaultPassword) {
        console.log("æˆæƒç éªŒè¯å¤±è´¥:", code, "ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œä¹Ÿä¸æ˜¯é»˜è®¤å¯†ç ");
        errElAuth.textContent = "æˆæƒç æ— æ•ˆï¼Œè¯·ç¡®è®¤åé‡æ–°è¾“å…¥ã€‚";
        shakeCard();
        return;
      }

      console.log("æˆæƒç éªŒè¯æˆåŠŸï¼Œæ˜¾ç¤ºåº”ç”¨");
      errElAuth.textContent = "";
      showApp(code);
    }

    function showApp(code) {
      if (!authScreen || !appRoot) {
        console.error("æ— æ³•æ˜¾ç¤ºåº”ç”¨ï¼šå…ƒç´ æœªæ‰¾åˆ°");
        return;
      }
      authScreen.style.display = "none";
      appRoot.classList.add("visible");
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ code, ts: Date.now() }));
      } catch (e) {
        console.warn("localStorage ä¿å­˜å¤±è´¥:", e);
      }
    }

    (async function bootstrapAuth() {
      console.log("å¼€å§‹åˆå§‹åŒ–æˆæƒç³»ç»Ÿ");
      // ç­‰å¾… DOM åŠ è½½å®Œæˆ
      if (document.readyState === "loading") {
        await new Promise((resolve) => {
          document.addEventListener("DOMContentLoaded", resolve);
        });
      }

      if (!initAuthElements()) {
        console.error("åˆå§‹åŒ–æˆæƒå…ƒç´ å¤±è´¥");
        return;
      }

      console.log("æˆæƒå…ƒç´ åˆå§‹åŒ–æˆåŠŸ");

      // åŠ è½½æˆæƒç 
      await loadAuthCodes();

      // æ£€æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰ä¿å­˜çš„æˆæƒç 
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          if (parsed && parsed.code && (AUTH_CODES[parsed.code] || parsed.code === "dcone123")) {
            console.log("å‘ç°å·²ä¿å­˜çš„æˆæƒç ï¼Œè‡ªåŠ¨ç™»å½•");
            showApp(parsed.code);
            return;
          }
        }
      } catch (e) {
        console.warn("localStorage è¯»å–å¤±è´¥:", e);
      }

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      btn.addEventListener("click", handleAuth);
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") handleAuth();
      });
    })();
  </script>
</body>

</html>